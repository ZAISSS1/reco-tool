<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聯能永續-報價工具</title>
    <!-- 使用自定義圖標 - 強制重新載入 -->
    <link rel="icon" href="favicon.ico?v=2" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico?v=2" type="image/x-icon">
    <link rel="apple-touch-icon" href="favicon.ico?v=2">
    <meta name="theme-color" content="#667eea">
    <!-- SheetJS library for Excel processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #2a2a2a;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            overflow: hidden;
            border: 1px solid #404040;
        }

        .header {
            background: linear-gradient(135deg, #333333 0%, #1a1a1a 100%);
            color: #ffffff;
            text-align: center;
            padding: 30px 20px;
        }

        .header h1 {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            font-weight: bold;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #1a1a1a;
            border-bottom: 2px solid #404040;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .tab {
            flex: 1;
            min-width: 120px;
            padding: 12px 6px;
            text-align: center;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: #a0a0a0;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #2a2a2a;
            color: #ffffff;
            border-bottom: 3px solid #667eea;
        }

        .tab:hover {
            background: #333333;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h3 {
            color: #ffffff;
            margin-bottom: 15px;
            font-size: 1.4rem;
        }

        .info-box {
            background: #2a2a2a;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            color: #e0e0e0;
            border: 1px solid #404040;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #e0e0e0;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #555555;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #333333;
            color: #ffffff;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .btn {
            width: 60px;
            height: 60px;
            margin: 20px auto;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn:hover {
            transform: translateY(-3px);
        }

        .btn.quote { 
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); 
            color: #333;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .btn.quote:hover { 
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
            background: linear-gradient(135deg, #f8f8f8 0%, #e8e8e8 100%);
        }

        .btn.monthly { 
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); 
            color: #333;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .btn.monthly:hover { 
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
            background: linear-gradient(135deg, #f8f8f8 0%, #e8e8e8 100%);
        }

        .btn.single { 
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); 
            color: #333;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .btn.single:hover { 
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
            background: linear-gradient(135deg, #f8f8f8 0%, #e8e8e8 100%);
        }

        .btn.clean { 
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); 
            color: #333;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .btn.clean:hover { 
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
            background: linear-gradient(135deg, #f8f8f8 0%, #e8e8e8 100%);
        }



        .output-section {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #404040;
        }

        .output-area {
            width: 100%;
            min-height: 300px;
            border: 2px solid #555555;
            border-radius: 8px;
            padding: 15px;
            background: #2a2a2a;
            color: #ffffff;
            font-family: monospace;
            white-space: pre-wrap;
            margin-bottom: 15px;
        }

        .copy-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .copy-btn {
            width: 50px;
            height: 50px;
            margin: 15px auto;
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            color: #333;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            background: linear-gradient(135deg, #f8f8f8 0%, #e8e8e8 100%);
        }

        .status {
            margin-top: 15px;
            text-align: center;
            min-height: 40px;
            padding: 10px;
            border-radius: 5px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 5px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #e0e0e0;
            cursor: pointer;
            margin-bottom: 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            width: 16px;
            height: 16px;
        }

        h4 {
            color: #ffffff;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        small {
            color: #a0a0a0;
            font-size: 12px;
        }

        .mobile-text {
            display: none;
        }

        .desktop-text {
            display: inline;
        }

        .clear-btn-small {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(108, 117, 125, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .clear-btn-small:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
        }

        /* 拖曳上傳樣式 */
        .drop-zone {
            border: 2px dashed #666;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #2a2a2a;
            transition: all 0.3s ease;
            position: relative;
            min-height: 120px;
        }

        .drop-zone:hover, .drop-zone.dragover,
        .drop-zone-inline:hover, .drop-zone-inline.dragover {
            border-color: #4CAF50 !important;
            background: #2f3f2f !important;
        }

        .drop-zone-content {
            pointer-events: none;
        }

        .drop-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .drop-text {
            color: #ccc;
            font-size: 16px;
        }

        /* 照片合併按鈕樣式 */
        .btn-merge {
            background: linear-gradient(135deg, #1565C0, #0D47A1);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(21, 101, 192, 0.3);
        }

        .btn-merge:hover {
            background: linear-gradient(135deg, #0D47A1, #0A3880);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(21, 101, 192, 0.4);
        }

        .btn-clear {
            background: linear-gradient(135deg, #9E9E9E, #757575);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(158, 158, 158, 0.3);
        }

        .btn-clear:hover {
            background: linear-gradient(135deg, #757575, #616161);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(158, 158, 158, 0.4);
        }

        .btn-download {
            background: linear-gradient(135deg, #2E7D32, #1B5E20);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(46, 125, 50, 0.3);
        }

        .btn-download:hover {
            background: linear-gradient(135deg, #1B5E20, #0F4318);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(46, 125, 50, 0.4);
        }



        /* 照片預覽樣式 */
        .photo-preview {
            display: inline-block;
            margin: 5px;
            border: 2px solid #444;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }

        .photo-preview img {
            width: 120px;
            height: 90px;
            object-fit: cover;
        }

        .photo-remove {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .merged-photo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .merged-photo-content {
            flex: 1;
            text-align: left;
        }

        .merged-photo-controls {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .merged-photo img {
            max-width: 100%;
            height: auto;
            border: 2px solid #4CAF50;
            border-radius: 8px;
        }

        /* 登入界面樣式 */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-container {
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
            border: 1px solid #404040;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .login-title {
            font-size: 28px;
            color: #ffffff;
            margin-bottom: 30px;
            font-weight: bold;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .login-input {
            padding: 15px;
            border: 2px solid #555555;
            border-radius: 10px;
            font-size: 16px;
            background: #333333;
            color: #ffffff;
            transition: all 0.3s ease;
        }

        .login-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }

        .login-btn {
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .login-error {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e74c3c;
            margin-top: 10px;
            display: none;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .logout-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        }

        @media (max-width: 768px) {
            .login-container {
                padding: 30px 20px;
            }
            
            .login-title {
                font-size: 24px;
            }
            
            .logout-btn {
                top: 10px;
                right: 10px;
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .container {
                margin: 5px;
                border-radius: 10px;
            }
            
            .header {
                padding: 15px 10px;
            }
            
            .header h1 {
                font-size: 20px;
                margin: 0;
            }
            
            .tab-content {
                padding: 15px 10px;
            }
            
            .tabs {
                gap: 0;
                padding: 2px;
                position: sticky;
                top: 0;
                z-index: 1001;
            }
            
            .tab {
                padding: 6px 3px;
                font-size: 10px;
                min-height: auto;
                min-width: auto;
                flex: 1;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 10px;
                margin-bottom: 15px;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            h3 {
                font-size: 18px;
                margin-bottom: 10px;
            }
            
            h4 {
                font-size: 16px;
                margin-bottom: 10px;
                padding-bottom: 5px;
            }
            
            .info-box {
                padding: 10px;
                margin-bottom: 15px;
                font-size: 14px;
            }
            
            label {
                font-size: 14px;
                margin-bottom: 5px;
            }
            
            input, textarea, select {
                font-size: 16px;
                padding: 8px;
                margin-bottom: 0;
            }
            
            textarea {
                height: 120px;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 16px;
                margin: 15px auto;
                min-width: 200px;
            }
            
            .copy-btn {
                padding: 10px 15px;
                font-size: 14px;
                margin: 10px auto;
            }
            
            .output-area {
                min-height: 200px;
                padding: 10px;
                font-size: 14px;
            }
            
            .checkbox-group {
                gap: 5px;
                margin-top: 3px;
            }
            
            .checkbox-group label {
                font-size: 13px;
                margin-bottom: 3px;
            }
            
            .status {
                padding: 8px;
                margin-top: 10px;
                font-size: 14px;
            }
            
            .section {
                margin-bottom: 20px;
            }
            
            .desktop-text {
                display: none;
            }
            
            .mobile-text {
                display: inline;
            }
            
            .photo-upload-row {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            .photo-upload-row #single-drop-zone {
                flex: 1 !important;
                min-width: auto !important;
            }
            
            .photo-upload-row #single-merge-controls {
                flex-direction: row !important;
                justify-content: center;
                gap: 10px !important;
            }
        }

        /* 外部價格表格樣式 */
        .vendor-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: #2a2a2a;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #404040;
        }

        .vendor-table th {
            background: linear-gradient(135deg, #333333 0%, #1a1a1a 100%);
            color: #ffffff;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            border-bottom: 2px solid #404040;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .vendor-table td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid #404040;
            background: #2a2a2a;
            color: #e0e0e0;
            position: relative;
        }

        .vendor-table tr:hover td {
            background: #333333;
        }

        .vendor-table td.editable {
            cursor: text;
            transition: all 0.3s ease;
        }

        .vendor-table td.editable:hover {
            background: #404040 !important;
            color: #ffffff;
        }

        .vendor-table td.editing {
            background: #667eea !important;
            color: #ffffff;
        }

        .vendor-table td input {
            width: 100%;
            background: transparent;
            border: none;
            color: #ffffff;
            text-align: center;
            padding: 5px;
            font-size: inherit;
        }

        .vendor-table td input:focus {
            outline: 2px solid #667eea;
            border-radius: 4px;
        }

        .delete-row-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .delete-row-btn:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        .vendor-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .vendor-controls button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            color: white;
        }

        .vendor-controls .add-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .vendor-controls .add-btn:hover {
            background: linear-gradient(135deg, #218838 0%, #1c7a6b 100%);
            transform: translateY(-2px);
        }

        .vendor-controls .save-btn {
            background: linear-gradient(135deg, #007bff 0%, #667eea 100%);
        }

        .vendor-controls .save-btn:hover {
            background: linear-gradient(135deg, #0056b3 0%, #5a67d8 100%);
            transform: translateY(-2px);
        }

        .vendor-controls .export-btn {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
        }

        .vendor-controls .export-btn:hover {
            background: linear-gradient(135deg, #5a359a 0%, #d91a72 100%);
            transform: translateY(-2px);
        }

        .vendor-controls .import-btn {
            background: linear-gradient(135deg, #fd7e14 0%, #ffc107 100%);
        }

        .vendor-controls .import-btn:hover {
            background: linear-gradient(135deg, #dc6502 0%, #d39e00 100%);
            transform: translateY(-2px);
        }

        .file-input {
            display: none;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid #404040;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .vendor-table {
                font-size: 12px;
            }
            
            .vendor-table th, .vendor-table td {
                padding: 8px 5px;
            }
            
            .vendor-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .vendor-controls button {
                margin-bottom: 10px;
            }
        }

        /* 競爭廠商比較樣式 */
        .vendor-comparison-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #404040;
            margin-top: 10px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            background: #2a2a2a;
        }

        .comparison-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            border-bottom: 2px solid #404040;
            font-size: 14px;
        }

        .comparison-table td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid #404040;
            background: #2a2a2a;
            color: #e0e0e0;
            font-size: 13px;
        }

        .comparison-table tr:hover td {
            background: #333333;
        }

        .comparison-table .vendor-name {
            font-weight: 600;
            color: #667eea;
        }

        .comparison-table .price-cell {
            font-weight: 600;
        }

        .no-comparison {
            text-align: center;
            color: #888;
            font-style: italic;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .comparison-table {
                font-size: 11px;
            }
            
            .comparison-table th, .comparison-table td {
                padding: 6px 4px;
            }
        }
    </style>
</head>
<body>
    <!-- 登入界面 -->
    <div id="login-overlay" class="login-overlay">
        <div class="login-container">
            <h2 class="login-title">🔒 系統登入</h2>
            <form id="login-form" class="login-form">
                <input type="text" id="username" class="login-input" placeholder="請輸入帳號" required>
                <input type="password" id="password" class="login-input" placeholder="請輸入密碼" required>
                <button type="submit" class="login-btn">登入系統</button>
                <div id="login-error" class="login-error">帳號或密碼錯誤，請再試一次</div>
            </form>
        </div>
    </div>
    
    <!-- 登出按鈕 -->
    <button id="logout-btn" class="logout-btn" onclick="logout()" style="display: none;">登出</button>
    <div class="container">
        <div class="header">
            <h1>聯能永續-報價工具</h1>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('auto-quote')"><span class="desktop-text">🚀 客戶⮕包月自動報價</span><span class="mobile-text">自動報價</span></button>
            <button class="tab" onclick="showTab('single-quote')"><span class="desktop-text">🚀 客戶⮕單趟自動報價</span><span class="mobile-text">單趟報價</span></button>
            <button class="tab" onclick="showTab('quote')"><span class="desktop-text">🚀 客戶⮕包月手動報價</span><span class="mobile-text">客戶報價</span></button>
            <button class="tab" onclick="showTab('monthly')"><span class="desktop-text">🚀 報價⮕包月任務</span><span class="mobile-text">包月任務</span></button>
            <button class="tab" onclick="showTab('single')"><span class="desktop-text">🚀 報價⮕單趟任務</span><span class="mobile-text">單趟任務</span></button>
            <button class="tab" onclick="showTab('clean')"><span class="desktop-text">🚀 報價⮕單次清潔</span><span class="mobile-text">清潔任務</span></button>
            <button class="tab" onclick="showTab('vendor-pricing')"><span class="desktop-text">💱 外部價格</span><span class="mobile-text">外部價格</span></button>
        </div>

        <!-- 客戶單⮕自動報價單 -->
        <div id="auto-quote" class="tab-content active">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">🚀 客戶⮕包月自動報價</h3>
                    <button class="clear-btn-small" onclick="clearAutoQuoteForm()" title="清空表單">×</button>
                </div>
                <div class="info-box">
                    💡 自動偵測Google試算表最新資料，依照儲存格內容生成專業標準化報價單
                </div>
                
                <div class="form-group">
                    <h4>🔗 Google試算表連結</h4>
                    <div class="form-row" style="grid-template-columns: 2fr 1fr;">
                        <div>
                            <label for="sheets-url">試算表網址：</label>
                            <input type="text" id="sheets-url" placeholder="請貼上Google試算表的共享連結" style="width: 100%;" onchange="saveUrlToHistory()">
                            <small style="color: #888; margin-top: 5px; display: block;">💡 提示：請確保試算表分享設定為「知道連結的使用者」</small>
                        </div>
                        <div>
                            <label for="saved-urls">歷史網址：</label>
                            <select id="saved-urls" onchange="loadSavedUrl()" style="width: 100%;">
                                <option value="">選擇歷史網址</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 歷史網址管理 -->
                    <div style="margin-top: 15px; text-align: center;">
                        <button id="manage-urls-btn" onclick="toggleUrlManager()" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 14px; margin-right: 10px;">管理歷史網址</button>
                        <button onclick="clearAllUrls()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 14px;">清空全部</button>
                    </div>
                    
                    <div id="url-manager" style="display: none; margin-top: 15px; padding: 15px; background: #2a2a2a; border-radius: 8px; border: 1px solid #404040;">
                        <h5 style="color: #fff; margin-bottom: 15px; text-align: center;">📝 歷史網址管理</h5>
                        <!-- 網址列表將動態生成 -->
                    </div>
                </div>
                
                <div class="form-group">
                    <h4>⚙️ 資料輸入</h4>
                    <!-- 第一行：收取星期、收取時間、樓層、月費、趟數 -->
                    <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr 1fr 1fr;">
                        <div>
                            <label for="manual-days">收取星期：</label>
                            <div style="margin-top: 8px; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px;">
                                <label style="display: flex; align-items: center; font-size: 13px; color: #e0e0e0; cursor: pointer; margin-bottom: 0; white-space: nowrap;">
                                    <input type="checkbox" name="manual-days" value="週一" style="width: 14px; height: 14px; margin-right: 4px;"> 週一
                                </label>
                                <label style="display: flex; align-items: center; font-size: 13px; color: #e0e0e0; cursor: pointer; margin-bottom: 0; white-space: nowrap;">
                                    <input type="checkbox" name="manual-days" value="週二" style="width: 14px; height: 14px; margin-right: 4px;"> 週二
                                </label>
                                <label style="display: flex; align-items: center; font-size: 13px; color: #e0e0e0; cursor: pointer; margin-bottom: 0; white-space: nowrap;">
                                    <input type="checkbox" name="manual-days" value="週三" style="width: 14px; height: 14px; margin-right: 4px;"> 週三
                                </label>
                                <label style="display: flex; align-items: center; font-size: 13px; color: #e0e0e0; cursor: pointer; margin-bottom: 0; white-space: nowrap;">
                                    <input type="checkbox" name="manual-days" value="週四" style="width: 14px; height: 14px; margin-right: 4px;"> 週四
                                </label>
                                <label style="display: flex; align-items: center; font-size: 13px; color: #e0e0e0; cursor: pointer; margin-bottom: 0; white-space: nowrap;">
                                    <input type="checkbox" name="manual-days" value="週五" style="width: 14px; height: 14px; margin-right: 4px;"> 週五
                                </label>
                                <label style="display: flex; align-items: center; font-size: 13px; color: #e0e0e0; cursor: pointer; margin-bottom: 0; white-space: nowrap;">
                                    <input type="checkbox" name="manual-days" value="週六" style="width: 14px; height: 14px; margin-right: 4px;"> 週六
                                </label>
                                <label style="display: flex; align-items: center; font-size: 13px; color: #e0e0e0; cursor: pointer; margin-bottom: 0; white-space: nowrap;">
                                    <input type="checkbox" name="manual-days" value="週日" style="width: 14px; height: 14px; margin-right: 4px;"> 週日
                                </label>
                                <div></div> <!-- 空格補位 -->
                            </div>
                        </div>
                        <div>
                            <label for="manual-time">收取時間：</label>
                            <input type="text" id="manual-time" placeholder="0" value="">
                        </div>
                        <div>
                            <label for="manual-floor">樓層：</label>
                            <input type="number" id="manual-floor" placeholder="0" min="-10" max="50" value="">
                        </div>
                        <div>
                            <label for="manual-fee">月費(元)：</label>
                            <input type="number" id="manual-fee" placeholder="0" min="0" value="">
                        </div>
                        <div>
                            <label for="manual-frequency">趟數：</label>
                            <input type="number" id="manual-frequency" placeholder="0" min="1" max="7" value="">
                        </div>
                    </div>
                    
                    <!-- 第二行：垃圾包數、垃圾袋容量、資源包數、資源袋容量 -->
                    <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                        <div>
                            <label for="manual-trash">垃圾包數：</label>
                            <input type="number" id="manual-trash" placeholder="0" min="0" value="">
                        </div>
                        <div>
                            <label for="manual-trash-volume">垃圾袋容量：</label>
                            <select id="manual-trash-volume">
                                <option value="">請選擇</option>
                                <option value="14公升">14公升</option>
                                <option value="25公升">25公升</option>
                                <option value="75公升">75公升</option>
                                <option value="76公升">76公升</option>
                            </select>
                        </div>
                        <div>
                            <label for="manual-recycle">資源包數：</label>
                            <input type="number" id="manual-recycle" placeholder="0" min="0" value="">
                        </div>
                        <div>
                            <label for="manual-recycle-volume">資源袋容量：</label>
                            <select id="manual-recycle-volume">
                                <option value="">請選擇</option>
                                <option value="14公升">14公升</option>
                                <option value="25公升">25公升</option>
                                <option value="75公升">75公升</option>
                                <option value="76公升">76公升</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 第三行：最多垃圾袋數、最多資源袋數、特殊需求 -->
                    <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
                        <div>
                            <label for="manual-trash-max">最多垃圾袋數：</label>
                            <input type="number" id="manual-trash-max" placeholder="0" min="0" value="">
                        </div>
                        <div>
                            <label for="manual-recycle-max">最多資源袋數：</label>
                            <input type="number" id="manual-recycle-max" placeholder="0" min="0" value="">
                        </div>
                        <div>
                            <label for="manual-special-notes">特殊需求：</label>
                            <input type="text" id="manual-special-notes" placeholder="特殊需求" value="">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <h4>📊 資料偵測設定</h4>
                    <div class="form-row">
                        <div>
                            <label for="update-mode">更新模式：</label>
                            <select id="update-mode" onchange="toggleCustomRowInput()">
                                <option value="latest">最新一列</option>
                                <option value="all">所有資料</option>
                                <option value="last-5">最後5列</option>
                                <option value="last-10">最後10列</option>
                                <option value="last-20">最後20列</option>
                            </select>
                        </div>
                        <div>
                            <label for="sheet-name">工作表名稱：</label>
                            <input type="text" id="sheet-name" placeholder="例：報價資料" value="工作表1">
                        </div>
                        <div>
                            <label for="data-columns">資料欄位：</label>
                            <select id="data-columns">
                                <option value="auto">自動偵測</option>
                                <option value="A-H">A到H欄</option>
                                <option value="A-J">A到J欄</option>
                                <option value="A-L">A到L欄</option>
                            </select>
                        </div>
                    </div>
                    

                </div>
                
                <div style="display: flex; justify-content: center; margin: 25px 0;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; width: 100%; max-width: 600px;">
                        <div></div>
                        <button onclick="fetchGoogleSheetsData()" style="background: white; color: #333; border: 2px solid #ddd; width: 50px; height: 50px; font-size: 18px; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; font-weight: bold; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" title="讀取資料">
                            ⇄
                        </button>
                        <div></div>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: center; margin: 15px 0;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; width: 100%; max-width: 600px;">
                        <div></div>
                        <button onclick="clearAutoQuoteForm()" style="background: #6c757d; color: white; border: none; width: 30px; height: 30px; font-size: 14px; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; font-weight: 600; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(108, 117, 125, 0.3);" title="清空表單" onmouseover="this.style.background='#5a6268'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(108, 117, 125, 0.4)'" onmouseout="this.style.background='#6c757d'; this.style.transform='translateY(0px)'; this.style.boxShadow='0 2px 5px rgba(108, 117, 125, 0.3)'">
                            ×
                        </button>
                        <div></div>
                    </div>
                </div>
                
                <div id="auto-sheets-status" class="status" style="display: none;"></div>
                
                <div class="form-group" id="auto-detected-data" style="display: none;">
                    <h4>📋 偵測資料</h4>
                    <div id="detected-data-preview" class="output-area" style="background: #2a2a2a; border: 1px solid #404040; border-radius: 8px; max-height: 300px; overflow-y: auto;"></div>
                </div>
                
                <div class="form-group" id="auto-quote-controls" style="display: none;">
                    <h4>⚡ 自動生成</h4>
                    <div style="display: flex; justify-content: center; margin: 20px 0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; width: 100%; max-width: 600px;">
                            <div></div>
                            <button class="btn quote" onclick="generateAutoQuote()">∞</button>
                            <div></div>
                        </div>
                    </div>
                </div>
                
                <!-- 競爭廠商比較區塊 -->
                <div class="output-section" id="vendor-comparison" style="display: none; margin-bottom: 20px;">
                    <h4>📊 競爭廠商比較</h4>
                    <div id="vendor-comparison-table" class="vendor-comparison-container"></div>
                </div>

                <div class="output-section" id="auto-quote-output" style="display: none;">
                    <h4>📄 自動生成的報價單</h4>
                    <div class="output-area" id="auto-quote-result-display"></div>
                    <button class="copy-btn" onclick="copyAutoQuote()">⧉</button>
                    <div class="status" id="auto-quote-copy-status"></div>
                </div>
                
                <div id="auto-quote-final-status" class="status" style="display: none;"></div>
            </div>
        </div>

        <!-- 客戶單⮕報價單 -->
        <div id="quote" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">🚀 客戶⮕包月手動報價</h3>
                    <button class="clear-btn-small" onclick="clearQuoteForm()" title="清空表單">×</button>
                </div>
                <div class="info-box">
                    💡 將客戶資料轉換為專業標準化報價單格式
                </div>
                
                <div class="form-group">
                    <h4>⚙️ 資料輸入</h4>
                    
                    <!-- 第一行：收取基本設定 -->
                    <div class="form-row">
                        <div>
                            <label for="service-days">收取星期：</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px;">
                                <label style="display: flex; align-items: center; font-size: 14px; color: #e0e0e0; cursor: pointer; margin-bottom: 0;"><input type="checkbox" name="service-days" value="週一" style="width: 16px; height: 16px; margin-right: 8px;"> 週一</label>
                                <label style="display: flex; align-items: center; font-size: 14px; color: #e0e0e0; cursor: pointer; margin-bottom: 0;"><input type="checkbox" name="service-days" value="週二" checked style="width: 16px; height: 16px; margin-right: 8px;"> 週二</label>
                                <label style="display: flex; align-items: center; font-size: 14px; color: #e0e0e0; cursor: pointer; margin-bottom: 0;"><input type="checkbox" name="service-days" value="週三" style="width: 16px; height: 16px; margin-right: 8px;"> 週三</label>
                                <label style="display: flex; align-items: center; font-size: 14px; color: #e0e0e0; cursor: pointer; margin-bottom: 0;"><input type="checkbox" name="service-days" value="週四" style="width: 16px; height: 16px; margin-right: 8px;"> 週四</label>
                                <label style="display: flex; align-items: center; font-size: 14px; color: #e0e0e0; cursor: pointer; margin-bottom: 0;"><input type="checkbox" name="service-days" value="週五" checked style="width: 16px; height: 16px; margin-right: 8px;"> 週五</label>
                                <label style="display: flex; align-items: center; font-size: 14px; color: #e0e0e0; cursor: pointer; margin-bottom: 0;"><input type="checkbox" name="service-days" value="週六" style="width: 16px; height: 16px; margin-right: 8px;"> 週六</label>
                                <label style="display: flex; align-items: center; font-size: 14px; color: #e0e0e0; cursor: pointer; margin-bottom: 0;"><input type="checkbox" name="service-days" value="週日" style="width: 16px; height: 16px; margin-right: 8px;"> 週日</label>
                            </div>
                        </div>
                        <div>
                            <label for="service-time">收取時間：</label>
                            <input type="text" id="service-time" placeholder="0">
                        </div>
                        <div>
                            <label for="floor-level">樓層：</label>
                            <input type="number" id="floor-level" min="-10" max="50" placeholder="0">
                        </div>
                        <div>
                            <label for="monthly-fee">月費(元)：</label>
                            <input type="number" id="monthly-fee" min="0" step="50" placeholder="0">
                        </div>
                    </div>
                    
                    <!-- 第二行：垃圾和資源設定 -->
                    <div class="form-row">
                        <div>
                            <label for="trash-bags">垃圾包數：</label>
                            <input type="number" id="trash-bags" min="0" placeholder="0">
                        </div>
                        <div>
                            <label for="trash-volume">垃圾袋容量：</label>
                            <select id="trash-volume">
                                <option value="0公升">0公升</option>
                                <option value="14公升" selected>14公升</option>
                                <option value="25公升">25公升</option>
                                <option value="75公升">75公升</option>
                                <option value="76公升">76公升</option>
                            </select>
                        </div>
                        <div>
                            <label for="recycle-bags">資源包數：</label>
                            <input type="number" id="recycle-bags" min="0" placeholder="0">
                        </div>
                        <div>
                            <label for="recycle-volume">資源袋容量：</label>
                            <select id="recycle-volume">
                                <option value="0公升">0公升</option>
                                <option value="14公升" selected>14公升</option>
                                <option value="25公升">25公升</option>
                                <option value="75公升">75公升</option>
                                <option value="76公升">76公升</option>
                            </select>
                        </div>
                    </div>

                    <!-- 第三行：限制和特殊需求 -->
                    <div class="form-row">
                        <div>
                            <label for="trash-max">最多垃圾袋數：</label>
                            <input type="number" id="trash-max" min="0" placeholder="0">
                        </div>
                        <div>
                            <label for="recycle-max">最多資源袋數：</label>
                            <input type="number" id="recycle-max" min="0" placeholder="0">
                        </div>
                        <div>
                            <label for="special-notes">特殊需求：</label>
                            <input type="text" id="special-notes" placeholder="特殊需求">
                        </div>
                        <div></div> <!-- 空欄位保持對齊 -->
                    </div>
                    
                    <button class="btn quote" onclick="generateQuote()">∞</button>
                </div>
                
                <div class="output-section" id="quote-output" style="display: none;">
                    <h4>📋 生成的報價單</h4>
                    <div class="output-area" id="quote-result"></div>
                    <button class="copy-btn" onclick="copyToClipboard('quote-result')">⧉</button>
                    <div class="status" id="quote-status"></div>
                </div>
            </div>
        </div>

        <!-- 客戶單⮕單趟報價單 -->
        <div id="single-quote" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">🚀 客戶⮕單趟自動報價</h3>
                    <button class="clear-btn-small" onclick="clearSingleQuoteForm()" title="清空表單">×</button>
                </div>
                <div class="info-box">
                    💡 能偵測試算表中的地址資料，生成單趟垃圾代收報價單
                </div>
                
                <div class="form-group">
                    <h4>🔗 Google試算表連結</h4>
                    <div class="form-row" style="grid-template-columns: 2fr 1fr;">
                        <div>
                            <label for="single-quote-sheets-url">試算表網址：</label>
                            <input type="text" id="single-quote-sheets-url" placeholder="請貼上Google試算表的共享連結" style="width: 100%;" onchange="saveSingleQuoteUrlToHistory()">
                            <small style="color: #888; margin-top: 5px; display: block;">💡 提示：請確保試算表分享設定為「知道連結的使用者」</small>
                        </div>
                        <div>
                            <label for="single-quote-saved-urls">歷史網址：</label>
                            <select id="single-quote-saved-urls" onchange="loadSingleQuoteSavedUrl()" style="width: 100%;">
                                <option value="">選擇歷史網址</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 歷史網址管理 -->
                    <div style="margin-top: 15px; text-align: center;">
                        <button id="single-quote-manage-urls-btn" onclick="toggleSingleQuoteUrlManager()" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 14px; margin-right: 10px;">管理歷史網址</button>
                        <button onclick="clearAllSingleQuoteUrls()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 14px;">清空全部</button>
                    </div>
                    
                    <div id="single-quote-url-manager" style="display: none; margin-top: 15px; padding: 15px; background: #2a2a2a; border-radius: 8px; border: 1px solid #404040;">
                        <h5 style="color: #fff; margin-bottom: 15px; text-align: center;">📝 歷史網址管理</h5>
                        <!-- 網址列表將動態生成 -->
                    </div>
                </div>

                <div class="form-group">
                    <h4>⚙️ 單趟垃圾代收設定</h4>
                    
                    <!-- 第一行：日期、時間、有無上樓、一樓費用、上樓費用 -->
                    <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr 1fr 1fr;">
                        <div>
                            <label for="single-quote-date">🔥執行日期：</label>
                            <input type="date" id="single-quote-date">
                        </div>
                        <div>
                            <label for="single-quote-time">🔥執行時間：</label>
                            <input type="text" id="single-quote-time" placeholder="例如：1200-1600前完成" value="">
                        </div>
                        <div>
                            <label for="single-quote-upstairs-option">🪜有無上樓：</label>
                            <select id="single-quote-upstairs-option">
                                <option value="有/無/自選">有/無/自選</option>
                                <option value="有">有</option>
                                <option value="無">無</option>
                                <option value="自選">自選</option>
                            </select>
                        </div>
                        <div>
                            <label for="single-quote-ground-fee-type">💰放置一樓代收費用：</label>
                            <select id="single-quote-ground-fee-type" onchange="toggleGroundFeeInput()">
                                <option value="none">無</option>
                                <option value="manual">手動填寫</option>
                            </select>
                        </div>
                        <div>
                            <label for="single-quote-upstairs-fee-type">💰上樓費用代收費用：</label>
                            <select id="single-quote-upstairs-fee-type" onchange="toggleUpstairsFeeInput()">
                                <option value="none">無</option>
                                <option value="manual">手動填寫</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 第二行：費用金額輸入 -->
                    <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr 1fr 1fr;">
                        <div></div> <!-- 空欄位 -->
                        <div></div> <!-- 空欄位 -->
                        <div></div> <!-- 空欄位 -->
                        <div id="single-quote-ground-fee-input" style="display: none;">
                            <label for="single-quote-ground-fee">金額：</label>
                            <input type="number" id="single-quote-ground-fee" min="0" step="50" placeholder="300" value="">
                        </div>
                        <div id="single-quote-upstairs-fee-input" style="display: none;">
                            <label for="single-quote-upstairs-fee">金額：</label>
                            <input type="number" id="single-quote-upstairs-fee" min="0" step="50" placeholder="500" value="">
                        </div>
                    </div>
                    
                    <!-- 第三行：垃圾照片描述 1-5 -->
                    <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr 1fr 1fr;">
                        <div>
                            <label for="single-quote-photo1-type">🗑️圖1描述：</label>
                            <select id="single-quote-photo1-type" onchange="togglePhotoInput(1)">
                                <option value="none">無</option>
                                <option value="manual">手動填寫</option>
                            </select>
                        </div>
                        <div>
                            <label for="single-quote-photo2-type">🗑️圖2描述：</label>
                            <select id="single-quote-photo2-type" onchange="togglePhotoInput(2)">
                                <option value="none">無</option>
                                <option value="manual">手動填寫</option>
                            </select>
                        </div>
                        <div>
                            <label for="single-quote-photo3-type">🗑️圖3描述：</label>
                            <select id="single-quote-photo3-type" onchange="togglePhotoInput(3)">
                                <option value="none">無</option>
                                <option value="manual">手動填寫</option>
                            </select>
                        </div>
                        <div>
                            <label for="single-quote-photo4-type">🗑️圖4描述：</label>
                            <select id="single-quote-photo4-type" onchange="togglePhotoInput(4)">
                                <option value="none">無</option>
                                <option value="manual">手動填寫</option>
                            </select>
                        </div>
                        <div>
                            <label for="single-quote-photo5-type">🗑️圖5描述：</label>
                            <select id="single-quote-photo5-type" onchange="togglePhotoInput(5)">
                                <option value="none">無</option>
                                <option value="manual">手動填寫</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 第四行：照片描述輸入框 1-5 -->
                    <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr 1fr 1fr;">
                        <div id="single-quote-photo1-input" style="display: none;">
                            <input type="text" id="single-quote-photo1" placeholder="例如：客廳垃圾袋" value="">
                        </div>
                        <div id="single-quote-photo2-input" style="display: none;">
                            <input type="text" id="single-quote-photo2" placeholder="例如：廚房垃圾" value="">
                        </div>
                        <div id="single-quote-photo3-input" style="display: none;">
                            <input type="text" id="single-quote-photo3" placeholder="例如：資源回收" value="">
                        </div>
                        <div id="single-quote-photo4-input" style="display: none;">
                            <input type="text" id="single-quote-photo4" placeholder="例如：其他垃圾" value="">
                        </div>
                        <div id="single-quote-photo5-input" style="display: none;">
                            <input type="text" id="single-quote-photo5" placeholder="例如：大型垃圾" value="">
                        </div>
                    </div>
                    
                    <!-- 第五行：垃圾照片描述 6-10 -->
                    <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr 1fr 1fr;">
                        <div>
                            <label for="single-quote-photo6-type">🗑️圖6描述：</label>
                            <select id="single-quote-photo6-type" onchange="togglePhotoInput(6)">
                                <option value="none">無</option>
                                <option value="manual">手動填寫</option>
                            </select>
                        </div>
                        <div>
                            <label for="single-quote-photo7-type">🗑️圖7描述：</label>
                            <select id="single-quote-photo7-type" onchange="togglePhotoInput(7)">
                                <option value="none">無</option>
                                <option value="manual">手動填寫</option>
                            </select>
                        </div>
                        <div>
                            <label for="single-quote-photo8-type">🗑️圖8描述：</label>
                            <select id="single-quote-photo8-type" onchange="togglePhotoInput(8)">
                                <option value="none">無</option>
                                <option value="manual">手動填寫</option>
                            </select>
                        </div>
                        <div>
                            <label for="single-quote-photo9-type">🗑️圖9描述：</label>
                            <select id="single-quote-photo9-type" onchange="togglePhotoInput(9)">
                                <option value="none">無</option>
                                <option value="manual">手動填寫</option>
                            </select>
                        </div>
                        <div>
                            <label for="single-quote-photo10-type">🗑️圖10描述：</label>
                            <select id="single-quote-photo10-type" onchange="togglePhotoInput(10)">
                                <option value="none">無</option>
                                <option value="manual">手動填寫</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 第六行：照片描述輸入框 6-10 -->
                    <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr 1fr 1fr;">
                        <div id="single-quote-photo6-input" style="display: none;">
                            <input type="text" id="single-quote-photo6" placeholder="例如：陽台垃圾" value="">
                        </div>
                        <div id="single-quote-photo7-input" style="display: none;">
                            <input type="text" id="single-quote-photo7" placeholder="例如：房間垃圾" value="">
                        </div>
                        <div id="single-quote-photo8-input" style="display: none;">
                            <input type="text" id="single-quote-photo8" placeholder="例如：浴室垃圾" value="">
                        </div>
                        <div id="single-quote-photo9-input" style="display: none;">
                            <input type="text" id="single-quote-photo9" placeholder="例如：書房垃圾" value="">
                        </div>
                        <div id="single-quote-photo10-input" style="display: none;">
                            <input type="text" id="single-quote-photo10" placeholder="例如：其他區域" value="">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <h4>📊 資料偵測設定</h4>
                    <div class="form-row">
                        <div>
                            <label for="single-quote-update-mode">更新模式：</label>
                            <select id="single-quote-update-mode">
                                <option value="latest">最新一列</option>
                                <option value="all">所有資料</option>
                                <option value="last-5">最後5列</option>
                                <option value="last-10">最後10列</option>
                                <option value="last-20">最後20列</option>
                            </select>
                        </div>
                        <div>
                            <label for="single-quote-sheet-name">工作表名稱：</label>
                            <input type="text" id="single-quote-sheet-name" placeholder="例：報價資料" value="工作表1">
                        </div>
                        <div>
                            <label for="single-quote-data-columns">資料欄位：</label>
                            <select id="single-quote-data-columns">
                                <option value="auto">自動偵測</option>
                                <option value="A-H">A到H欄</option>
                                <option value="A-J">A到J欄</option>
                                <option value="A-L">A到L欄</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: center; margin: 25px 0;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; width: 100%; max-width: 600px;">
                        <button onclick="fetchSingleQuoteGoogleSheetsData()" style="background: white; color: #333; border: 2px solid #ddd; width: 50px; height: 50px; font-size: 18px; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; font-weight: bold; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" title="讀取試算表資料">
                            ⇄
                        </button>
                        <button class="btn quote" onclick="generateSingleQuote()">∞</button>
                        <button onclick="clearSingleQuoteForm()" style="background: #6c757d; color: white; border: none; width: 50px; height: 50px; font-size: 14px; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; font-weight: 600; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(108, 117, 125, 0.3);" title="清空表單" onmouseover="this.style.background='#5a6268'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(108, 117, 125, 0.4)'" onmouseout="this.style.background='#6c757d'; this.style.transform='translateY(0px)'; this.style.boxShadow='0 2px 5px rgba(108, 117, 125, 0.3)'">
                            ×
                        </button>
                    </div>
                </div>
                
                <div id="single-quote-sheets-status" class="status" style="display: none;"></div>
                
                <div class="form-group" id="single-quote-detected-data" style="display: none;">
                    <h4>📋 偵測資料</h4>
                    <div id="single-quote-detected-data-preview" class="output-area" style="background: #2a2a2a; border: 1px solid #404040; border-radius: 8px; max-height: 300px; overflow-y: auto;"></div>
                </div>
                
                <div class="form-group" id="single-quote-controls" style="display: none;">
                    <h4>⚡ 自動生成</h4>
                    <div style="display: flex; justify-content: center; margin: 20px 0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; width: 100%; max-width: 600px;">
                            <div></div>
                            <button class="btn quote" onclick="generateSingleQuote()">∞</button>
                            <div></div>
                        </div>
                    </div>
                </div>
                
                <div class="output-section" id="single-quote-output" style="display: none;">
                    <h4>📄 單趟垃圾代收報價單</h4>
                    <div class="output-area" id="single-quote-result-display"></div>
                    <button class="copy-btn" onclick="copySingleQuote()">⧉</button>
                    <div class="status" id="single-quote-copy-status"></div>
                </div>
                
                <div id="single-quote-final-status" class="status" style="display: none;"></div>
            </div>
        </div>

        <!-- 報價單⮕包月任務單 -->
        <div id="monthly" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">🚀 報價⮕包月任務</h3>
                    <button class="clear-btn-small" onclick="clearMonthlyForm()" title="清空表單">×</button>
                </div>
                <div class="info-box">
                    💡 將報價資料轉換為包月任務執行單格式
                </div>
                
                <div class="form-group">
                    <h4>⚙️ 資料輸入</h4>
                    
                    <!-- 第一行設定參數 -->
                    <div class="form-row">
                        <div>
                            <label for="monthly-date">日期：</label>
                            <input type="date" id="monthly-date">
                        </div>
                        <div>
                            <label for="monthly-calculation-mode">計費方式：</label>
                            <select id="monthly-calculation-mode" onchange="toggleMonthlyPriceInput()">
                                <option value="percentage" selected>百分比抽成</option>
                                <option value="fixed">固定價格</option>
                            </select>
                        </div>
                        <div id="monthly-percentage-div">
                            <label for="monthly-percentage">百分比：</label>
                            <input type="text" id="monthly-percentage" value="50" placeholder="執行人抽成%數">
                        </div>
                        <div id="monthly-fixed-price-div" style="display: none;">
                            <label for="monthly-fixed-price">固定價格：</label>
                            <input type="number" id="monthly-fixed-price" min="0" step="50" placeholder="例如：300">
                        </div>
                        <div>
                            <label for="monthly-upstairs" style="color: #888;">上樓：</label>
                            <select id="monthly-upstairs" style="color: #888;">
                                <option value="" selected>請選擇</option>
                                <option value="需上樓">需上樓</option>
                                <option value="不用上樓">不用上樓</option>
                            </select>
                        </div>
                        <div>
                            <label for="monthly-address" style="color: #888;">地址：</label>
                            <input type="text" id="monthly-address" placeholder="請輸入完整地址" value="" style="color: #888;">
                        </div>
                        <div>
                            <label for="monthly-phone" style="color: #888;">電話：</label>
                            <input type="text" id="monthly-phone" placeholder="請輸入聯絡電話" value="" style="color: #888;">
                        </div>
                        <div>
                            <label for="monthly-name" style="color: #888;">姓名：</label>
                            <input type="text" id="monthly-name" placeholder="請輸入客戶姓名" value="" style="color: #888;">
                        </div>
                        <div>
                            <label for="monthly-key" style="color: #888;">鑰匙：</label>
                            <select id="monthly-key" style="color: #888;">
                                <option value="" selected>請選擇</option>
                                <option value="無">無</option>
                                <option value="有">有</option>
                            </select>
                        </div>
                        <div>
                            <label for="monthly-time" style="color: #888;">時間：</label>
                            <input type="text" id="monthly-time" placeholder="例如：0800後" value="" style="color: #888;">
                        </div>
                    </div>
                    
                    <!-- 第二行設定參數 -->
                    <div class="form-row">
                        <div>
                            <label for="monthly-trash-pickup" style="color: #888;">垃圾：</label>
                            <input type="number" id="monthly-trash-pickup" min="1" max="100" value="" placeholder="垃圾一次收取包數" style="color: #888;">
                        </div>
                        <div>
                            <label for="monthly-recycle-pickup" style="color: #888;">資源：</label>
                            <input type="number" id="monthly-recycle-pickup" min="1" max="100" value="" placeholder="資源一次收取包數" style="color: #888;">
                        </div>
                        <div>
                            <label for="monthly-bag" style="color: #888;">專用袋：</label>
                            <select id="monthly-bag" style="color: #888;">
                                <option value="" selected>請選擇</option>
                                <option value="有">有</option>
                                <option value="無">無</option>
                            </select>
                        </div>
                        <div></div> <!-- 空欄位保持對齊 -->
                    </div>
                    
                    <h4>📝 輸入資料</h4>
                    <label for="monthly-quote-data">貼上報價資料：</label>
                    <textarea id="monthly-quote-data" placeholder="請在此貼上完整的報價資料..." style="height: 200px;"></textarea>
                    
                    <button class="btn monthly" onclick="generateMonthlyTask()">∞</button>
                </div>
                
                <div class="output-section" id="monthly-output" style="display: none;">
                    <h4>📋 包月任務單</h4>
                    <div class="copy-buttons">
                        <div>
                            <h5>一般版任務單</h5>
                            <div class="output-area" id="monthly-general"></div>
                            <button class="copy-btn" onclick="copyToClipboard('monthly-general')">⧉</button>
                        </div>
                        <div>
                            <h5>限制版任務單</h5>
                            <div class="output-area" id="monthly-limited"></div>
                            <button class="copy-btn" onclick="copyToClipboard('monthly-limited')">⧉</button>
                        </div>
                    </div>
                    <div class="status" id="monthly-status"></div>
                </div>
            </div>
        </div>

        <!-- 報價單⮕單趟任務單 -->
        <div id="single" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">🚀 報價⮕單趟任務</h3>
                    <button class="clear-btn-small" onclick="clearSingleForm()" title="清空表單">×</button>
                </div>
                <div class="info-box">
                    💡 將報價資料轉換為單次服務的任務執行單
                </div>
                
                <div class="form-group">
                    <h4>⚙️ 資料輸入</h4>
                    
                    <!-- 第一行參數 -->
                    <div class="form-row">
                        <div>
                            <label for="single-date">日期：</label>
                            <input type="date" id="single-date">
                        </div>
                        <div>
                            <label for="single-time">時間：</label>
                            <input type="text" id="single-time" placeholder="例：14:30">
                        </div>
                        <div>
                            <label for="single-phone">電話：</label>
                            <input type="text" id="single-phone" placeholder="例：0912345678">
                        </div>
                        <div>
                            <label for="single-name">姓氏：</label>
                            <input type="text" id="single-name" placeholder="例：陳">
                        </div>
                    </div>
                    
                    <!-- 第二行參數 -->
                    <div class="form-row">
                        <div>
                            <label for="single-address">地址：</label>
                            <input type="text" id="single-address" placeholder="例：台北市中山區民生東路">
                        </div>
                        <div>
                            <label for="single-floor">樓層：</label>
                            <input type="text" id="single-floor" placeholder="例：3F 或 地下1樓">
                        </div>
                        <div>
                            <label for="single-customer-bag">客戶使用專用袋：</label>
                            <select id="single-customer-bag">
                                <option value="無" selected>無</option>
                                <option value="有">有</option>
                                <option value="部分有">部分有</option>
                            </select>
                        </div>
                        <div>
                            <label for="single-waste-type">垃圾資源量：</label>
                            <select id="single-waste-type">
                                <option value="如圖" selected>如圖</option>
                                <option value="手動填寫">手動填寫</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 第三行參數 -->
                    <div class="form-row">
                        <div>
                            <label for="single-fee">費用：</label>
                            <input type="text" id="single-fee" placeholder="例：500">
                        </div>
                        <div>
                            <label for="single-other1">其他說明1：</label>
                            <input type="text" id="single-other1" placeholder="例：回報路段">
                        </div>
                        <div>
                            <label for="single-other2">其他說明2：</label>
                            <input type="text" id="single-other2" placeholder="例：額外備註">
                        </div>
                        <div>
                            <label for="single-other3">其他說明3：</label>
                            <input type="text" id="single-other3" placeholder="例：特殊要求">
                        </div>
                    </div>
                    
                    <h4>📷 現況照片上傳</h4>
                    
                    <!-- 照片功能一行式布局 -->
                    <div class="photo-upload-row" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: stretch; margin-bottom: 15px; min-height: 110px;">
                        <!-- 拖曳上傳區域 -->
                        <div id="single-drop-zone" class="drop-zone-inline" style="flex: 0 0 280px; border: 2px dashed #666; border-radius: 8px; padding: 15px; text-align: center; background: #2a2a2a; transition: all 0.3s ease; position: relative; height: 110px; display: flex; align-items: center; justify-content: center;">
                            <div class="drop-zone-content">
                                <div style="font-size: 1.5em; margin-bottom: 5px;">📁</div>
                                <div style="color: #ccc; font-size: 14px;">拖曳照片或點擊選擇</div>
                                <input type="file" id="single-images" multiple accept="image/png,image/jpg,image/jpeg" style="opacity: 0; position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer;">
                            </div>
                        </div>
                        
                        <!-- 控制按鈕區域 -->
                        <div id="single-merge-controls" style="display: none; flex: 0 0 auto; height: 110px; flex-direction: column; justify-content: center; gap: 8px;">
                            <button type="button" class="btn-merge" onclick="mergeSingleImages()">≫</button>
                            <button type="button" class="btn-clear" onclick="clearSingleImages()">×</button>
                        </div>
                        
                        <!-- 照片預覽區域 -->
                        <div id="single-image-preview" style="flex: 1; min-width: 180px; min-height: 110px; display: flex; flex-direction: column; justify-content: flex-start;"></div>
                    </div>
                    
                    <!-- 合併照片顯示區域 - 移到下方 -->
                    <div id="single-merged-preview" style="width: 100%; margin-bottom: 15px; display: flex; justify-content: center;"></div>
                    
                    <button class="btn single" onclick="generateSingleTask()">∞</button>
                </div>
                
                <div class="output-section" id="single-output" style="display: none;">
                    <h4>📋 單趟任務單</h4>
                    <div class="output-area" id="single-result"></div>
                    <button class="copy-btn" onclick="copyToClipboard('single-result')">⧉</button>
                    <div class="status" id="single-status"></div>
                </div>
            </div>
        </div>

        <!-- 報價單⮕單次清潔任務單 -->
        <div id="clean" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">🚀 報價⮕單次清潔</h3>
                    <button class="clear-btn-small" onclick="clearCleanForm()" title="清空表單">×</button>
                </div>
                <div class="info-box">
                    💡 將報價資料轉換為單次清潔服務的任務執行單
                </div>
                
                <div class="form-group">
                    <h4>⚙️ 資料輸入</h4>
                    
                    <!-- 第一行參數 -->
                    <div class="form-row">
                        <div>
                            <label for="clean-date">日期：</label>
                            <input type="date" id="clean-date">
                        </div>
                        <div>
                            <label for="clean-time">時間：</label>
                            <input type="text" id="clean-time" placeholder="例：14:30">
                        </div>
                        <div>
                            <label for="clean-phone">電話：</label>
                            <input type="text" id="clean-phone" placeholder="例：0912345678">
                        </div>
                        <div>
                            <label for="clean-name">姓氏：</label>
                            <input type="text" id="clean-name" placeholder="例：陳">
                        </div>
                        <div>
                            <label for="clean-address">地址：</label>
                            <input type="text" id="clean-address" placeholder="例：台北市中山區民生東路">
                        </div>
                        <div>
                            <label for="clean-floor">樓層：</label>
                            <input type="text" id="clean-floor" placeholder="例：3F 或 地下1樓">
                        </div>
                        <div>
                            <label for="clean-waste-type">現況照片：</label>
                            <select id="clean-waste-type">
                                <option value="如圖" selected>如圖</option>
                                <option value="手動填寫">手動填寫</option>
                            </select>
                        </div>
                        <div>
                            <label for="clean-fee">費用：</label>
                            <input type="text" id="clean-fee" placeholder="例：800">
                        </div>
                    </div>
                    
                    <!-- 第二行參數 -->
                    <div class="form-row">
                        <div>
                            <label for="clean-other1">其他說明1：</label>
                            <input type="text" id="clean-other1" placeholder="例：特殊清潔需求">
                        </div>
                        <div>
                            <label for="clean-other2">其他說明2：</label>
                            <input type="text" id="clean-other2" placeholder="例：額外備註">
                        </div>
                        <div>
                            <label for="clean-other3">其他說明3：</label>
                            <input type="text" id="clean-other3" placeholder="例：注意事項">
                        </div>
                    </div>
                    
                    <h4>🧹 清潔範圍</h4>
                    <div class="form-row">
                        <div>
                            <label for="clean-scope-1">1.</label>
                            <input type="text" id="clean-scope-1" placeholder="清潔項目 1">
                        </div>
                        <div>
                            <label for="clean-scope-2">2.</label>
                            <input type="text" id="clean-scope-2" placeholder="清潔項目 2">
                        </div>
                        <div>
                            <label for="clean-scope-3">3.</label>
                            <input type="text" id="clean-scope-3" placeholder="清潔項目 3">
                        </div>
                        <div>
                            <label for="clean-scope-4">4.</label>
                            <input type="text" id="clean-scope-4" placeholder="清潔項目 4">
                        </div>
                        <div>
                            <label for="clean-scope-5">5.</label>
                            <input type="text" id="clean-scope-5" placeholder="清潔項目 5">
                        </div>
                        <div>
                            <label for="clean-scope-6">6.</label>
                            <input type="text" id="clean-scope-6" placeholder="清潔項目 6">
                        </div>
                    </div>
                    <div class="form-row">
                        <div>
                            <label for="clean-scope-7">7.</label>
                            <input type="text" id="clean-scope-7" placeholder="清潔項目 7">
                        </div>
                        <div>
                            <label for="clean-scope-8">8.</label>
                            <input type="text" id="clean-scope-8" placeholder="清潔項目 8">
                        </div>
                        <div>
                            <label for="clean-scope-9">9.</label>
                            <input type="text" id="clean-scope-9" placeholder="清潔項目 9">
                        </div>
                        <div>
                            <label for="clean-scope-10">10.</label>
                            <input type="text" id="clean-scope-10" placeholder="清潔項目 10">
                        </div>
                        <div></div> <!-- 空欄位保持對齊 -->
                        <div></div> <!-- 空欄位保持對齊 -->
                    </div>
                    
                    <h4>📷 現況照片上傳</h4>
                    
                    <!-- 照片功能一行式布局 -->
                    <div class="photo-upload-row" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: stretch; margin-bottom: 15px; min-height: 110px;">
                        <!-- 拖曳上傳區域 -->
                        <div id="clean-drop-zone" class="drop-zone-inline" style="flex: 0 0 280px; border: 2px dashed #666; border-radius: 8px; padding: 15px; text-align: center; background: #2a2a2a; transition: all 0.3s ease; position: relative; height: 110px; display: flex; align-items: center; justify-content: center;">
                            <div class="drop-zone-content">
                                <div style="font-size: 1.5em; margin-bottom: 5px;">📁</div>
                                <div style="color: #ccc; font-size: 14px;">拖曳照片或點擊選擇</div>
                                <input type="file" id="clean-images" multiple accept="image/png,image/jpg,image/jpeg" style="opacity: 0; position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer;">
                            </div>
                        </div>
                        
                        <!-- 控制按鈕區域 -->
                        <div id="clean-merge-controls" style="display: none; flex: 0 0 auto; height: 110px; flex-direction: column; justify-content: center; gap: 8px;">
                            <button type="button" class="btn-merge" onclick="mergeCleanImages()">≫</button>
                            <button type="button" class="btn-clear" onclick="clearCleanImages()">×</button>
                        </div>
                        
                        <!-- 照片預覽區域 -->
                        <div id="clean-image-preview" style="flex: 1; min-width: 180px; min-height: 110px; display: flex; flex-direction: column; justify-content: flex-start;"></div>
                    </div>
                    
                    <!-- 合併照片顯示區域 - 移到下方 -->
                    <div id="clean-merged-preview" style="width: 100%; margin-bottom: 15px; display: flex; justify-content: center;"></div>
                    
                    <button class="btn clean" onclick="generateCleanTask()">∞</button>
                </div>
                
                <div class="output-section" id="clean-output" style="display: none;">
                    <h4>📋 清潔任務單</h4>
                    <div class="output-area" id="clean-result"></div>
                    <button class="copy-btn" onclick="copyToClipboard('clean-result')">⧉</button>
                    <div class="status" id="clean-status"></div>
                </div>
            </div>
        </div>

        <!-- 外部價格頁面 -->
        <div id="vendor-pricing" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">💱 外部價格管理</h3>
                </div>
                <div class="info-box">
                    💡 管理外部廠商的價格資訊，支援直接編輯、新增刪除、資料儲存與匯出功能
                </div>
                
                <!-- 控制按鈕 -->
                <div class="vendor-controls">
                    <button class="add-btn" onclick="addVendorRow()">➕ 新增廠商</button>
                    <button class="save-btn" onclick="saveVendorData()">💾 儲存資料</button>
                    <button class="export-btn" onclick="exportVendorData()">📤 匯出Excel</button>
                    <button class="import-btn" onclick="document.getElementById('import-file').click()">📥 匯入Excel</button>
                    <input type="file" id="import-file" class="file-input" accept=".xlsx,.xls" onchange="importVendorData(event)">
                </div>
                
                <!-- 資料表格 -->
                <div class="table-container">
                    <table class="vendor-table" id="vendor-table">
                        <thead>
                            <tr>
                                <th>廠商名稱</th>
                                <th>方案名稱</th>
                                <th>週次數</th>
                                <th>他行週總量</th>
                                <th>我方換算-14</th>
                                <th>我方換算-25</th>
                                <th>原價</th>
                                <th>1月優</th>
                                <th>3月優</th>
                                <th>6月優</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="vendor-table-body">
                            <!-- 資料將通過JavaScript動態生成 -->
                        </tbody>
                    </table>
                </div>
                
                <div class="status" id="vendor-status" style="margin-top: 20px;"></div>
            </div>
        </div>

    <script>
        // Tab switching functionality
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // 當切換到外部價格管理頁面時，自動載入並顯示資料
            if (tabName === 'vendor-pricing') {
                setTimeout(() => {
                    loadVendorData();
                }, 100); // 短暫延遲確保DOM已更新
            }
        }

        // 切換包月任務計費方式
        function toggleMonthlyPriceInput() {
            const calculationMode = document.getElementById('monthly-calculation-mode').value;
            const percentageDiv = document.getElementById('monthly-percentage-div');
            const fixedPriceDiv = document.getElementById('monthly-fixed-price-div');
            
            if (calculationMode === 'fixed') {
                percentageDiv.style.display = 'none';
                fixedPriceDiv.style.display = 'block';
            } else {
                percentageDiv.style.display = 'block';
                fixedPriceDiv.style.display = 'none';
            }
        }

        // Quote generation function
        function generateQuote() {
            // 獲取所有表單數據
            const serviceDaysCheckboxes = document.querySelectorAll('input[name="service-days"]:checked');
            const serviceDays = Array.from(serviceDaysCheckboxes).map(checkbox => checkbox.value);
            const serviceTime = document.getElementById('service-time').value;
            const floorLevel = parseInt(document.getElementById('floor-level').value);
            const trashBags = document.getElementById('trash-bags').value;
            const trashVolume = document.getElementById('trash-volume').value;
            const recycleBags = document.getElementById('recycle-bags').value;
            const recycleVolume = document.getElementById('recycle-volume').value;
            const trashMax = document.getElementById('trash-max').value;
            const recycleMax = document.getElementById('recycle-max').value;
            const monthlyFee = document.getElementById('monthly-fee').value;
            const specialNotes = document.getElementById('special-notes').value;
            
            // 格式化服務日期
            const daysText = serviceDays.length > 0 ? serviceDays.join('、') : '待確定';
            
            // 格式化時間
            let formattedTime = serviceTime;
            if (serviceTime) {
                const timeMatch = serviceTime.match(/(\d{4})/);
                if (timeMatch) {
                    const timeStr = timeMatch[1];
                    const hour = parseInt(timeStr.substring(0, 2));
                    const minute = timeStr.substring(2);
                    if (hour < 12) {
                        formattedTime = `上午 ${hour.toString().padStart(2, '0')}：${minute}`;
                    } else if (hour < 18) {
                        formattedTime = `下午 ${hour.toString().padStart(2, '0')}：${minute}`;
                    } else {
                        formattedTime = `晚間 ${hour.toString().padStart(2, '0')}：${minute}`;
                    }
                }
            }
            
            // 計算週趟數和格式化日期
            const weeklyTrips = serviceDays.length || 2;
            const dayMapping = {"週一": "週1", "週二": "週2", "週三": "週3", "週四": "週4", "週五": "週5", "週六": "週6", "週日": "週7"};
            const formattedDays = serviceDays.map(day => dayMapping[day] || day).join('+');
            const tripsAndDays = serviceDays.length > 0 ? `${weeklyTrips}趟-${formattedDays}` : `${weeklyTrips}趟`;
            
            // 格式化樓層
            const floorNumber = floorLevel < 0 ? `地下${Math.abs(floorLevel)}樓` : `${floorLevel}F`;
            
            // 收取時間描述
            let collectionTimeDesc = '';
            if (formattedTime.includes('上午')) {
                collectionTimeDesc = '中午前';
            } else if (formattedTime.includes('下午')) {
                collectionTimeDesc = '下午結束前';
            } else if (formattedTime.includes('晚間')) {
                collectionTimeDesc = '半夜前';
            } else {
                collectionTimeDesc = '中午/下午/半夜/';
            }
            
            // 鑰匙提示
            const keyNote = floorLevel > 1 ? '（上樓代收需提供1樓大門鑰匙）' : 
                           floorLevel < 0 ? '（地下室代收需提供地下室鑰匙）' : '';
            
            const quote = `⛔報價資料⛔

一週趟數：${tripsAndDays}
   置放時間：${formattedTime || '（準時置放）'}
   置放樓層：${floorNumber}

（⚠️垃圾當日:${collectionTimeDesc} 代收完畢）
（⚠️過程中嚴禁催促）
（⚠️請準時置放以免多有糾紛）

 1週垃圾：${trashBags}包數（${trashVolume}）
（1次最多收取${trashMax}袋--超量拒收）
（垃圾請綁緊、勿外露）
（垃圾袋外部勿流湯汁）
（一次性紙/塑膠容器均垃圾）


 1週資源:${recycleBags}包數（${recycleVolume}）-用一般塑膠袋
（1次最多收取${recycleMax}袋--超量拒收）
（若未裝袋一律拒收）
（請勿用黑色袋子裝資源）
（僅收寶特玻璃鐵鋁罐）
（僅收中小紙板箱壓扁折好）
（僅收書本/乾淨紙張）

⚠️下列物品視為垃圾
（便當盒/塑膠袋/吸管➡️垃圾）
（軟塑膠蓋/吸管➡️垃圾）
（早餐盒/快飲杯➡️垃圾）
（泡棉/雞蛋軟塑膠盒➡️垃圾）
（蛋糕盒/緩衝材料➡️垃圾）

一個月費用：${monthlyFee}元
（上樓代收需提供1樓大門鑰匙）
${keyNote}

-
📑配合事項📑
▪垃圾務必打包綁好放置門口
▪如因政策變動需改時間
⬇️將提前告知煩請配合
▪自備雙北市政府專用垃圾袋
▪收款後不退款內容不更改
▪有超量一律拒收

    ⇩

🚨 其他問題 🚨
📄請先完整閱讀報價內容提出
💬客服解決任何問題

    ⇩

⭕解決問題⭕
✔️.上述問題均解決
✔️.上述內容能配合
回覆告知我們：同意✅+開始日

    ⇩

收到_同意✅_後
💧客服➡️提供繳費單
💧客戶➡️完成繳費
💧客服➡️開始代收

⚠️ 注意事項 ⚠️
🔴1分錢1分服務低價無安全保障
🟠近期多起案例請務必留意
🟡年輕專業團隊-流程皆有 SOP
🟢成員平均 30-35 歲皆具良民證
🔵過年及天災人禍停止代收無退款
➡️延至下一次可代收工作日



🌍解決垃圾並不只是收走
⚡我們改變的是城市的運轉速度

${specialNotes ? `特殊需求：${specialNotes}` : ''}`;

            document.getElementById('quote-result').textContent = quote;
            document.getElementById('quote-output').style.display = 'block';
            showStatus('quote-status', '✅ 報價單生成完成！', 'success');
        }

        // Monthly task generation function
        function generateMonthlyTask() {
            const quoteData = document.getElementById('monthly-quote-data').value;
            const date = document.getElementById('monthly-date').value;
            
            // 獲取所有手動輸入欄位
            const calculationMode = document.getElementById('monthly-calculation-mode').value;
            const percentage = document.getElementById('monthly-percentage').value.replace('%', '') || '50';
            const fixedPrice = document.getElementById('monthly-fixed-price').value;
            const upstairs = document.getElementById('monthly-upstairs').value;
            const address = document.getElementById('monthly-address').value;
            const phone = document.getElementById('monthly-phone').value;
            const name = document.getElementById('monthly-name').value;
            const trashPickup = document.getElementById('monthly-trash-pickup').value;
            const recyclePickup = document.getElementById('monthly-recycle-pickup').value;
            const key = document.getElementById('monthly-key').value;
            const manualTime = document.getElementById('monthly-time').value;
            const bag = document.getElementById('monthly-bag').value;
            
            if (!quoteData || !date) {
                showStatus('monthly-status', '請填寫報價資料和執行日期', 'error');
                return;
            }
            
            // 解析報價資料
            let extractedAddress = address, extractedName = name, extractedPhone = phone;
            let fee = 0, weekDays = '未填', time = '上午';
            let trashAmount = '未填', recycleAmount = '未填';
            
            // 如果手動欄位為空，則從報價資料中提取
            if (!address || !name || !phone) {
                const lines = quoteData.split('\n');
                for (const line of lines) {
                    if (line.includes('地址') && !extractedAddress) {
                        extractedAddress = line.split(/[：:]/)[1]?.trim() || '';
                    }
                    if (line.includes('姓名') && !extractedName) {
                        extractedName = line.split(/[：:]/)[1]?.trim() || '';
                    }
                    if (line.includes('電話') && !extractedPhone) {
                        extractedPhone = line.split(/[：:]/)[1]?.trim() || '';
                    }
                }
            }
            
            // 提取費用並應用計算模式
            if (calculationMode === 'fixed' && fixedPrice) {
                fee = parseInt(fixedPrice);
            } else {
                const feeMatch = quoteData.match(/一個月費用：(\d+)/);
                if (feeMatch) {
                    const originalFee = parseInt(feeMatch[1]);
                    fee = Math.floor(originalFee * (parseInt(percentage) / 100));
                }
            }
            
            // 提取週趟數和日期
            const weekMatch = quoteData.match(/一週趟數：.*?(\d+趟)-(週.*?)\n/);
            weekDays = weekMatch ? weekMatch[2] : '未填';
            
            // 將週1+週4格式轉換為星期格式
            function convertWeekdayFormat(weekStr) {
                if (!weekStr || weekStr === '未填') return '未填';
                
                const weekMap = {
                    '週1': '週一', '週2': '週二', '週3': '週三', 
                    '週4': '週四', '週5': '週五', '週6': '週六', '週日': '週日'
                };
                
                // 處理週1+週4這種格式
                return weekStr.replace(/週(\d)/g, (match, num) => {
                    return weekMap[match] || match;
                });
            }
            
            weekDays = convertWeekdayFormat(weekDays);
            
            // 時間格式化函數
            function formatTimeToChinnese(timeStr) {
                timeStr = timeStr.replace(/[：:後]/g, '').trim();
                if (timeStr.length === 4 && !isNaN(timeStr)) {
                    const hour = parseInt(timeStr.substring(0, 2));
                    const minute = timeStr.substring(2);
                    let period;
                    if (hour < 12) {
                        period = '上午';
                    } else if (hour < 18) {
                        period = '下午';
                    } else {
                        period = '晚間';
                    }
                    return `${period} ${hour.toString().padStart(2, '0')}：${minute} 後`;
                }
                if (timeStr.includes('上午') || timeStr.includes('下午') || timeStr.includes('晚間')) {
                    return timeStr + (timeStr.endsWith('後') ? '' : ' 後');
                }
                return timeStr + (timeStr && !timeStr.endsWith('後') ? '後' : '');
            }
            
            // 使用手動時間或從文字中提取
            if (manualTime.trim()) {
                time = formatTimeToChinnese(manualTime);
            } else {
                const timeMatch = quoteData.match(/置放時間：(\d{2}：\d{2})/);
                if (timeMatch) {
                    const timeStr = timeMatch[1].replace('：', '');
                    time = formatTimeToChinnese(timeStr);
                } else {
                    time = '上午';
                }
            }
            
            // 提取垃圾量 - 增強版偵測
            let trashMatchFound = false;
            const trashPatterns = [
                /1週垃圾：(\d+)包數.*?\((\d+公升)\)/,
                /垃圾.*?(\d+)包.*?(\d+公升)/,
                /1週垃圾.*?(\d+).*?(\d+公升)/,
                /週垃圾：(\d+)包數.*?\((\d+公升)\)/,
                /垃圾包數：(\d+).*?(\d+公升)/
            ];
            
            for (const pattern of trashPatterns) {
                const match = quoteData.match(pattern);
                if (match) {
                    const volume = match[2].replace('公升', '');
                    trashAmount = `${match[1]}包（${volume}公升）`;
                    trashMatchFound = true;
                    break;
                }
            }
            
            // 提取資源量 - 增強版偵測
            let recycleMatchFound = false;
            const recyclePatterns = [
                /1週資源:(\d+)包數.*?\((\d+公升)\)/,
                /1週資源：(\d+)包數.*?\((\d+公升)\)/,
                /資源.*?(\d+)包.*?(\d+公升)/,
                /1週資源.*?(\d+).*?(\d+公升)/,
                /週資源：(\d+)包數.*?\((\d+公升)\)/,
                /資源包數：(\d+).*?(\d+公升)/
            ];
            
            for (const pattern of recyclePatterns) {
                const match = quoteData.match(pattern);
                if (match) {
                    const volume = match[2].replace('公升', '');
                    recycleAmount = `${match[1]}包（${volume}公升）`;
                    recycleMatchFound = true;
                    break;
                }
            }
            
            // 如果沒有找到完整的包數和容量，嘗試只找包數
            if (!trashMatchFound) {
                const trashSimplePatterns = [
                    /垃圾.*?(\d+)包/,
                    /1週垃圾.*?(\d+)/,
                    /垃圾包數：(\d+)/
                ];
                for (const pattern of trashSimplePatterns) {
                    const match = quoteData.match(pattern);
                    if (match) {
                        trashAmount = `${match[1]}包`;
                        break;
                    }
                }
            }
            
            if (!recycleMatchFound) {
                const recycleSimplePatterns = [
                    /資源.*?(\d+)包/,
                    /1週資源.*?(\d+)/,
                    /資源包數：(\d+)/
                ];
                for (const pattern of recycleSimplePatterns) {
                    const match = quoteData.match(pattern);
                    if (match) {
                        recycleAmount = `${match[1]}包`;
                        break;
                    }
                }
            }
            
            const dateObj = new Date(date);
            const weekDaysArray = ['日', '一', '二', '三', '四', '五', '六'];
            const weekDay = weekDaysArray[dateObj.getDay()];
            const formattedDate = `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
            const dateWithWeekday = `${formattedDate} 週${weekDay}`;
            
            const generalTask = `🧑‍🚀包月任務🧑‍🚀

➡️日期：${dateWithWeekday}
➡️星期：${weekDays}
➡️時間：${time}
➡️地址：${extractedAddress}
➡️上樓：${upstairs === '需上樓' ? '是' : '否'}
➡️鑰匙：${key}
➡️費用：${fee}
➡️客戶自備專用袋：${bag}
➡️1週垃圾量：${trashAmount}
（1-${trashPickup}）
➡️1週資源量：${recycleAmount}
（1-${recyclePickup}）
➡️姓名：${extractedName}
➡️電話：${extractedPhone}
➡️其他：
1.若有鑰匙索取請回報
2.7天內複製歸還原鑰
3.另有規定時間者除外
4.鑰匙通常粘置信箱

📛已新增日曆📛
📛務必請過目📛
📛有問題提出📛`;

            const limitedTask = `🧑‍🚀包月任務🧑‍🚀

➡️日期：${dateWithWeekday}
➡️星期：${weekDays}
➡️時間：${time}
➡️地址：${extractedAddress}
➡️上樓：${upstairs === '需上樓' ? '是' : '否'}
➡️鑰匙：${key}
➡️費用：${fee}
➡️客戶自備專用袋：${bag}
➡️1週垃圾量：${trashAmount}
（1-${trashPickup}）
➡️1週資源量：${recycleAmount}
（1-${recyclePickup}）
➡️姓名：${extractedName}
➡️電話：${extractedPhone}
➡️基本服務：
1.超量一律收走
2.現場清空
3.正確回報

➡️其他：
1.若有鑰匙索取請回報
2.7天內複製歸還原鑰
3.另有規定時間者除外
4.鑰匙通常粘置信箱

📛已新增日曆📛
📛務必請過目📛
📛有問題提出📛`;

            document.getElementById('monthly-general').textContent = generalTask;
            document.getElementById('monthly-limited').textContent = limitedTask;
            document.getElementById('monthly-output').style.display = 'block';
            showStatus('monthly-status', '✅ 包月任務單轉換完成！', 'success');
        }



        // Single task generation function
        function generateSingleTask() {
            const date = document.getElementById('single-date').value;
            const time = document.getElementById('single-time').value;
            const phone = document.getElementById('single-phone').value;
            const name = document.getElementById('single-name').value;
            const address = document.getElementById('single-address').value;
            const floor = document.getElementById('single-floor').value;
            const wasteType = document.getElementById('single-waste-type').value;

            const fee = document.getElementById('single-fee').value;
            const customerBag = document.getElementById('single-customer-bag').value;
            const otherNotes1 = document.getElementById('single-other1').value;
            const otherNotes2 = document.getElementById('single-other2').value;
            const otherNotes3 = document.getElementById('single-other3').value;
            
            if (!date) {
                showStatus('single-status', '請填寫執行日期', 'error');
                return;
            }
            
            const dateObj = new Date(date);
            const weekDays = ['日', '一', '二', '三', '四', '五', '六'];
            const weekDay = weekDays[dateObj.getDay()];
            const formattedDate = `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
            const dateWithWeekday = `${formattedDate} 週${weekDay}`;
            
            // 格式化時間 - 支援時間區間
            let formattedTime = time || '上午';
            if (time) {
                // 檢查是否為時間區間格式 (如 1500-1630)
                const timeRangeMatch = time.match(/(\d{4})-(\d{4})/);
                if (timeRangeMatch) {
                    const startTime = timeRangeMatch[1];
                    const endTime = timeRangeMatch[2];
                    
                    // 格式化開始時間
                    const startHour = parseInt(startTime.substring(0, 2));
                    const startMinute = startTime.substring(2);
                    let startPeriod = startHour < 12 ? '上午' : (startHour < 18 ? '下午' : '晚間');
                    
                    // 格式化結束時間
                    const endHour = parseInt(endTime.substring(0, 2));
                    const endMinute = endTime.substring(2);
                    
                    formattedTime = `${startPeriod} ${startHour.toString().padStart(2, '0')}：${startMinute}-${endHour.toString().padStart(2, '0')}：${endMinute}`;
                } else if (time.match(/^\d{4}$/)) {
                    // 處理四位數時間格式 (如 1300)
                    const hour = parseInt(time.substring(0, 2));
                    const minute = time.substring(2);
                    let period = hour < 12 ? '上午' : (hour < 18 ? '下午' : '晚間');
                    formattedTime = `${period} ${hour.toString().padStart(2, '0')}：${minute}`;
                } else if (time.includes(':')) {
                    // 原有的單一時間格式處理
                    const [hour, minute] = time.split(':');
                    const hourInt = parseInt(hour);
                    if (hourInt < 12) {
                        formattedTime = `上午 ${hour}：${minute}`;
                    } else if (hourInt < 18) {
                        formattedTime = `下午 ${hour}：${minute}`;
                    } else {
                        formattedTime = `晚間 ${hour}：${minute}`;
                    }
                } else {
                    // 其他格式直接顯示
                    formattedTime = time;
                }
            }
            
            // 決定垃圾資源量文字
            const wasteAmount = '如圖';
            
            // 構建其他說明內容
            let otherDetails = '';
            let itemNumber = 4;
            if (otherNotes1) {
                otherDetails += `${itemNumber}.${otherNotes1}\n`;
                itemNumber++;
            }
            if (otherNotes2) {
                otherDetails += `${itemNumber}.${otherNotes2}\n`;
                itemNumber++;
            }
            if (otherNotes3) {
                otherDetails += `${itemNumber}.${otherNotes3}`;
            }

            const singleTask = `🧑‍🚀單趟任務🧑‍🚀

➡️日期：${dateWithWeekday}
➡️時間：${formattedTime}
➡️電話：${phone}
➡️姓名：${name}
➡️地址：${address}
➡️樓層：${floor}
➡️客戶自備專用袋：${customerBag}
➡️費用：${fee}
➡️垃圾資源量：${wasteAmount}
➡️現況照片：
➡️其他：
1.回報：
（1）單趟：XX+路段/街
2.少量超量一律清走
3.照片拍完善
${otherDetails}

🔥已新增日曆🔥
🔥務必請過目🔥
🔥有問題提出🔥`;

            document.getElementById('single-result').textContent = singleTask;
            document.getElementById('single-output').style.display = 'block';
            showStatus('single-status', '✅ 單趟任務單轉換完成！', 'success');
        }



        // Clean task generation function
        function generateCleanTask() {
            const date = document.getElementById('clean-date').value;
            const time = document.getElementById('clean-time').value;
            const phone = document.getElementById('clean-phone').value;
            const name = document.getElementById('clean-name').value;
            const address = document.getElementById('clean-address').value;
            const floor = document.getElementById('clean-floor').value;
            const wasteType = document.getElementById('clean-waste-type').value;
            const fee = document.getElementById('clean-fee').value;
            const otherNotes1 = document.getElementById('clean-other1').value;
            const otherNotes2 = document.getElementById('clean-other2').value;
            const otherNotes3 = document.getElementById('clean-other3').value;
            
            if (!date) {
                showStatus('clean-status', '請填寫清潔日期', 'error');
                return;
            }
            
            // 收集清潔範圍
            const cleaningScope = [];
            for (let i = 1; i <= 10; i++) {
                const scopeItem = document.getElementById(`clean-scope-${i}`).value.trim();
                if (scopeItem) {
                    cleaningScope.push(`${i}.${scopeItem}`);
                }
            }
            
            const dateObj = new Date(date);
            const weekDays = ['日', '一', '二', '三', '四', '五', '六'];
            const weekDay = weekDays[dateObj.getDay()];
            const formattedDate = `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
            const dateWithWeekday = `${formattedDate} 週${weekDay}`;
            
            // 格式化時間
            let formattedTime = time || '上午';
            if (time && time.includes(':')) {
                const [hour, minute] = time.split(':');
                const hourInt = parseInt(hour);
                if (hourInt < 12) {
                    formattedTime = `上午 ${hour}：${minute}`;
                } else if (hourInt < 18) {
                    formattedTime = `下午 ${hour}：${minute}`;
                } else {
                    formattedTime = `晚間 ${hour}：${minute}`;
                }
            }
            
            // 生成清潔範圍文字
            const scopeText = cleaningScope.length > 0 ? cleaningScope.join('\n') : '待現場確認';
            
            // 構建其他說明內容
            let otherDetails = '';
            let itemNumber = 5;
            if (otherNotes1) {
                otherDetails += `${itemNumber}.${otherNotes1}\n`;
                itemNumber++;
            }
            if (otherNotes2) {
                otherDetails += `${itemNumber}.${otherNotes2}\n`;
                itemNumber++;
            }
            if (otherNotes3) {
                otherDetails += `${itemNumber}.${otherNotes3}`;
            }
            
            const cleanTask = `🧑‍🚀清潔任務🧑‍🚀

➡️日期：${dateWithWeekday}
➡️電話：${phone}
➡️姓名：${name}
➡️地址：${address}
➡️上樓：${floor.includes('F') && !floor.includes('1F') ? '有' : '無'}
➡️費用：${fee}
➡️清潔範圍：
${scopeText}
➡️現況照片：如圖
➡️其他：
1.回報：
（1）單趟：XX+路段/街
2.現場清潔後及少量垃圾
   一律帶走清空
3.照片拍完善
4.清潔照片僅拍完成後照片即可
${otherDetails}

🔥已新增日曆🔥
🔥務必請過目🔥
🔥有問題提出🔥`;

            document.getElementById('clean-result').textContent = cleanTask;
            document.getElementById('clean-output').style.display = 'block';
            showStatus('clean-status', '✅ 清潔任務單轉換完成！', 'success');
        }

        // Copy to clipboard function
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(function() {
                    const statusId = elementId.includes('quote') ? 'quote-status' : 
                                   elementId.includes('monthly') ? 'monthly-status' :
                                   elementId.includes('single') ? 'single-status' : 'clean-status';
                    showStatus(statusId, '✅ 內容已成功複製到剪貼簿！', 'success');
                }, function(err) {
                    showStatus(statusId, '❌ 複製失敗，請手動選取文字複製', 'error');
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    const statusId = elementId.includes('quote') ? 'quote-status' : 
                                   elementId.includes('monthly') ? 'monthly-status' :
                                   elementId.includes('single') ? 'single-status' : 'clean-status';
                    showStatus(statusId, '✅ 內容已成功複製到剪貼簿！', 'success');
                } catch (err) {
                    showStatus(statusId, '❌ 複製失敗，請手動選取文字複製', 'error');
                }
                document.body.removeChild(textArea);
            }
        }

        // Show status message
        function showStatus(elementId, message, type) {
            const statusElement = document.getElementById(elementId);
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            
            setTimeout(() => {
                statusElement.textContent = '';
                statusElement.className = 'status';
            }, 4000);
        }

        // Clear form functions
        function clearQuoteForm() {
            // Reset form fields to default values
            document.getElementById('service-time').value = '0800';
            document.getElementById('floor-level').value = '1';
            document.getElementById('monthly-fee').value = '1200';
            document.getElementById('trash-bags').value = '6';
            document.getElementById('trash-volume').value = '14公升';
            document.getElementById('recycle-bags').value = '3';
            document.getElementById('recycle-volume').value = '14公升';
            document.getElementById('trash-max').value = '3';
            document.getElementById('recycle-max').value = '3';
            document.getElementById('special-notes').value = '';
            
            // Clear and reset checkboxes to default (週二 and 週五)
            const checkboxes = document.querySelectorAll('input[name="service-days"]');
            checkboxes.forEach(cb => cb.checked = false);
            document.querySelector('input[name="service-days"][value="週二"]').checked = true;
            document.querySelector('input[name="service-days"][value="週五"]').checked = true;
            
            // Hide output
            document.getElementById('quote-output').style.display = 'none';
            document.getElementById('quote-status').textContent = '';
            
            // Show confirmation message
            showStatus('quote-status', '✅ 表單已清空重置！', 'success');
        }

        function clearMonthlyForm() {
            document.getElementById('monthly-quote-data').value = '';
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('monthly-date').value = today;
            document.getElementById('monthly-percentage').value = '50';
            document.getElementById('monthly-upstairs').value = '不需上樓';
            document.getElementById('monthly-address').value = '';
            document.getElementById('monthly-phone').value = '';
            document.getElementById('monthly-name').value = '';
            document.getElementById('monthly-trash-pickup').value = '3';
            document.getElementById('monthly-recycle-pickup').value = '3';
            document.getElementById('monthly-key').value = '無';
            document.getElementById('monthly-time').value = '';
            document.getElementById('monthly-bag').value = '有';
            
            // Hide output
            document.getElementById('monthly-output').style.display = 'none';
            document.getElementById('monthly-status').textContent = '';
        }

        function clearSingleForm() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('single-date').value = today;
            document.getElementById('single-time').value = '';
            document.getElementById('single-phone').value = '';
            document.getElementById('single-name').value = '';
            document.getElementById('single-address').value = '';
            document.getElementById('single-floor').value = '';
            document.getElementById('single-customer-bag').value = '無';
            document.getElementById('single-waste-type').value = '如圖';
            document.getElementById('single-fee').value = '';
            document.getElementById('single-other1').value = '';
            document.getElementById('single-other2').value = '';
            document.getElementById('single-other3').value = '';
            
            // Clear images using the new clear function
            clearSingleImages();
            
            // Hide output
            document.getElementById('single-output').style.display = 'none';
            document.getElementById('single-status').textContent = '';
            
            // Show confirmation message
            showStatus('single-status', '✅ 表單已清空重置！', 'success');
        }

        function clearCleanForm() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('clean-date').value = today;
            document.getElementById('clean-time').value = '';
            document.getElementById('clean-phone').value = '';
            document.getElementById('clean-name').value = '';
            document.getElementById('clean-address').value = '';
            document.getElementById('clean-floor').value = '';
            document.getElementById('clean-waste-type').value = '如圖';
            document.getElementById('clean-fee').value = '';
            document.getElementById('clean-other1').value = '';
            document.getElementById('clean-other2').value = '';
            document.getElementById('clean-other3').value = '';
            
            // Clear cleaning scope inputs
            for (let i = 1; i <= 10; i++) {
                document.getElementById(`clean-scope-${i}`).value = '';
            }
            
            // Clear images using the new clear function
            clearCleanImages();
            
            // Hide output
            document.getElementById('clean-output').style.display = 'none';
            document.getElementById('clean-status').textContent = '';
        }

        // Set today's date as default for date inputs
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('monthly-date').value = today;
            document.getElementById('single-date').value = today;
            document.getElementById('clean-date').value = today;
            
            // Initialize drag and drop for single trip and clean photos
            initializeSingleImageUpload();
            initializeCleanImageUpload();
        });

        // Single trip image upload functions
        let singleImages = [];

        function initializeSingleImageUpload() {
            const dropZone = document.getElementById('single-drop-zone');
            const fileInput = document.getElementById('single-images');

            if (!dropZone || !fileInput) return;

            // Drag and drop events
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', (e) => {
                // Only remove dragover if we're actually leaving the drop zone
                if (!dropZone.contains(e.relatedTarget)) {
                    dropZone.classList.remove('dragover');
                }
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleSingleImageFiles(files);
            });

            // File input change event
            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                handleSingleImageFiles(files);
            });
        }

        function handleSingleImageFiles(files) {
            // Filter for image files only
            const imageFiles = files.filter(file => file.type.startsWith('image/'));
            
            if (imageFiles.length === 0) {
                showStatus('single-status', '❌ 請選擇有效的圖片檔案 (PNG, JPG, JPEG)', 'error');
                return;
            }

            // Add new images to collection
            imageFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageData = {
                        file: file,
                        dataUrl: e.target.result,
                        id: Date.now() + Math.random()
                    };
                    singleImages.push(imageData);
                    updateSingleImagePreview();
                };
                reader.readAsDataURL(file);
            });

            showStatus('single-status', `✅ 已添加 ${imageFiles.length} 張照片`, 'success');
        }

        function updateSingleImagePreview() {
            const previewContainer = document.getElementById('single-image-preview');
            const mergeControls = document.getElementById('single-merge-controls');
            
            if (singleImages.length === 0) {
                previewContainer.innerHTML = '';
                mergeControls.style.display = 'none';
                return;
            }

            // Show merge controls
            mergeControls.style.display = 'flex';
            
            // Create compact preview HTML for inline layout
            let previewHTML = '<div style="margin-bottom: 8px; font-size: 14px; color: #ccc;"><strong>已上傳 (' + singleImages.length + '張)</strong></div>';
            previewHTML += '<div style="display: flex; flex-wrap: wrap; gap: 5px;">';
            
            // Show only first 6 images in preview, indicate more if needed
            const displayCount = Math.min(6, singleImages.length);
            
            for (let i = 0; i < displayCount; i++) {
                const image = singleImages[i];
                previewHTML += `
                    <div class="photo-preview-inline" style="position: relative; display: inline-block;">
                        <img src="${image.dataUrl}" alt="Photo ${i + 1}" style="width: 60px; height: 45px; object-fit: cover; border-radius: 3px; border: 1px solid #444;">
                        <button class="photo-remove-inline" onclick="removeSingleImage(${image.id})" title="刪除照片" style="position: absolute; top: -5px; right: -5px; background: rgba(231, 76, 60, 0.9); color: white; border: none; border-radius: 50%; width: 16px; height: 16px; cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center;">×</button>
                    </div>
                `;
            }
            
            if (singleImages.length > 6) {
                previewHTML += `<div style="color: #888; font-size: 12px; align-self: center;">+${singleImages.length - 6}張</div>`;
            }
            
            previewHTML += '</div>';
            previewContainer.innerHTML = previewHTML;
        }

        function removeSingleImage(imageId) {
            singleImages = singleImages.filter(img => img.id !== imageId);
            updateSingleImagePreview();
            
            if (singleImages.length === 0) {
                document.getElementById('single-merged-preview').innerHTML = '';
                showStatus('single-status', '✅ 所有照片已清除', 'success');
            }
        }

        function clearSingleImages() {
            singleImages = [];
            document.getElementById('single-images').value = '';
            document.getElementById('single-image-preview').innerHTML = '';
            document.getElementById('single-merged-preview').innerHTML = '';
            document.getElementById('single-merge-controls').style.display = 'none';
            showStatus('single-status', '✅ 所有照片已清除', 'success');
        }

        function mergeSingleImages() {
            if (singleImages.length === 0) {
                showStatus('single-status', '❌ 請先上傳照片', 'error');
                return;
            }

            showStatus('single-status', '🔄 正在合併照片...', 'success');

            // Create canvas for merging
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Load all images and merge
            Promise.all(singleImages.map(imageData => {
                return new Promise(resolve => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.src = imageData.dataUrl;
                });
            })).then(images => {
                // Smart grid layout based on image count
                let imagesPerRow, rows;
                if (images.length === 1) {
                    imagesPerRow = 1;
                    rows = 1;
                } else if (images.length === 2) {
                    imagesPerRow = 2;
                    rows = 1;
                } else if (images.length === 3) {
                    imagesPerRow = 3;
                    rows = 1;
                } else if (images.length === 4) {
                    imagesPerRow = 2;
                    rows = 2;
                } else if (images.length <= 6) {
                    imagesPerRow = 3;
                    rows = 2;
                } else if (images.length <= 9) {
                    imagesPerRow = 3;
                    rows = 3;
                } else {
                    imagesPerRow = 4;
                    rows = Math.ceil(images.length / 4);
                }
                
                const imageSize = Math.floor(600 / Math.max(imagesPerRow, rows));
                const totalWidth = imagesPerRow * imageSize;
                const totalHeight = rows * imageSize;
                
                // Optimize canvas size to reduce white space
                const actualWidth = Math.max(totalWidth, totalHeight);
                const actualHeight = Math.max(totalWidth, totalHeight);
                canvas.width = actualWidth;
                canvas.height = actualHeight;
                const finalMarginX = (actualWidth - totalWidth) / 2;
                const finalMarginY = (actualHeight - totalHeight) / 2;
                
                
                // Draw images in smart grid
                images.forEach((img, index) => {
                    const col = index % imagesPerRow;
                    const row = Math.floor(index / imagesPerRow);
                    const x = finalMarginX + col * imageSize;
                    const y = finalMarginY + row * imageSize;
                    
                    // Draw image as square (crop to fit)
                    const aspectRatio = img.width / img.height;
                    let sourceX = 0, sourceY = 0, sourceSize;
                    
                    if (aspectRatio > 1) {
                        // 寬圖片，裁切左右
                        sourceSize = img.height;
                        sourceX = (img.width - sourceSize) / 2;
                    } else {
                        // 高圖片，裁切上下
                        sourceSize = img.width;
                        sourceY = (img.height - sourceSize) / 2;
                    }
                    
                    ctx.drawImage(img, sourceX, sourceY, sourceSize, sourceSize, x, y, imageSize, imageSize);
                    
                    // Draw red grid lines
                    ctx.strokeStyle = '#FF0000';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y, imageSize, imageSize);
                });
                
                
                // Display merged image
                const mergedDataUrl = canvas.toDataURL('image/jpeg', 0.9);
                const mergedPreview = document.getElementById('single-merged-preview');
                mergedPreview.innerHTML = `
                    <div class="merged-photo">
                        <div class="merged-photo-content">
                            <div><strong>合併照片：</strong></div>
                            <img src="${mergedDataUrl}" alt="合併照片">
                        </div>
                        <div class="merged-photo-controls">
                            <button class="btn-download" onclick="downloadMergedImage('${mergedDataUrl}', 'single')">↓</button>
                        </div>
                    </div>
                `;
                
                showStatus('single-status', `✅ 已成功合併 ${images.length} 張照片！`, 'success');
            });
        }

        function downloadMergedImage(dataUrl, type) {
            const link = document.createElement('a');
            link.download = `合併照片_${type}_${new Date().toISOString().slice(0,10)}.jpg`;
            link.href = dataUrl;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Clean task image upload functions
        let cleanImages = [];

        function initializeCleanImageUpload() {
            const dropZone = document.getElementById('clean-drop-zone');
            const fileInput = document.getElementById('clean-images');

            if (!dropZone || !fileInput) return;

            // Drag and drop events
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', (e) => {
                if (!dropZone.contains(e.relatedTarget)) {
                    dropZone.classList.remove('dragover');
                }
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleCleanImageFiles(files);
            });

            // File input change event
            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                handleCleanImageFiles(files);
            });
        }

        function handleCleanImageFiles(files) {
            const imageFiles = files.filter(file => file.type.startsWith('image/'));
            
            if (imageFiles.length === 0) {
                showStatus('clean-status', '❌ 請選擇有效的圖片檔案 (PNG, JPG, JPEG)', 'error');
                return;
            }

            imageFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageData = {
                        file: file,
                        dataUrl: e.target.result,
                        id: Date.now() + Math.random()
                    };
                    cleanImages.push(imageData);
                    updateCleanImagePreview();
                };
                reader.readAsDataURL(file);
            });

            showStatus('clean-status', `✅ 已添加 ${imageFiles.length} 張照片`, 'success');
        }

        function updateCleanImagePreview() {
            const previewContainer = document.getElementById('clean-image-preview');
            const mergeControls = document.getElementById('clean-merge-controls');
            
            if (cleanImages.length === 0) {
                previewContainer.innerHTML = '';
                mergeControls.style.display = 'none';
                return;
            }

            // Show merge controls
            mergeControls.style.display = 'flex';
            
            // Create compact preview HTML for inline layout
            let previewHTML = '<div style="margin-bottom: 8px; font-size: 14px; color: #ccc;"><strong>已上傳 (' + cleanImages.length + '張)</strong></div>';
            previewHTML += '<div style="display: flex; flex-wrap: wrap; gap: 5px;">';
            
            const displayCount = Math.min(6, cleanImages.length);
            
            for (let i = 0; i < displayCount; i++) {
                const image = cleanImages[i];
                previewHTML += `
                    <div class="photo-preview-inline" style="position: relative; display: inline-block;">
                        <img src="${image.dataUrl}" alt="Photo ${i + 1}" style="width: 60px; height: 45px; object-fit: cover; border-radius: 3px; border: 1px solid #444;">
                        <button class="photo-remove-inline" onclick="removeCleanImage(${image.id})" title="刪除照片" style="position: absolute; top: -5px; right: -5px; background: rgba(231, 76, 60, 0.9); color: white; border: none; border-radius: 50%; width: 16px; height: 16px; cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center;">×</button>
                    </div>
                `;
            }
            
            if (cleanImages.length > 6) {
                previewHTML += `<div style="color: #888; font-size: 12px; align-self: center;">+${cleanImages.length - 6}張</div>`;
            }
            
            previewHTML += '</div>';
            previewContainer.innerHTML = previewHTML;
        }

        function removeCleanImage(imageId) {
            cleanImages = cleanImages.filter(img => img.id !== imageId);
            updateCleanImagePreview();
            
            if (cleanImages.length === 0) {
                document.getElementById('clean-merged-preview').innerHTML = '';
                showStatus('clean-status', '✅ 所有照片已清除', 'success');
            }
        }

        function clearCleanImages() {
            cleanImages = [];
            document.getElementById('clean-images').value = '';
            document.getElementById('clean-image-preview').innerHTML = '';
            document.getElementById('clean-merged-preview').innerHTML = '';
            document.getElementById('clean-merge-controls').style.display = 'none';
            showStatus('clean-status', '✅ 所有照片已清除', 'success');
        }

        function mergeCleanImages() {
            if (cleanImages.length === 0) {
                showStatus('clean-status', '❌ 請先上傳照片', 'error');
                return;
            }

            showStatus('clean-status', '🔄 正在合併照片...', 'success');

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            Promise.all(cleanImages.map(imageData => {
                return new Promise(resolve => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.src = imageData.dataUrl;
                });
            })).then(images => {
                // Smart grid layout based on image count
                let imagesPerRow, rows;
                if (images.length === 1) {
                    imagesPerRow = 1;
                    rows = 1;
                } else if (images.length === 2) {
                    imagesPerRow = 2;
                    rows = 1;
                } else if (images.length === 3) {
                    imagesPerRow = 3;
                    rows = 1;
                } else if (images.length === 4) {
                    imagesPerRow = 2;
                    rows = 2;
                } else if (images.length <= 6) {
                    imagesPerRow = 3;
                    rows = 2;
                } else if (images.length <= 9) {
                    imagesPerRow = 3;
                    rows = 3;
                } else {
                    imagesPerRow = 4;
                    rows = Math.ceil(images.length / 4);
                }
                
                const imageSize = Math.floor(600 / Math.max(imagesPerRow, rows));
                const totalWidth = imagesPerRow * imageSize;
                const totalHeight = rows * imageSize;
                
                // Optimize canvas size to reduce white space
                const actualWidth = Math.max(totalWidth, totalHeight);
                const actualHeight = Math.max(totalWidth, totalHeight);
                canvas.width = actualWidth;
                canvas.height = actualHeight;
                const finalMarginX = (actualWidth - totalWidth) / 2;
                const finalMarginY = (actualHeight - totalHeight) / 2;
                
                
                // Draw images in smart grid
                images.forEach((img, index) => {
                    const col = index % imagesPerRow;
                    const row = Math.floor(index / imagesPerRow);
                    const x = finalMarginX + col * imageSize;
                    const y = finalMarginY + row * imageSize;
                    
                    // Draw image as square (crop to fit)
                    const aspectRatio = img.width / img.height;
                    let sourceX = 0, sourceY = 0, sourceSize;
                    
                    if (aspectRatio > 1) {
                        // 寬圖片，裁切左右
                        sourceSize = img.height;
                        sourceX = (img.width - sourceSize) / 2;
                    } else {
                        // 高圖片，裁切上下
                        sourceSize = img.width;
                        sourceY = (img.height - sourceSize) / 2;
                    }
                    
                    ctx.drawImage(img, sourceX, sourceY, sourceSize, sourceSize, x, y, imageSize, imageSize);
                    
                    // Draw red grid lines
                    ctx.strokeStyle = '#FF0000';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y, imageSize, imageSize);
                });
                
                
                const mergedDataUrl = canvas.toDataURL('image/jpeg', 0.9);
                const mergedPreview = document.getElementById('clean-merged-preview');
                mergedPreview.innerHTML = `
                    <div class="merged-photo">
                        <div class="merged-photo-content">
                            <div><strong>合併照片：</strong></div>
                            <img src="${mergedDataUrl}" alt="合併照片">
                        </div>
                        <div class="merged-photo-controls">
                            <button class="btn-download" onclick="downloadMergedImage('${mergedDataUrl}', 'clean')">↓</button>
                        </div>
                    </div>
                `;
                
                showStatus('clean-status', `✅ 已成功合併 ${images.length} 張照片！`, 'success');
            });
        }

        // 自動報價單相關函數
        let autoQuoteData = null;
        
        // 存儲用戶選中的資料行
        let selectedAutoQuoteData = null;
        let selectedAutoQuoteRowIndex = -1;

        function clearAutoQuoteForm() {
            // 清空Google試算表網址
            document.getElementById('sheets-url').value = '';
            document.getElementById('saved-urls').value = '';
            
            // 清空手動輸入欄位
            document.getElementById('manual-fee').value = '';
            document.getElementById('manual-time').value = '';
            document.getElementById('manual-floor').value = '';
            document.getElementById('manual-frequency').value = '';
            document.getElementById('manual-trash').value = '';
            document.getElementById('manual-recycle').value = '';
            document.getElementById('manual-trash-volume').value = '';
            document.getElementById('manual-recycle-volume').value = '';
            document.getElementById('manual-trash-max').value = '';
            document.getElementById('manual-recycle-max').value = '';
            document.getElementById('manual-special-notes').value = '';
            
            // 清空複選框
            document.querySelectorAll('input[name="manual-days"]').forEach(cb => cb.checked = false);
            
            // 隱藏輸出區域
            document.getElementById('auto-detected-data').style.display = 'none';
            document.getElementById('auto-quote-controls').style.display = 'none';
            document.getElementById('auto-quote-output').style.display = 'none';
            document.getElementById('auto-sheets-status').style.display = 'none';
            document.getElementById('auto-quote-final-status').style.display = 'none';
            
            // 清空數據
            autoQuoteData = null;
            selectedAutoQuoteData = null;
            selectedAutoQuoteRowIndex = -1;
        }

        async function fetchGoogleSheetsData() {
            const sheetsUrl = document.getElementById('sheets-url').value.trim();
            
            if (!sheetsUrl) {
                showStatus('auto-sheets-status', '❌ 請輸入Google試算表網址', 'error');
                return;
            }

            if (!sheetsUrl.includes('docs.google.com/spreadsheets')) {
                showStatus('auto-sheets-status', '❌ 請輸入有效的Google試算表連結', 'error');
                return;
            }

            showStatus('auto-sheets-status', '🔄 正在載入試算表資料...', 'success');

            try {
                // 從URL中提取試算表ID
                let spreadsheetId = '';
                const urlMatch = sheetsUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                if (urlMatch) {
                    spreadsheetId = urlMatch[1];
                } else {
                    throw new Error('無法解析試算表ID，請確認URL格式正確');
                }

                // 構建CSV導出URL - 更穩定的方式
                const csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv`;
                
                console.log('正在嘗試載入:', csvUrl);

                // 使用代理方式避免CORS問題
                const proxyUrl = `https://cors-anywhere.herokuapp.com/${csvUrl}`;
                let response;
                
                try {
                    // 首先嘗試直接訪問
                    response = await fetch(csvUrl, {
                        mode: 'cors',
                        headers: {
                            'Accept': 'text/csv,text/plain'
                        }
                    });
                } catch (corsError) {
                    console.log('直接訪問失敗，嘗試代理方式:', corsError);
                    // 如果CORS失敗，顯示說明
                    throw new Error('由於瀏覽器安全限制，無法直接讀取Google試算表。請確認：\n1. 試算表已設為「知道連結的使用者」可檢視\n2. 或手動複製貼上資料到下方');
                }

                if (!response.ok) {
                    if (response.status === 403) {
                        throw new Error('無法存取試算表，請確認分享設定為「知道連結的使用者」可檢視');
                    } else if (response.status === 404) {
                        throw new Error('找不到試算表，請確認網址正確');
                    } else {
                        throw new Error(`載入失敗 (錯誤代碼: ${response.status})`);
                    }
                }

                const csvText = await response.text();
                console.log('CSV資料:', csvText.substring(0, 200) + '...');
                
                if (!csvText || csvText.trim().length === 0) {
                    throw new Error('試算表資料為空，請確認表格中有資料');
                }

                // 改進的CSV解析
                const rows = parseCSV(csvText);
                const filteredRows = rows.filter(row => row.some(cell => cell && cell.length > 0));
                
                if (filteredRows.length === 0) {
                    throw new Error('試算表中沒有找到任何有效資料');
                }

                const startRow = 1; // 固定從第2列開始（跳過表頭）
                const updateMode = document.getElementById('update-mode').value;
                
                // 取得表頭和資料行
                const headers = filteredRows[0] || [];
                const allDataRows = filteredRows.slice(1); // 移除表頭行
                
                let dataRows;
                if (updateMode === 'latest') {
                    dataRows = allDataRows.slice(-1);
                } else if (updateMode === 'last-5') {
                    dataRows = allDataRows.slice(-5);
                } else if (updateMode === 'last-10') {
                    dataRows = allDataRows.slice(-10);
                } else if (updateMode === 'last-20') {
                    dataRows = allDataRows.slice(-20);
                } else {
                    dataRows = allDataRows; // 所有資料模式
                }

                autoQuoteData = {
                    headers: headers,
                    rows: dataRows
                };

                displayDetectedData(autoQuoteData);
                showStatus('auto-sheets-status', `✅ 成功載入 ${dataRows.length} 筆資料`, 'success');

            } catch (error) {
                console.error('載入試算表失敗:', error);
                showStatus('auto-sheets-status', `❌ ${error.message}`, 'error');
                
                // 顯示手動輸入選項
                showManualDataInput();
            }
        }

        // 改進的CSV解析函數 - 修復多行標題問題
        function parseCSV(csvText) {
            const rows = [];
            
            console.log('CSV總行數:', csvText.split('\n').length);
            console.log('CSV前500字符:', csvText.substring(0, 500));
            
            // 更強健的CSV解析 - 處理嵌入式換行符
            let current = '';
            let inQuotes = false;
            let currentRow = [];
            let i = 0;
            
            while (i < csvText.length) {
                const char = csvText[i];
                
                if (char === '"') {
                    if (inQuotes && i + 1 < csvText.length && csvText[i + 1] === '"') {
                        // 處理雙引號轉義
                        current += '"';
                        i += 2;
                        continue;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    currentRow.push(current.trim().replace(/^"|"$/g, ''));
                    current = '';
                } else if ((char === '\n' || char === '\r') && !inQuotes) {
                    // 只有在不在引號內時才視為行結束
                    if (current.trim() || currentRow.length > 0) {
                        currentRow.push(current.trim().replace(/^"|"$/g, ''));
                        if (currentRow.some(cell => cell.length > 0)) {
                            rows.push(currentRow);
                        }
                        currentRow = [];
                        current = '';
                    }
                } else if (char !== '\r') {
                    // 在引號內時，保留換行符
                    current += char;
                }
                
                i++;
            }
            
            // 處理最後一行
            if (current.trim() || currentRow.length > 0) {
                currentRow.push(current.trim().replace(/^"|"$/g, ''));
                if (currentRow.some(cell => cell.length > 0)) {
                    rows.push(currentRow);
                }
            }
            
            // 偵錯第一行的解析結果
            if (rows.length > 0) {
                console.log('標題行解析結果:', rows[0]);
                console.log('標題行欄位數量:', rows[0].length);
                console.log('前5個標題:', rows[0].slice(0, 5));
            }
            
            return rows;
        }

        // 顯示手動資料輸入選項
        function showManualDataInput() {
            const detectedDataDiv = document.getElementById('auto-detected-data');
            detectedDataDiv.style.display = 'block';
            
            const preview = document.getElementById('detected-data-preview');
            preview.innerHTML = `
                <div style="text-align: center; padding: 20px; background: #333; border-radius: 8px;">
                    <h4 style="color: #ffd700; margin-bottom: 15px;">📋 手動資料輸入</h4>
                    <p style="color: #e0e0e0; margin-bottom: 15px;">由於自動讀取失敗，請手動輸入客戶資料：</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="manual-name" placeholder="客戶姓名" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                        <input type="text" id="manual-address" placeholder="服務地址" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                        <input type="text" id="manual-phone" placeholder="聯絡電話" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                        <input type="number" id="manual-fee" placeholder="月費" value="1200" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                        <input type="text" id="manual-days" placeholder="服務星期" value="週二、週五" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                        <input type="text" id="manual-time" placeholder="服務時間" value="0800" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                        <input type="number" id="manual-floor" placeholder="樓層" value="1" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                        <input type="number" id="manual-trash" placeholder="垃圾袋數" value="6" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                        <input type="number" id="manual-recycle" placeholder="資源袋數" value="3" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                    </div>
                    <button onclick="useManualData()" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold;">
                        ✅ 使用手動資料生成報價單
                    </button>
                </div>
            `;
            
            document.getElementById('auto-quote-controls').style.display = 'none';
        }

        // 使用手動輸入的資料
        function useManualData() {
            showStatus('auto-sheets-status', '🔄 正在使用手動資料生成報價單...', 'success');
            
            const selectedDays = Array.from(document.querySelectorAll('input[name="manual-days"]:checked')).map(cb => cb.value);
            const manualData = {
                lineName: '',
                address: '',
                housingType: '',
                monthlyFee: document.getElementById('manual-fee').value || '',
                serviceDays: selectedDays.join('、') || '',
                serviceTime: document.getElementById('manual-time').value || '',
                floor: document.getElementById('manual-floor').value || '',
                trashBags: document.getElementById('manual-trash').value || '',
                recycleBags: document.getElementById('manual-recycle').value || '',
                trashVolume: document.getElementById('manual-trash-volume').value || '',
                recycleVolume: document.getElementById('manual-recycle-volume').value || '',
                trashMax: document.getElementById('manual-trash-max').value || '',
                recycleMax: document.getElementById('manual-recycle-max').value || '',
                specialNotes: document.getElementById('manual-special-notes').value || ''
            };

            try {
                const quote = generateQuoteFromData(manualData);
                document.getElementById('auto-quote-result-display').textContent = quote;
                document.getElementById('auto-quote-output').style.display = 'block';
                
                // 顯示使用的資料預覽
                const preview = document.getElementById('detected-data-preview');
                preview.innerHTML = `
                    <div style="background: #2a2a2a; padding: 15px; border-radius: 8px; color: #e0e0e0;">
                        <h4 style="color: #28a745; margin-bottom: 10px;">✅ 使用的手動資料：</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <div><strong>月費：</strong> ${manualData.monthlyFee}元</div>
                            <div><strong>收取星期：</strong> ${manualData.serviceDays}</div>
                            <div><strong>服務時間：</strong> ${manualData.serviceTime}</div>
                            <div><strong>樓層：</strong> ${manualData.floor}樓</div>
                            <div><strong>垃圾袋數：</strong> ${manualData.trashBags}包</div>
                            <div><strong>資源袋數：</strong> ${manualData.recycleBags}包</div>
                            <div><strong>垃圾袋容量：</strong> ${manualData.trashVolume}</div>
                            <div><strong>資源袋容量：</strong> ${manualData.recycleVolume}</div>
                            <div><strong>最多垃圾袋數：</strong> ${manualData.trashMax}袋</div>
                            <div><strong>最多資源袋數：</strong> ${manualData.recycleMax}袋</div>
                            ${manualData.specialNotes ? `<div><strong>特殊需求：</strong> ${manualData.specialNotes}</div>` : ''}
                        </div>
                    </div>
                `;
                
                document.getElementById('auto-detected-data').style.display = 'block';
                showStatus('auto-quote-final-status', '✅ 手動資料報價單生成完成！', 'success');
                
            } catch (error) {
                showStatus('auto-quote-final-status', `❌ 生成失敗: ${error.message}`, 'error');
            }
        }

        function displayDetectedData(data) {
            const preview = document.getElementById('detected-data-preview');
            let html = '<table style="width: 100%; border-collapse: collapse; color: #e0e0e0;">';
            
            if (data.headers.length > 0) {
                html += '<tr style="background: #404040;">';
                data.headers.forEach(header => {
                    // 簡化表頭顯示：移除表情符號，提取關鍵字
                    let simplifiedHeader = header;
                    
                    // 移除所有表情符號
                    simplifiedHeader = simplifiedHeader.replace(/[\u{1F000}-\u{1F6FF}]|[\u{1F700}-\u{1F77F}]|[\u{1F780}-\u{1F7FF}]|[\u{1F800}-\u{1F8FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '');
                    
                    // 判斷欄位類型
                    const isResourceField = header.toLowerCase().includes('資源');
                    const isTrashField = header.toLowerCase().includes('垃圾');
                    
                    // 提取關鍵字（方括號內的內容或最後的重要詞彙）
                    const bracketMatch = simplifiedHeader.match(/\[([^\]]+)\]/);
                    if (bracketMatch) {
                        simplifiedHeader = bracketMatch[1];
                    } else {
                        // 如果沒有方括號，提取最後的關鍵詞
                        if (simplifiedHeader.includes('地址')) {
                            simplifiedHeader = '地址';
                        } else {
                            simplifiedHeader = simplifiedHeader.trim()
                                .replace(/.*垃圾.*/, '垃圾量')
                                .replace(/.*資源.*/, '資源量')
                                .replace(/.*月費.*|.*費用.*/, '月費')
                                .replace(/.*星期.*|.*收取.*/, '次數')
                                .replace(/.*時間.*/, '時間')
                                .replace(/.*樓層.*/, '樓層')
                                .replace(/.*line.*|.*暱稱.*/, 'LINE暱稱')
                                .replace(/.*住宅.*|.*性質.*/, '住宅性質');
                        }
                    }
                    
                    // 清理多餘的空格和符號
                    simplifiedHeader = simplifiedHeader.replace(/["""'']/g, '').trim();
                    
                    // 設定樣式：垃圾欄位用紅色，資源欄位用綠色
                    let backgroundColor = '#404040';
                    let textColor = '#e0e0e0';
                    
                    if (isTrashField) {
                        backgroundColor = '#dc3545'; // 紅色
                        textColor = '#ffffff';
                    } else if (isResourceField) {
                        backgroundColor = '#28a745'; // 綠色
                        textColor = '#ffffff';
                    }
                    
                    html += `<th style="border: 1px solid #666; padding: 8px; text-align: left; background-color: ${backgroundColor}; color: ${textColor};">${simplifiedHeader}</th>`;
                });
                html += '</tr>';
            }

            data.rows.forEach((row, index) => {
                html += `<tr onclick="selectAutoQuoteRowForQuote(${index})" style="cursor: pointer; background: ${index % 2 === 0 ? '#2a2a2a' : '#333333'};" class="auto-data-row" title="點擊選擇此資料作為報價單來源" onmouseover="this.style.background='#4a4a4a'" onmouseout="this.style.background='${index % 2 === 0 ? '#2a2a2a' : '#333333'}'">`;
                row.forEach(cell => {
                    html += `<td style="border: 1px solid #666; padding: 8px;">${cell}</td>`;
                });
                html += '</tr>';
            });

            html += '</table>';
            preview.innerHTML = html;
            
            document.getElementById('auto-detected-data').style.display = 'block';
            document.getElementById('auto-quote-controls').style.display = 'none'; // 先隱藏生成按鈕，需要選擇資料後才顯示
        }
        
        // 選擇包月自動報價資料行
        function selectAutoQuoteRowForQuote(rowIndex) {
            console.log('selectAutoQuoteRowForQuote called with index:', rowIndex);
            
            if (!autoQuoteData || !autoQuoteData.rows || rowIndex >= autoQuoteData.rows.length) {
                console.error('Invalid row index or data not available');
                return;
            }
            
            const headers = autoQuoteData.headers;
            const selectedRowData = autoQuoteData.rows[rowIndex];
            
            console.log('Available headers:', headers);
            console.log('Selected row data:', selectedRowData);
            
            // 更新選中行的視覺效果
            const allRows = document.querySelectorAll('.auto-data-row');
            allRows.forEach((row, index) => {
                if (index === rowIndex) {
                    row.style.border = '3px solid #FFD700';
                    row.style.background = '#4a4a00';
                } else {
                    row.style.border = '';
                    row.style.background = index % 2 === 0 ? '#2a2a2a' : '#333333';
                }
            });
            
            // 儲存選中的資料
            selectedAutoQuoteData = selectedRowData;
            selectedAutoQuoteRowIndex = rowIndex;
            
            // 顯示生成按鈕
            document.getElementById('auto-quote-controls').style.display = 'block';
            
            // 偵測並預覽選中資料的關鍵資訊
            const previewData = {};
            headers.forEach((header, index) => {
                const cellValue = selectedRowData[index];
                const lowerHeader = header.toLowerCase();
                
                if (lowerHeader.includes('line') || lowerHeader.includes('暱稱')) {
                    previewData.lineName = cellValue;
                } else if (header.includes('地址') || header.includes('區域')) {
                    previewData.address = cellValue;
                } else if (lowerHeader.includes('月費') || lowerHeader.includes('費用')) {
                    previewData.monthlyFee = cellValue;
                } else if (header.includes('住宅') || header.includes('性質')) {
                    previewData.housingType = cellValue;
                }
            });
            
            // 顯示選擇狀態
            let statusMsg = `✅ 已選擇第 ${rowIndex + 1} 行資料`;
            if (previewData.lineName) {
                statusMsg += ` | 客戶: ${previewData.lineName}`;
            }
            if (previewData.address) {
                statusMsg += ` | 地址: ${previewData.address.substring(0, 15)}...`;
            }
            if (previewData.monthlyFee) {
                statusMsg += ` | 月費: ${previewData.monthlyFee}元`;
            }
            
            showStatus('auto-sheets-status', statusMsg, 'success');
        }

        function generateAutoQuote() {
            if (!autoQuoteData || !autoQuoteData.rows || autoQuoteData.rows.length === 0) {
                showStatus('auto-quote-final-status', '❌ 請先載入試算表資料', 'error');
                return;
            }
            
            if (selectedAutoQuoteData === null || selectedAutoQuoteRowIndex === -1) {
                showStatus('auto-quote-final-status', '❌ 請先點擊選擇要用於生成報價單的資料行', 'error');
                return;
            }

            showStatus('auto-quote-final-status', '🔄 正在生成自動報價單...', 'success');

            try {
                const selectedRow = selectedAutoQuoteData;
                const headers = autoQuoteData.headers;
                
                // 先獲取手動輸入的資料
                const selectedDays = Array.from(document.querySelectorAll('input[name="manual-days"]:checked')).map(cb => cb.value);
                const manualData = {
                    lineName: '',
                    address: '',
                    housingType: '',
                    monthlyFee: document.getElementById('manual-fee').value || '',
                    serviceDays: selectedDays.join('、') || '',
                    serviceTime: document.getElementById('manual-time').value || '',
                    floor: document.getElementById('manual-floor').value || '',
                    frequency: document.getElementById('manual-frequency').value || '',
                    trashBags: document.getElementById('manual-trash').value || '',
                    recycleBags: document.getElementById('manual-recycle').value || '',
                    trashVolume: document.getElementById('manual-trash-volume').value || '',
                    recycleVolume: document.getElementById('manual-recycle-volume').value || '',
                    trashMax: document.getElementById('manual-trash-max').value || '',
                    recycleMax: document.getElementById('manual-recycle-max').value || '',
                    specialNotes: document.getElementById('manual-special-notes').value || ''
                };
                
                console.log('Manual data collected:', manualData);

                const fieldMapping = {};
                console.log('Headers:', headers);
                console.log('Headers length:', headers.length);
                console.log('Selected row:', selectedRow);
                console.log('Selected row length:', selectedRow.length);
                
                // 收集垃圾和資源的包數與容量數據
                let trashData = { bags: '', volume: '' };
                let recycleData = { bags: '', volume: '' };
                
                headers.forEach((header, index) => {
                    const lowerHeader = header.toLowerCase();
                    const cellValue = selectedRow[index];
                    console.log(`Processing header: "${header}" (${lowerHeader}) with value: "${cellValue}"`);
                    
                    // 更精確的欄位偵測邏輯
                    if (lowerHeader.includes('line') || lowerHeader.includes('暱稱')) {
                        fieldMapping.lineName = cellValue;
                        console.log(`Detected LINE name: ${cellValue}`);
                    } else if (header.includes('地址') || header.includes('區域') || (header.includes('收取') && (header.includes('地址') || header.includes('區域')))) {
                        fieldMapping.address = cellValue;
                        console.log(`Detected address from header "${header}": ${cellValue}`);
                        
                        // 自動偵測地址中的樓層數字並填入樓層欄位（只在手動欄位為空時）
                        if (cellValue && (!manualData.floor || manualData.floor.trim() === '')) {
                            const floorMatch = cellValue.match(/(\d+)[樓F]/);
                            if (floorMatch) {
                                fieldMapping.floor = floorMatch[1];
                                // 只在手動欄位為空時自動填入
                                document.getElementById('manual-floor').value = floorMatch[1];
                                console.log(`Auto-detected floor: ${floorMatch[1]} from address: ${cellValue}`);
                            } else {
                                console.log(`No floor detected in address: ${cellValue}, keeping manual input`);
                            }
                        }
                    } else if (header.includes('住宅') || header.includes('性質')) {
                        fieldMapping.housingType = cellValue;
                        console.log(`Detected housing type from header "${header}": ${cellValue}`);
                    } else if (lowerHeader.includes('月費') || lowerHeader.includes('費用')) {
                        // 優先使用手動輸入的月費，其次是試算表數據
                        fieldMapping.monthlyFee = (manualData.monthlyFee && manualData.monthlyFee.trim() !== '') ? manualData.monthlyFee : cellValue;
                    } else if (lowerHeader.includes('星期') || lowerHeader.includes('收取')) {
                        // 處理次數欄位，生成「一週趟數：X趟」格式
                        if (cellValue && cellValue.trim() !== '') {
                            const frequencyMatch = cellValue.match(/(\d+)/);
                            if (frequencyMatch) {
                                fieldMapping.weeklyFrequency = `一週趟數：${frequencyMatch[1]}趟`;
                            } else {
                                fieldMapping.weeklyFrequency = `一週趟數：${cellValue}趟`;
                            }
                        }
                        // 保持原有的服務日邏輯，優先使用手動選擇的星期
                        fieldMapping.serviceDays = manualData.serviceDays;
                    } else if (lowerHeader.includes('時間')) {
                        // 優先使用手動輸入的時間，其次是試算表數據
                        fieldMapping.serviceTime = (manualData.serviceTime && manualData.serviceTime.trim() !== '') ? manualData.serviceTime : cellValue;
                    } else if (lowerHeader.includes('樓層')) {
                        // 優先使用手動輸入的樓層資料，其次是試算表中的樓層資料，最後預設為0
                        fieldMapping.floor = (manualData.floor && manualData.floor.trim() !== '') ? manualData.floor : ((cellValue && cellValue.trim() !== '') ? cellValue : '0');
                    } else if (lowerHeader.includes('垃圾')) {
                        console.log(`Found trash header: "${header}" with value: "${cellValue}"`);
                        // 如果該欄位有數據，同時記錄包數和容量
                        if (cellValue && cellValue.trim() !== '') {
                            const bagMatch = cellValue.match(/(\d+)包/);
                            const headerVolumeMatch = header.match(/(\d+(?:\/\d+)?公升)/);
                            
                            if (bagMatch) {
                                trashData.bags = bagMatch[1];
                                // 同時記錄該欄位對應的容量
                                if (headerVolumeMatch) {
                                    trashData.volume = headerVolumeMatch[1];
                                }
                                console.log(`Trash data found: ${trashData.bags}包 in ${header} (volume: ${trashData.volume})`);
                            }
                        }
                    } else if (lowerHeader.includes('資源')) {
                        console.log(`Found recycle header: "${header}" with value: "${cellValue}"`);
                        // 如果該欄位有數據，同時記錄包數和容量
                        if (cellValue && cellValue.trim() !== '') {
                            const bagMatch = cellValue.match(/(\d+)包/);
                            const headerVolumeMatch = header.match(/(\d+(?:\/\d+)?公升)/);
                            
                            if (bagMatch) {
                                recycleData.bags = bagMatch[1];
                                // 同時記錄該欄位對應的容量
                                if (headerVolumeMatch) {
                                    recycleData.volume = headerVolumeMatch[1];
                                }
                                console.log(`Recycle data found: ${recycleData.bags}包 in ${header} (volume: ${recycleData.volume})`);
                            }
                        }
                    }
                });
                
                // 組合垃圾袋數據
                if (manualData.trashBags || manualData.trashVolume) {
                    if (manualData.trashBags && manualData.trashVolume) {
                        fieldMapping.trashBags = `${manualData.trashBags}包數（${manualData.trashVolume}）`;
                    } else if (manualData.trashBags) {
                        fieldMapping.trashBags = `${manualData.trashBags}包數（14公升）`;
                    } else {
                        fieldMapping.trashBags = `6包數（${manualData.trashVolume}）`;
                    }
                } else if (trashData.bags && trashData.volume) {
                    fieldMapping.trashBags = `${trashData.bags}包（${trashData.volume}）`;
                } else if (trashData.bags) {
                    fieldMapping.trashBags = `${trashData.bags}包（14公升）`;
                } else {
                    fieldMapping.trashBags = '6包（14公升）';
                }
                
                // 組合資源袋數據
                if (manualData.recycleBags || manualData.recycleVolume) {
                    if (manualData.recycleBags && manualData.recycleVolume) {
                        fieldMapping.recycleBags = `${manualData.recycleBags}包數（${manualData.recycleVolume}）`;
                    } else if (manualData.recycleBags) {
                        fieldMapping.recycleBags = `${manualData.recycleBags}包數（14公升）`;
                    } else {
                        fieldMapping.recycleBags = `3包數（${manualData.recycleVolume}）`;
                    }
                } else if (recycleData.bags && recycleData.volume) {
                    fieldMapping.recycleBags = `${recycleData.bags}包（${recycleData.volume}）`;
                } else if (recycleData.bags) {
                    fieldMapping.recycleBags = `${recycleData.bags}包（14公升）`;
                } else {
                    fieldMapping.recycleBags = '3包（14公升）';
                }
                
                console.log(`Final trash data: bags="${trashData.bags}", volume="${trashData.volume}", result="${fieldMapping.trashBags}"`);
                console.log(`Final recycle data: bags="${recycleData.bags}", volume="${recycleData.volume}", result="${fieldMapping.recycleBags}"`);
                
                console.log('Final field mapping:', fieldMapping);
                
                // 加入手動輸入的其他數據
                if (manualData.trashMax) {
                    fieldMapping.trashMax = manualData.trashMax;
                }
                if (manualData.recycleMax) {
                    fieldMapping.recycleMax = manualData.recycleMax;
                }
                if (manualData.specialNotes) {
                    fieldMapping.specialNotes = manualData.specialNotes;
                }
                // 確保手動輸入的重要欄位正確傳遞（覆蓋之前的設定）
                if (manualData.frequency) {
                    fieldMapping.frequency = manualData.frequency;
                }
                // 確保手動輸入的收取星期一定優先使用
                if (manualData.serviceDays && manualData.serviceDays.trim() !== '') {
                    fieldMapping.serviceDays = manualData.serviceDays;
                }
                // 確保手動輸入的樓層一定優先使用
                if (manualData.floor && manualData.floor.trim() !== '') {
                    fieldMapping.floor = manualData.floor;
                }
                // 確保手動輸入的月費一定優先使用
                if (manualData.monthlyFee && manualData.monthlyFee.trim() !== '') {
                    fieldMapping.monthlyFee = manualData.monthlyFee;
                }
                // 確保手動輸入的時間一定優先使用
                if (manualData.serviceTime && manualData.serviceTime.trim() !== '') {
                    fieldMapping.serviceTime = manualData.serviceTime;
                }
                
                console.log('Final fieldMapping with manual overrides:', fieldMapping);

                // 生成競爭廠商比較
                generateVendorComparison(fieldMapping);

                const quote = generateQuoteFromData(fieldMapping);
                
                document.getElementById('auto-quote-result-display').textContent = quote;
                document.getElementById('auto-quote-output').style.display = 'block';
                showStatus('auto-quote-final-status', '✅ 自動報價單生成完成！', 'success');

            } catch (error) {
                console.error('生成報價單失敗:', error);
                showStatus('auto-quote-final-status', `❌ 生成失敗: ${error.message}`, 'error');
            }
        }

        function generateQuoteFromData(data) {
            const lineName = data.lineName || '';
            const address = data.address || '';
            const housingType = data.housingType || '';
            const monthlyFee = (data.monthlyFee && data.monthlyFee.trim() !== '') ? data.monthlyFee : '0';
            const serviceDays = data.serviceDays || '週二、週五';
            const serviceTime = (data.serviceTime && data.serviceTime.trim() !== '') ? data.serviceTime : '0';
            const floor = (data.floor && data.floor.trim() !== '') ? data.floor : '0';
            const trashBags = data.trashBags || '6';
            const recycleBags = data.recycleBags || '3';

            // 樓層顯示
            let floorDisplay;
            const floorNum = parseInt(floor);
            if (floorNum < 0) {
                floorDisplay = `地下${Math.abs(floorNum)}樓`;
            } else {
                floorDisplay = `${floorNum}F`;
            }

            // 時間格式化 - 根據時間自動判斷上午/下午/晚上
            let timeDisplay = serviceTime;
            if (serviceTime && serviceTime.length === 4 && /^\d{4}$/.test(serviceTime)) {
                const hour = parseInt(serviceTime.substring(0, 2));
                const minute = serviceTime.substring(2);
                
                let period;
                if (hour >= 6 && hour < 12) {
                    period = '上午';
                } else if (hour >= 12 && hour < 18) {
                    period = '下午';
                } else {
                    period = '晚間';
                }
                
                timeDisplay = `${period} ${hour.toString().padStart(2, '0')}：${minute}`;
            } else if (serviceTime && serviceTime.includes(':')) {
                // 如果已經是時間格式，檢查是否需要加上時段
                const timeMatch = serviceTime.match(/(\d{1,2}):(\d{2})/);
                if (timeMatch) {
                    const hour = parseInt(timeMatch[1]);
                    const minute = timeMatch[2];
                    
                    let period;
                    if (hour >= 6 && hour < 12) {
                        period = '上午';
                    } else if (hour >= 12 && hour < 18) {
                        period = '下午';
                    } else {
                        period = '晚間';
                    }
                    
                    timeDisplay = `${period} ${hour.toString().padStart(2, '0')}：${minute}`;
                } else {
                    timeDisplay = serviceTime;
                }
            } else if (!serviceTime || serviceTime.trim() === '' || serviceTime === '0') {
                // 如果沒有輸入時間或時間為0，顯示0
                timeDisplay = '0';
            }

            // 收取時間描述 - 根據時間段動態生成
            let collectionTimeDesc = '';
            if (timeDisplay.includes('上午')) {
                collectionTimeDesc = '中午前';
            } else if (timeDisplay.includes('下午')) {
                collectionTimeDesc = '下午前';
            } else if (timeDisplay.includes('晚間')) {
                collectionTimeDesc = '半夜前';
            } else {
                collectionTimeDesc = '中午前';
            }

            // 服務星期格式化
            let daysDisplay = serviceDays;
            if (serviceDays.includes('週')) {
                daysDisplay = serviceDays.replace(/週/g, '週').replace(/、/g, '+');
            }

            // 處理垃圾袋顯示格式
            let trashDisplay;
            if (typeof trashBags === 'string' && (trashBags.includes('公升') || trashBags.includes('包'))) {
                // 如果已經包含完整格式（如：3包 75/76公升），需要轉換為標準格式
                if (trashBags.includes('包') && trashBags.includes('公升')) {
                    // 提取包數和容量
                    const bagMatch = trashBags.match(/(\d+)包/);
                    const volumeMatch = trashBags.match(/(\d+(?:\/\d+)?公升)/);
                    if (bagMatch && volumeMatch) {
                        trashDisplay = `${bagMatch[1]}包數（${volumeMatch[1]}）`;
                    } else {
                        trashDisplay = trashBags;
                    }
                } else {
                    trashDisplay = trashBags;
                }
            } else {
                // 否則從數字建立格式
                const trashNum = parseInt(trashBags) || 6;
                trashDisplay = `${trashNum}包數（14公升）`;
            }

            // 處理資源袋顯示格式
            let recycleDisplay;
            if (typeof recycleBags === 'string' && (recycleBags.includes('公升') || recycleBags.includes('包'))) {
                // 如果已經包含完整格式（如：3包 14公升），需要轉換為標準格式
                if (recycleBags.includes('包') && recycleBags.includes('公升')) {
                    // 提取包數和容量
                    const bagMatch = recycleBags.match(/(\d+)包/);
                    const volumeMatch = recycleBags.match(/(\d+(?:\/\d+)?公升)/);
                    if (bagMatch && volumeMatch) {
                        recycleDisplay = `${bagMatch[1]}包數（${volumeMatch[1]}）`;
                    } else {
                        recycleDisplay = recycleBags;
                    }
                } else {
                    recycleDisplay = recycleBags;
                }
            } else {
                // 否則從數字建立格式
                const recycleNum = parseInt(recycleBags) || 3;
                recycleDisplay = `${recycleNum}包數（14公升）`;
            }

            // 計算每次最多收取袋數（從顯示文字中提取數字）
            const trashNum = parseInt(trashDisplay.match(/(\d+)包/)?.[1]) || 6;
            const recycleNum = parseInt(recycleDisplay.match(/(\d+)包/)?.[1]) || 3;
            
            // 如果手動輸入了最大袋數，使用手動數據，否則計算
            let trashMax, recycleMax;
            if (data.trashMax) {
                trashMax = parseInt(data.trashMax);
            } else {
                trashMax = Math.floor(trashNum / 2) || 3;
            }
            
            if (data.recycleMax) {
                recycleMax = parseInt(data.recycleMax);
            } else {
                recycleMax = Math.floor(recycleNum / 2) || 3;
            }

            // 顯示客戶資訊（如果有的話）
            let customerInfo = '';
            if (lineName) customerInfo += `LINE暱稱：${lineName}\n`;
            if (address) customerInfo += `地址：${address}\n`;
            if (housingType) customerInfo += `住宅性質：${housingType}\n`;
            if (customerInfo) customerInfo += '\n------------------------------------\n\n';

            // 優先使用手動輸入的趟數，其次是自動偵測，最後是預設值
            let weeklyFrequency;
            if (data.frequency) {
                weeklyFrequency = `一週趟數：${data.frequency}趟`;
            } else if (data.weeklyFrequency) {
                weeklyFrequency = data.weeklyFrequency;
            } else {
                weeklyFrequency = '一週趟數：2趟';
            }
            
            // 如果沒有選擇服務星期，使用預設值
            let finalDaysDisplay = daysDisplay;
            if (!serviceDays || serviceDays.trim() === '') {
                finalDaysDisplay = '週二、週五';
            }
            
            // 最終格式：趟數-星期
            const serviceSchedule = `${weeklyFrequency}-${finalDaysDisplay}`;
            
            const quote = `${customerInfo}⛔報價資料⛔

${serviceSchedule}
   置放時間：${timeDisplay}
   置放樓層：${floorDisplay}

（⚠️垃圾當日:${collectionTimeDesc} 代收完畢）
（⚠️過程中嚴禁催促）
（⚠️請準時置放以免多有糾紛）

 1週垃圾：${trashDisplay}
（1次最多收取${trashMax}袋--超量拒收）
（垃圾請綁緊、勿外露）
（垃圾袋外部勿流湯汁）
（一次性紙/塑膠容器均垃圾）


 1週資源:${recycleDisplay}-用一般塑膠袋
（1次最多收取${recycleMax}袋--超量拒收）
（若未裝袋一律拒收）
（請勿用黑色袋子裝資源）
（僅收寶特玻璃鐵鋁罐）
（僅收中小紙板箱壓扁折好）
（僅收書本/乾淨紙張）

⚠️下列物品視為垃圾
（便當盒/塑膠袋/吸管➡️垃圾）
（軟塑膠蓋/吸管➡️垃圾）
（早餐盒/快飲杯➡️垃圾）
（泡棉/雞蛋軟塑膠盒➡️垃圾）
（蛋糕盒/緩衝材料➡️垃圾）

一個月費用：${monthlyFee}元
（上樓代收需提供1樓大門鑰匙）

-
📑配合事項📑
▪垃圾務必打包綁好放置門口
▪如因政策變動需改時間
⬇️將提前告知煩請配合
▪自備雙北市政府專用垃圾袋
▪收款後不退款內容不更改
▪有超量一律拒收

    ⇩

🚨 其他問題 🚨
📄請先完整閱讀報價內容提出
💬客服解決任何問題

    ⇩

⭕解決問題⭕
✔️.上述問題均解決
✔️.上述內容能配合
回覆告知我們：同意✅+開始日

    ⇩

收到_同意✅_後
💧客服➡️提供繳費單
💧客戶➡️完成繳費
💧客服➡️開始代收

⚠️ 注意事項 ⚠️
🔴1分錢1分服務低價無安全保障
🟠近期多起案例請務必留意
🟡年輕專業團隊-流程皆有 SOP
🟢成員平均 30-35 歲皆具良民證
🔵過年及天災人禍停止代收無退款
➡️延至下一次可代收工作日



🌍解決垃圾並不只是收走
⚡我們改變的是城市的運轉速度`;

            return quote;
        }

        function copyAutoQuote() {
            const quoteText = document.getElementById('auto-quote-result-display').textContent;
            
            if (!quoteText) {
                showStatus('auto-quote-copy-status', '❌ 沒有報價單可複製', 'error');
                return;
            }

            navigator.clipboard.writeText(quoteText).then(() => {
                showStatus('auto-quote-copy-status', '✅ 自動報價單已複製到剪貼簿', 'success');
            }).catch(() => {
                showStatus('auto-quote-copy-status', '❌ 複製失敗，請手動選擇複製', 'error');
            });
        }

        // 單趟報價Google試算表讀取功能
        async function fetchSingleQuoteGoogleSheetsData() {
            const sheetsUrl = document.getElementById('single-quote-sheets-url').value.trim();
            
            if (!sheetsUrl) {
                showStatus('single-quote-sheets-status', '❌ 請輸入Google試算表網址', 'error');
                return;
            }

            if (!sheetsUrl.includes('docs.google.com/spreadsheets')) {
                showStatus('single-quote-sheets-status', '❌ 請輸入有效的Google試算表連結', 'error');
                return;
            }

            showStatus('single-quote-sheets-status', '🔄 正在載入試算表資料...', 'success');

            try {
                // 從URL中提取試算表ID
                let spreadsheetId = '';
                const urlMatch = sheetsUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                if (urlMatch) {
                    spreadsheetId = urlMatch[1];
                } else {
                    throw new Error('無法解析試算表ID，請確認URL格式正確');
                }

                // 構建CSV導出URL
                const csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv`;
                
                let response;
                try {
                    response = await fetch(csvUrl, {
                        mode: 'cors',
                        headers: {
                            'Accept': 'text/csv,text/plain'
                        }
                    });
                } catch (corsError) {
                    throw new Error('由於瀏覽器安全限制，無法直接讀取Google試算表。請確認：\n1. 試算表已設為「知道連結的使用者」可檢視\n2. 或手動複製貼上資料');
                }

                if (!response.ok) {
                    if (response.status === 403) {
                        throw new Error('無法存取試算表，請確認分享設定為「知道連結的使用者」可檢視');
                    } else if (response.status === 404) {
                        throw new Error('找不到試算表，請確認網址正確');
                    } else {
                        throw new Error(`載入失敗 (錯誤代碼: ${response.status})`);
                    }
                }

                const csvText = await response.text();
                
                if (!csvText || csvText.trim().length === 0) {
                    throw new Error('試算表資料為空，請確認表格中有資料');
                }

                // CSV解析
                const rows = parseCSV(csvText);
                const filteredRows = rows.filter(row => row.some(cell => cell && cell.length > 0));
                
                if (filteredRows.length === 0) {
                    throw new Error('試算表中沒有找到任何有效資料');
                }

                const updateMode = document.getElementById('single-quote-update-mode').value;
                
                // 取得表頭和資料行
                const headers = filteredRows[0] || [];
                const allDataRows = filteredRows.slice(1);
                
                let dataRows;
                if (updateMode === 'latest') {
                    dataRows = allDataRows.slice(-1);
                } else if (updateMode === 'last-5') {
                    dataRows = allDataRows.slice(-5);
                } else if (updateMode === 'last-10') {
                    dataRows = allDataRows.slice(-10);
                } else if (updateMode === 'last-20') {
                    dataRows = allDataRows.slice(-20);
                } else {
                    dataRows = allDataRows;
                }

                if (dataRows.length === 0) {
                    throw new Error('沒有找到符合條件的資料行');
                }

                // 顯示資料預覽
                displaySingleQuoteData(headers, dataRows);
                showStatus('single-quote-sheets-status', `✅ 成功載入 ${dataRows.length} 行資料`, 'success');

            } catch (error) {
                console.error('載入資料失敗:', error);
                showStatus('single-quote-sheets-status', `❌ ${error.message}`, 'error');
            }
        }

        // 存儲試算表資料供選擇使用
        let singleQuoteTableData = {
            headers: [],
            rows: []
        };

        function displaySingleQuoteData(headers, rows) {
            // 儲存資料供後續使用
            singleQuoteTableData.headers = headers;
            singleQuoteTableData.rows = rows;
            
            const container = document.getElementById('single-quote-detected-data-preview');
            
            let html = '<table style="width: 100%; border-collapse: collapse; font-size: 12px;">';
            
            // 表頭
            html += '<tr style="background: #404040;">';
            headers.forEach(header => {
                html += `<th style="border: 1px solid #666; padding: 8px; text-align: left; color: #fff;">${header}</th>`;
            });
            html += '</tr>';
            
            // 資料行
            rows.forEach((row, index) => {
                const bgColor = index % 2 === 0 ? '#333333' : '#2a2a2a';
                html += `<tr onclick="selectSingleQuoteRowForQuote(${index})" style="cursor: pointer; background: ${bgColor};" class="single-data-row" title="點擊選擇此資料作為報價單來源" onmouseover="this.style.background='#4a4a4a'" onmouseout="this.style.background='${bgColor}'">`;
                row.forEach(cell => {
                    html += `<td style="border: 1px solid #666; padding: 8px; color: #e0e0e0;">${cell || ''}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</table>';
            container.innerHTML = html;
            
            document.getElementById('single-quote-detected-data').style.display = 'block';
            document.getElementById('single-quote-controls').style.display = 'block';
        }

        let singleQuoteSelectedData = null;
        let singleQuoteSelectedRowIndex = -1;

        function selectSingleQuoteRowForQuote(rowIndex) {
            console.log('selectSingleQuoteRow called with index:', rowIndex);
            
            // 使用存儲的資料而不是DOM查詢
            const headers = singleQuoteTableData.headers;
            const rows = singleQuoteTableData.rows;
            const selectedRowData = rows[rowIndex];
            
            console.log('Available headers:', headers);
            console.log('Selected row data:', selectedRowData);
            
            // 同時更新DOM高亮
            const container = document.getElementById('single-quote-detected-data-preview');
            const table = container.querySelector('table');
            const dataRows = Array.from(table.querySelectorAll('tr')).slice(1);
            const selectedRow = dataRows[rowIndex];
            
            if (selectedRow) {
                // 清除之前的選擇高亮
                dataRows.forEach(row => {
                    row.style.border = '';
                });
                
                // 高亮選中的行
                selectedRow.style.border = '3px solid #FFD700';
            }
            
            // 解析選中行的資料
            const fieldMapping = {};
            headers.forEach((header, index) => {
                fieldMapping[header] = selectedRowData[index] || '';
            });
            
            // 智能欄位偵測
            const detectedData = {
                address: '',
                lineName: '',
                serviceTime: '',
                weeklyFrequency: '',
                serviceDays: '',
                housingType: '',
                trashBags: '',
                recycleBags: ''
            };
            
            // 偵測地址 - 擴展偵測條件
            for (const [header, value] of Object.entries(fieldMapping)) {
                if (header.includes('地址') || 
                    (header.includes('收取') && header.includes('地址')) || 
                    header.includes('區域+地址') || 
                    header.includes('收取區域') ||
                    header.includes('正確收取地址') ||
                    header.includes('收取位置') ||
                    header.includes('服務地址')) {
                    detectedData.address = value;
                    break;
                }
            }
            
            // 偵測LINE暱稱 - 擴展偵測條件
            for (const [header, value] of Object.entries(fieldMapping)) {
                if (header.includes('暱稱') || 
                    header.includes('Line') || 
                    header.includes('LINE') || 
                    (header.includes('顯示') && header.includes('暱稱')) || 
                    header.includes('Line顯示') ||
                    header.includes('客戶暱稱') ||
                    header.includes('用戶暱稱')) {
                    detectedData.lineName = value;
                    break;
                }
            }
            
            // 儲存選中的資料
            singleQuoteSelectedData = detectedData;
            singleQuoteSelectedRowIndex = rowIndex;
            
            console.log('Selected row field mapping:', fieldMapping);
            console.log('Detected data:', detectedData);
            
            // 更新所有行樣式
            const allRows = document.querySelectorAll('.single-data-row');
            allRows.forEach((row, index) => {
                if (index === rowIndex) {
                    row.style.border = '3px solid #FFD700';
                    row.style.background = '#4a4a00';
                } else {
                    row.style.border = '';
                    row.style.background = index % 2 === 0 ? '#333333' : '#2a2a2a';
                }
            });
            
            // 顯示偵測結果狀態
            let statusMsg = `✅ 已選擇第 ${rowIndex + 1} 行資料`;
            if (detectedData.address) {
                statusMsg += ` | 地址: ${detectedData.address.substring(0, 20)}...`;
            }
            if (detectedData.lineName) {
                statusMsg += ` | 暱稱: ${detectedData.lineName}`;
            }
            
            showStatus('single-quote-sheets-status', statusMsg, 'success');
        }

        // 日期轉換為包含星期幾的格式
        function formatDateWithWeekday(dateString) {
            if (!dateString) return '待確認';
            
            const date = new Date(dateString);
            const weekdays = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
            const weekday = weekdays[date.getDay()];
            
            // 格式化為 YYYY/MM/DD (星期X)
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            return `${year}/${month}/${day} (${weekday})`;
        }

        // 時間格式轉換
        function formatTime(timeString) {
            if (!timeString || timeString.trim() === '') return '待確認';
            
            // 檢查是否為數字格式的時間 (如 1200-1300完成)
            const timePattern = /(\d{3,4})-(\d{3,4})(.*)$/;
            const match = timeString.match(timePattern);
            
            if (match) {
                const startTime = match[1];
                const endTime = match[2];
                const suffix = match[3] || '';
                
                // 轉換時間格式
                const formatHour = (time, isStart = false) => {
                    const hour = parseInt(time.slice(0, -2));
                    const minute = time.slice(-2);
                    
                    if (hour >= 12) {
                        const displayHour = hour === 12 ? 12 : hour - 12;
                        const period = isStart ? '下午 ' : '';
                        return `${period}${displayHour}：${minute}`;
                    } else {
                        const displayHour = hour === 0 ? 12 : hour;
                        const period = isStart ? '上午 ' : '';
                        return `${period}${displayHour}：${minute}`;
                    }
                };
                
                const startHour = parseInt(startTime.slice(0, -2));
                const endHour = parseInt(endTime.slice(0, -2));
                
                // 判斷時間段，只在開始時間顯示上午/下午
                if (startHour >= 12 && endHour >= 12) {
                    // 都是下午
                    return `下午 ${formatHour(startTime, false)}-${formatHour(endTime, false)}${suffix}`;
                } else if (startHour < 12 && endHour < 12) {
                    // 都是上午
                    return `上午 ${formatHour(startTime, false)}-${formatHour(endTime, false)}${suffix}`;
                } else {
                    // 跨越上午下午
                    return `${formatHour(startTime, true)}-${formatHour(endTime, true)}${suffix}`;
                }
            }
            
            // 如果不是數字格式，直接返回原始文字
            return timeString;
        }

        // 控制費用輸入框顯示/隱藏
        function toggleGroundFeeInput() {
            const type = document.getElementById('single-quote-ground-fee-type').value;
            const input = document.getElementById('single-quote-ground-fee-input');
            input.style.display = type === 'manual' ? 'block' : 'none';
        }

        function toggleUpstairsFeeInput() {
            const type = document.getElementById('single-quote-upstairs-fee-type').value;
            const input = document.getElementById('single-quote-upstairs-fee-input');
            input.style.display = type === 'manual' ? 'block' : 'none';
        }

        // 控制照片描述輸入框顯示/隱藏
        function togglePhotoInput(photoNumber) {
            const type = document.getElementById(`single-quote-photo${photoNumber}-type`).value;
            const input = document.getElementById(`single-quote-photo${photoNumber}-input`);
            input.style.display = type === 'manual' ? 'block' : 'none';
        }

        // 生成單趟垃圾代收報價單
        function generateSingleQuote() {
            try {
                // 獲取費用資料
                const groundFeeType = document.getElementById('single-quote-ground-fee-type').value;
                const upstairsFeeType = document.getElementById('single-quote-upstairs-fee-type').value;
                
                const groundFee = groundFeeType === 'manual' ? 
                    (document.getElementById('single-quote-ground-fee').value || '300') : null;
                const upstairsFee = upstairsFeeType === 'manual' ? 
                    (document.getElementById('single-quote-upstairs-fee').value || '500') : null;
                
                const upstairsOption = document.getElementById('single-quote-upstairs-option').value || '有/無/自選';
                const dateRaw = document.getElementById('single-quote-date').value;
                const timeRaw = document.getElementById('single-quote-time').value;
                
                // 格式化日期和時間
                const date = formatDateWithWeekday(dateRaw);
                const time = formatTime(timeRaw);
                
                // 獲取照片描述 - 只收集有選擇手動填寫且有內容的
                const photos = [];
                for (let i = 1; i <= 10; i++) {
                    const type = document.getElementById(`single-quote-photo${i}-type`).value;
                    if (type === 'manual') {
                        const content = document.getElementById(`single-quote-photo${i}`).value;
                        if (content && content.trim() !== '') {
                            photos.push(content.trim());
                        }
                    }
                }

                // 從選中的試算表資料中獲取地址和LINE暱稱
                const address = singleQuoteSelectedData ? singleQuoteSelectedData.address : '';
                const lineName = singleQuoteSelectedData ? singleQuoteSelectedData.lineName : '';
                
                console.log('Generate quote - Address:', address);
                console.log('Generate quote - Line Name:', lineName);
                console.log('singleQuoteSelectedData:', singleQuoteSelectedData);

                // 生成報價單
                const quote = generateSingleQuoteTemplate({
                    groundFee,
                    upstairsFee,
                    upstairsOption,
                    date,
                    time,
                    photos,
                    address,
                    lineName
                });

                // 顯示結果
                document.getElementById('single-quote-result-display').textContent = quote;
                document.getElementById('single-quote-output').style.display = 'block';
                
                showStatus('single-quote-copy-status', '✅ 單趟垃圾代收報價單已生成', 'success');

            } catch (error) {
                showStatus('single-quote-copy-status', `❌ 生成失敗: ${error.message}`, 'error');
            }
        }

        // 單趟垃圾代收報價單範本
        function generateSingleQuoteTemplate(data) {
            const {groundFee, upstairsFee, upstairsOption, date, time, photos, address, lineName} = data;
            
            console.log('Template generation - Address:', address);
            console.log('Template generation - Line Name:', lineName);
            console.log('Template generation - Full data:', data);
            
            let quote = ``;

            // 如果有LINE暱稱，顯示在最上方
            if (lineName) {
                quote += `LINE暱稱：${lineName}\n`;
                console.log('Added line name to quote');
            }
            
            // 如果有地址，顯示在暱稱下方
            if (address) {
                quote += `地址：${address}\n`;
                console.log('Added address to quote');
            }
            
            // 如果有住宅性質，從選中資料中取得
            if (singleQuoteSelectedData && singleQuoteSelectedData.housingType) {
                quote += `住宅性質：${singleQuoteSelectedData.housingType}\n`;
                console.log('Added housing type to quote');
            }
            
            // 如果有任何客戶資訊，添加分隔線，然後加上標題
            if (lineName || address || (singleQuoteSelectedData && singleQuoteSelectedData.housingType)) {
                quote += `\n------------------------------------\n\n🔥單趟垃圾代收🔥

`;
                console.log('Added separator line and title');
            } else {
                quote += `🔥單趟垃圾代收🔥

`;
            }
            
            quote += `🗑️垃圾資源🗑️：

`;

            // 添加照片描述 - 只顯示有內容的照片
            if (photos && photos.length > 0) {
                photos.forEach((photo, index) => {
                    quote += `${index + 1}.圖${index + 1}：${photo}\n`;
                });
            }

            quote += `


⚠️代收規範⚠️
依照片主體代收
範圍請劃線標示
事業廢棄物拒收
僅收一般生活垃圾
超量/超數/超趟=拒收

☝️注意事項☝️
1分錢1分服務
合法代收方式
互助互利互相`;

            // 只顯示有設定費用的方案
            if (groundFee) {
                quote += `

方案1
💰放置一樓代收費用：${groundFee}元`;
            }
            
            if (upstairsFee) {
                quote += `
方案2
💰上樓費用代收費用：${upstairsFee}元`;
            }

            quote += `

🔥執行日期：${date}
🔥執行時間：${time}

✅同意上述內容後請回覆
✅將開立繳費單
✅20 分內完成繳費
✅提供電話與姓名
✅單趟預約即完成
✅收款後費用無法退款
✅收款後內容無法更改

📸照片與回報規範
1️⃣置放1樓者
🖼提供完整照片
📩並回傳給客服
2️⃣上樓者：無需回傳
3️⃣置放完畢即可離開
4️⃣代收完成後會回報

🌍解決垃圾並不只是收走
⚡我們改變的是城市的運轉速度`;

            return quote;
        }

        // 複製單趟報價單
        function copySingleQuote() {
            const quoteText = document.getElementById('single-quote-result-display').textContent;
            
            if (!quoteText) {
                showStatus('single-quote-copy-status', '❌ 沒有報價單可複製', 'error');
                return;
            }

            navigator.clipboard.writeText(quoteText).then(() => {
                showStatus('single-quote-copy-status', '✅ 單趟垃圾代收報價單已複製到剪貼簿', 'success');
            }).catch(() => {
                showStatus('single-quote-copy-status', '❌ 複製失敗，請手動選擇複製', 'error');
            });
        }

        // 單趟報價歷史網址管理
        function saveSingleQuoteUrlToHistory() {
            const url = document.getElementById('single-quote-sheets-url').value.trim();
            if (!url) return;
            
            let savedUrls = JSON.parse(localStorage.getItem('singleQuoteSavedUrls') || '[]');
            
            // 檢查是否已存在相同網址
            const existingIndex = savedUrls.findIndex(item => (typeof item === 'string' ? item : item.url) === url);
            
            if (existingIndex === -1) {
                // 新增網址，詢問自定義名稱
                const customName = prompt('請為此網址設定一個自定義名稱（可選，直接按確定使用預設名稱）：', `單趟試算表 ${savedUrls.length + 1}`);
                const urlData = {
                    url: url,
                    name: customName && customName.trim() !== '' ? customName.trim() : `單趟試算表 ${savedUrls.length + 1}`,
                    dateAdded: new Date().toLocaleDateString('zh-TW')
                };
                
                // 新增到最前面
                savedUrls.unshift(urlData);
                
                // 保留最多10筆記錄
                savedUrls = savedUrls.slice(0, 10);
                
                // 儲存到localStorage
                localStorage.setItem('singleQuoteSavedUrls', JSON.stringify(savedUrls));
                
                showStatus('single-quote-sheets-status', `✅ 網址已儲存為「${urlData.name}」`, 'success');
            } else {
                // 網址已存在，移到最前面
                const existingItem = savedUrls.splice(existingIndex, 1)[0];
                savedUrls.unshift(existingItem);
                localStorage.setItem('singleQuoteSavedUrls', JSON.stringify(savedUrls));
                
                const itemName = typeof existingItem === 'string' ? '單趟試算表' : existingItem.name;
                showStatus('single-quote-sheets-status', `✅ 網址「${itemName}」已移至最上方`, 'success');
            }
            
            // 更新下拉選單
            updateSingleQuoteSavedUrlsDropdown();
        }

        function loadSingleQuoteSavedUrl() {
            const select = document.getElementById('single-quote-saved-urls');
            const selectedValue = select.value;
            
            if (selectedValue) {
                document.getElementById('single-quote-sheets-url').value = selectedValue;
                select.value = ''; // 清空選擇
                
                // 自動觸發儲存功能，將選取的網址移到最前面
                saveSingleQuoteUrlToHistory();
            }
        }

        function updateSingleQuoteSavedUrlsDropdown() {
            const select = document.getElementById('single-quote-saved-urls');
            const savedUrls = JSON.parse(localStorage.getItem('singleQuoteSavedUrls') || '[]');
            
            // 清空現有選項（保留第一個空選項）
            select.innerHTML = '<option value="">選擇歷史網址</option>';
            
            // 加入儲存的網址
            savedUrls.forEach((item, index) => {
                const option = document.createElement('option');
                
                if (typeof item === 'string') {
                    // 舊格式相容性
                    option.value = item;
                    option.textContent = `${index + 1}. ${item.length > 45 ? item.substring(0, 45) + '...' : item}`;
                } else {
                    // 新格式，顯示自定義名稱和日期
                    option.value = item.url;
                    option.textContent = `${index + 1}. ${item.name} (${item.dateAdded})`;
                }
                
                select.appendChild(option);
            });
            
            // 更新管理列表
            updateSingleQuoteUrlManagerList();
        }

        function updateSingleQuoteUrlManagerList() {
            const container = document.getElementById('single-quote-url-manager');
            if (!container) return;
            
            const savedUrls = JSON.parse(localStorage.getItem('singleQuoteSavedUrls') || '[]');
            
            if (savedUrls.length === 0) {
                container.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">暫無儲存的網址</div>';
                return;
            }
            
            let html = '<div style="max-height: 300px; overflow-y: auto;">';
            savedUrls.forEach((item, index) => {
                let displayText, fullUrl;
                
                if (typeof item === 'string') {
                    // 舊格式相容性
                    displayText = `${index + 1}. ${item}`;
                    fullUrl = item;
                } else {
                    // 新格式，顯示自定義名稱和儲存日期
                    displayText = `${index + 1}. ${item.name} (${item.dateAdded})`;
                    fullUrl = item.url;
                }
                
                html += `
                    <div style="display: flex; align-items: center; margin-bottom: 10px; padding: 10px; background: #333; border-radius: 5px;">
                        <div style="flex: 1; margin-right: 10px;">
                            <div style="color: #fff; font-weight: bold; margin-bottom: 5px;">
                                ${displayText}
                            </div>
                            <div style="color: #aaa; font-size: 11px; word-break: break-all;">
                                ${fullUrl}
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="editSingleQuoteUrlName(${index})" style="background: #28a745; color: white; border: none; padding: 5px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">改名</button>
                            <button onclick="editSingleQuoteUrl(${index})" style="background: #007bff; color: white; border: none; padding: 5px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">編輯</button>
                            <button onclick="deleteSingleQuoteUrl(${index})" style="background: #dc3545; color: white; border: none; padding: 5px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">刪除</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function editSingleQuoteUrlName(index) {
            const savedUrls = JSON.parse(localStorage.getItem('singleQuoteSavedUrls') || '[]');
            if (index >= savedUrls.length) return;
            
            const item = savedUrls[index];
            let currentName;
            
            if (typeof item === 'string') {
                currentName = `單趟試算表 ${index + 1}`;
                // 升級舊格式到新格式
                savedUrls[index] = {
                    url: item,
                    name: currentName,
                    dateAdded: new Date().toLocaleDateString('zh-TW')
                };
            } else {
                currentName = item.name;
            }
            
            const newName = prompt('編輯名稱：', currentName);
            
            if (newName && newName.trim() !== '' && newName.trim() !== currentName) {
                savedUrls[index].name = newName.trim();
                localStorage.setItem('singleQuoteSavedUrls', JSON.stringify(savedUrls));
                updateSingleQuoteSavedUrlsDropdown();
                showStatus('single-quote-sheets-status', '✅ 名稱已更新', 'success');
            }
        }

        function editSingleQuoteUrl(index) {
            const savedUrls = JSON.parse(localStorage.getItem('singleQuoteSavedUrls') || '[]');
            if (index >= savedUrls.length) return;
            
            const item = savedUrls[index];
            const oldUrl = typeof item === 'string' ? item : item.url;
            const newUrl = prompt('編輯網址：', oldUrl);
            
            if (newUrl && newUrl.trim() !== '' && newUrl.trim() !== oldUrl) {
                if (typeof item === 'string') {
                    // 升級舊格式到新格式
                    savedUrls[index] = {
                        url: newUrl.trim(),
                        name: `單趟試算表 ${index + 1}`,
                        dateAdded: new Date().toLocaleDateString('zh-TW')
                    };
                } else {
                    savedUrls[index].url = newUrl.trim();
                }
                
                localStorage.setItem('singleQuoteSavedUrls', JSON.stringify(savedUrls));
                updateSingleQuoteSavedUrlsDropdown();
                showStatus('single-quote-sheets-status', '✅ 網址已更新', 'success');
            }
        }

        function deleteSingleQuoteUrl(index) {
            const savedUrls = JSON.parse(localStorage.getItem('singleQuoteSavedUrls') || '[]');
            if (index >= savedUrls.length) return;
            
            const item = savedUrls[index];
            const itemName = typeof item === 'string' ? '單趟試算表' : item.name;
            
            if (confirm(`確定要刪除「${itemName}」嗎？`)) {
                savedUrls.splice(index, 1);
                localStorage.setItem('singleQuoteSavedUrls', JSON.stringify(savedUrls));
                updateSingleQuoteSavedUrlsDropdown();
                showStatus('single-quote-sheets-status', `✅ 「${itemName}」已刪除`, 'success');
            }
        }

        function clearAllSingleQuoteUrls() {
            if (confirm('確定要清空所有歷史網址嗎？此操作無法復原。')) {
                localStorage.removeItem('singleQuoteSavedUrls');
                updateSingleQuoteSavedUrlsDropdown();
                showStatus('single-quote-sheets-status', '✅ 所有歷史網址已清空', 'success');
            }
        }

        function toggleSingleQuoteUrlManager() {
            const manager = document.getElementById('single-quote-url-manager');
            const button = document.getElementById('single-quote-manage-urls-btn');
            
            if (manager.style.display === 'none' || !manager.style.display) {
                manager.style.display = 'block';
                button.textContent = '隱藏歷史網址管理';
                updateSingleQuoteUrlManagerList();
            } else {
                manager.style.display = 'none';
                button.textContent = '管理歷史網址';
            }
        }

        // 清空單趟報價表單
        function clearSingleQuoteForm() {
            // 清空Google試算表網址
            document.getElementById('single-quote-sheets-url').value = '';
            document.getElementById('single-quote-saved-urls').value = '';
            
            // 重置費用設定
            document.getElementById('single-quote-ground-fee-type').value = 'none';
            document.getElementById('single-quote-upstairs-fee-type').value = 'none';
            document.getElementById('single-quote-ground-fee').value = '';
            document.getElementById('single-quote-upstairs-fee').value = '';
            document.getElementById('single-quote-ground-fee-input').style.display = 'none';
            document.getElementById('single-quote-upstairs-fee-input').style.display = 'none';
            
            // 清空基本設定
            document.getElementById('single-quote-upstairs-option').value = '有/無/自選';
            document.getElementById('single-quote-date').value = '';
            document.getElementById('single-quote-time').value = '';
            
            // 重置照片描述 (1-10)
            for (let i = 1; i <= 10; i++) {
                document.getElementById(`single-quote-photo${i}-type`).value = 'none';
                document.getElementById(`single-quote-photo${i}`).value = '';
                document.getElementById(`single-quote-photo${i}-input`).style.display = 'none';
            }
            
            // 隱藏輸出區域
            document.getElementById('single-quote-detected-data').style.display = 'none';
            document.getElementById('single-quote-controls').style.display = 'none';
            document.getElementById('single-quote-output').style.display = 'none';
            document.getElementById('single-quote-sheets-status').style.display = 'none';
            document.getElementById('single-quote-final-status').style.display = 'none';
        }

        // Removed duplicate DOMContentLoaded - using unified one below

        // 包月自動報價歷史網址管理
        function saveUrlToHistory() {
            const url = document.getElementById('sheets-url').value.trim();
            if (!url) return;
            
            let savedUrls = JSON.parse(localStorage.getItem('autoQuoteSavedUrls') || '[]');
            
            // 檢查是否已存在相同網址
            const existingIndex = savedUrls.findIndex(item => (typeof item === 'string' ? item : item.url) === url);
            
            if (existingIndex === -1) {
                // 新增網址，詢問自定義名稱
                const customName = prompt('請為此網址設定一個自定義名稱（可選，直接按確定使用預設名稱）：', `試算表 ${savedUrls.length + 1}`);
                const urlData = {
                    url: url,
                    name: customName && customName.trim() !== '' ? customName.trim() : `試算表 ${savedUrls.length + 1}`,
                    dateAdded: new Date().toLocaleDateString('zh-TW')
                };
                
                // 新增到最前面
                savedUrls.unshift(urlData);
                
                // 保留最多10筆記錄
                savedUrls = savedUrls.slice(0, 10);
                
                // 儲存到localStorage
                localStorage.setItem('autoQuoteSavedUrls', JSON.stringify(savedUrls));
                
                showStatus('auto-sheets-status', `✅ 網址已儲存為「${urlData.name}」`, 'success');
            } else {
                // 網址已存在，移到最前面
                const existingItem = savedUrls.splice(existingIndex, 1)[0];
                savedUrls.unshift(existingItem);
                localStorage.setItem('autoQuoteSavedUrls', JSON.stringify(savedUrls));
                
                const itemName = typeof existingItem === 'string' ? '試算表' : existingItem.name;
                showStatus('auto-sheets-status', `✅ 網址「${itemName}」已移至最上方`, 'success');
            }
            
            // 更新下拉選單
            updateSavedUrlsDropdown();
        }

        function loadSavedUrl() {
            const select = document.getElementById('saved-urls');
            const selectedValue = select.value;
            
            if (selectedValue) {
                document.getElementById('sheets-url').value = selectedValue;
                select.value = ''; // 清空選擇
                
                // 自動觸發儲存功能，將選取的網址移到最前面
                saveUrlToHistory();
            }
        }

        function updateSavedUrlsDropdown() {
            const select = document.getElementById('saved-urls');
            const savedUrls = JSON.parse(localStorage.getItem('autoQuoteSavedUrls') || '[]');
            
            // 清空現有選項（保留第一個空選項）
            select.innerHTML = '<option value="">選擇歷史網址</option>';
            
            // 加入儲存的網址
            savedUrls.forEach((item, index) => {
                const option = document.createElement('option');
                
                if (typeof item === 'string') {
                    // 舊格式相容性
                    option.value = item;
                    option.textContent = `${index + 1}. ${item.length > 45 ? item.substring(0, 45) + '...' : item}`;
                } else {
                    // 新格式，包含自定義名稱
                    option.value = item.url;
                    option.textContent = `${index + 1}. ${item.name} (${item.dateAdded})`;
                }
                
                select.appendChild(option);
            });
            
            // 更新管理列表
            updateUrlManagerList();
        }

        function updateUrlManagerList() {
            const container = document.getElementById('url-manager');
            if (!container) return;
            
            const savedUrls = JSON.parse(localStorage.getItem('autoQuoteSavedUrls') || '[]');
            
            if (savedUrls.length === 0) {
                container.innerHTML = '<div style="color: #888; text-align: center; padding: 20px;">暫無儲存的網址</div>';
                return;
            }
            
            let html = '<div style="max-height: 300px; overflow-y: auto;">';
            savedUrls.forEach((item, index) => {
                let displayText, fullUrl;
                
                if (typeof item === 'string') {
                    // 舊格式相容性
                    displayText = `${index + 1}. ${item}`;
                    fullUrl = item;
                } else {
                    // 新格式，顯示自定義名稱和儲存日期
                    displayText = `${index + 1}. ${item.name} (${item.dateAdded})`;
                    fullUrl = item.url;
                }
                
                html += `
                    <div style="display: flex; align-items: center; margin-bottom: 10px; padding: 10px; background: #333; border-radius: 5px;">
                        <div style="flex: 1; margin-right: 10px;">
                            <div style="color: #fff; font-weight: bold; margin-bottom: 5px;">
                                ${displayText}
                            </div>
                            <div style="color: #aaa; font-size: 11px; word-break: break-all;">
                                ${fullUrl}
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="editUrlName(${index})" style="background: #28a745; color: white; border: none; padding: 5px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">改名</button>
                            <button onclick="editUrl(${index})" style="background: #007bff; color: white; border: none; padding: 5px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">編輯</button>
                            <button onclick="deleteUrl(${index})" style="background: #dc3545; color: white; border: none; padding: 5px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">刪除</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function editUrlName(index) {
            const savedUrls = JSON.parse(localStorage.getItem('autoQuoteSavedUrls') || '[]');
            if (index >= savedUrls.length) return;
            
            const item = savedUrls[index];
            let currentName;
            
            if (typeof item === 'string') {
                currentName = `試算表 ${index + 1}`;
                // 升級舊格式到新格式
                savedUrls[index] = {
                    url: item,
                    name: currentName,
                    dateAdded: new Date().toLocaleDateString('zh-TW')
                };
            } else {
                currentName = item.name;
            }
            
            const newName = prompt('編輯名稱：', currentName);
            
            if (newName && newName.trim() !== '' && newName.trim() !== currentName) {
                savedUrls[index].name = newName.trim();
                localStorage.setItem('autoQuoteSavedUrls', JSON.stringify(savedUrls));
                updateSavedUrlsDropdown();
                showStatus('auto-sheets-status', '✅ 名稱已更新', 'success');
            }
        }

        function editUrl(index) {
            const savedUrls = JSON.parse(localStorage.getItem('autoQuoteSavedUrls') || '[]');
            if (index >= savedUrls.length) return;
            
            const item = savedUrls[index];
            const oldUrl = typeof item === 'string' ? item : item.url;
            const newUrl = prompt('編輯網址：', oldUrl);
            
            if (newUrl && newUrl.trim() !== '' && newUrl.trim() !== oldUrl) {
                if (typeof item === 'string') {
                    // 升級舊格式到新格式
                    savedUrls[index] = {
                        url: newUrl.trim(),
                        name: `試算表 ${index + 1}`,
                        dateAdded: new Date().toLocaleDateString('zh-TW')
                    };
                } else {
                    savedUrls[index].url = newUrl.trim();
                }
                
                localStorage.setItem('autoQuoteSavedUrls', JSON.stringify(savedUrls));
                updateSavedUrlsDropdown();
                showStatus('auto-sheets-status', '✅ 網址已更新', 'success');
            }
        }

        function deleteUrl(index) {
            const savedUrls = JSON.parse(localStorage.getItem('autoQuoteSavedUrls') || '[]');
            if (index >= savedUrls.length) return;
            
            const item = savedUrls[index];
            const itemName = typeof item === 'string' ? '試算表' : item.name;
            
            if (confirm(`確定要刪除「${itemName}」嗎？`)) {
                savedUrls.splice(index, 1);
                localStorage.setItem('autoQuoteSavedUrls', JSON.stringify(savedUrls));
                updateSavedUrlsDropdown();
                showStatus('auto-sheets-status', `✅ 「${itemName}」已刪除`, 'success');
            }
        }

        function clearAllUrls() {
            if (confirm('確定要清空所有歷史網址嗎？此操作無法復原。')) {
                localStorage.removeItem('autoQuoteSavedUrls');
                updateSavedUrlsDropdown();
                showStatus('auto-sheets-status', '✅ 所有歷史網址已清空', 'success');
            }
        }

        function toggleUrlManager() {
            const manager = document.getElementById('url-manager');
            const button = document.getElementById('manage-urls-btn');
            
            if (manager.style.display === 'none' || !manager.style.display) {
                manager.style.display = 'block';
                button.textContent = '隱藏歷史網址管理';
                updateUrlManagerList();
            } else {
                manager.style.display = 'none';
                button.textContent = '管理歷史網址';
            }
        }

        // 網址記憶功能 (舊版已被新版取代)




        // 控制更新模式UI（目前無需額外輸入欄位）
        function toggleCustomRowInput() {
            // 所有模式都不需要額外輸入欄位
        }

        // 選擇特定行作為報價單來源
        function selectRowForQuote(rowIndex) {
            if (!autoQuoteData || !autoQuoteData.rows || rowIndex >= autoQuoteData.rows.length) {
                showStatus('auto-quote-final-status', '❌ 無效的資料行選擇', 'error');
                return;
            }

            showStatus('auto-quote-final-status', `🔄 正在使用第${rowIndex + 1}行資料生成報價單...`, 'success');

            try {
                // 移除之前選中行的高亮
                document.querySelectorAll('.data-row').forEach(row => {
                    row.style.border = '';
                    row.style.boxShadow = '';
                });

                // 高亮選中的行
                const selectedRow = document.querySelector(`tr[onclick="selectRowForQuote(${rowIndex})"]`);
                if (selectedRow) {
                    selectedRow.style.border = '2px solid #ffd700';
                    selectedRow.style.boxShadow = '0 0 10px rgba(255, 215, 0, 0.3)';
                }

                const selectedRowData = autoQuoteData.rows[rowIndex];
                const headers = autoQuoteData.headers;

                // 獲取手動輸入的資料
                const selectedDays = Array.from(document.querySelectorAll('input[name="manual-days"]:checked')).map(cb => cb.value);
                const manualData = {
                    lineName: '',
                    address: '',
                    housingType: '',
                    monthlyFee: document.getElementById('manual-fee').value || '',
                    serviceDays: selectedDays.join('、') || '',
                    serviceTime: document.getElementById('manual-time').value || '',
                    floor: document.getElementById('manual-floor').value || '',
                    frequency: document.getElementById('manual-frequency').value || '',
                    trashBags: document.getElementById('manual-trash').value || '',
                    recycleBags: document.getElementById('manual-recycle').value || '',
                    trashVolume: document.getElementById('manual-trash-volume').value || '',
                    recycleVolume: document.getElementById('manual-recycle-volume').value || '',
                    trashMax: document.getElementById('manual-trash-max').value || '',
                    recycleMax: document.getElementById('manual-recycle-max').value || '',
                    specialNotes: document.getElementById('manual-special-notes').value || ''
                };

                const fieldMapping = {};
                let trashData = { bags: '', volume: '' };
                let recycleData = { bags: '', volume: '' };

                // 處理選中行的資料（使用與generateAutoQuote相同的邏輯）
                headers.forEach((header, index) => {
                    const lowerHeader = header.toLowerCase();
                    const cellValue = selectedRowData[index];

                    if (lowerHeader.includes('line') || lowerHeader.includes('暱稱')) {
                        fieldMapping.lineName = cellValue;
                    } else if (lowerHeader.includes('地址')) {
                        fieldMapping.address = cellValue;
                        if (cellValue && (!manualData.floor || manualData.floor.trim() === '')) {
                            const floorMatch = cellValue.match(/(\d+)[樓F]/);
                            if (floorMatch) {
                                fieldMapping.floor = floorMatch[1];
                                document.getElementById('manual-floor').value = floorMatch[1];
                            }
                        }
                    } else if (lowerHeader.includes('住宅') || lowerHeader.includes('性質')) {
                        fieldMapping.housingType = cellValue;
                    } else if (lowerHeader.includes('月費') || lowerHeader.includes('費用')) {
                        fieldMapping.monthlyFee = (manualData.monthlyFee && manualData.monthlyFee.trim() !== '') ? manualData.monthlyFee : cellValue;
                    } else if (lowerHeader.includes('星期') || lowerHeader.includes('收取')) {
                        if (cellValue && cellValue.trim() !== '') {
                            const frequencyMatch = cellValue.match(/(\d+)/);
                            if (frequencyMatch) {
                                fieldMapping.weeklyFrequency = `一週趟數：${frequencyMatch[1]}趟`;
                            } else {
                                fieldMapping.weeklyFrequency = `一週趟數：${cellValue}趟`;
                            }
                        }
                        fieldMapping.serviceDays = manualData.serviceDays;
                    } else if (lowerHeader.includes('時間')) {
                        fieldMapping.serviceTime = (manualData.serviceTime && manualData.serviceTime.trim() !== '') ? manualData.serviceTime : cellValue;
                    } else if (lowerHeader.includes('樓層')) {
                        fieldMapping.floor = (manualData.floor && manualData.floor.trim() !== '') ? manualData.floor : ((cellValue && cellValue.trim() !== '') ? cellValue : '0');
                    } else if (lowerHeader.includes('垃圾')) {
                        if (cellValue && cellValue.trim() !== '') {
                            const bagMatch = cellValue.match(/(\d+)包/);
                            const headerVolumeMatch = header.match(/(\d+(?:\/\d+)?公升)/);
                            if (bagMatch) {
                                trashData.bags = bagMatch[1];
                                if (headerVolumeMatch) {
                                    trashData.volume = headerVolumeMatch[1];
                                }
                            }
                        }
                    } else if (lowerHeader.includes('資源')) {
                        if (cellValue && cellValue.trim() !== '') {
                            const bagMatch = cellValue.match(/(\d+)包/);
                            const headerVolumeMatch = header.match(/(\d+(?:\/\d+)?公升)/);
                            if (bagMatch) {
                                recycleData.bags = bagMatch[1];
                                if (headerVolumeMatch) {
                                    recycleData.volume = headerVolumeMatch[1];
                                }
                            }
                        }
                    }
                });

                // 組合垃圾袋和資源袋資料
                if (manualData.trashBags || manualData.trashVolume) {
                    if (manualData.trashBags && manualData.trashVolume) {
                        fieldMapping.trashBags = `${manualData.trashBags}包數（${manualData.trashVolume}）`;
                    } else if (manualData.trashBags) {
                        fieldMapping.trashBags = `${manualData.trashBags}包數（14公升）`;
                    } else {
                        fieldMapping.trashBags = `6包數（${manualData.trashVolume}）`;
                    }
                } else if (trashData.bags && trashData.volume) {
                    fieldMapping.trashBags = `${trashData.bags}包（${trashData.volume}）`;
                } else if (trashData.bags) {
                    fieldMapping.trashBags = `${trashData.bags}包（14公升）`;
                } else {
                    fieldMapping.trashBags = '6包（14公升）';
                }

                if (manualData.recycleBags || manualData.recycleVolume) {
                    if (manualData.recycleBags && manualData.recycleVolume) {
                        fieldMapping.recycleBags = `${manualData.recycleBags}包數（${manualData.recycleVolume}）`;
                    } else if (manualData.recycleBags) {
                        fieldMapping.recycleBags = `${manualData.recycleBags}包數（14公升）`;
                    } else {
                        fieldMapping.recycleBags = `3包數（${manualData.recycleVolume}）`;
                    }
                } else if (recycleData.bags && recycleData.volume) {
                    fieldMapping.recycleBags = `${recycleData.bags}包（${recycleData.volume}）`;
                } else if (recycleData.bags) {
                    fieldMapping.recycleBags = `${recycleData.bags}包（14公升）`;
                } else {
                    fieldMapping.recycleBags = '3包（14公升）';
                }

                console.log(`Selected row ${rowIndex + 1} field mapping:`, fieldMapping);

                const quote = generateQuoteFromData(fieldMapping);
                document.getElementById('auto-quote-result-display').textContent = quote;
                document.getElementById('auto-quote-output').style.display = 'block';

                showStatus('auto-quote-final-status', `✅ 已使用第${rowIndex + 1}行資料生成報價單！`, 'success');

            } catch (error) {
                showStatus('auto-quote-final-status', `❌ 生成失敗: ${error.message}`, 'error');
            }
        }

        // 頁面載入時初始化網址下拉選單
        document.addEventListener('DOMContentLoaded', function() {
            updateSingleQuoteSavedUrlsDropdown();
            updateSavedUrlsDropdown();
            showTab('auto-quote'); // Initialize first tab as active
            loadVendorData(); // 載入外部價格資料
        });

        // ========== 外部價格管理功能 ==========
        
        // 外部價格資料
        const defaultVendorData = [
            // 我來科技
            {
                vendorName: "我來科技",
                planName: "小資方案",
                weeklyFreq: "1",
                otherVolume: "22X2",
                ourConvert14: "25X1+25X1",
                ourConvert25: "14X2+14X2",
                originalPrice: "480",
                discount1m: "470",
                discount3m: "",
                discount6m: ""
            },
            {
                vendorName: "我來科技",
                planName: "家庭方案",
                weeklyFreq: "2",
                otherVolume: "22X4",
                ourConvert14: "25X2+25X2",
                ourConvert25: "14X4+14X4",
                originalPrice: "980",
                discount1m: "960",
                discount3m: "",
                discount6m: ""
            },
            {
                vendorName: "我來科技",
                planName: "家庭方案",
                weeklyFreq: "3",
                otherVolume: "22X6",
                ourConvert14: "25X3+25X3",
                ourConvert25: "14X6+14X6",
                originalPrice: "1,480",
                discount1m: "1,450",
                discount3m: "",
                discount6m: ""
            },
            // 垃可
            {
                vendorName: "垃可",
                planName: "小資方案",
                weeklyFreq: "1",
                otherVolume: "30X1",
                ourConvert14: "14X1+14X1",
                ourConvert25: "25X1",
                originalPrice: "380",
                discount1m: "無",
                discount3m: "361",
                discount6m: "342"
            },
            {
                vendorName: "垃可",
                planName: "小資方案",
                weeklyFreq: "2",
                otherVolume: "30X2",
                ourConvert14: "14X2+14X2",
                ourConvert25: "25X1+25X1",
                originalPrice: "760",
                discount1m: "無",
                discount3m: "722",
                discount6m: "684"
            },
            {
                vendorName: "垃可",
                planName: "小資方案",
                weeklyFreq: "3",
                otherVolume: "30X3",
                ourConvert14: "14X3+14X3",
                ourConvert25: "25X2+25X1",
                originalPrice: "1,140",
                discount1m: "無",
                discount3m: "1,083",
                discount6m: "1,026"
            },
            {
                vendorName: "垃可",
                planName: "小資方案",
                weeklyFreq: "4",
                otherVolume: "30X4",
                ourConvert14: "14X4+14X4",
                ourConvert25: "25X2+25X2",
                originalPrice: "1,440",
                discount1m: "無",
                discount3m: "1,368",
                discount6m: "1,296"
            },
            {
                vendorName: "垃可",
                planName: "小資方案",
                weeklyFreq: "5",
                otherVolume: "30X5",
                ourConvert14: "14X5+14X5",
                ourConvert25: "25X3+25X2",
                originalPrice: "1,800",
                discount1m: "無",
                discount3m: "1,710",
                discount6m: "1,620"
            },
            {
                vendorName: "垃可",
                planName: "家庭方案",
                weeklyFreq: "1",
                otherVolume: "60X1",
                ourConvert14: "14X2+14X2",
                ourConvert25: "25X1+25X1",
                originalPrice: "560",
                discount1m: "無",
                discount3m: "532",
                discount6m: "504"
            },
            {
                vendorName: "垃可",
                planName: "家庭方案",
                weeklyFreq: "2",
                otherVolume: "60X2",
                ourConvert14: "14X4+14X4",
                ourConvert25: "25X2+25X2",
                originalPrice: "1,120",
                discount1m: "無",
                discount3m: "1,064",
                discount6m: "1,008"
            },
            {
                vendorName: "垃可",
                planName: "家庭方案",
                weeklyFreq: "3",
                otherVolume: "60X3",
                ourConvert14: "14X6+14X6",
                ourConvert25: "25X4+25X2",
                originalPrice: "1,680",
                discount1m: "無",
                discount3m: "1,596",
                discount6m: "1,512"
            },
            {
                vendorName: "垃可",
                planName: "家庭方案",
                weeklyFreq: "4",
                otherVolume: "60X4",
                ourConvert14: "14X8+14X8",
                ourConvert25: "25X4+25X4",
                originalPrice: "2,160",
                discount1m: "無",
                discount3m: "2,052",
                discount6m: "1,944"
            },
            {
                vendorName: "垃可",
                planName: "家庭方案",
                weeklyFreq: "5",
                otherVolume: "60X5",
                ourConvert14: "14X10+14X10",
                ourConvert25: "25X6+25X4",
                originalPrice: "2,700",
                discount1m: "無",
                discount3m: "2,565",
                discount6m: "2,430"
            },
            {
                vendorName: "垃可",
                planName: "商務方案",
                weeklyFreq: "1",
                otherVolume: "76X1",
                ourConvert14: "33X1+33X1",
                ourConvert25: "25X2+25X1",
                originalPrice: "800",
                discount1m: "無",
                discount3m: "760",
                discount6m: "720"
            },
            {
                vendorName: "垃可",
                planName: "商務方案",
                weeklyFreq: "2",
                otherVolume: "76X2",
                ourConvert14: "33X2+33X2",
                ourConvert25: "25X4+25X2",
                originalPrice: "1,600",
                discount1m: "無",
                discount3m: "1,520",
                discount6m: "1,440"
            },
            {
                vendorName: "垃可",
                planName: "商務方案",
                weeklyFreq: "3",
                otherVolume: "76X3",
                ourConvert14: "33X3+33X3",
                ourConvert25: "25X6+25X3",
                originalPrice: "2,400",
                discount1m: "無",
                discount3m: "2,280",
                discount6m: "2,160"
            },
            {
                vendorName: "垃可",
                planName: "商務方案",
                weeklyFreq: "4",
                otherVolume: "76X4",
                ourConvert14: "33X4+33X4",
                ourConvert25: "25X8+25X4",
                originalPrice: "3,040",
                discount1m: "無",
                discount3m: "2,888",
                discount6m: "2,736"
            },
            {
                vendorName: "垃可",
                planName: "商務方案",
                weeklyFreq: "5",
                otherVolume: "76X5",
                ourConvert14: "33X5+33X5",
                ourConvert25: "25X10+25X5",
                originalPrice: "3,800",
                discount1m: "無",
                discount3m: "3,610",
                discount6m: "3,420"
            },
            {
                vendorName: "垃可",
                planName: "企業方案",
                weeklyFreq: "1",
                otherVolume: "152X1",
                ourConvert14: "14X6+14X6",
                ourConvert25: "25X3+25X3",
                originalPrice: "1,080",
                discount1m: "無",
                discount3m: "1,026",
                discount6m: "972"
            },
            {
                vendorName: "垃可",
                planName: "企業方案",
                weeklyFreq: "2",
                otherVolume: "152X2",
                ourConvert14: "14X12+14X12",
                ourConvert25: "25X6+25X6",
                originalPrice: "2,160",
                discount1m: "無",
                discount3m: "2,052",
                discount6m: "1,944"
            },
            {
                vendorName: "垃可",
                planName: "企業方案",
                weeklyFreq: "3",
                otherVolume: "152X3",
                ourConvert14: "14X18+14X18",
                ourConvert25: "25X9+25X9",
                originalPrice: "3,240",
                discount1m: "無",
                discount3m: "3,078",
                discount6m: "2,916"
            },
            {
                vendorName: "垃可",
                planName: "企業方案",
                weeklyFreq: "4",
                otherVolume: "152X4",
                ourConvert14: "14X24+14X24",
                ourConvert25: "25X12+25X12",
                originalPrice: "4,160",
                discount1m: "無",
                discount3m: "3,952",
                discount6m: "3,744"
            },
            {
                vendorName: "垃可",
                planName: "企業方案",
                weeklyFreq: "5",
                otherVolume: "152X5",
                ourConvert14: "14X30+14X30",
                ourConvert25: "25X15+25X15",
                originalPrice: "5,200",
                discount1m: "無",
                discount3m: "4,940",
                discount6m: "4,680"
            },
            // 信義垃圾
            {
                vendorName: "信義垃圾",
                planName: "小資方案",
                weeklyFreq: "3",
                otherVolume: "30X3",
                ourConvert14: "14X3+14X3",
                ourConvert25: "25X2+25X1",
                originalPrice: "361",
                discount1m: "無",
                discount3m: "1,083",
                discount6m: "無"
            },
            {
                vendorName: "信義垃圾",
                planName: "小資方案",
                weeklyFreq: "3",
                otherVolume: "30X3",
                ourConvert14: "14X3+14X3",
                ourConvert25: "25X2+25X1",
                originalPrice: "342",
                discount1m: "無",
                discount3m: "無",
                discount6m: "2,052"
            },
            {
                vendorName: "信義垃圾",
                planName: "家庭方案",
                weeklyFreq: "3",
                otherVolume: "60X3",
                ourConvert14: "14X6+14X6",
                ourConvert25: "25X3+25X3",
                originalPrice: "532",
                discount1m: "無",
                discount3m: "1,596",
                discount6m: "無"
            },
            {
                vendorName: "信義垃圾",
                planName: "家庭方案",
                weeklyFreq: "3",
                otherVolume: "60X3",
                ourConvert14: "14X6+14X6",
                ourConvert25: "25X3+25X3",
                originalPrice: "504",
                discount1m: "無",
                discount3m: "無",
                discount6m: "3,024"
            },
            // 大台北收垃圾
            {
                vendorName: "大台北收垃圾",
                planName: "1次方案",
                weeklyFreq: "1",
                otherVolume: "25X1+25X1",
                ourConvert14: "14X2+14X2",
                ourConvert25: "25X1+25X1",
                originalPrice: "600",
                discount1m: "無",
                discount3m: "無",
                discount6m: "無"
            },
            {
                vendorName: "大台北收垃圾",
                planName: "2次方案",
                weeklyFreq: "2",
                otherVolume: "25X2+25X2",
                ourConvert14: "14X4+14X4",
                ourConvert25: "25X2+25X2",
                originalPrice: "800",
                discount1m: "無",
                discount3m: "無",
                discount6m: "無"
            },
            {
                vendorName: "大台北收垃圾",
                planName: "3次方案",
                weeklyFreq: "3",
                otherVolume: "25X3+25X3",
                ourConvert14: "14X6+14X6",
                ourConvert25: "25X3+25X3",
                originalPrice: "1100",
                discount1m: "無",
                discount3m: "無",
                discount6m: "無"
            }
        ];

        // 載入廠商資料
        function loadVendorData() {
            const savedData = localStorage.getItem('vendorPricingData');
            let vendorData = savedData ? JSON.parse(savedData) : defaultVendorData;
            renderVendorTable(vendorData);
        }

        // 渲染廠商表格
        function renderVendorTable(data) {
            const tbody = document.getElementById('vendor-table-body');
            tbody.innerHTML = '';
            
            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="editable" onclick="makeEditable(this, ${index}, 'vendorName')">${row.vendorName}</td>
                    <td class="editable" onclick="makeEditable(this, ${index}, 'planName')">${row.planName}</td>
                    <td class="editable" onclick="makeEditable(this, ${index}, 'weeklyFreq')">${row.weeklyFreq}</td>
                    <td class="editable" onclick="makeEditable(this, ${index}, 'otherVolume')">${row.otherVolume}</td>
                    <td class="editable" onclick="makeEditable(this, ${index}, 'ourConvert14')">${row.ourConvert14}</td>
                    <td class="editable" onclick="makeEditable(this, ${index}, 'ourConvert25')">${row.ourConvert25}</td>
                    <td class="editable" onclick="makeEditable(this, ${index}, 'originalPrice')">${row.originalPrice}</td>
                    <td class="editable" onclick="makeEditable(this, ${index}, 'discount1m')">${row.discount1m}</td>
                    <td class="editable" onclick="makeEditable(this, ${index}, 'discount3m')">${row.discount3m}</td>
                    <td class="editable" onclick="makeEditable(this, ${index}, 'discount6m')">${row.discount6m}</td>
                    <td><button class="delete-row-btn" onclick="deleteVendorRow(${index})">🗑️ 刪除</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 使儲存格可編輯
        function makeEditable(cell, rowIndex, field) {
            if (cell.querySelector('input')) return; // 已經在編輯中
            
            const currentValue = cell.textContent;
            cell.classList.add('editing');
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentValue;
            input.style.width = '100%';
            
            // 當失去焦點或按下 Enter 時保存
            input.onblur = () => saveCell(cell, input, rowIndex, field);
            input.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    saveCell(cell, input, rowIndex, field);
                }
            };
            
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            input.select();
        }

        // 保存儲存格編輯
        function saveCell(cell, input, rowIndex, field) {
            const newValue = input.value.trim();
            const savedData = localStorage.getItem('vendorPricingData');
            let vendorData = savedData ? JSON.parse(savedData) : defaultVendorData;
            
            if (rowIndex < vendorData.length) {
                vendorData[rowIndex][field] = newValue;
                localStorage.setItem('vendorPricingData', JSON.stringify(vendorData));
            }
            
            cell.classList.remove('editing');
            cell.textContent = newValue;
            cell.onclick = () => makeEditable(cell, rowIndex, field);
            
            showVendorStatus('✅ 資料已更新', 'success');
        }

        // 新增廠商資料列
        function addVendorRow() {
            const savedData = localStorage.getItem('vendorPricingData');
            let vendorData = savedData ? JSON.parse(savedData) : defaultVendorData;
            
            const newRow = {
                vendorName: "新廠商",
                planName: "新方案", 
                weeklyFreq: "1次",
                otherVolume: "0L",
                ourConvert14: "0包",
                ourConvert25: "0包",
                originalPrice: "0",
                discount1m: "0",
                discount3m: "0", 
                discount6m: "0"
            };
            
            vendorData.push(newRow);
            localStorage.setItem('vendorPricingData', JSON.stringify(vendorData));
            renderVendorTable(vendorData);
            showVendorStatus('✅ 已新增廠商資料', 'success');
        }

        // 刪除廠商資料列  
        function deleteVendorRow(index) {
            const savedData = localStorage.getItem('vendorPricingData');
            let vendorData = savedData ? JSON.parse(savedData) : defaultVendorData;
            
            if (index >= 0 && index < vendorData.length) {
                const deletedVendor = vendorData[index].vendorName;
                vendorData.splice(index, 1);
                localStorage.setItem('vendorPricingData', JSON.stringify(vendorData));
                renderVendorTable(vendorData);
                showVendorStatus(`✅ 已刪除「${deletedVendor}」`, 'success');
            }
        }

        // 儲存所有廠商資料到 localStorage
        function saveVendorData() {
            const savedData = localStorage.getItem('vendorPricingData');
            if (savedData) {
                showVendorStatus('✅ 資料已儲存到瀏覽器', 'success');
            } else {
                showVendorStatus('❌ 沒有資料需要儲存', 'error');
            }
        }

        // 匯出廠商資料為 Excel 檔案
        function exportVendorData() {
            const savedData = localStorage.getItem('vendorPricingData');
            const vendorData = savedData ? JSON.parse(savedData) : defaultVendorData;
            
            // 創建工作表資料
            const worksheetData = [
                // 表頭
                ['廠商名稱', '方案名稱', '週次數', '他行週總量', '我方換算-14', '我方換算-25', '原價', '1月優', '3月優', '6月優'],
                // 資料行
                ...vendorData.map(row => [
                    row.vendorName,
                    row.planName,
                    row.weeklyFreq,
                    row.otherVolume,
                    row.ourConvert14,
                    row.ourConvert25,
                    row.originalPrice,
                    row.discount1m,
                    row.discount3m,
                    row.discount6m
                ])
            ];
            
            // 創建工作簿和工作表
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
            
            // 設定欄位寬度
            const colWidths = [
                { wch: 15 }, // 廠商名稱
                { wch: 12 }, // 方案名稱
                { wch: 8 },  // 週次數
                { wch: 15 }, // 他行週總量
                { wch: 18 }, // 我方換算-14
                { wch: 18 }, // 我方換算-25
                { wch: 10 }, // 原價
                { wch: 8 },  // 1月優
                { wch: 8 },  // 3月優
                { wch: 8 }   // 6月優
            ];
            worksheet['!cols'] = colWidths;
            
            // 將工作表添加到工作簿
            XLSX.utils.book_append_sheet(workbook, worksheet, '外部價格');
            
            // 匯出Excel檔案
            const fileName = `外部價格資料_${new Date().toISOString().slice(0, 10)}.xlsx`;
            XLSX.writeFile(workbook, fileName);
            
            showVendorStatus('✅ 資料已匯出為 Excel 檔案', 'success');
        }

        // 匯入 Excel 檔案
        function importVendorData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // 讀取Excel檔案
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 取得第一個工作表
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // 轉換為JSON格式
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length < 2) {
                        showVendorStatus('❌ Excel 檔案內容不足', 'error');
                        return;
                    }
                    
                    // 取得表頭 (第一行)
                    const headers = jsonData[0];
                    const expectedHeaders = ['廠商名稱', '方案名稱', '週次數', '他行週總量', '我方換算-14', '我方換算-25', '原價', '1月優', '3月優', '6月優'];
                    
                    // 驗證表頭格式
                    const headersMatch = expectedHeaders.every(header => headers.includes(header));
                    if (!headersMatch) {
                        showVendorStatus('❌ Excel 檔案表頭格式不正確', 'error');
                        return;
                    }
                    
                    // 轉換資料格式
                    const importedData = [];
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row.length >= 10 && row[0]) { // 確保有足夠的欄位且廠商名稱不為空
                            importedData.push({
                                vendorName: row[0] || '',
                                planName: row[1] || '',
                                weeklyFreq: row[2] || '',
                                otherVolume: row[3] || '',
                                ourConvert14: row[4] || '',
                                ourConvert25: row[5] || '',
                                originalPrice: row[6] || '',
                                discount1m: row[7] || '',
                                discount3m: row[8] || '',
                                discount6m: row[9] || ''
                            });
                        }
                    }
                    
                    if (importedData.length > 0) {
                        localStorage.setItem('vendorPricingData', JSON.stringify(importedData));
                        renderVendorTable(importedData);
                        showVendorStatus(`✅ 成功匯入 ${importedData.length} 筆廠商資料`, 'success');
                    } else {
                        showVendorStatus('❌ Excel 檔案無有效資料', 'error');
                    }
                    
                } catch (error) {
                    console.error('Excel import error:', error);
                    showVendorStatus('❌ Excel 檔案解析失敗', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
            
            // 清空 file input
            event.target.value = '';
        }

        // 顯示廠商功能狀態訊息
        function showVendorStatus(message, type) {
            const statusDiv = document.getElementById('vendor-status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            
            // 3秒後清除訊息
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = 'status';
            }, 3000);
        }

        // ========== 競爭廠商比較功能 ==========
        
        // 生成競爭廠商比較表格
        function generateVendorComparison(fieldMapping) {
            try {
                // 從localStorage獲取廠商資料，如果沒有則使用預設資料
                const savedData = localStorage.getItem('vendorPricingData');
                let vendorData = savedData ? JSON.parse(savedData) : defaultVendorData;
                
                // 取得客戶的週次數 - 優先使用Google試算表的weeklyFrequency，再使用手動輸入的frequency
                let frequency = 0;
                
                // 優先從weeklyFrequency解析（Google試算表資料更準確）
                if (fieldMapping.weeklyFrequency) {
                    const match = fieldMapping.weeklyFrequency.match(/(\d+)趟/);
                    if (match) {
                        frequency = parseInt(match[1]);
                    }
                }
                
                // 如果還是沒有頻率，才使用手動輸入的frequency
                if (frequency === 0) {
                    frequency = parseInt(fieldMapping.frequency) || 0;
                }
                
                console.log('Customer frequency:', frequency);
                console.log('FieldMapping frequency:', fieldMapping.frequency);
                console.log('FieldMapping weeklyFrequency:', fieldMapping.weeklyFrequency);
                
                if (frequency === 0) {
                    document.getElementById('vendor-comparison-table').innerHTML = '<div class="no-comparison">無法確定週次數，無法進行廠商比較</div>';
                    document.getElementById('vendor-comparison').style.display = 'block';
                    return;
                }
                
                // 篩選相同週次數的廠商方案
                const matchingPlans = vendorData.filter(vendor => {
                    const vendorFreq = parseInt(vendor.weeklyFreq) || 0;
                    return vendorFreq === frequency;
                });
                
                console.log('Matching plans by frequency:', matchingPlans);
                
                if (matchingPlans.length === 0) {
                    document.getElementById('vendor-comparison-table').innerHTML = '<div class="no-comparison">沒有找到相同週次數的競爭廠商方案</div>';
                    document.getElementById('vendor-comparison').style.display = 'block';
                    return;
                }
                
                // 取得客戶垃圾量資訊進行進一步篩選（可選）
                // 這裡簡化處理，顯示所有相同週次數的方案
                
                // 生成比較表格HTML
                let tableHtml = `
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>廠商名稱</th>
                                <th>方案名稱</th>
                                <th>週次數</th>
                                <th>垃圾量</th>
                                <th>我方換算-14</th>
                                <th>我方換算-25</th>
                                <th>原價</th>
                                <th>1月優</th>
                                <th>3月優</th>
                                <th>6月優</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                matchingPlans.forEach(vendor => {
                    tableHtml += `
                        <tr>
                            <td class="vendor-name">${vendor.vendorName}</td>
                            <td>${vendor.planName}</td>
                            <td>${vendor.weeklyFreq}次</td>
                            <td>${vendor.otherVolume}</td>
                            <td class="price-cell">${vendor.ourConvert14}包</td>
                            <td class="price-cell">${vendor.ourConvert25}包</td>
                            <td class="price-cell">$${vendor.originalPrice}</td>
                            <td class="price-cell">${vendor.discount1m === '無' ? '無' : '$' + vendor.discount1m}</td>
                            <td class="price-cell">${vendor.discount3m === '無' ? '無' : '$' + vendor.discount3m}</td>
                            <td class="price-cell">${vendor.discount6m === '無' ? '無' : '$' + vendor.discount6m}</td>
                        </tr>
                    `;
                });
                
                tableHtml += `
                        </tbody>
                    </table>
                `;
                
                document.getElementById('vendor-comparison-table').innerHTML = tableHtml;
                document.getElementById('vendor-comparison').style.display = 'block';
                
                console.log('Vendor comparison generated successfully');
                
            } catch (error) {
                console.error('Error generating vendor comparison:', error);
                document.getElementById('vendor-comparison-table').innerHTML = '<div class="no-comparison">載入競爭廠商資料失敗</div>';
                document.getElementById('vendor-comparison').style.display = 'block';
            }
        }

        // Tab switching functionality
        function showTab(tabId, clickedButton = null) {
            // Hide all tab contents
            const allTabs = document.querySelectorAll('.tab-content');
            allTabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            const allTabButtons = document.querySelectorAll('.tab');
            allTabButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Add active class to clicked button - use event.target if available
            if (!clickedButton && typeof event !== 'undefined' && event.target) {
                clickedButton = event.target;
            }
            if (!clickedButton) {
                clickedButton = document.querySelector(`button[onclick*="${tabId}"]`);
            }
            if (clickedButton) {
                clickedButton.classList.add('active');
            }
            
            // 當切換到外部價格管理頁面時，自動載入並顯示資料
            if (tabId === 'vendor-pricing') {
                setTimeout(() => {
                    loadVendorData();
                }, 100); // 短暫延遲確保DOM已更新
            }
        }

        // ========== 會員登入功能 ==========
        
        // 預定的帳號密碼
        const validCredentials = {
            username: 'reco',
            password: '123456'
        };
        
        // 檢查登入狀態
        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem('userLoggedIn') === 'true';
            const loginTime = localStorage.getItem('loginTime');
            
            // 檢查是否超過24小時（可選）
            const currentTime = new Date().getTime();
            const loginTimeMs = parseInt(loginTime) || 0;
            const isSessionValid = (currentTime - loginTimeMs) < (24 * 60 * 60 * 1000); // 24小時
            
            if (isLoggedIn && isSessionValid) {
                showMainContent();
            } else {
                showLoginForm();
                // 清除過期的登入資訊
                if (!isSessionValid) {
                    localStorage.removeItem('userLoggedIn');
                    localStorage.removeItem('loginTime');
                }
            }
        }
        
        // 顯示登入表單
        function showLoginForm() {
            document.getElementById('login-overlay').style.display = 'flex';
            document.getElementById('logout-btn').style.display = 'none';
            // 隱藏主要內容
            const container = document.querySelector('.container');
            if (container) container.style.display = 'none';
        }
        
        // 顯示主要內容
        function showMainContent() {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('logout-btn').style.display = 'block';
            // 顯示主要內容
            const container = document.querySelector('.container');
            if (container) container.style.display = 'block';
        }
        
        // 登入驗證
        function login(username, password) {
            if (username === validCredentials.username && password === validCredentials.password) {
                localStorage.setItem('userLoggedIn', 'true');
                localStorage.setItem('loginTime', new Date().getTime().toString());
                showMainContent();
                return true;
            }
            return false;
        }
        
        // 登出
        function logout() {
            localStorage.removeItem('userLoggedIn');
            localStorage.removeItem('loginTime');
            showLoginForm();
        }
        
        // 登入表單事件監聴
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化檢查登入狀態
            checkLoginStatus();
            
            // 登入表單提交事件
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const username = document.getElementById('username').value.trim();
                    const password = document.getElementById('password').value.trim();
                    
                    if (login(username, password)) {
                        document.getElementById('login-error').style.display = 'none';
                        // 清除表單
                        document.getElementById('username').value = '';
                        document.getElementById('password').value = '';
                    } else {
                        document.getElementById('login-error').style.display = 'block';
                        // 清除密碼欄位
                        document.getElementById('password').value = '';
                        document.getElementById('password').focus();
                    }
                });
            }
            
            // Enter 鍵快速登入
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && document.getElementById('login-overlay').style.display === 'flex') {
                    const loginForm = document.getElementById('login-form');
                    if (loginForm) {
                        loginForm.dispatchEvent(new Event('submit'));
                    }
                }
            });
        });
        
    </script>
</body>
</html>
