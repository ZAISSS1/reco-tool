<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聯能永續-報價工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #2a2a2a;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            overflow: hidden;
            border: 1px solid #404040;
        }

        .header {
            background: linear-gradient(135deg, #333333 0%, #1a1a1a 100%);
            color: #ffffff;
            text-align: center;
            padding: 30px 20px;
        }

        .header h1 {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            font-weight: bold;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #1a1a1a;
            border-bottom: 2px solid #404040;
            overflow-x: auto;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .tab {
            flex: 1;
            min-width: 200px;
            padding: 15px 10px;
            text-align: center;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #a0a0a0;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #2a2a2a;
            color: #ffffff;
            border-bottom: 3px solid #667eea;
        }

        .tab:hover {
            background: #333333;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h3 {
            color: #ffffff;
            margin-bottom: 15px;
            font-size: 1.4rem;
        }

        .info-box {
            background: #2a2a2a;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            color: #e0e0e0;
            border: 1px solid #404040;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #e0e0e0;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #555555;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #333333;
            color: #ffffff;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .btn {
            width: 60px;
            height: 60px;
            margin: 20px auto;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn:hover {
            transform: translateY(-3px);
        }

        .btn.quote { 
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); 
            color: #333;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .btn.quote:hover { 
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
            background: linear-gradient(135deg, #f8f8f8 0%, #e8e8e8 100%);
        }

        .btn.monthly { 
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); 
            color: #333;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .btn.monthly:hover { 
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
            background: linear-gradient(135deg, #f8f8f8 0%, #e8e8e8 100%);
        }

        .btn.single { 
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); 
            color: #333;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .btn.single:hover { 
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
            background: linear-gradient(135deg, #f8f8f8 0%, #e8e8e8 100%);
        }

        .btn.clean { 
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); 
            color: #333;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .btn.clean:hover { 
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
            background: linear-gradient(135deg, #f8f8f8 0%, #e8e8e8 100%);
        }

        .btn-financial {
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            color: #333;
            border: none;
            width: 60px;
            height: 60px;
            font-size: 24px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .btn-financial:hover {
            background: linear-gradient(135deg, #f8f8f8 0%, #e8e8e8 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
        }

        .output-section {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #404040;
        }

        .output-area {
            width: 100%;
            min-height: 300px;
            border: 2px solid #555555;
            border-radius: 8px;
            padding: 15px;
            background: #2a2a2a;
            color: #ffffff;
            font-family: monospace;
            white-space: pre-wrap;
            margin-bottom: 15px;
        }

        .copy-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .copy-btn {
            width: 50px;
            height: 50px;
            margin: 15px auto;
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            color: #333;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            background: linear-gradient(135deg, #f8f8f8 0%, #e8e8e8 100%);
        }

        .status {
            margin-top: 15px;
            text-align: center;
            min-height: 40px;
            padding: 10px;
            border-radius: 5px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 5px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #e0e0e0;
            cursor: pointer;
            margin-bottom: 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            width: 16px;
            height: 16px;
        }

        h4 {
            color: #ffffff;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        small {
            color: #a0a0a0;
            font-size: 12px;
        }

        .mobile-text {
            display: none;
        }

        .desktop-text {
            display: inline;
        }

        .clear-btn-small {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(108, 117, 125, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .clear-btn-small:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
        }

        /* 拖曳上傳樣式 */
        .drop-zone {
            border: 2px dashed #666;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #2a2a2a;
            transition: all 0.3s ease;
            position: relative;
            min-height: 120px;
        }

        .drop-zone:hover, .drop-zone.dragover,
        .drop-zone-inline:hover, .drop-zone-inline.dragover {
            border-color: #4CAF50 !important;
            background: #2f3f2f !important;
        }

        .drop-zone-content {
            pointer-events: none;
        }

        .drop-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .drop-text {
            color: #ccc;
            font-size: 16px;
        }

        /* 照片合併按鈕樣式 */
        .btn-merge {
            background: linear-gradient(135deg, #1565C0, #0D47A1);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(21, 101, 192, 0.3);
        }

        .btn-merge:hover {
            background: linear-gradient(135deg, #0D47A1, #0A3880);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(21, 101, 192, 0.4);
        }

        .btn-clear {
            background: linear-gradient(135deg, #9E9E9E, #757575);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(158, 158, 158, 0.3);
        }

        .btn-clear:hover {
            background: linear-gradient(135deg, #757575, #616161);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(158, 158, 158, 0.4);
        }

        .btn-download {
            background: linear-gradient(135deg, #2E7D32, #1B5E20);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(46, 125, 50, 0.3);
        }

        .btn-download:hover {
            background: linear-gradient(135deg, #1B5E20, #0F4318);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(46, 125, 50, 0.4);
        }

        .btn-financial {
            background: linear-gradient(135deg, #FF6B35, #F7931E);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }

        .btn-financial:hover {
            background: linear-gradient(135deg, #F7931E, #E8890B);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
        }

        /* 照片預覽樣式 */
        .photo-preview {
            display: inline-block;
            margin: 5px;
            border: 2px solid #444;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }

        .photo-preview img {
            width: 120px;
            height: 90px;
            object-fit: cover;
        }

        .photo-remove {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .merged-photo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .merged-photo-content {
            flex: 1;
            text-align: left;
        }

        .merged-photo-controls {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .merged-photo img {
            max-width: 100%;
            height: auto;
            border: 2px solid #4CAF50;
            border-radius: 8px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 5px;
                border-radius: 10px;
            }
            
            .header {
                padding: 15px 10px;
            }
            
            .header h1 {
                font-size: 20px;
                margin: 0;
            }
            
            .tab-content {
                padding: 15px 10px;
            }
            
            .tabs {
                gap: 2px;
                padding: 5px 2px;
                position: sticky;
                top: 0;
                z-index: 1001;
            }
            
            .tab {
                padding: 8px 6px;
                font-size: 11px;
                min-height: auto;
                min-width: auto;
                flex: 1;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 10px;
                margin-bottom: 15px;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            h3 {
                font-size: 18px;
                margin-bottom: 10px;
            }
            
            h4 {
                font-size: 16px;
                margin-bottom: 10px;
                padding-bottom: 5px;
            }
            
            .info-box {
                padding: 10px;
                margin-bottom: 15px;
                font-size: 14px;
            }
            
            label {
                font-size: 14px;
                margin-bottom: 5px;
            }
            
            input, textarea, select {
                font-size: 16px;
                padding: 8px;
                margin-bottom: 0;
            }
            
            textarea {
                height: 120px;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 16px;
                margin: 15px auto;
                min-width: 200px;
            }
            
            .copy-btn {
                padding: 10px 15px;
                font-size: 14px;
                margin: 10px auto;
            }
            
            .output-area {
                min-height: 200px;
                padding: 10px;
                font-size: 14px;
            }
            
            .checkbox-group {
                gap: 5px;
                margin-top: 3px;
            }
            
            .checkbox-group label {
                font-size: 13px;
                margin-bottom: 3px;
            }
            
            .status {
                padding: 8px;
                margin-top: 10px;
                font-size: 14px;
            }
            
            .section {
                margin-bottom: 20px;
            }
            
            .desktop-text {
                display: none;
            }
            
            .mobile-text {
                display: inline;
            }
            
            .photo-upload-row {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            .photo-upload-row #single-drop-zone {
                flex: 1 !important;
                min-width: auto !important;
            }
            
            .photo-upload-row #single-merge-controls {
                flex-direction: row !important;
                justify-content: center;
                gap: 10px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>聯能永續-報價工具</h1>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('auto-quote')"><span class="desktop-text">🚀 客戶單⮕自動報價單</span><span class="mobile-text">自動報價</span></button>
            <button class="tab" onclick="showTab('quote')"><span class="desktop-text">🚀 客戶單⮕報價單</span><span class="mobile-text">客戶報價</span></button>
            <button class="tab" onclick="showTab('monthly')"><span class="desktop-text">🚀 報價單⮕包月任務單</span><span class="mobile-text">包月任務</span></button>
            <button class="tab" onclick="showTab('single')"><span class="desktop-text">🚀 報價單⮕單趟任務單</span><span class="mobile-text">單趟任務</span></button>
            <button class="tab" onclick="showTab('clean')"><span class="desktop-text">🚀 報價單⮕單次清潔任務單</span><span class="mobile-text">清潔任務</span></button>
            <button class="tab" onclick="showTab('financial')"><span class="desktop-text">💰 財務分析</span><span class="mobile-text">財務分析</span></button>
        </div>

        <!-- 客戶單⮕自動報價單 -->
        <div id="auto-quote" class="tab-content active">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">🚀 客戶單⮕自動報價單</h3>
                    <button class="clear-btn-small" onclick="clearAutoQuoteForm()" title="清空表單">×</button>
                </div>
                <div class="info-box">
                    💡 自動偵測Google試算表最新資料，依照儲存格內容生成專業標準化報價單
                </div>
                
                <div class="form-group">
                    <h4>🔗 Google試算表連結</h4>
                    <div class="form-row">
                        <div style="grid-column: span 3;">
                            <label for="sheets-url">試算表網址：</label>
                            <input type="text" id="sheets-url" placeholder="請貼上Google試算表的共享連結" style="width: 100%;" onchange="saveUrlToHistory()">
                            <small style="color: #888; margin-top: 5px; display: block;">💡 提示：請確保試算表分享設定為「知道連結的使用者」</small>
                        </div>
                        <div>
                            <label for="saved-urls">歷史網址：</label>
                            <select id="saved-urls" onchange="loadSavedUrl()" style="width: 100%;">
                                <option value="">選擇歷史網址</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <h4>⚙️ 資料輸入</h4>
                    <!-- 第一行：收取星期、收取時間、樓層、月費、趟數 -->
                    <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr 1fr 1fr;">
                        <div>
                            <label for="manual-days">收取星期：</label>
                            <div style="margin-top: 8px; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px;">
                                <label style="display: flex; align-items: center; font-size: 13px; color: #e0e0e0; cursor: pointer; margin-bottom: 0; white-space: nowrap;">
                                    <input type="checkbox" name="manual-days" value="週一" style="width: 14px; height: 14px; margin-right: 4px;"> 週一
                                </label>
                                <label style="display: flex; align-items: center; font-size: 13px; color: #e0e0e0; cursor: pointer; margin-bottom: 0; white-space: nowrap;">
                                    <input type="checkbox" name="manual-days" value="週二" style="width: 14px; height: 14px; margin-right: 4px;"> 週二
                                </label>
                                <label style="display: flex; align-items: center; font-size: 13px; color: #e0e0e0; cursor: pointer; margin-bottom: 0; white-space: nowrap;">
                                    <input type="checkbox" name="manual-days" value="週三" style="width: 14px; height: 14px; margin-right: 4px;"> 週三
                                </label>
                                <label style="display: flex; align-items: center; font-size: 13px; color: #e0e0e0; cursor: pointer; margin-bottom: 0; white-space: nowrap;">
                                    <input type="checkbox" name="manual-days" value="週四" style="width: 14px; height: 14px; margin-right: 4px;"> 週四
                                </label>
                                <label style="display: flex; align-items: center; font-size: 13px; color: #e0e0e0; cursor: pointer; margin-bottom: 0; white-space: nowrap;">
                                    <input type="checkbox" name="manual-days" value="週五" style="width: 14px; height: 14px; margin-right: 4px;"> 週五
                                </label>
                                <label style="display: flex; align-items: center; font-size: 13px; color: #e0e0e0; cursor: pointer; margin-bottom: 0; white-space: nowrap;">
                                    <input type="checkbox" name="manual-days" value="週六" style="width: 14px; height: 14px; margin-right: 4px;"> 週六
                                </label>
                                <label style="display: flex; align-items: center; font-size: 13px; color: #e0e0e0; cursor: pointer; margin-bottom: 0; white-space: nowrap;">
                                    <input type="checkbox" name="manual-days" value="週日" style="width: 14px; height: 14px; margin-right: 4px;"> 週日
                                </label>
                                <div></div> <!-- 空格補位 -->
                            </div>
                        </div>
                        <div>
                            <label for="manual-time">收取時間：</label>
                            <input type="text" id="manual-time" placeholder="0" value="">
                        </div>
                        <div>
                            <label for="manual-floor">樓層：</label>
                            <input type="number" id="manual-floor" placeholder="0" min="-10" max="50" value="">
                        </div>
                        <div>
                            <label for="manual-fee">月費(元)：</label>
                            <input type="number" id="manual-fee" placeholder="0" min="0" value="">
                        </div>
                        <div>
                            <label for="manual-frequency">趟數：</label>
                            <input type="number" id="manual-frequency" placeholder="0" min="1" max="7" value="">
                        </div>
                    </div>
                    
                    <!-- 第二行：垃圾包數、垃圾袋容量、資源包數、資源袋容量 -->
                    <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                        <div>
                            <label for="manual-trash">垃圾包數：</label>
                            <input type="number" id="manual-trash" placeholder="0" min="0" value="">
                        </div>
                        <div>
                            <label for="manual-trash-volume">垃圾袋容量：</label>
                            <select id="manual-trash-volume">
                                <option value="">請選擇</option>
                                <option value="14公升">14公升</option>
                                <option value="25公升">25公升</option>
                                <option value="75公升">75公升</option>
                                <option value="76公升">76公升</option>
                            </select>
                        </div>
                        <div>
                            <label for="manual-recycle">資源包數：</label>
                            <input type="number" id="manual-recycle" placeholder="0" min="0" value="">
                        </div>
                        <div>
                            <label for="manual-recycle-volume">資源袋容量：</label>
                            <select id="manual-recycle-volume">
                                <option value="">請選擇</option>
                                <option value="14公升">14公升</option>
                                <option value="25公升">25公升</option>
                                <option value="75公升">75公升</option>
                                <option value="76公升">76公升</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 第三行：最多垃圾袋數、最多資源袋數、特殊需求 -->
                    <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
                        <div>
                            <label for="manual-trash-max">最多垃圾袋數：</label>
                            <input type="number" id="manual-trash-max" placeholder="0" min="0" value="">
                        </div>
                        <div>
                            <label for="manual-recycle-max">最多資源袋數：</label>
                            <input type="number" id="manual-recycle-max" placeholder="0" min="0" value="">
                        </div>
                        <div>
                            <label for="manual-special-notes">特殊需求：</label>
                            <input type="text" id="manual-special-notes" placeholder="特殊需求" value="">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <h4>📊 資料偵測設定</h4>
                    <div class="form-row">
                        <div>
                            <label for="sheet-name">工作表名稱：</label>
                            <input type="text" id="sheet-name" placeholder="例：報價資料" value="工作表1">
                        </div>
                        <div>
                            <label for="start-row">開始列數：</label>
                            <input type="number" id="start-row" min="1" value="2" placeholder="第幾列開始">
                        </div>
                        <div>
                            <label for="data-columns">資料欄位：</label>
                            <select id="data-columns">
                                <option value="auto">自動偵測</option>
                                <option value="A-H">A到H欄</option>
                                <option value="A-J">A到J欄</option>
                                <option value="A-L">A到L欄</option>
                            </select>
                        </div>
                        <div>
                            <label for="update-mode">更新模式：</label>
                            <select id="update-mode">
                                <option value="latest">最新一列</option>
                                <option value="all">所有資料</option>
                                <option value="last-5">最後5列</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: center; margin: 25px 0;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; width: 100%; max-width: 600px;">
                        <div></div>
                        <button onclick="fetchGoogleSheetsData()" style="background: white; color: #333; border: 2px solid #ddd; width: 50px; height: 50px; font-size: 18px; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; font-weight: bold; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" title="讀取資料">
                            ⇄
                        </button>
                        <div></div>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: center; margin: 15px 0;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; width: 100%; max-width: 600px;">
                        <div></div>
                        <button onclick="clearAutoQuoteForm()" style="background: #6c757d; color: white; border: none; width: 30px; height: 30px; font-size: 14px; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; font-weight: 600; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(108, 117, 125, 0.3);" title="清空表單" onmouseover="this.style.background='#5a6268'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(108, 117, 125, 0.4)'" onmouseout="this.style.background='#6c757d'; this.style.transform='translateY(0px)'; this.style.boxShadow='0 2px 5px rgba(108, 117, 125, 0.3)'">
                            ×
                        </button>
                        <div></div>
                    </div>
                </div>
                
                <div id="auto-sheets-status" class="status" style="display: none;"></div>
                
                <div class="form-group" id="auto-detected-data" style="display: none;">
                    <h4>📋 偵測資料</h4>
                    <div id="detected-data-preview" class="output-area" style="background: #2a2a2a; border: 1px solid #404040; border-radius: 8px; max-height: 300px; overflow-y: auto;"></div>
                </div>
                
                <div class="form-group" id="auto-quote-controls" style="display: none;">
                    <h4>⚡ 自動生成</h4>
                    <div style="display: flex; justify-content: center; margin: 20px 0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; width: 100%; max-width: 600px;">
                            <div></div>
                            <button class="btn quote" onclick="generateAutoQuote()">∞</button>
                            <div></div>
                        </div>
                    </div>
                </div>
                
                <div class="output-section" id="auto-quote-output" style="display: none;">
                    <h4>📄 自動生成的報價單</h4>
                    <div class="output-area" id="auto-quote-result-display"></div>
                    <button class="copy-btn" onclick="copyAutoQuote()">⧉</button>
                    <div class="status" id="auto-quote-copy-status"></div>
                </div>
                
                <div id="auto-quote-final-status" class="status" style="display: none;"></div>
            </div>
        </div>

        <!-- 客戶單⮕報價單 -->
        <div id="quote" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">🚀 客戶單⮕報價單</h3>
                    <button class="clear-btn-small" onclick="clearQuoteForm()" title="清空表單">×</button>
                </div>
                <div class="info-box">
                    💡 將客戶資料轉換為專業標準化報價單格式
                </div>
                
                <div class="form-group">
                    <h4>⚙️ 資料輸入</h4>
                    
                    <!-- 第一行：收取基本設定 -->
                    <div class="form-row">
                        <div>
                            <label for="service-days">收取星期：</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px;">
                                <label style="display: flex; align-items: center; font-size: 14px; color: #e0e0e0; cursor: pointer; margin-bottom: 0;"><input type="checkbox" name="service-days" value="週一" style="width: 16px; height: 16px; margin-right: 8px;"> 週一</label>
                                <label style="display: flex; align-items: center; font-size: 14px; color: #e0e0e0; cursor: pointer; margin-bottom: 0;"><input type="checkbox" name="service-days" value="週二" checked style="width: 16px; height: 16px; margin-right: 8px;"> 週二</label>
                                <label style="display: flex; align-items: center; font-size: 14px; color: #e0e0e0; cursor: pointer; margin-bottom: 0;"><input type="checkbox" name="service-days" value="週三" style="width: 16px; height: 16px; margin-right: 8px;"> 週三</label>
                                <label style="display: flex; align-items: center; font-size: 14px; color: #e0e0e0; cursor: pointer; margin-bottom: 0;"><input type="checkbox" name="service-days" value="週四" style="width: 16px; height: 16px; margin-right: 8px;"> 週四</label>
                                <label style="display: flex; align-items: center; font-size: 14px; color: #e0e0e0; cursor: pointer; margin-bottom: 0;"><input type="checkbox" name="service-days" value="週五" checked style="width: 16px; height: 16px; margin-right: 8px;"> 週五</label>
                                <label style="display: flex; align-items: center; font-size: 14px; color: #e0e0e0; cursor: pointer; margin-bottom: 0;"><input type="checkbox" name="service-days" value="週六" style="width: 16px; height: 16px; margin-right: 8px;"> 週六</label>
                                <label style="display: flex; align-items: center; font-size: 14px; color: #e0e0e0; cursor: pointer; margin-bottom: 0;"><input type="checkbox" name="service-days" value="週日" style="width: 16px; height: 16px; margin-right: 8px;"> 週日</label>
                            </div>
                        </div>
                        <div>
                            <label for="service-time">收取時間：</label>
                            <input type="text" id="service-time" placeholder="0">
                        </div>
                        <div>
                            <label for="floor-level">樓層：</label>
                            <input type="number" id="floor-level" min="-10" max="50" placeholder="0">
                        </div>
                        <div>
                            <label for="monthly-fee">月費(元)：</label>
                            <input type="number" id="monthly-fee" min="0" step="50" placeholder="0">
                        </div>
                    </div>
                    
                    <!-- 第二行：垃圾和資源設定 -->
                    <div class="form-row">
                        <div>
                            <label for="trash-bags">垃圾包數：</label>
                            <input type="number" id="trash-bags" min="0" placeholder="0">
                        </div>
                        <div>
                            <label for="trash-volume">垃圾袋容量：</label>
                            <select id="trash-volume">
                                <option value="0公升">0公升</option>
                                <option value="14公升" selected>14公升</option>
                                <option value="25公升">25公升</option>
                                <option value="75公升">75公升</option>
                                <option value="76公升">76公升</option>
                            </select>
                        </div>
                        <div>
                            <label for="recycle-bags">資源包數：</label>
                            <input type="number" id="recycle-bags" min="0" placeholder="0">
                        </div>
                        <div>
                            <label for="recycle-volume">資源袋容量：</label>
                            <select id="recycle-volume">
                                <option value="0公升">0公升</option>
                                <option value="14公升" selected>14公升</option>
                                <option value="25公升">25公升</option>
                                <option value="75公升">75公升</option>
                                <option value="76公升">76公升</option>
                            </select>
                        </div>
                    </div>

                    <!-- 第三行：限制和特殊需求 -->
                    <div class="form-row">
                        <div>
                            <label for="trash-max">最多垃圾袋數：</label>
                            <input type="number" id="trash-max" min="0" placeholder="0">
                        </div>
                        <div>
                            <label for="recycle-max">最多資源袋數：</label>
                            <input type="number" id="recycle-max" min="0" placeholder="0">
                        </div>
                        <div>
                            <label for="special-notes">特殊需求：</label>
                            <input type="text" id="special-notes" placeholder="特殊需求">
                        </div>
                        <div></div> <!-- 空欄位保持對齊 -->
                    </div>
                    
                    <button class="btn quote" onclick="generateQuote()">∞</button>
                </div>
                
                <div class="output-section" id="quote-output" style="display: none;">
                    <h4>📋 生成的報價單</h4>
                    <div class="output-area" id="quote-result"></div>
                    <button class="copy-btn" onclick="copyToClipboard('quote-result')">⧉</button>
                    <div class="status" id="quote-status"></div>
                </div>
            </div>
        </div>

        <!-- 報價單⮕包月任務單 -->
        <div id="monthly" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">🚀 報價單⮕包月任務單</h3>
                    <button class="clear-btn-small" onclick="clearMonthlyForm()" title="清空表單">×</button>
                </div>
                <div class="info-box">
                    💡 將報價資料轉換為包月任務執行單格式
                </div>
                
                <div class="form-group">
                    <h4>⚙️ 資料輸入</h4>
                    
                    <!-- 第一行設定參數 -->
                    <div class="form-row">
                        <div>
                            <label for="monthly-date">日期：</label>
                            <input type="date" id="monthly-date">
                        </div>
                        <div>
                            <label for="monthly-percentage">百分比：</label>
                            <input type="text" id="monthly-percentage" value="50" placeholder="執行人抽成%數">
                        </div>
                        <div>
                            <label for="monthly-upstairs">上樓：</label>
                            <select id="monthly-upstairs">
                                <option value="需上樓" selected>需上樓</option>
                                <option value="不用上樓">不用上樓</option>
                            </select>
                        </div>
                        <div>
                            <label for="monthly-address">地址：</label>
                            <input type="text" id="monthly-address" placeholder="請輸入完整地址">
                        </div>
                        <div>
                            <label for="monthly-phone">電話：</label>
                            <input type="text" id="monthly-phone" placeholder="請輸入聯絡電話">
                        </div>
                        <div>
                            <label for="monthly-name">姓名：</label>
                            <input type="text" id="monthly-name" placeholder="請輸入客戶姓名">
                        </div>
                        <div>
                            <label for="monthly-key">鑰匙：</label>
                            <select id="monthly-key">
                                <option value="無" selected>無</option>
                                <option value="有">有</option>
                            </select>
                        </div>
                        <div>
                            <label for="monthly-time">時間：</label>
                            <input type="text" id="monthly-time" placeholder="例如：0800後">
                        </div>
                    </div>
                    
                    <!-- 第二行設定參數 -->
                    <div class="form-row">
                        <div>
                            <label for="monthly-trash-pickup">垃圾：</label>
                            <input type="number" id="monthly-trash-pickup" min="1" max="100" value="3" placeholder="垃圾一次收取包數">
                        </div>
                        <div>
                            <label for="monthly-recycle-pickup">資源：</label>
                            <input type="number" id="monthly-recycle-pickup" min="1" max="100" value="3" placeholder="資源一次收取包數">
                        </div>
                        <div>
                            <label for="monthly-bag">專用袋：</label>
                            <select id="monthly-bag">
                                <option value="有" selected>有</option>
                                <option value="無">無</option>
                            </select>
                        </div>
                        <div></div> <!-- 空欄位保持對齊 -->
                    </div>
                    
                    <h4>📝 輸入資料</h4>
                    <label for="monthly-quote-data">貼上報價資料：</label>
                    <textarea id="monthly-quote-data" placeholder="請在此貼上完整的報價資料..." style="height: 200px;"></textarea>
                    
                    <button class="btn monthly" onclick="generateMonthlyTask()">∞</button>
                </div>
                
                <div class="output-section" id="monthly-output" style="display: none;">
                    <h4>📋 包月任務單</h4>
                    <div class="copy-buttons">
                        <div>
                            <h5>一般版任務單</h5>
                            <div class="output-area" id="monthly-general"></div>
                            <button class="copy-btn" onclick="copyToClipboard('monthly-general')">⧉</button>
                        </div>
                        <div>
                            <h5>限制版任務單</h5>
                            <div class="output-area" id="monthly-limited"></div>
                            <button class="copy-btn" onclick="copyToClipboard('monthly-limited')">⧉</button>
                        </div>
                    </div>
                    <div class="status" id="monthly-status"></div>
                </div>
            </div>
        </div>

        <!-- 報價單⮕單趟任務單 -->
        <div id="single" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">🚀 報價單⮕單趟任務單</h3>
                    <button class="clear-btn-small" onclick="clearSingleForm()" title="清空表單">×</button>
                </div>
                <div class="info-box">
                    💡 將報價資料轉換為單次服務的任務執行單
                </div>
                
                <div class="form-group">
                    <h4>⚙️ 資料輸入</h4>
                    
                    <!-- 第一行參數 -->
                    <div class="form-row">
                        <div>
                            <label for="single-date">日期：</label>
                            <input type="date" id="single-date">
                        </div>
                        <div>
                            <label for="single-time">時間：</label>
                            <input type="text" id="single-time" placeholder="例：14:30">
                        </div>
                        <div>
                            <label for="single-phone">電話：</label>
                            <input type="text" id="single-phone" placeholder="例：0912345678">
                        </div>
                        <div>
                            <label for="single-name">姓氏：</label>
                            <input type="text" id="single-name" placeholder="例：陳">
                        </div>
                    </div>
                    
                    <!-- 第二行參數 -->
                    <div class="form-row">
                        <div>
                            <label for="single-address">地址：</label>
                            <input type="text" id="single-address" placeholder="例：台北市中山區民生東路">
                        </div>
                        <div>
                            <label for="single-floor">樓層：</label>
                            <input type="text" id="single-floor" placeholder="例：3F 或 地下1樓">
                        </div>
                        <div>
                            <label for="single-customer-bag">客戶使用專用袋：</label>
                            <select id="single-customer-bag">
                                <option value="無" selected>無</option>
                                <option value="有">有</option>
                                <option value="部分有">部分有</option>
                            </select>
                        </div>
                        <div>
                            <label for="single-waste-type">垃圾資源量：</label>
                            <select id="single-waste-type">
                                <option value="如圖" selected>如圖</option>
                                <option value="手動填寫">手動填寫</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 第三行參數 -->
                    <div class="form-row">
                        <div>
                            <label for="single-fee">費用：</label>
                            <input type="text" id="single-fee" placeholder="例：500">
                        </div>
                        <div>
                            <label for="single-other1">其他說明1：</label>
                            <input type="text" id="single-other1" placeholder="例：回報路段">
                        </div>
                        <div>
                            <label for="single-other2">其他說明2：</label>
                            <input type="text" id="single-other2" placeholder="例：額外備註">
                        </div>
                        <div>
                            <label for="single-other3">其他說明3：</label>
                            <input type="text" id="single-other3" placeholder="例：特殊要求">
                        </div>
                    </div>
                    
                    <h4>📷 現況照片上傳</h4>
                    
                    <!-- 照片功能一行式布局 -->
                    <div class="photo-upload-row" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: stretch; margin-bottom: 15px; min-height: 110px;">
                        <!-- 拖曳上傳區域 -->
                        <div id="single-drop-zone" class="drop-zone-inline" style="flex: 0 0 280px; border: 2px dashed #666; border-radius: 8px; padding: 15px; text-align: center; background: #2a2a2a; transition: all 0.3s ease; position: relative; height: 110px; display: flex; align-items: center; justify-content: center;">
                            <div class="drop-zone-content">
                                <div style="font-size: 1.5em; margin-bottom: 5px;">📁</div>
                                <div style="color: #ccc; font-size: 14px;">拖曳照片或點擊選擇</div>
                                <input type="file" id="single-images" multiple accept="image/png,image/jpg,image/jpeg" style="opacity: 0; position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer;">
                            </div>
                        </div>
                        
                        <!-- 控制按鈕區域 -->
                        <div id="single-merge-controls" style="display: none; flex: 0 0 auto; height: 110px; flex-direction: column; justify-content: center; gap: 8px;">
                            <button type="button" class="btn-merge" onclick="mergeSingleImages()">≫</button>
                            <button type="button" class="btn-clear" onclick="clearSingleImages()">×</button>
                        </div>
                        
                        <!-- 照片預覽區域 -->
                        <div id="single-image-preview" style="flex: 1; min-width: 180px; min-height: 110px; display: flex; flex-direction: column; justify-content: flex-start;"></div>
                    </div>
                    
                    <!-- 合併照片顯示區域 - 移到下方 -->
                    <div id="single-merged-preview" style="width: 100%; margin-bottom: 15px; display: flex; justify-content: center;"></div>
                    
                    <button class="btn single" onclick="generateSingleTask()">∞</button>
                </div>
                
                <div class="output-section" id="single-output" style="display: none;">
                    <h4>📋 單趟任務單</h4>
                    <div class="output-area" id="single-result"></div>
                    <button class="copy-btn" onclick="copyToClipboard('single-result')">⧉</button>
                    <div class="status" id="single-status"></div>
                </div>
            </div>
        </div>

        <!-- 報價單⮕單次清潔任務單 -->
        <div id="clean" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">🚀 報價單⮕單次清潔任務單</h3>
                    <button class="clear-btn-small" onclick="clearCleanForm()" title="清空表單">×</button>
                </div>
                <div class="info-box">
                    💡 將報價資料轉換為單次清潔服務的任務執行單
                </div>
                
                <div class="form-group">
                    <h4>⚙️ 資料輸入</h4>
                    
                    <!-- 第一行參數 -->
                    <div class="form-row">
                        <div>
                            <label for="clean-date">日期：</label>
                            <input type="date" id="clean-date">
                        </div>
                        <div>
                            <label for="clean-time">時間：</label>
                            <input type="text" id="clean-time" placeholder="例：14:30">
                        </div>
                        <div>
                            <label for="clean-phone">電話：</label>
                            <input type="text" id="clean-phone" placeholder="例：0912345678">
                        </div>
                        <div>
                            <label for="clean-name">姓氏：</label>
                            <input type="text" id="clean-name" placeholder="例：陳">
                        </div>
                        <div>
                            <label for="clean-address">地址：</label>
                            <input type="text" id="clean-address" placeholder="例：台北市中山區民生東路">
                        </div>
                        <div>
                            <label for="clean-floor">樓層：</label>
                            <input type="text" id="clean-floor" placeholder="例：3F 或 地下1樓">
                        </div>
                        <div>
                            <label for="clean-waste-type">現況照片：</label>
                            <select id="clean-waste-type">
                                <option value="如圖" selected>如圖</option>
                                <option value="手動填寫">手動填寫</option>
                            </select>
                        </div>
                        <div>
                            <label for="clean-fee">費用：</label>
                            <input type="text" id="clean-fee" placeholder="例：800">
                        </div>
                    </div>
                    
                    <!-- 第二行參數 -->
                    <div class="form-row">
                        <div>
                            <label for="clean-other1">其他說明1：</label>
                            <input type="text" id="clean-other1" placeholder="例：特殊清潔需求">
                        </div>
                        <div>
                            <label for="clean-other2">其他說明2：</label>
                            <input type="text" id="clean-other2" placeholder="例：額外備註">
                        </div>
                        <div>
                            <label for="clean-other3">其他說明3：</label>
                            <input type="text" id="clean-other3" placeholder="例：注意事項">
                        </div>
                    </div>
                    
                    <h4>🧹 清潔範圍</h4>
                    <div class="form-row">
                        <div>
                            <label for="clean-scope-1">1.</label>
                            <input type="text" id="clean-scope-1" placeholder="清潔項目 1">
                        </div>
                        <div>
                            <label for="clean-scope-2">2.</label>
                            <input type="text" id="clean-scope-2" placeholder="清潔項目 2">
                        </div>
                        <div>
                            <label for="clean-scope-3">3.</label>
                            <input type="text" id="clean-scope-3" placeholder="清潔項目 3">
                        </div>
                        <div>
                            <label for="clean-scope-4">4.</label>
                            <input type="text" id="clean-scope-4" placeholder="清潔項目 4">
                        </div>
                        <div>
                            <label for="clean-scope-5">5.</label>
                            <input type="text" id="clean-scope-5" placeholder="清潔項目 5">
                        </div>
                        <div>
                            <label for="clean-scope-6">6.</label>
                            <input type="text" id="clean-scope-6" placeholder="清潔項目 6">
                        </div>
                    </div>
                    <div class="form-row">
                        <div>
                            <label for="clean-scope-7">7.</label>
                            <input type="text" id="clean-scope-7" placeholder="清潔項目 7">
                        </div>
                        <div>
                            <label for="clean-scope-8">8.</label>
                            <input type="text" id="clean-scope-8" placeholder="清潔項目 8">
                        </div>
                        <div>
                            <label for="clean-scope-9">9.</label>
                            <input type="text" id="clean-scope-9" placeholder="清潔項目 9">
                        </div>
                        <div>
                            <label for="clean-scope-10">10.</label>
                            <input type="text" id="clean-scope-10" placeholder="清潔項目 10">
                        </div>
                        <div></div> <!-- 空欄位保持對齊 -->
                        <div></div> <!-- 空欄位保持對齊 -->
                    </div>
                    
                    <h4>📷 現況照片上傳</h4>
                    
                    <!-- 照片功能一行式布局 -->
                    <div class="photo-upload-row" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: stretch; margin-bottom: 15px; min-height: 110px;">
                        <!-- 拖曳上傳區域 -->
                        <div id="clean-drop-zone" class="drop-zone-inline" style="flex: 0 0 280px; border: 2px dashed #666; border-radius: 8px; padding: 15px; text-align: center; background: #2a2a2a; transition: all 0.3s ease; position: relative; height: 110px; display: flex; align-items: center; justify-content: center;">
                            <div class="drop-zone-content">
                                <div style="font-size: 1.5em; margin-bottom: 5px;">📁</div>
                                <div style="color: #ccc; font-size: 14px;">拖曳照片或點擊選擇</div>
                                <input type="file" id="clean-images" multiple accept="image/png,image/jpg,image/jpeg" style="opacity: 0; position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer;">
                            </div>
                        </div>
                        
                        <!-- 控制按鈕區域 -->
                        <div id="clean-merge-controls" style="display: none; flex: 0 0 auto; height: 110px; flex-direction: column; justify-content: center; gap: 8px;">
                            <button type="button" class="btn-merge" onclick="mergeCleanImages()">≫</button>
                            <button type="button" class="btn-clear" onclick="clearCleanImages()">×</button>
                        </div>
                        
                        <!-- 照片預覽區域 -->
                        <div id="clean-image-preview" style="flex: 1; min-width: 180px; min-height: 110px; display: flex; flex-direction: column; justify-content: flex-start;"></div>
                    </div>
                    
                    <!-- 合併照片顯示區域 - 移到下方 -->
                    <div id="clean-merged-preview" style="width: 100%; margin-bottom: 15px; display: flex; justify-content: center;"></div>
                    
                    <button class="btn clean" onclick="generateCleanTask()">∞</button>
                </div>
                
                <div class="output-section" id="clean-output" style="display: none;">
                    <h4>📋 清潔任務單</h4>
                    <div class="output-area" id="clean-result"></div>
                    <button class="copy-btn" onclick="copyToClipboard('clean-result')">⧉</button>
                    <div class="status" id="clean-status"></div>
                </div>
            </div>
        </div>

        <!-- 財務分析 -->
        <div id="financial" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">💰 財務分析</h3>
                    <button class="clear-btn-small" onclick="clearFinancialForm()" title="清空表單">×</button>
                </div>
                <div class="info-box">
                    💡 分析支出數據，自動計算各類別費用並生成財務報告。支援兩種方式：1. 直接貼上CSV資料 2. Google試算表連結（需要特殊設定）
                </div>
                
                <div class="form-group">
                    <h4>📊 資料輸入方式</h4>
                    <div style="margin-bottom: 15px;">
                        <label style="color: #e0e0e0; margin-bottom: 10px; display: block;">選擇輸入方式：</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; color: #e0e0e0; cursor: pointer;">
                                <input type="radio" name="input-method" value="csv" checked onchange="toggleInputMethod()" style="margin-right: 8px;">
                                CSV資料貼上
                            </label>
                            <label style="display: flex; align-items: center; color: #e0e0e0; cursor: pointer;">
                                <input type="radio" name="input-method" value="sheets" onchange="toggleInputMethod()" style="margin-right: 8px;">
                                Google試算表連結
                            </label>
                        </div>
                    </div>
                    
                    <!-- CSV資料貼上區域 -->
                    <div id="csv-input-area">
                        <h4>📝 CSV資料</h4>
                        <textarea id="financial-csv-data" placeholder="請將CSV資料貼上此處，例如：&#10;日期,項目,金額,類別&#10;2025-01-01,午餐,200,餐飲費&#10;2025-01-02,加油,1500,燃料費" style="width: 100%; height: 150px; background: #2a2a2a; color: white; border: 1px solid #555; border-radius: 4px; padding: 10px; font-family: monospace; resize: vertical;"></textarea>
                        <small style="color: #888; margin-top: 5px; display: block;">💡 從Google試算表複製資料時，請選擇資料範圍後直接Ctrl+C複製，然後貼上到此處</small>
                    </div>
                    
                    <!-- Google試算表連結區域 -->
                    <div id="sheets-input-area" style="display: none;">
                        <h4>🔗 Google試算表連結</h4>
                        <div class="form-row">
                            <div style="grid-column: span 2;">
                                <label for="financial-sheets-url">試算表網址：</label>
                                <input type="text" id="financial-sheets-url" placeholder="請貼上Google試算表的共享連結" style="width: 100%;">
                                <small style="color: #888; margin-top: 5px; display: block;">💡 提示：請確保試算表分享設定為「知道連結的使用者」</small>
                            </div>
                            <div>
                                <label for="financial-url-dropdown">記憶網址：</label>
                                <select id="financial-url-dropdown" onchange="selectFinancialUrl()" style="width: 100%;">
                                    <option value="">選擇已存網址</option>
                                </select>
                                <button type="button" onclick="saveFinancialUrl()" style="width: 100%; margin-top: 5px; padding: 5px; background: #444; color: white; border: 1px solid #666; border-radius: 4px; cursor: pointer;">💾 存儲網址</button>
                            </div>
                            <div>
                                <label for="financial-sheet-name">工作表名稱：</label>
                                <input type="text" id="financial-sheet-name" placeholder="例：工作表1 或留空使用預設工作表" style="width: 100%;">
                                <small style="color: #888; margin-top: 5px; display: block;">💡 可指定特定工作表名稱，留空則使用預設工作表</small>
                            </div>
                            <div>
                                <label for="financial-cell-range">儲存格範圍：</label>
                                <input type="text" id="financial-cell-range" placeholder="例：A1:Z100 或留空讀取全部" style="width: 100%;">
                                <small style="color: #888; margin-top: 5px; display: block;">💡 可指定範圍如 A1:Z100，或留空讀取整個工作表</small>
                            </div>
                        </div>
                    </div>
                </div>
                

                
                <!-- 欄位選擇區域 -->
                <div id="financial-column-selection" style="display: none;">
                    <h4>📋 選擇分析欄位</h4>
                    <div style="background: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div id="financial-column-checkboxes" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;"></div>
                        <div style="margin-top: 15px; text-align: center;">
                            <button type="button" onclick="selectAllColumns()" style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 10px; cursor: pointer;">全選</button>
                            <button type="button" onclick="clearAllColumns()" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 10px; cursor: pointer;">清空</button>
                            <button type="button" onclick="proceedWithAnalysis()" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">開始分析</button>
                        </div>
                    </div>
                </div>
                
                <!-- 資料預覽區域 -->
                <div id="financial-data-preview" style="display: none;">
                    <h4>📊 原始資料預覽</h4>
                    <div id="financial-raw-data" style="background: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 20px; max-height: 300px; overflow-y: auto;"></div>
                </div>
                
                <!-- 財務分析結果 -->
                <div id="financial-analysis-output" style="display: none;">
                    <h4>📈 財務分析結果</h4>
                    <div id="financial-summary" style="background: #2a2a2a; padding: 20px; border-radius: 8px; margin-bottom: 15px;"></div>
                    <div id="financial-breakdown" style="background: #2a2a2a; padding: 20px; border-radius: 8px; margin-bottom: 15px;"></div>
                    <button class="copy-btn" onclick="copyFinancialAnalysis()">⧉ 複製分析結果</button>
                </div>
                
                <div class="status" id="financial-status"></div>
            </div>
        </div>
    </div>

    <script>
        // Tab switching functionality
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // Quote generation function
        function generateQuote() {
            // 獲取所有表單數據
            const serviceDaysCheckboxes = document.querySelectorAll('input[name="service-days"]:checked');
            const serviceDays = Array.from(serviceDaysCheckboxes).map(checkbox => checkbox.value);
            const serviceTime = document.getElementById('service-time').value;
            const floorLevel = parseInt(document.getElementById('floor-level').value);
            const trashBags = document.getElementById('trash-bags').value;
            const trashVolume = document.getElementById('trash-volume').value;
            const recycleBags = document.getElementById('recycle-bags').value;
            const recycleVolume = document.getElementById('recycle-volume').value;
            const trashMax = document.getElementById('trash-max').value;
            const recycleMax = document.getElementById('recycle-max').value;
            const monthlyFee = document.getElementById('monthly-fee').value;
            const specialNotes = document.getElementById('special-notes').value;
            
            // 格式化服務日期
            const daysText = serviceDays.length > 0 ? serviceDays.join('、') : '待確定';
            
            // 格式化時間
            let formattedTime = serviceTime;
            if (serviceTime) {
                const timeMatch = serviceTime.match(/(\d{4})/);
                if (timeMatch) {
                    const timeStr = timeMatch[1];
                    const hour = parseInt(timeStr.substring(0, 2));
                    const minute = timeStr.substring(2);
                    if (hour < 12) {
                        formattedTime = `上午 ${hour.toString().padStart(2, '0')}：${minute}`;
                    } else if (hour < 18) {
                        formattedTime = `下午 ${hour.toString().padStart(2, '0')}：${minute}`;
                    } else {
                        formattedTime = `晚間 ${hour.toString().padStart(2, '0')}：${minute}`;
                    }
                }
            }
            
            // 計算週趟數和格式化日期
            const weeklyTrips = serviceDays.length || 2;
            const dayMapping = {"週一": "週1", "週二": "週2", "週三": "週3", "週四": "週4", "週五": "週5", "週六": "週6", "週日": "週7"};
            const formattedDays = serviceDays.map(day => dayMapping[day] || day).join('+');
            const tripsAndDays = serviceDays.length > 0 ? `${weeklyTrips}趟-${formattedDays}` : `${weeklyTrips}趟`;
            
            // 格式化樓層
            const floorNumber = floorLevel < 0 ? `地下${Math.abs(floorLevel)}樓` : `${floorLevel}F`;
            
            // 收取時間描述
            let collectionTimeDesc = '';
            if (formattedTime.includes('上午')) {
                collectionTimeDesc = '中午前';
            } else if (formattedTime.includes('下午')) {
                collectionTimeDesc = '下午結束前';
            } else if (formattedTime.includes('晚間')) {
                collectionTimeDesc = '半夜前';
            } else {
                collectionTimeDesc = '中午/下午/半夜/';
            }
            
            // 鑰匙提示
            const keyNote = floorLevel > 1 ? '（上樓代收需提供1樓大門鑰匙）' : 
                           floorLevel < 0 ? '（地下室代收需提供地下室鑰匙）' : '';
            
            const quote = `⛔報價資料⛔

一週趟數：${tripsAndDays}
   置放時間：${formattedTime || '（準時置放）'}
   置放樓層：${floorNumber}

（⚠️ 垃圾當日：${collectionTimeDesc}   代收完畢）

（⚠️ 過程中嚴禁催促）
（⚠️ 請準時置放 以免多有糾紛）

 1週垃圾：${trashBags}包數（${trashVolume}）
（1次最多收取${trashMax}袋--超量拒收）
（垃圾請綁緊、勿外露）
（垃圾袋外部勿流湯汁）
（一次性紙/塑膠容器均垃圾）


 1週資源:${recycleBags}包數（${recycleVolume}）-用一般塑膠袋
（1次最多收取${recycleMax}袋--超量拒收）
（若未裝袋一律拒收）
（請勿用黑色袋子裝資源）
（僅收寶特玻璃鐵鋁罐）
（僅收中小紙板箱壓扁折好）
（僅收書本/乾淨紙張）

⚠️下列物品視為垃圾
（便當盒/塑膠袋/吸管➡️垃圾）
（軟塑膠蓋/吸管➡️垃圾）
（早餐盒/快飲杯➡️垃圾）
（泡棉/雞蛋軟塑膠盒➡️垃圾）
（蛋糕盒/緩衝材料➡️垃圾）

一個月費用：${monthlyFee}元
${keyNote}

-
⛔配合事項⛔
⭐.垃圾務必打包綁好放置門口
⭐.如因政策關係需更改時間
  （會在提前告知 煩請配合）
⭐.自備雙北市政府專用垃圾袋
⭐.收款後不退款內容不更改
⭐.若有超量垃圾拒收

⏬⏬

⛔其他問題⛔
🟥.請完整看完報價內容後提出
🟥.客服會為您解決任何問題

⏬⏬

⭕解決問題⭕
✔️.上述問題均解決
✔️.上述內容能配合
回覆告知我們：同意✅+開始日

⏬⏬

收到_同意✅_後
💧客服➡️提供繳費單
💧客戶➡️完成繳費
💧客服➡️開始代收

✖️注意事項✖️
🔻.1分錢1分服務_便宜無安全服務
🔻.近期多案例/請房東住戶多注意
🔻.均為年輕團隊作業流程均有SOP
🔻.成員平均30-35歲內均有良民證
🔻.過年及天災人禍停止代收無退款
       延至下一次能代收工作日



🔥萬事順心🔥

${specialNotes ? `特殊需求：${specialNotes}` : ''}`;

            document.getElementById('quote-result').textContent = quote;
            document.getElementById('quote-output').style.display = 'block';
            showStatus('quote-status', '✅ 報價單生成完成！', 'success');
        }

        // Monthly task generation function
        function generateMonthlyTask() {
            const quoteData = document.getElementById('monthly-quote-data').value;
            const date = document.getElementById('monthly-date').value;
            
            // 獲取所有手動輸入欄位
            const percentage = document.getElementById('monthly-percentage').value.replace('%', '') || '50';
            const upstairs = document.getElementById('monthly-upstairs').value;
            const address = document.getElementById('monthly-address').value;
            const phone = document.getElementById('monthly-phone').value;
            const name = document.getElementById('monthly-name').value;
            const trashPickup = document.getElementById('monthly-trash-pickup').value;
            const recyclePickup = document.getElementById('monthly-recycle-pickup').value;
            const key = document.getElementById('monthly-key').value;
            const manualTime = document.getElementById('monthly-time').value;
            const bag = document.getElementById('monthly-bag').value;
            
            if (!quoteData || !date) {
                showStatus('monthly-status', '請填寫報價資料和執行日期', 'error');
                return;
            }
            
            // 解析報價資料
            let extractedAddress = address, extractedName = name, extractedPhone = phone;
            let fee = 0, weekDays = '未填', time = '上午';
            let trashAmount = '未填', recycleAmount = '未填';
            
            // 如果手動欄位為空，則從報價資料中提取
            if (!address || !name || !phone) {
                const lines = quoteData.split('\n');
                for (const line of lines) {
                    if (line.includes('地址') && !extractedAddress) {
                        extractedAddress = line.split(/[：:]/)[1]?.trim() || '';
                    }
                    if (line.includes('姓名') && !extractedName) {
                        extractedName = line.split(/[：:]/)[1]?.trim() || '';
                    }
                    if (line.includes('電話') && !extractedPhone) {
                        extractedPhone = line.split(/[：:]/)[1]?.trim() || '';
                    }
                }
            }
            
            // 提取費用並應用百分比
            const feeMatch = quoteData.match(/一個月費用：(\d+)/);
            if (feeMatch) {
                const originalFee = parseInt(feeMatch[1]);
                fee = Math.floor(originalFee * (parseInt(percentage) / 100));
            }
            
            // 提取週趟數和日期
            const weekMatch = quoteData.match(/一週趟數：.*?(\d+趟)-(週.*?)\n/);
            weekDays = weekMatch ? weekMatch[2] : '未填';
            
            // 將週1+週4格式轉換為星期格式
            function convertWeekdayFormat(weekStr) {
                if (!weekStr || weekStr === '未填') return '未填';
                
                const weekMap = {
                    '週1': '週一', '週2': '週二', '週3': '週三', 
                    '週4': '週四', '週5': '週五', '週6': '週六', '週日': '週日'
                };
                
                // 處理週1+週4這種格式
                return weekStr.replace(/週(\d)/g, (match, num) => {
                    return weekMap[match] || match;
                });
            }
            
            weekDays = convertWeekdayFormat(weekDays);
            
            // 時間格式化函數
            function formatTimeToChinnese(timeStr) {
                timeStr = timeStr.replace(/[：:後]/g, '').trim();
                if (timeStr.length === 4 && !isNaN(timeStr)) {
                    const hour = parseInt(timeStr.substring(0, 2));
                    const minute = timeStr.substring(2);
                    let period;
                    if (hour < 12) {
                        period = '上午';
                    } else if (hour < 18) {
                        period = '下午';
                    } else {
                        period = '晚間';
                    }
                    return `${period} ${hour.toString().padStart(2, '0')}：${minute} 後`;
                }
                if (timeStr.includes('上午') || timeStr.includes('下午') || timeStr.includes('晚間')) {
                    return timeStr + (timeStr.endsWith('後') ? '' : ' 後');
                }
                return timeStr + (timeStr && !timeStr.endsWith('後') ? '後' : '');
            }
            
            // 使用手動時間或從文字中提取
            if (manualTime.trim()) {
                time = formatTimeToChinnese(manualTime);
            } else {
                const timeMatch = quoteData.match(/置放時間：(\d{2}：\d{2})/);
                if (timeMatch) {
                    const timeStr = timeMatch[1].replace('：', '');
                    time = formatTimeToChinnese(timeStr);
                } else {
                    time = '上午';
                }
            }
            
            // 提取垃圾量 - 增強版偵測
            let trashMatchFound = false;
            const trashPatterns = [
                /1週垃圾：(\d+)包數.*?\((\d+公升)\)/,
                /垃圾.*?(\d+)包.*?(\d+公升)/,
                /1週垃圾.*?(\d+).*?(\d+公升)/,
                /週垃圾：(\d+)包數.*?\((\d+公升)\)/,
                /垃圾包數：(\d+).*?(\d+公升)/
            ];
            
            for (const pattern of trashPatterns) {
                const match = quoteData.match(pattern);
                if (match) {
                    trashAmount = `${match[1]}包（${match[2]}公升）`;
                    trashMatchFound = true;
                    break;
                }
            }
            
            // 提取資源量 - 增強版偵測
            let recycleMatchFound = false;
            const recyclePatterns = [
                /1週資源:(\d+)包數.*?\((\d+公升)\)/,
                /1週資源：(\d+)包數.*?\((\d+公升)\)/,
                /資源.*?(\d+)包.*?(\d+公升)/,
                /1週資源.*?(\d+).*?(\d+公升)/,
                /週資源：(\d+)包數.*?\((\d+公升)\)/,
                /資源包數：(\d+).*?(\d+公升)/
            ];
            
            for (const pattern of recyclePatterns) {
                const match = quoteData.match(pattern);
                if (match) {
                    recycleAmount = `${match[1]}包（${match[2]}公升）`;
                    recycleMatchFound = true;
                    break;
                }
            }
            
            // 如果沒有找到完整的包數和容量，嘗試只找包數
            if (!trashMatchFound) {
                const trashSimplePatterns = [
                    /垃圾.*?(\d+)包/,
                    /1週垃圾.*?(\d+)/,
                    /垃圾包數：(\d+)/
                ];
                for (const pattern of trashSimplePatterns) {
                    const match = quoteData.match(pattern);
                    if (match) {
                        trashAmount = `${match[1]}包`;
                        break;
                    }
                }
            }
            
            if (!recycleMatchFound) {
                const recycleSimplePatterns = [
                    /資源.*?(\d+)包/,
                    /1週資源.*?(\d+)/,
                    /資源包數：(\d+)/
                ];
                for (const pattern of recycleSimplePatterns) {
                    const match = quoteData.match(pattern);
                    if (match) {
                        recycleAmount = `${match[1]}包`;
                        break;
                    }
                }
            }
            
            const dateObj = new Date(date);
            const weekDaysArray = ['日', '一', '二', '三', '四', '五', '六'];
            const weekDay = weekDaysArray[dateObj.getDay()];
            const formattedDate = `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
            const dateWithWeekday = `${formattedDate} 週${weekDay}`;
            
            const generalTask = `🧑‍🚀包月任務🧑‍🚀

➡️日期：${dateWithWeekday}
➡️星期：${weekDays}
➡️時間：${time}
➡️地址：${extractedAddress}
➡️上樓：${upstairs === '需上樓' ? '是' : '否'}
➡️鑰匙：${key}
➡️費用：${fee}
➡️客戶自備專用袋：${bag}
➡️1週垃圾量：${trashAmount}
（1-${trashPickup}）
➡️1週資源量：${recycleAmount}
（1-${recyclePickup}）
➡️姓名：${extractedName}
➡️電話：${extractedPhone}
➡️其他：
1.若有鑰匙索取請回報
2.7天內複製歸還原鑰
3.另有規定時間者除外
4.鑰匙通常粘置信箱

📛已新增日曆📛
📛務必請過目📛
📛有問題提出📛`;

            const limitedTask = `🧑‍🚀包月任務🧑‍🚀

➡️日期：${dateWithWeekday}
➡️星期：${weekDays}
➡️時間：${time}
➡️地址：${extractedAddress}
➡️上樓：${upstairs === '需上樓' ? '是' : '否'}
➡️鑰匙：${key}
➡️費用：${fee}
➡️客戶自備專用袋：${bag}
➡️1週垃圾量：${trashAmount}
（1-${trashPickup}）
➡️1週資源量：${recycleAmount}
（1-${recyclePickup}）
➡️姓名：${extractedName}
➡️電話：${extractedPhone}
➡️基本服務：
1.超量一律收走
2.現場清空
3.正確回報

➡️其他：
1.若有鑰匙索取請回報
2.7天內複製歸還原鑰
3.另有規定時間者除外
4.鑰匙通常粘置信箱

📛已新增日曆📛
📛務必請過目📛
📛有問題提出📛`;

            document.getElementById('monthly-general').textContent = generalTask;
            document.getElementById('monthly-limited').textContent = limitedTask;
            document.getElementById('monthly-output').style.display = 'block';
            showStatus('monthly-status', '✅ 包月任務單轉換完成！', 'success');
        }



        // Single task generation function
        function generateSingleTask() {
            const date = document.getElementById('single-date').value;
            const time = document.getElementById('single-time').value;
            const phone = document.getElementById('single-phone').value;
            const name = document.getElementById('single-name').value;
            const address = document.getElementById('single-address').value;
            const floor = document.getElementById('single-floor').value;
            const wasteType = document.getElementById('single-waste-type').value;

            const fee = document.getElementById('single-fee').value;
            const customerBag = document.getElementById('single-customer-bag').value;
            const otherNotes1 = document.getElementById('single-other1').value;
            const otherNotes2 = document.getElementById('single-other2').value;
            const otherNotes3 = document.getElementById('single-other3').value;
            
            if (!date) {
                showStatus('single-status', '請填寫執行日期', 'error');
                return;
            }
            
            const dateObj = new Date(date);
            const weekDays = ['日', '一', '二', '三', '四', '五', '六'];
            const weekDay = weekDays[dateObj.getDay()];
            const formattedDate = `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
            const dateWithWeekday = `${formattedDate} 週${weekDay}`;
            
            // 格式化時間 - 支援時間區間
            let formattedTime = time || '上午';
            if (time) {
                // 檢查是否為時間區間格式 (如 1500-1630)
                const timeRangeMatch = time.match(/(\d{4})-(\d{4})/);
                if (timeRangeMatch) {
                    const startTime = timeRangeMatch[1];
                    const endTime = timeRangeMatch[2];
                    
                    // 格式化開始時間
                    const startHour = parseInt(startTime.substring(0, 2));
                    const startMinute = startTime.substring(2);
                    let startPeriod = startHour < 12 ? '上午' : (startHour < 18 ? '下午' : '晚間');
                    
                    // 格式化結束時間
                    const endHour = parseInt(endTime.substring(0, 2));
                    const endMinute = endTime.substring(2);
                    
                    formattedTime = `${startPeriod} ${startHour.toString().padStart(2, '0')}：${startMinute}-${endHour.toString().padStart(2, '0')}：${endMinute}`;
                } else if (time.match(/^\d{4}$/)) {
                    // 處理四位數時間格式 (如 1300)
                    const hour = parseInt(time.substring(0, 2));
                    const minute = time.substring(2);
                    let period = hour < 12 ? '上午' : (hour < 18 ? '下午' : '晚間');
                    formattedTime = `${period} ${hour.toString().padStart(2, '0')}：${minute}`;
                } else if (time.includes(':')) {
                    // 原有的單一時間格式處理
                    const [hour, minute] = time.split(':');
                    const hourInt = parseInt(hour);
                    if (hourInt < 12) {
                        formattedTime = `上午 ${hour}：${minute}`;
                    } else if (hourInt < 18) {
                        formattedTime = `下午 ${hour}：${minute}`;
                    } else {
                        formattedTime = `晚間 ${hour}：${minute}`;
                    }
                } else {
                    // 其他格式直接顯示
                    formattedTime = time;
                }
            }
            
            // 決定垃圾資源量文字
            const wasteAmount = '如圖';
            
            // 構建其他說明內容
            let otherDetails = '';
            let itemNumber = 4;
            if (otherNotes1) {
                otherDetails += `${itemNumber}.${otherNotes1}\n`;
                itemNumber++;
            }
            if (otherNotes2) {
                otherDetails += `${itemNumber}.${otherNotes2}\n`;
                itemNumber++;
            }
            if (otherNotes3) {
                otherDetails += `${itemNumber}.${otherNotes3}`;
            }

            const singleTask = `🧑‍🚀單趟任務🧑‍🚀

➡️日期：${dateWithWeekday}
➡️時間：${formattedTime}
➡️電話：${phone}
➡️姓名：${name}
➡️地址：${address}
➡️樓層：${floor}
➡️客戶自備專用袋：${customerBag}
➡️費用：${fee}
➡️垃圾資源量：${wasteAmount}
➡️現況照片：
➡️其他：
1.回報：
（1）單趟：XX+路段/街
2.少量超量一律清走
3.照片拍完善
${otherDetails}

🔥已新增日曆🔥
🔥務必請過目🔥
🔥有問題提出🔥`;

            document.getElementById('single-result').textContent = singleTask;
            document.getElementById('single-output').style.display = 'block';
            showStatus('single-status', '✅ 單趟任務單轉換完成！', 'success');
        }



        // Clean task generation function
        function generateCleanTask() {
            const date = document.getElementById('clean-date').value;
            const time = document.getElementById('clean-time').value;
            const phone = document.getElementById('clean-phone').value;
            const name = document.getElementById('clean-name').value;
            const address = document.getElementById('clean-address').value;
            const floor = document.getElementById('clean-floor').value;
            const wasteType = document.getElementById('clean-waste-type').value;
            const fee = document.getElementById('clean-fee').value;
            const otherNotes1 = document.getElementById('clean-other1').value;
            const otherNotes2 = document.getElementById('clean-other2').value;
            const otherNotes3 = document.getElementById('clean-other3').value;
            
            if (!date) {
                showStatus('clean-status', '請填寫清潔日期', 'error');
                return;
            }
            
            // 收集清潔範圍
            const cleaningScope = [];
            for (let i = 1; i <= 10; i++) {
                const scopeItem = document.getElementById(`clean-scope-${i}`).value.trim();
                if (scopeItem) {
                    cleaningScope.push(`${i}.${scopeItem}`);
                }
            }
            
            const dateObj = new Date(date);
            const weekDays = ['日', '一', '二', '三', '四', '五', '六'];
            const weekDay = weekDays[dateObj.getDay()];
            const formattedDate = `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
            const dateWithWeekday = `${formattedDate} 週${weekDay}`;
            
            // 格式化時間
            let formattedTime = time || '上午';
            if (time && time.includes(':')) {
                const [hour, minute] = time.split(':');
                const hourInt = parseInt(hour);
                if (hourInt < 12) {
                    formattedTime = `上午 ${hour}：${minute}`;
                } else if (hourInt < 18) {
                    formattedTime = `下午 ${hour}：${minute}`;
                } else {
                    formattedTime = `晚間 ${hour}：${minute}`;
                }
            }
            
            // 生成清潔範圍文字
            const scopeText = cleaningScope.length > 0 ? cleaningScope.join('\n') : '待現場確認';
            
            // 構建其他說明內容
            let otherDetails = '';
            let itemNumber = 5;
            if (otherNotes1) {
                otherDetails += `${itemNumber}.${otherNotes1}\n`;
                itemNumber++;
            }
            if (otherNotes2) {
                otherDetails += `${itemNumber}.${otherNotes2}\n`;
                itemNumber++;
            }
            if (otherNotes3) {
                otherDetails += `${itemNumber}.${otherNotes3}`;
            }
            
            const cleanTask = `🧑‍🚀清潔任務🧑‍🚀

➡️日期：${dateWithWeekday}
➡️電話：${phone}
➡️姓名：${name}
➡️地址：${address}
➡️上樓：${floor.includes('F') && !floor.includes('1F') ? '有' : '無'}
➡️費用：${fee}
➡️清潔範圍：
${scopeText}
➡️現況照片：如圖
➡️其他：
1.回報：
（1）單趟：XX+路段/街
2.現場清潔後及少量垃圾
   一律帶走清空
3.照片拍完善
4.清潔照片僅拍完成後照片即可
${otherDetails}

🔥已新增日曆🔥
🔥務必請過目🔥
🔥有問題提出🔥`;

            document.getElementById('clean-result').textContent = cleanTask;
            document.getElementById('clean-output').style.display = 'block';
            showStatus('clean-status', '✅ 清潔任務單轉換完成！', 'success');
        }

        // Copy to clipboard function
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(function() {
                    const statusId = elementId.includes('quote') ? 'quote-status' : 
                                   elementId.includes('monthly') ? 'monthly-status' :
                                   elementId.includes('single') ? 'single-status' : 'clean-status';
                    showStatus(statusId, '✅ 內容已成功複製到剪貼簿！', 'success');
                }, function(err) {
                    showStatus(statusId, '❌ 複製失敗，請手動選取文字複製', 'error');
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    const statusId = elementId.includes('quote') ? 'quote-status' : 
                                   elementId.includes('monthly') ? 'monthly-status' :
                                   elementId.includes('single') ? 'single-status' : 'clean-status';
                    showStatus(statusId, '✅ 內容已成功複製到剪貼簿！', 'success');
                } catch (err) {
                    showStatus(statusId, '❌ 複製失敗，請手動選取文字複製', 'error');
                }
                document.body.removeChild(textArea);
            }
        }

        // Show status message
        function showStatus(elementId, message, type) {
            const statusElement = document.getElementById(elementId);
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            
            setTimeout(() => {
                statusElement.textContent = '';
                statusElement.className = 'status';
            }, 4000);
        }

        // Clear form functions
        function clearQuoteForm() {
            // Reset form fields to default values
            document.getElementById('service-time').value = '0800';
            document.getElementById('floor-level').value = '1';
            document.getElementById('monthly-fee').value = '1200';
            document.getElementById('trash-bags').value = '6';
            document.getElementById('trash-volume').value = '14公升';
            document.getElementById('recycle-bags').value = '3';
            document.getElementById('recycle-volume').value = '14公升';
            document.getElementById('trash-max').value = '3';
            document.getElementById('recycle-max').value = '3';
            document.getElementById('special-notes').value = '';
            
            // Clear and reset checkboxes to default (週二 and 週五)
            const checkboxes = document.querySelectorAll('input[name="service-days"]');
            checkboxes.forEach(cb => cb.checked = false);
            document.querySelector('input[name="service-days"][value="週二"]').checked = true;
            document.querySelector('input[name="service-days"][value="週五"]').checked = true;
            
            // Hide output
            document.getElementById('quote-output').style.display = 'none';
            document.getElementById('quote-status').textContent = '';
            
            // Show confirmation message
            showStatus('quote-status', '✅ 表單已清空重置！', 'success');
        }

        function clearMonthlyForm() {
            document.getElementById('monthly-quote-data').value = '';
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('monthly-date').value = today;
            document.getElementById('monthly-percentage').value = '50';
            document.getElementById('monthly-upstairs').value = '不需上樓';
            document.getElementById('monthly-address').value = '';
            document.getElementById('monthly-phone').value = '';
            document.getElementById('monthly-name').value = '';
            document.getElementById('monthly-trash-pickup').value = '3';
            document.getElementById('monthly-recycle-pickup').value = '3';
            document.getElementById('monthly-key').value = '無';
            document.getElementById('monthly-time').value = '';
            document.getElementById('monthly-bag').value = '有';
            
            // Hide output
            document.getElementById('monthly-output').style.display = 'none';
            document.getElementById('monthly-status').textContent = '';
        }

        function clearSingleForm() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('single-date').value = today;
            document.getElementById('single-time').value = '';
            document.getElementById('single-phone').value = '';
            document.getElementById('single-name').value = '';
            document.getElementById('single-address').value = '';
            document.getElementById('single-floor').value = '';
            document.getElementById('single-customer-bag').value = '無';
            document.getElementById('single-waste-type').value = '如圖';
            document.getElementById('single-fee').value = '';
            document.getElementById('single-other1').value = '';
            document.getElementById('single-other2').value = '';
            document.getElementById('single-other3').value = '';
            
            // Clear images using the new clear function
            clearSingleImages();
            
            // Hide output
            document.getElementById('single-output').style.display = 'none';
            document.getElementById('single-status').textContent = '';
            
            // Show confirmation message
            showStatus('single-status', '✅ 表單已清空重置！', 'success');
        }

        function clearCleanForm() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('clean-date').value = today;
            document.getElementById('clean-time').value = '';
            document.getElementById('clean-phone').value = '';
            document.getElementById('clean-name').value = '';
            document.getElementById('clean-address').value = '';
            document.getElementById('clean-floor').value = '';
            document.getElementById('clean-waste-type').value = '如圖';
            document.getElementById('clean-fee').value = '';
            document.getElementById('clean-other1').value = '';
            document.getElementById('clean-other2').value = '';
            document.getElementById('clean-other3').value = '';
            
            // Clear cleaning scope inputs
            for (let i = 1; i <= 10; i++) {
                document.getElementById(`clean-scope-${i}`).value = '';
            }
            
            // Clear images using the new clear function
            clearCleanImages();
            
            // Hide output
            document.getElementById('clean-output').style.display = 'none';
            document.getElementById('clean-status').textContent = '';
        }

        // Set today's date as default for date inputs
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('monthly-date').value = today;
            document.getElementById('single-date').value = today;
            document.getElementById('clean-date').value = today;
            
            // Initialize drag and drop for single trip and clean photos
            initializeSingleImageUpload();
            initializeCleanImageUpload();
        });

        // Single trip image upload functions
        let singleImages = [];

        function initializeSingleImageUpload() {
            const dropZone = document.getElementById('single-drop-zone');
            const fileInput = document.getElementById('single-images');

            if (!dropZone || !fileInput) return;

            // Drag and drop events
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', (e) => {
                // Only remove dragover if we're actually leaving the drop zone
                if (!dropZone.contains(e.relatedTarget)) {
                    dropZone.classList.remove('dragover');
                }
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleSingleImageFiles(files);
            });

            // File input change event
            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                handleSingleImageFiles(files);
            });
        }

        function handleSingleImageFiles(files) {
            // Filter for image files only
            const imageFiles = files.filter(file => file.type.startsWith('image/'));
            
            if (imageFiles.length === 0) {
                showStatus('single-status', '❌ 請選擇有效的圖片檔案 (PNG, JPG, JPEG)', 'error');
                return;
            }

            // Add new images to collection
            imageFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageData = {
                        file: file,
                        dataUrl: e.target.result,
                        id: Date.now() + Math.random()
                    };
                    singleImages.push(imageData);
                    updateSingleImagePreview();
                };
                reader.readAsDataURL(file);
            });

            showStatus('single-status', `✅ 已添加 ${imageFiles.length} 張照片`, 'success');
        }

        function updateSingleImagePreview() {
            const previewContainer = document.getElementById('single-image-preview');
            const mergeControls = document.getElementById('single-merge-controls');
            
            if (singleImages.length === 0) {
                previewContainer.innerHTML = '';
                mergeControls.style.display = 'none';
                return;
            }

            // Show merge controls
            mergeControls.style.display = 'flex';
            
            // Create compact preview HTML for inline layout
            let previewHTML = '<div style="margin-bottom: 8px; font-size: 14px; color: #ccc;"><strong>已上傳 (' + singleImages.length + '張)</strong></div>';
            previewHTML += '<div style="display: flex; flex-wrap: wrap; gap: 5px;">';
            
            // Show only first 6 images in preview, indicate more if needed
            const displayCount = Math.min(6, singleImages.length);
            
            for (let i = 0; i < displayCount; i++) {
                const image = singleImages[i];
                previewHTML += `
                    <div class="photo-preview-inline" style="position: relative; display: inline-block;">
                        <img src="${image.dataUrl}" alt="Photo ${i + 1}" style="width: 60px; height: 45px; object-fit: cover; border-radius: 3px; border: 1px solid #444;">
                        <button class="photo-remove-inline" onclick="removeSingleImage(${image.id})" title="刪除照片" style="position: absolute; top: -5px; right: -5px; background: rgba(231, 76, 60, 0.9); color: white; border: none; border-radius: 50%; width: 16px; height: 16px; cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center;">×</button>
                    </div>
                `;
            }
            
            if (singleImages.length > 6) {
                previewHTML += `<div style="color: #888; font-size: 12px; align-self: center;">+${singleImages.length - 6}張</div>`;
            }
            
            previewHTML += '</div>';
            previewContainer.innerHTML = previewHTML;
        }

        function removeSingleImage(imageId) {
            singleImages = singleImages.filter(img => img.id !== imageId);
            updateSingleImagePreview();
            
            if (singleImages.length === 0) {
                document.getElementById('single-merged-preview').innerHTML = '';
                showStatus('single-status', '✅ 所有照片已清除', 'success');
            }
        }

        function clearSingleImages() {
            singleImages = [];
            document.getElementById('single-images').value = '';
            document.getElementById('single-image-preview').innerHTML = '';
            document.getElementById('single-merged-preview').innerHTML = '';
            document.getElementById('single-merge-controls').style.display = 'none';
            showStatus('single-status', '✅ 所有照片已清除', 'success');
        }

        function mergeSingleImages() {
            if (singleImages.length === 0) {
                showStatus('single-status', '❌ 請先上傳照片', 'error');
                return;
            }

            showStatus('single-status', '🔄 正在合併照片...', 'success');

            // Create canvas for merging
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Load all images and merge
            Promise.all(singleImages.map(imageData => {
                return new Promise(resolve => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.src = imageData.dataUrl;
                });
            })).then(images => {
                // Smart grid layout based on image count
                let imagesPerRow, rows;
                if (images.length === 1) {
                    imagesPerRow = 1;
                    rows = 1;
                } else if (images.length === 2) {
                    imagesPerRow = 2;
                    rows = 1;
                } else if (images.length === 3) {
                    imagesPerRow = 3;
                    rows = 1;
                } else if (images.length === 4) {
                    imagesPerRow = 2;
                    rows = 2;
                } else if (images.length <= 6) {
                    imagesPerRow = 3;
                    rows = 2;
                } else if (images.length <= 9) {
                    imagesPerRow = 3;
                    rows = 3;
                } else {
                    imagesPerRow = 4;
                    rows = Math.ceil(images.length / 4);
                }
                
                const imageSize = Math.floor(600 / Math.max(imagesPerRow, rows));
                const totalWidth = imagesPerRow * imageSize;
                const totalHeight = rows * imageSize;
                
                // Optimize canvas size to reduce white space
                const actualWidth = totalWidth + 40;
                const actualHeight = totalHeight + 40;
                canvas.width = actualWidth;
                canvas.height = actualHeight;
                const finalMarginX = 20;
                const finalMarginY = 20;
                
                // Fill background
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw images in smart grid
                images.forEach((img, index) => {
                    const col = index % imagesPerRow;
                    const row = Math.floor(index / imagesPerRow);
                    const x = finalMarginX + col * imageSize;
                    const y = finalMarginY + row * imageSize;
                    
                    // Draw image as square (crop to fit)
                    const aspectRatio = img.width / img.height;
                    let sourceX = 0, sourceY = 0, sourceSize;
                    
                    if (aspectRatio > 1) {
                        // 寬圖片，裁切左右
                        sourceSize = img.height;
                        sourceX = (img.width - sourceSize) / 2;
                    } else {
                        // 高圖片，裁切上下
                        sourceSize = img.width;
                        sourceY = (img.height - sourceSize) / 2;
                    }
                    
                    ctx.drawImage(img, sourceX, sourceY, sourceSize, sourceSize, x, y, imageSize, imageSize);
                    
                    // Draw red grid lines
                    ctx.strokeStyle = '#FF0000';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y, imageSize, imageSize);
                });
                
                // Add watermark "聯雄認證" with date/time from bottom-left to top-right
                const now = new Date();
                const dateStr = now.getFullYear() + '/' + 
                              String(now.getMonth() + 1).padStart(2, '0') + '/' + 
                              String(now.getDate()).padStart(2, '0');
                const timeStr = String(now.getHours()).padStart(2, '0') + ':' + 
                              String(now.getMinutes()).padStart(2, '0') + ':' + 
                              String(now.getSeconds()).padStart(2, '0');
                const watermarkText = `聯雄認證 ${dateStr} ${timeStr}`;
                
                ctx.save();
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate(-Math.PI / 4); // -45 degrees (left-bottom to right-top)
                ctx.font = 'bold 32px Arial, sans-serif';
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.lineWidth = 1;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.strokeText(watermarkText, 0, 0);
                ctx.fillText(watermarkText, 0, 0);
                ctx.restore();
                
                // Display merged image
                const mergedDataUrl = canvas.toDataURL('image/jpeg', 0.9);
                const mergedPreview = document.getElementById('single-merged-preview');
                mergedPreview.innerHTML = `
                    <div class="merged-photo">
                        <div class="merged-photo-content">
                            <div><strong>合併照片：</strong></div>
                            <img src="${mergedDataUrl}" alt="合併照片">
                        </div>
                        <div class="merged-photo-controls">
                            <button class="btn-download" onclick="downloadMergedImage('${mergedDataUrl}', 'single')">↓</button>
                        </div>
                    </div>
                `;
                
                showStatus('single-status', `✅ 已成功合併 ${images.length} 張照片！`, 'success');
            });
        }

        function downloadMergedImage(dataUrl, type) {
            const link = document.createElement('a');
            link.download = `合併照片_${type}_${new Date().toISOString().slice(0,10)}.jpg`;
            link.href = dataUrl;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Clean task image upload functions
        let cleanImages = [];

        function initializeCleanImageUpload() {
            const dropZone = document.getElementById('clean-drop-zone');
            const fileInput = document.getElementById('clean-images');

            if (!dropZone || !fileInput) return;

            // Drag and drop events
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', (e) => {
                if (!dropZone.contains(e.relatedTarget)) {
                    dropZone.classList.remove('dragover');
                }
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleCleanImageFiles(files);
            });

            // File input change event
            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                handleCleanImageFiles(files);
            });
        }

        function handleCleanImageFiles(files) {
            const imageFiles = files.filter(file => file.type.startsWith('image/'));
            
            if (imageFiles.length === 0) {
                showStatus('clean-status', '❌ 請選擇有效的圖片檔案 (PNG, JPG, JPEG)', 'error');
                return;
            }

            imageFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageData = {
                        file: file,
                        dataUrl: e.target.result,
                        id: Date.now() + Math.random()
                    };
                    cleanImages.push(imageData);
                    updateCleanImagePreview();
                };
                reader.readAsDataURL(file);
            });

            showStatus('clean-status', `✅ 已添加 ${imageFiles.length} 張照片`, 'success');
        }

        function updateCleanImagePreview() {
            const previewContainer = document.getElementById('clean-image-preview');
            const mergeControls = document.getElementById('clean-merge-controls');
            
            if (cleanImages.length === 0) {
                previewContainer.innerHTML = '';
                mergeControls.style.display = 'none';
                return;
            }

            // Show merge controls
            mergeControls.style.display = 'flex';
            
            // Create compact preview HTML for inline layout
            let previewHTML = '<div style="margin-bottom: 8px; font-size: 14px; color: #ccc;"><strong>已上傳 (' + cleanImages.length + '張)</strong></div>';
            previewHTML += '<div style="display: flex; flex-wrap: wrap; gap: 5px;">';
            
            const displayCount = Math.min(6, cleanImages.length);
            
            for (let i = 0; i < displayCount; i++) {
                const image = cleanImages[i];
                previewHTML += `
                    <div class="photo-preview-inline" style="position: relative; display: inline-block;">
                        <img src="${image.dataUrl}" alt="Photo ${i + 1}" style="width: 60px; height: 45px; object-fit: cover; border-radius: 3px; border: 1px solid #444;">
                        <button class="photo-remove-inline" onclick="removeCleanImage(${image.id})" title="刪除照片" style="position: absolute; top: -5px; right: -5px; background: rgba(231, 76, 60, 0.9); color: white; border: none; border-radius: 50%; width: 16px; height: 16px; cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center;">×</button>
                    </div>
                `;
            }
            
            if (cleanImages.length > 6) {
                previewHTML += `<div style="color: #888; font-size: 12px; align-self: center;">+${cleanImages.length - 6}張</div>`;
            }
            
            previewHTML += '</div>';
            previewContainer.innerHTML = previewHTML;
        }

        function removeCleanImage(imageId) {
            cleanImages = cleanImages.filter(img => img.id !== imageId);
            updateCleanImagePreview();
            
            if (cleanImages.length === 0) {
                document.getElementById('clean-merged-preview').innerHTML = '';
                showStatus('clean-status', '✅ 所有照片已清除', 'success');
            }
        }

        function clearCleanImages() {
            cleanImages = [];
            document.getElementById('clean-images').value = '';
            document.getElementById('clean-image-preview').innerHTML = '';
            document.getElementById('clean-merged-preview').innerHTML = '';
            document.getElementById('clean-merge-controls').style.display = 'none';
            showStatus('clean-status', '✅ 所有照片已清除', 'success');
        }

        function mergeCleanImages() {
            if (cleanImages.length === 0) {
                showStatus('clean-status', '❌ 請先上傳照片', 'error');
                return;
            }

            showStatus('clean-status', '🔄 正在合併照片...', 'success');

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            Promise.all(cleanImages.map(imageData => {
                return new Promise(resolve => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.src = imageData.dataUrl;
                });
            })).then(images => {
                // Smart grid layout based on image count
                let imagesPerRow, rows;
                if (images.length === 1) {
                    imagesPerRow = 1;
                    rows = 1;
                } else if (images.length === 2) {
                    imagesPerRow = 2;
                    rows = 1;
                } else if (images.length === 3) {
                    imagesPerRow = 3;
                    rows = 1;
                } else if (images.length === 4) {
                    imagesPerRow = 2;
                    rows = 2;
                } else if (images.length <= 6) {
                    imagesPerRow = 3;
                    rows = 2;
                } else if (images.length <= 9) {
                    imagesPerRow = 3;
                    rows = 3;
                } else {
                    imagesPerRow = 4;
                    rows = Math.ceil(images.length / 4);
                }
                
                const imageSize = Math.floor(600 / Math.max(imagesPerRow, rows));
                const totalWidth = imagesPerRow * imageSize;
                const totalHeight = rows * imageSize;
                
                // Optimize canvas size to reduce white space
                const actualWidth = totalWidth + 40;
                const actualHeight = totalHeight + 40;
                canvas.width = actualWidth;
                canvas.height = actualHeight;
                const finalMarginX = 20;
                const finalMarginY = 20;
                
                // Fill background
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw images in smart grid
                images.forEach((img, index) => {
                    const col = index % imagesPerRow;
                    const row = Math.floor(index / imagesPerRow);
                    const x = finalMarginX + col * imageSize;
                    const y = finalMarginY + row * imageSize;
                    
                    // Draw image as square (crop to fit)
                    const aspectRatio = img.width / img.height;
                    let sourceX = 0, sourceY = 0, sourceSize;
                    
                    if (aspectRatio > 1) {
                        // 寬圖片，裁切左右
                        sourceSize = img.height;
                        sourceX = (img.width - sourceSize) / 2;
                    } else {
                        // 高圖片，裁切上下
                        sourceSize = img.width;
                        sourceY = (img.height - sourceSize) / 2;
                    }
                    
                    ctx.drawImage(img, sourceX, sourceY, sourceSize, sourceSize, x, y, imageSize, imageSize);
                    
                    // Draw red grid lines
                    ctx.strokeStyle = '#FF0000';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y, imageSize, imageSize);
                });
                
                // Add watermark "聯雄認證" with date/time from bottom-left to top-right
                const now = new Date();
                const dateStr = now.getFullYear() + '/' + 
                              String(now.getMonth() + 1).padStart(2, '0') + '/' + 
                              String(now.getDate()).padStart(2, '0');
                const timeStr = String(now.getHours()).padStart(2, '0') + ':' + 
                              String(now.getMinutes()).padStart(2, '0') + ':' + 
                              String(now.getSeconds()).padStart(2, '0');
                const watermarkText = `聯雄認證 ${dateStr} ${timeStr}`;
                
                ctx.save();
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate(-Math.PI / 4); // -45 degrees (left-bottom to right-top)
                ctx.font = 'bold 32px Arial, sans-serif';
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.lineWidth = 1;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.strokeText(watermarkText, 0, 0);
                ctx.fillText(watermarkText, 0, 0);
                ctx.restore();
                
                const mergedDataUrl = canvas.toDataURL('image/jpeg', 0.9);
                const mergedPreview = document.getElementById('clean-merged-preview');
                mergedPreview.innerHTML = `
                    <div class="merged-photo">
                        <div class="merged-photo-content">
                            <div><strong>合併照片：</strong></div>
                            <img src="${mergedDataUrl}" alt="合併照片">
                        </div>
                        <div class="merged-photo-controls">
                            <button class="btn-download" onclick="downloadMergedImage('${mergedDataUrl}', 'clean')">↓</button>
                        </div>
                    </div>
                `;
                
                showStatus('clean-status', `✅ 已成功合併 ${images.length} 張照片！`, 'success');
            });
        }

        // 自動報價單相關函數
        let autoQuoteData = null;

        function clearAutoQuoteForm() {
            // 清空Google試算表網址
            document.getElementById('sheets-url').value = '';
            document.getElementById('saved-urls').value = '';
            
            // 清空手動輸入欄位
            document.getElementById('manual-fee').value = '';
            document.getElementById('manual-time').value = '';
            document.getElementById('manual-floor').value = '';
            document.getElementById('manual-frequency').value = '';
            document.getElementById('manual-trash').value = '';
            document.getElementById('manual-recycle').value = '';
            document.getElementById('manual-trash-volume').value = '';
            document.getElementById('manual-recycle-volume').value = '';
            document.getElementById('manual-trash-max').value = '';
            document.getElementById('manual-recycle-max').value = '';
            document.getElementById('manual-special-notes').value = '';
            
            // 清空複選框
            document.querySelectorAll('input[name="manual-days"]').forEach(cb => cb.checked = false);
            
            // 隱藏輸出區域
            document.getElementById('auto-detected-data').style.display = 'none';
            document.getElementById('auto-quote-controls').style.display = 'none';
            document.getElementById('auto-quote-output').style.display = 'none';
            document.getElementById('auto-sheets-status').style.display = 'none';
            document.getElementById('auto-quote-final-status').style.display = 'none';
            
            // 清空數據
            autoQuoteData = null;
        }

        async function fetchGoogleSheetsData() {
            const sheetsUrl = document.getElementById('sheets-url').value.trim();
            
            if (!sheetsUrl) {
                showStatus('auto-sheets-status', '❌ 請輸入Google試算表網址', 'error');
                return;
            }

            if (!sheetsUrl.includes('docs.google.com/spreadsheets')) {
                showStatus('auto-sheets-status', '❌ 請輸入有效的Google試算表連結', 'error');
                return;
            }

            showStatus('auto-sheets-status', '🔄 正在載入試算表資料...', 'success');

            try {
                // 從URL中提取試算表ID
                let spreadsheetId = '';
                const urlMatch = sheetsUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                if (urlMatch) {
                    spreadsheetId = urlMatch[1];
                } else {
                    throw new Error('無法解析試算表ID，請確認URL格式正確');
                }

                // 構建CSV導出URL - 更穩定的方式
                const csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv`;
                
                console.log('正在嘗試載入:', csvUrl);

                // 使用代理方式避免CORS問題
                const proxyUrl = `https://cors-anywhere.herokuapp.com/${csvUrl}`;
                let response;
                
                try {
                    // 首先嘗試直接訪問
                    response = await fetch(csvUrl, {
                        mode: 'cors',
                        headers: {
                            'Accept': 'text/csv,text/plain'
                        }
                    });
                } catch (corsError) {
                    console.log('直接訪問失敗，嘗試代理方式:', corsError);
                    // 如果CORS失敗，顯示說明
                    throw new Error('由於瀏覽器安全限制，無法直接讀取Google試算表。請確認：\n1. 試算表已設為「知道連結的使用者」可檢視\n2. 或手動複製貼上資料到下方');
                }

                if (!response.ok) {
                    if (response.status === 403) {
                        throw new Error('無法存取試算表，請確認分享設定為「知道連結的使用者」可檢視');
                    } else if (response.status === 404) {
                        throw new Error('找不到試算表，請確認網址正確');
                    } else {
                        throw new Error(`載入失敗 (錯誤代碼: ${response.status})`);
                    }
                }

                const csvText = await response.text();
                console.log('CSV資料:', csvText.substring(0, 200) + '...');
                
                if (!csvText || csvText.trim().length === 0) {
                    throw new Error('試算表資料為空，請確認表格中有資料');
                }

                // 改進的CSV解析
                const rows = parseCSV(csvText);
                const filteredRows = rows.filter(row => row.some(cell => cell && cell.length > 0));
                
                if (filteredRows.length === 0) {
                    throw new Error('試算表中沒有找到任何有效資料');
                }

                const startRow = Math.max(0, parseInt(document.getElementById('start-row').value) - 1);
                const updateMode = document.getElementById('update-mode').value;
                
                let dataRows;
                if (updateMode === 'latest') {
                    dataRows = filteredRows.slice(-1);
                } else if (updateMode === 'last-5') {
                    dataRows = filteredRows.slice(-5);
                } else {
                    dataRows = filteredRows.slice(startRow);
                }

                autoQuoteData = {
                    headers: filteredRows[0] || [],
                    rows: dataRows
                };

                displayDetectedData(autoQuoteData);
                showStatus('auto-sheets-status', `✅ 成功載入 ${dataRows.length} 筆資料`, 'success');

            } catch (error) {
                console.error('載入試算表失敗:', error);
                showStatus('auto-sheets-status', `❌ ${error.message}`, 'error');
                
                // 顯示手動輸入選項
                showManualDataInput();
            }
        }

        // 改進的CSV解析函數
        function parseCSV(csvText) {
            const rows = [];
            const lines = csvText.split('\n');
            
            for (let line of lines) {
                if (!line.trim()) continue;
                
                const row = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        row.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                row.push(current.trim());
                rows.push(row);
            }
            
            return rows;
        }

        // 顯示手動資料輸入選項
        function showManualDataInput() {
            const detectedDataDiv = document.getElementById('auto-detected-data');
            detectedDataDiv.style.display = 'block';
            
            const preview = document.getElementById('detected-data-preview');
            preview.innerHTML = `
                <div style="text-align: center; padding: 20px; background: #333; border-radius: 8px;">
                    <h4 style="color: #ffd700; margin-bottom: 15px;">📋 手動資料輸入</h4>
                    <p style="color: #e0e0e0; margin-bottom: 15px;">由於自動讀取失敗，請手動輸入客戶資料：</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="manual-name" placeholder="客戶姓名" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                        <input type="text" id="manual-address" placeholder="服務地址" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                        <input type="text" id="manual-phone" placeholder="聯絡電話" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                        <input type="number" id="manual-fee" placeholder="月費" value="1200" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                        <input type="text" id="manual-days" placeholder="服務星期" value="週二、週五" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                        <input type="text" id="manual-time" placeholder="服務時間" value="0800" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                        <input type="number" id="manual-floor" placeholder="樓層" value="1" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                        <input type="number" id="manual-trash" placeholder="垃圾袋數" value="6" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                        <input type="number" id="manual-recycle" placeholder="資源袋數" value="3" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                    </div>
                    <button onclick="useManualData()" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold;">
                        ✅ 使用手動資料生成報價單
                    </button>
                </div>
            `;
            
            document.getElementById('auto-quote-controls').style.display = 'none';
        }

        // 使用手動輸入的資料
        function useManualData() {
            showStatus('auto-sheets-status', '🔄 正在使用手動資料生成報價單...', 'success');
            
            const selectedDays = Array.from(document.querySelectorAll('input[name="manual-days"]:checked')).map(cb => cb.value);
            const manualData = {
                lineName: '',
                address: '',
                housingType: '',
                monthlyFee: document.getElementById('manual-fee').value || '',
                serviceDays: selectedDays.join('、') || '',
                serviceTime: document.getElementById('manual-time').value || '',
                floor: document.getElementById('manual-floor').value || '',
                trashBags: document.getElementById('manual-trash').value || '',
                recycleBags: document.getElementById('manual-recycle').value || '',
                trashVolume: document.getElementById('manual-trash-volume').value || '',
                recycleVolume: document.getElementById('manual-recycle-volume').value || '',
                trashMax: document.getElementById('manual-trash-max').value || '',
                recycleMax: document.getElementById('manual-recycle-max').value || '',
                specialNotes: document.getElementById('manual-special-notes').value || ''
            };

            try {
                const quote = generateQuoteFromData(manualData);
                document.getElementById('auto-quote-result-display').textContent = quote;
                document.getElementById('auto-quote-output').style.display = 'block';
                
                // 顯示使用的資料預覽
                const preview = document.getElementById('detected-data-preview');
                preview.innerHTML = `
                    <div style="background: #2a2a2a; padding: 15px; border-radius: 8px; color: #e0e0e0;">
                        <h4 style="color: #28a745; margin-bottom: 10px;">✅ 使用的手動資料：</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <div><strong>月費：</strong> ${manualData.monthlyFee}元</div>
                            <div><strong>收取星期：</strong> ${manualData.serviceDays}</div>
                            <div><strong>服務時間：</strong> ${manualData.serviceTime}</div>
                            <div><strong>樓層：</strong> ${manualData.floor}樓</div>
                            <div><strong>垃圾袋數：</strong> ${manualData.trashBags}包</div>
                            <div><strong>資源袋數：</strong> ${manualData.recycleBags}包</div>
                            <div><strong>垃圾袋容量：</strong> ${manualData.trashVolume}</div>
                            <div><strong>資源袋容量：</strong> ${manualData.recycleVolume}</div>
                            <div><strong>最多垃圾袋數：</strong> ${manualData.trashMax}袋</div>
                            <div><strong>最多資源袋數：</strong> ${manualData.recycleMax}袋</div>
                            ${manualData.specialNotes ? `<div><strong>特殊需求：</strong> ${manualData.specialNotes}</div>` : ''}
                        </div>
                    </div>
                `;
                
                document.getElementById('auto-detected-data').style.display = 'block';
                showStatus('auto-quote-final-status', '✅ 手動資料報價單生成完成！', 'success');
                
            } catch (error) {
                showStatus('auto-quote-final-status', `❌ 生成失敗: ${error.message}`, 'error');
            }
        }

        function displayDetectedData(data) {
            const preview = document.getElementById('detected-data-preview');
            let html = '<table style="width: 100%; border-collapse: collapse; color: #e0e0e0;">';
            
            if (data.headers.length > 0) {
                html += '<tr style="background: #404040;">';
                data.headers.forEach(header => {
                    // 簡化表頭顯示：移除表情符號，提取關鍵字
                    let simplifiedHeader = header;
                    
                    // 移除所有表情符號
                    simplifiedHeader = simplifiedHeader.replace(/[\u{1F000}-\u{1F6FF}]|[\u{1F700}-\u{1F77F}]|[\u{1F780}-\u{1F7FF}]|[\u{1F800}-\u{1F8FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '');
                    
                    // 判斷欄位類型
                    const isResourceField = header.toLowerCase().includes('資源');
                    const isTrashField = header.toLowerCase().includes('垃圾');
                    
                    // 提取關鍵字（方括號內的內容或最後的重要詞彙）
                    const bracketMatch = simplifiedHeader.match(/\[([^\]]+)\]/);
                    if (bracketMatch) {
                        simplifiedHeader = bracketMatch[1];
                    } else {
                        // 如果沒有方括號，提取最後的關鍵詞
                        if (simplifiedHeader.includes('地址')) {
                            simplifiedHeader = '地址';
                        } else {
                            simplifiedHeader = simplifiedHeader.trim()
                                .replace(/.*垃圾.*/, '垃圾量')
                                .replace(/.*資源.*/, '資源量')
                                .replace(/.*月費.*|.*費用.*/, '月費')
                                .replace(/.*星期.*|.*收取.*/, '次數')
                                .replace(/.*時間.*/, '時間')
                                .replace(/.*樓層.*/, '樓層')
                                .replace(/.*line.*|.*暱稱.*/, 'LINE暱稱')
                                .replace(/.*住宅.*|.*性質.*/, '住宅性質');
                        }
                    }
                    
                    // 清理多餘的空格和符號
                    simplifiedHeader = simplifiedHeader.replace(/["""'']/g, '').trim();
                    
                    // 設定樣式：垃圾欄位用紅色，資源欄位用綠色
                    let backgroundColor = '#404040';
                    let textColor = '#e0e0e0';
                    
                    if (isTrashField) {
                        backgroundColor = '#dc3545'; // 紅色
                        textColor = '#ffffff';
                    } else if (isResourceField) {
                        backgroundColor = '#28a745'; // 綠色
                        textColor = '#ffffff';
                    }
                    
                    html += `<th style="border: 1px solid #666; padding: 8px; text-align: left; background-color: ${backgroundColor}; color: ${textColor};">${simplifiedHeader}</th>`;
                });
                html += '</tr>';
            }

            data.rows.forEach((row, index) => {
                html += `<tr style="background: ${index % 2 === 0 ? '#2a2a2a' : '#333333'};">`;
                row.forEach(cell => {
                    html += `<td style="border: 1px solid #666; padding: 8px;">${cell}</td>`;
                });
                html += '</tr>';
            });

            html += '</table>';
            preview.innerHTML = html;
            
            document.getElementById('auto-detected-data').style.display = 'block';
            document.getElementById('auto-quote-controls').style.display = 'block';
        }

        function generateAutoQuote() {
            if (!autoQuoteData || !autoQuoteData.rows || autoQuoteData.rows.length === 0) {
                showStatus('auto-quote-final-status', '❌ 請先載入試算表資料', 'error');
                return;
            }

            showStatus('auto-quote-final-status', '🔄 正在生成自動報價單...', 'success');

            try {
                const latestRow = autoQuoteData.rows[autoQuoteData.rows.length - 1];
                const headers = autoQuoteData.headers;
                
                // 先獲取手動輸入的資料
                const selectedDays = Array.from(document.querySelectorAll('input[name="manual-days"]:checked')).map(cb => cb.value);
                const manualData = {
                    lineName: '',
                    address: '',
                    housingType: '',
                    monthlyFee: document.getElementById('manual-fee').value || '',
                    serviceDays: selectedDays.join('、') || '',
                    serviceTime: document.getElementById('manual-time').value || '',
                    floor: document.getElementById('manual-floor').value || '',
                    frequency: document.getElementById('manual-frequency').value || '',
                    trashBags: document.getElementById('manual-trash').value || '',
                    recycleBags: document.getElementById('manual-recycle').value || '',
                    trashVolume: document.getElementById('manual-trash-volume').value || '',
                    recycleVolume: document.getElementById('manual-recycle-volume').value || '',
                    trashMax: document.getElementById('manual-trash-max').value || '',
                    recycleMax: document.getElementById('manual-recycle-max').value || '',
                    specialNotes: document.getElementById('manual-special-notes').value || ''
                };

                const fieldMapping = {};
                console.log('Headers:', headers);
                console.log('Latest row:', latestRow);
                
                // 收集垃圾和資源的包數與容量數據
                let trashData = { bags: '', volume: '' };
                let recycleData = { bags: '', volume: '' };
                
                headers.forEach((header, index) => {
                    const lowerHeader = header.toLowerCase();
                    const cellValue = latestRow[index];
                    console.log(`Processing header: "${header}" (${lowerHeader}) with value: "${cellValue}"`);
                    
                    if (lowerHeader.includes('line') || lowerHeader.includes('暱稱')) {
                        fieldMapping.lineName = cellValue;
                    } else if (lowerHeader.includes('地址')) {
                        fieldMapping.address = cellValue;
                        
                        // 自動偵測地址中的樓層數字並填入樓層欄位（只在手動欄位為空時）
                        if (cellValue && (!manualData.floor || manualData.floor.trim() === '')) {
                            const floorMatch = cellValue.match(/(\d+)[樓F]/);
                            if (floorMatch) {
                                fieldMapping.floor = floorMatch[1];
                                // 只在手動欄位為空時自動填入
                                document.getElementById('manual-floor').value = floorMatch[1];
                                console.log(`Auto-detected floor: ${floorMatch[1]} from address: ${cellValue}`);
                            } else {
                                console.log(`No floor detected in address: ${cellValue}, keeping manual input`);
                            }
                        }
                    } else if (lowerHeader.includes('住宅') || lowerHeader.includes('性質')) {
                        fieldMapping.housingType = cellValue;
                    } else if (lowerHeader.includes('月費') || lowerHeader.includes('費用')) {
                        // 優先使用手動輸入的月費，其次是試算表數據
                        fieldMapping.monthlyFee = (manualData.monthlyFee && manualData.monthlyFee.trim() !== '') ? manualData.monthlyFee : cellValue;
                    } else if (lowerHeader.includes('星期') || lowerHeader.includes('收取')) {
                        // 處理次數欄位，生成「一週趟數：X趟」格式
                        if (cellValue && cellValue.trim() !== '') {
                            const frequencyMatch = cellValue.match(/(\d+)/);
                            if (frequencyMatch) {
                                fieldMapping.weeklyFrequency = `一週趟數：${frequencyMatch[1]}趟`;
                            } else {
                                fieldMapping.weeklyFrequency = `一週趟數：${cellValue}趟`;
                            }
                        }
                        // 保持原有的服務日邏輯
                        fieldMapping.serviceDays = manualData.serviceDays;
                    } else if (lowerHeader.includes('時間')) {
                        // 優先使用手動輸入的時間，其次是試算表數據
                        fieldMapping.serviceTime = (manualData.serviceTime && manualData.serviceTime.trim() !== '') ? manualData.serviceTime : cellValue;
                    } else if (lowerHeader.includes('樓層')) {
                        // 優先使用手動輸入的樓層資料，其次是試算表中的樓層資料，最後預設為0
                        fieldMapping.floor = (manualData.floor && manualData.floor.trim() !== '') ? manualData.floor : ((cellValue && cellValue.trim() !== '') ? cellValue : '0');
                    } else if (lowerHeader.includes('垃圾')) {
                        console.log(`Found trash header: "${header}" with value: "${cellValue}"`);
                        // 如果該欄位有數據，同時記錄包數和容量
                        if (cellValue && cellValue.trim() !== '') {
                            const bagMatch = cellValue.match(/(\d+)包/);
                            const headerVolumeMatch = header.match(/(\d+(?:\/\d+)?公升)/);
                            
                            if (bagMatch) {
                                trashData.bags = bagMatch[1];
                                // 同時記錄該欄位對應的容量
                                if (headerVolumeMatch) {
                                    trashData.volume = headerVolumeMatch[1];
                                }
                                console.log(`Trash data found: ${trashData.bags}包 in ${header} (volume: ${trashData.volume})`);
                            }
                        }
                    } else if (lowerHeader.includes('資源')) {
                        console.log(`Found recycle header: "${header}" with value: "${cellValue}"`);
                        // 如果該欄位有數據，同時記錄包數和容量
                        if (cellValue && cellValue.trim() !== '') {
                            const bagMatch = cellValue.match(/(\d+)包/);
                            const headerVolumeMatch = header.match(/(\d+(?:\/\d+)?公升)/);
                            
                            if (bagMatch) {
                                recycleData.bags = bagMatch[1];
                                // 同時記錄該欄位對應的容量
                                if (headerVolumeMatch) {
                                    recycleData.volume = headerVolumeMatch[1];
                                }
                                console.log(`Recycle data found: ${recycleData.bags}包 in ${header} (volume: ${recycleData.volume})`);
                            }
                        }
                    }
                });
                
                // 組合垃圾袋數據
                if (manualData.trashBags || manualData.trashVolume) {
                    if (manualData.trashBags && manualData.trashVolume) {
                        fieldMapping.trashBags = `${manualData.trashBags}包數（${manualData.trashVolume}）`;
                    } else if (manualData.trashBags) {
                        fieldMapping.trashBags = `${manualData.trashBags}包數（14公升）`;
                    } else {
                        fieldMapping.trashBags = `6包數（${manualData.trashVolume}）`;
                    }
                } else if (trashData.bags && trashData.volume) {
                    fieldMapping.trashBags = `${trashData.bags}包（${trashData.volume}）`;
                } else if (trashData.bags) {
                    fieldMapping.trashBags = `${trashData.bags}包（14公升）`;
                } else {
                    fieldMapping.trashBags = '6包（14公升）';
                }
                
                // 組合資源袋數據
                if (manualData.recycleBags || manualData.recycleVolume) {
                    if (manualData.recycleBags && manualData.recycleVolume) {
                        fieldMapping.recycleBags = `${manualData.recycleBags}包數（${manualData.recycleVolume}）`;
                    } else if (manualData.recycleBags) {
                        fieldMapping.recycleBags = `${manualData.recycleBags}包數（14公升）`;
                    } else {
                        fieldMapping.recycleBags = `3包數（${manualData.recycleVolume}）`;
                    }
                } else if (recycleData.bags && recycleData.volume) {
                    fieldMapping.recycleBags = `${recycleData.bags}包（${recycleData.volume}）`;
                } else if (recycleData.bags) {
                    fieldMapping.recycleBags = `${recycleData.bags}包（14公升）`;
                } else {
                    fieldMapping.recycleBags = '3包（14公升）';
                }
                
                console.log(`Final trash data: bags="${trashData.bags}", volume="${trashData.volume}", result="${fieldMapping.trashBags}"`);
                console.log(`Final recycle data: bags="${recycleData.bags}", volume="${recycleData.volume}", result="${fieldMapping.recycleBags}"`);
                
                console.log('Final field mapping:', fieldMapping);
                
                // 加入手動輸入的其他數據
                if (manualData.trashMax) {
                    fieldMapping.trashMax = manualData.trashMax;
                }
                if (manualData.recycleMax) {
                    fieldMapping.recycleMax = manualData.recycleMax;
                }
                if (manualData.specialNotes) {
                    fieldMapping.specialNotes = manualData.specialNotes;
                }
                // 確保手動輸入的重要欄位正確傳遞（覆蓋之前的設定）
                if (manualData.frequency) {
                    fieldMapping.frequency = manualData.frequency;
                }
                // 確保手動輸入的樓層一定優先使用
                if (manualData.floor && manualData.floor.trim() !== '') {
                    fieldMapping.floor = manualData.floor;
                }
                // 確保手動輸入的月費一定優先使用
                if (manualData.monthlyFee && manualData.monthlyFee.trim() !== '') {
                    fieldMapping.monthlyFee = manualData.monthlyFee;
                }
                // 確保手動輸入的時間一定優先使用
                if (manualData.serviceTime && manualData.serviceTime.trim() !== '') {
                    fieldMapping.serviceTime = manualData.serviceTime;
                }

                const quote = generateQuoteFromData(fieldMapping);
                
                document.getElementById('auto-quote-result-display').textContent = quote;
                document.getElementById('auto-quote-output').style.display = 'block';
                showStatus('auto-quote-final-status', '✅ 自動報價單生成完成！', 'success');

            } catch (error) {
                console.error('生成報價單失敗:', error);
                showStatus('auto-quote-final-status', `❌ 生成失敗: ${error.message}`, 'error');
            }
        }

        function generateQuoteFromData(data) {
            const lineName = data.lineName || '';
            const address = data.address || '';
            const housingType = data.housingType || '';
            const monthlyFee = (data.monthlyFee && data.monthlyFee.trim() !== '') ? data.monthlyFee : '0';
            const serviceDays = data.serviceDays || '週二、週五';
            const serviceTime = (data.serviceTime && data.serviceTime.trim() !== '') ? data.serviceTime : '0';
            const floor = (data.floor && data.floor.trim() !== '') ? data.floor : '0';
            const trashBags = data.trashBags || '6';
            const recycleBags = data.recycleBags || '3';

            // 樓層顯示
            let floorDisplay;
            const floorNum = parseInt(floor);
            if (floorNum < 0) {
                floorDisplay = `地下${Math.abs(floorNum)}樓`;
            } else {
                floorDisplay = `${floorNum}F`;
            }

            // 時間格式化 - 根據時間自動判斷上午/下午/晚上
            let timeDisplay = serviceTime;
            if (serviceTime && serviceTime.length === 4 && /^\d{4}$/.test(serviceTime)) {
                const hour = parseInt(serviceTime.substring(0, 2));
                const minute = serviceTime.substring(2);
                
                let period;
                if (hour >= 6 && hour < 12) {
                    period = '上午';
                } else if (hour >= 12 && hour < 18) {
                    period = '下午';
                } else {
                    period = '晚間';
                }
                
                timeDisplay = `${period} ${hour.toString().padStart(2, '0')}：${minute}`;
            } else if (serviceTime && serviceTime.includes(':')) {
                // 如果已經是時間格式，檢查是否需要加上時段
                const timeMatch = serviceTime.match(/(\d{1,2}):(\d{2})/);
                if (timeMatch) {
                    const hour = parseInt(timeMatch[1]);
                    const minute = timeMatch[2];
                    
                    let period;
                    if (hour >= 6 && hour < 12) {
                        period = '上午';
                    } else if (hour >= 12 && hour < 18) {
                        period = '下午';
                    } else {
                        period = '晚間';
                    }
                    
                    timeDisplay = `${period} ${hour.toString().padStart(2, '0')}：${minute}`;
                } else {
                    timeDisplay = serviceTime;
                }
            } else if (!serviceTime || serviceTime.trim() === '' || serviceTime === '0') {
                // 如果沒有輸入時間或時間為0，顯示0
                timeDisplay = '0';
            }

            // 服務星期格式化
            let daysDisplay = serviceDays;
            if (serviceDays.includes('週')) {
                daysDisplay = serviceDays.replace(/週/g, '週').replace(/、/g, '+');
            }

            // 處理垃圾袋顯示格式
            let trashDisplay;
            if (typeof trashBags === 'string' && (trashBags.includes('公升') || trashBags.includes('包'))) {
                // 如果已經包含完整格式（如：3包 75/76公升），需要轉換為標準格式
                if (trashBags.includes('包') && trashBags.includes('公升')) {
                    // 提取包數和容量
                    const bagMatch = trashBags.match(/(\d+)包/);
                    const volumeMatch = trashBags.match(/(\d+(?:\/\d+)?公升)/);
                    if (bagMatch && volumeMatch) {
                        trashDisplay = `${bagMatch[1]}包數（${volumeMatch[1]}）`;
                    } else {
                        trashDisplay = trashBags;
                    }
                } else {
                    trashDisplay = trashBags;
                }
            } else {
                // 否則從數字建立格式
                const trashNum = parseInt(trashBags) || 6;
                trashDisplay = `${trashNum}包數（14公升）`;
            }

            // 處理資源袋顯示格式
            let recycleDisplay;
            if (typeof recycleBags === 'string' && (recycleBags.includes('公升') || recycleBags.includes('包'))) {
                // 如果已經包含完整格式（如：3包 14公升），需要轉換為標準格式
                if (recycleBags.includes('包') && recycleBags.includes('公升')) {
                    // 提取包數和容量
                    const bagMatch = recycleBags.match(/(\d+)包/);
                    const volumeMatch = recycleBags.match(/(\d+(?:\/\d+)?公升)/);
                    if (bagMatch && volumeMatch) {
                        recycleDisplay = `${bagMatch[1]}包數（${volumeMatch[1]}）`;
                    } else {
                        recycleDisplay = recycleBags;
                    }
                } else {
                    recycleDisplay = recycleBags;
                }
            } else {
                // 否則從數字建立格式
                const recycleNum = parseInt(recycleBags) || 3;
                recycleDisplay = `${recycleNum}包數（14公升）`;
            }

            // 計算每次最多收取袋數（從顯示文字中提取數字）
            const trashNum = parseInt(trashDisplay.match(/(\d+)包/)?.[1]) || 6;
            const recycleNum = parseInt(recycleDisplay.match(/(\d+)包/)?.[1]) || 3;
            
            // 如果手動輸入了最大袋數，使用手動數據，否則計算
            let trashMax, recycleMax;
            if (data.trashMax) {
                trashMax = parseInt(data.trashMax);
            } else {
                trashMax = Math.floor(trashNum / 2) || 3;
            }
            
            if (data.recycleMax) {
                recycleMax = parseInt(data.recycleMax);
            } else {
                recycleMax = Math.floor(recycleNum / 2) || 3;
            }

            // 顯示客戶資訊（如果有的話）
            let customerInfo = '';
            if (lineName) customerInfo += `LINE暱稱：${lineName}\n`;
            if (address) customerInfo += `地址：${address}\n`;
            if (housingType) customerInfo += `住宅性質：${housingType}\n`;
            if (customerInfo) customerInfo += '\n------------------------------------\n\n';

            // 優先使用手動輸入的趟數，其次是自動偵測，最後是預設值
            let weeklyFrequency;
            if (data.frequency) {
                weeklyFrequency = `一週趟數：${data.frequency}趟`;
            } else if (data.weeklyFrequency) {
                weeklyFrequency = data.weeklyFrequency;
            } else {
                weeklyFrequency = '一週趟數：2趟';
            }
            
            const quote = `${customerInfo}⛔報價資料⛔

${weeklyFrequency}-${daysDisplay}
   置放時間：${timeDisplay}
   置放樓層：${floorDisplay}

（⚠️ 垃圾當日：中午前   代收完畢）

（⚠️ 過程中嚴禁催促）
（⚠️ 請準時置放 以免多有糾紛）

 1週垃圾：${trashDisplay}
（1次最多收取${trashMax}袋--超量拒收）
（垃圾請綁緊、勿外露）
（垃圾袋外部勿流湯汁）
（一次性紙/塑膠容器均垃圾）


 1週資源:${recycleDisplay}-用一般塑膠袋
（1次最多收取${recycleMax}袋--超量拒收）
（若未裝袋一律拒收）
（請勿用黑色袋子裝資源）
（僅收寶特玻璃鐵鋁罐）
（僅收中小紙板箱壓扁折好）
（僅收書本/乾淨紙張）

⚠️下列物品視為垃圾
（便當盒/塑膠袋/吸管➡️垃圾）
（軟塑膠蓋/吸管➡️垃圾）
（早餐盒/快飲杯➡️垃圾）
（泡棉/雞蛋軟塑膠盒➡️垃圾）
（蛋糕盒/緩衝材料➡️垃圾）

一個月費用：${monthlyFee}元


-
⛔配合事項⛔
⭐.垃圾務必打包綁好放置門口
⭐.如因政策關係需更改時間
  （會在提前告知 煩請配合）
⭐.自備雙北市政府專用垃圾袋
⭐.收款後不退款內容不更改
⭐.若有超量垃圾拒收

⏬⏬

⛔其他問題⛔
🟥.請完整看完報價內容後提出
🟥.客服會為您解決任何問題

⏬⏬

⭕解決問題⭕
✔️.上述問題均解決
✔️.上述內容能配合
回覆告知我們：同意✅+開始日

⏬⏬

收到_同意✅_後
💧客服➡️提供繳費單
💧客戶➡️完成繳費
💧客服➡️開始代收

✖️注意事項✖️
🔻.1分錢1分服務_便宜無安全服務
🔻.近期多案例/請房東住戶多注意
🔻.均為年輕團隊作業流程均有SOP
🔻.成員平均30-35歲內均有良民證
🔻.過年及天災人禍停止代收無退款
       延至下一次能代收工作日



🔥萬事順心🔥`;

            return quote;
        }

        function copyAutoQuote() {
            const quoteText = document.getElementById('auto-quote-result-display').textContent;
            
            if (!quoteText) {
                showStatus('auto-quote-copy-status', '❌ 沒有報價單可複製', 'error');
                return;
            }

            navigator.clipboard.writeText(quoteText).then(() => {
                showStatus('auto-quote-copy-status', '✅ 自動報價單已複製到剪貼簿', 'success');
            }).catch(() => {
                showStatus('auto-quote-copy-status', '❌ 複製失敗，請手動選擇複製', 'error');
            });
        }

        // 網址記憶功能
        function saveUrlToHistory() {
            const url = document.getElementById('sheets-url').value.trim();
            if (!url || !url.includes('docs.google.com/spreadsheets')) {
                return;
            }

            let savedUrls = JSON.parse(localStorage.getItem('sheetsUrls') || '[]');
            
            // 移除重複的網址
            savedUrls = savedUrls.filter(savedUrl => savedUrl !== url);
            
            // 添加到開頭
            savedUrls.unshift(url);
            
            // 最多保留10個網址
            if (savedUrls.length > 10) {
                savedUrls = savedUrls.slice(0, 10);
            }
            
            localStorage.setItem('sheetsUrls', JSON.stringify(savedUrls));
            updateUrlDropdown();
        }

        function loadSavedUrl() {
            const selectedUrl = document.getElementById('saved-urls').value;
            if (selectedUrl) {
                document.getElementById('sheets-url').value = selectedUrl;
            }
        }

        function updateUrlDropdown() {
            const savedUrls = JSON.parse(localStorage.getItem('sheetsUrls') || '[]');
            const dropdown = document.getElementById('saved-urls');
            
            // 清空現有選項
            dropdown.innerHTML = '<option value="">選擇歷史網址</option>';
            
            // 添加歷史網址
            savedUrls.forEach((url, index) => {
                const option = document.createElement('option');
                option.value = url;
                // 顯示簡化的網址描述
                const urlId = url.match(/\/d\/([a-zA-Z0-9-_]+)/)?.[1] || 'unknown';
                option.textContent = `試算表 ${index + 1} (${urlId.substring(0, 8)}...)`;
                dropdown.appendChild(option);
            });
        }



        // 財務分析相關函數
        let financialData = null;

        function clearFinancialForm() {
            document.getElementById('financial-sheets-url').value = '';
            document.getElementById('financial-sheet-name').value = '';
            document.getElementById('financial-cell-range').value = '';
            document.getElementById('financial-csv-data').value = '';
            document.querySelector('input[name="input-method"][value="csv"]').checked = true;
            toggleInputMethod();
            document.getElementById('financial-data-preview').style.display = 'none';
            document.getElementById('financial-analysis-output').style.display = 'none';
            document.getElementById('financial-column-selection').style.display = 'none';
            document.getElementById('financial-status').style.display = 'none';
            financialData = null;
        }

        function toggleInputMethod() {
            const method = document.querySelector('input[name="input-method"]:checked').value;
            const csvArea = document.getElementById('csv-input-area');
            const sheetsArea = document.getElementById('sheets-input-area');
            
            if (method === 'csv') {
                csvArea.style.display = 'block';
                sheetsArea.style.display = 'none';
            } else {
                csvArea.style.display = 'none';
                sheetsArea.style.display = 'block';
            }
        }

        function saveFinancialUrl() {
            const url = document.getElementById('financial-sheets-url').value.trim();
            if (!url) {
                showStatus('financial-status', '❌ 請先輸入網址', 'error');
                return;
            }

            if (!url.includes('docs.google.com/spreadsheets')) {
                showStatus('financial-status', '❌ 請輸入有效的Google試算表連結', 'error');
                return;
            }

            // 獲取現有的網址列表
            let savedUrls = JSON.parse(localStorage.getItem('financialUrls') || '[]');
            
            // 檢查是否已存在
            if (!savedUrls.includes(url)) {
                savedUrls.push(url);
                // 限制最多存10個網址
                if (savedUrls.length > 10) {
                    savedUrls = savedUrls.slice(-10);
                }
                localStorage.setItem('financialUrls', JSON.stringify(savedUrls));
                updateFinancialUrlDropdown();
                showStatus('financial-status', '✅ 網址已存儲', 'success');
            } else {
                showStatus('financial-status', '⚠ 網址已存在', 'error');
            }
        }

        function selectFinancialUrl() {
            const dropdown = document.getElementById('financial-url-dropdown');
            const selectedUrl = dropdown.value;
            if (selectedUrl) {
                document.getElementById('financial-sheets-url').value = selectedUrl;
            }
        }

        function updateFinancialUrlDropdown() {
            const dropdown = document.getElementById('financial-url-dropdown');
            const savedUrls = JSON.parse(localStorage.getItem('financialUrls') || '[]');
            
            // 清空下拉選單
            dropdown.innerHTML = '<option value="">選擇已存網址</option>';
            
            // 添加儲存的網址
            savedUrls.forEach((url, index) => {
                const option = document.createElement('option');
                option.value = url;
                // 顯示簡化的網址
                const urlDisplay = url.length > 50 ? url.substring(0, 47) + '...' : url;
                option.textContent = `${index + 1}. ${urlDisplay}`;
                dropdown.appendChild(option);
            });

            // 添加刪除選項
            if (savedUrls.length > 0) {
                const deleteOption = document.createElement('option');
                deleteOption.value = 'DELETE_ALL';
                deleteOption.textContent = '🗑 清空所有網址';
                deleteOption.style.color = '#ff6b6b';
                dropdown.appendChild(deleteOption);
                
                // 處理刪除功能
                dropdown.addEventListener('change', function() {
                    if (this.value === 'DELETE_ALL') {
                        if (confirm('確定要清空所有儲存的網址嗎？')) {
                            localStorage.removeItem('financialUrls');
                            updateFinancialUrlDropdown();
                            showStatus('financial-status', '✅ 已清空所有網址', 'success');
                        } else {
                            this.value = '';
                        }
                    }
                });
            }
        }

        function filterVisibleRows(rows) {
            // 智能過濾無效資料行的邏輯
            const visibleRows = [];
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                let isVisible = true;
                const rowText = row.join('').toLowerCase();
                
                // 1. 過濾完全空白的行
                if (row.every(cell => !cell || cell.trim() === '')) {
                    isVisible = false;
                }
                
                // 2. 過濾月份標題行（如：4月、5月、6月等）
                const firstCell = row[0] ? row[0].toString().trim() : '';
                if (/^\d+月$/.test(firstCell) || firstCell.match(/^(1[0-2]|[1-9])月$/)) {
                    isVisible = false;
                }
                
                // 3. 過濾年份行（如：2025）
                if (row.length === 1 && /^20\d{2}$/.test(firstCell)) {
                    isVisible = false;
                }
                
                // 4. 過濾表頭行（包含欄位標題的行）
                if (rowText.includes('人力調') || rowText.includes('清潔') || 
                    rowText.includes('增加') || rowText.includes('包月') ||
                    rowText.includes('名稱') || rowText.includes('金額') ||
                    (rowText.includes('支出') && rowText.includes('費用') && rowText.includes('包月'))) {
                    // 這可能是表頭，但包含費用信息時保留
                    if (!rowText.match(/\d+/) || rowText.includes('標題') || rowText.includes('欄位')) {
                        isVisible = false;
                    }
                }
                
                // 5. 過濾分隔符行
                if (rowText.includes('---') || rowText.includes('===') || 
                    rowText.includes('***') || rowText.includes('///')) {
                    isVisible = false;
                }
                
                // 6. 過濾註解行（以#開頭）
                const firstNonEmptyCell = row.find(cell => cell && cell.trim() !== '');
                if (firstNonEmptyCell && firstNonEmptyCell.trim().startsWith('#')) {
                    isVisible = false;
                }
                
                // 7. 過濾明顯的測試資料
                if (rowText.includes('測試') || rowText.includes('test') || 
                    rowText.includes('範例') || rowText.includes('example')) {
                    isVisible = false;
                }
                
                // 8. 保留包含數字金額的資料行
                const hasAmount = row.some(cell => {
                    const cellStr = cell ? cell.toString().trim() : '';
                    return /\d+/.test(cellStr) && (
                        cellStr.includes('支出') || 
                        cellStr.includes('費用') || 
                        /^\d+$/.test(cellStr) ||
                        /^\d+\.\d+$/.test(cellStr)
                    );
                });
                
                // 如果包含金額信息，即使有其他過濾條件也保留
                if (hasAmount && !rowText.includes('測試') && !rowText.includes('test')) {
                    isVisible = true;
                }
                
                if (isVisible) {
                    visibleRows.push(row);
                }
            }
            
            return visibleRows;
        }

        function displayColumnSelection(data) {
            const checkboxContainer = document.getElementById('financial-column-checkboxes');
            checkboxContainer.innerHTML = '';
            
            data.headers.forEach((header, index) => {
                if (header && header.trim() !== '') {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.style.cssText = 'display: flex; align-items: center; color: #e0e0e0; padding: 5px;';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `col-${index}`;
                    checkbox.value = index;
                    checkbox.style.cssText = 'margin-right: 8px; width: 16px; height: 16px;';
                    
                    const label = document.createElement('label');
                    label.htmlFor = `col-${index}`;
                    label.textContent = header;
                    label.style.cssText = 'cursor: pointer; font-size: 14px;';
                    
                    checkboxDiv.appendChild(checkbox);
                    checkboxDiv.appendChild(label);
                    checkboxContainer.appendChild(checkboxDiv);
                }
            });
            
            document.getElementById('financial-column-selection').style.display = 'block';
        }

        function selectAllColumns() {
            const checkboxes = document.querySelectorAll('#financial-column-checkboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = true);
        }

        function clearAllColumns() {
            const checkboxes = document.querySelectorAll('#financial-column-checkboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = false);
        }

        function proceedWithAnalysis() {
            const selectedColumns = [];
            const checkboxes = document.querySelectorAll('#financial-column-checkboxes input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                showStatus('financial-status', '❌ 請至少選擇一個欄位進行分析', 'error');
                return;
            }
            
            checkboxes.forEach(checkbox => {
                selectedColumns.push(parseInt(checkbox.value));
            });
            
            // 根據選擇的欄位過濾資料
            const filteredData = {
                headers: selectedColumns.map(index => financialData.headers[index]),
                rows: financialData.rows.map(row => selectedColumns.map(index => row[index] || ''))
            };
            
            displayFinancialData(filteredData);
            performFinancialAnalysis(filteredData);
            showStatus('financial-status', `✅ 成功分析 ${selectedColumns.length} 個欄位的 ${filteredData.rows.length} 筆資料`, 'success');
        }

        async function analyzeFinancialData() {
            const method = document.querySelector('input[name="input-method"]:checked').value;
            
            if (method === 'csv') {
                // 處理CSV資料貼上
                const csvData = document.getElementById('financial-csv-data').value.trim();
                if (!csvData) {
                    showStatus('financial-status', '❌ 請貼上CSV資料', 'error');
                    return;
                }
                
                showStatus('financial-status', '🔄 正在解析CSV資料...', 'success');
                
                try {
                    // 解析CSV
                    const rows = parseCSV(csvData);
                    const filteredRows = rows.filter(row => row.some(cell => cell && cell.length > 0));
                    
                    if (filteredRows.length === 0) {
                        throw new Error('CSV資料中沒有找到任何有效資料');
                    }

                    // 儲存原始資料並顯示欄位選擇
                    financialData = {
                        headers: filteredRows[0] || [],
                        rows: filteredRows.slice(1) // 排除標題行
                    };

                    displayColumnSelection(financialData);
                    showStatus('financial-status', `✅ 成功解析 ${financialData.rows.length} 筆資料，請選擇要分析的欄位`, 'success');
                    
                } catch (error) {
                    console.error('解析CSV資料時發生錯誤:', error);
                    showStatus('financial-status', `❌ ${error.message}`, 'error');
                }
                return;
            }
            
            // 處理Google試算表連結
            const sheetsUrl = document.getElementById('financial-sheets-url').value.trim();
            
            if (!sheetsUrl) {
                showStatus('financial-status', '❌ 請輸入Google試算表網址', 'error');
                return;
            }

            if (!sheetsUrl.includes('docs.google.com/spreadsheets')) {
                showStatus('financial-status', '❌ 請輸入有效的Google試算表連結', 'error');
                return;
            }

            showStatus('financial-status', '🔄 正在載入試算表資料...', 'success');

            try {
                // 從URL中提取試算表ID
                let spreadsheetId = '';
                const urlMatch = sheetsUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                if (urlMatch) {
                    spreadsheetId = urlMatch[1];
                } else {
                    throw new Error('無法解析試算表ID，請確認URL格式正確');
                }

                // 構建CSV導出URL
                let csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv`;
                
                // 檢查是否指定了工作表名稱
                const sheetName = document.getElementById('financial-sheet-name').value.trim();
                if (sheetName) {
                    csvUrl += `&gid=0`; // 這裡需要實際的工作表ID，簡化處理
                    showStatus('financial-status', `🔄 正在載入工作表 "${sheetName}" 的資料...`, 'success');
                } else {
                    showStatus('financial-status', '🔄 正在載入預設工作表資料...', 'success');
                }
                
                // 檢查是否指定了儲存格範圍
                const cellRange = document.getElementById('financial-cell-range').value.trim();
                if (cellRange) {
                    // 驗證範圍格式 (支援多種格式: A1:Z100, A:Z, 1:100, A1, 等)
                    const upperRange = cellRange.toUpperCase();
                    const rangePatterns = [
                        /^[A-Z]+\d+:[A-Z]+\d+$/,  // A1:Z100
                        /^[A-Z]+:[A-Z]+$/,        // A:Z
                        /^\d+:\d+$/,              // 1:100
                        /^[A-Z]+\d+$/             // A1
                    ];
                    
                    const isValidRange = rangePatterns.some(pattern => pattern.test(upperRange));
                    
                    if (isValidRange) {
                        csvUrl += `&range=${encodeURIComponent(upperRange)}`;
                        showStatus('financial-status', `🔄 正在載入指定範圍 ${upperRange} 的資料...`, 'success');
                    } else {
                        throw new Error('儲存格範圍格式錯誤，支援格式：A1:Z100、A:Z、1:100、A1 等');
                    }
                }
                
                let response;
                try {
                    // 嘗試直接訪問
                    response = await fetch(csvUrl, {
                        mode: 'cors',
                        headers: {
                            'Accept': 'text/csv,text/plain'
                        }
                    });
                } catch (corsError) {
                    throw new Error('由於瀏覽器安全限制，無法直接讀取Google試算表。建議使用CSV貼上方式：\n1. 在Google試算表中選擇資料範圍\n2. 按Ctrl+C複製\n3. 切換到「CSV資料貼上」方式並貼上資料');
                }

                if (!response.ok) {
                    if (response.status === 403) {
                        throw new Error('無法存取試算表，請確認分享設定為「知道連結的使用者」可檢視');
                    } else if (response.status === 404) {
                        throw new Error('找不到試算表，請確認網址正確');
                    } else {
                        throw new Error(`載入失敗 (錯誤代碼: ${response.status})`);
                    }
                }

                const csvText = await response.text();
                
                if (!csvText || csvText.trim().length === 0) {
                    throw new Error('試算表資料為空，請確認表格中有資料');
                }

                // 解析CSV
                const rows = parseCSV(csvText);
                const filteredRows = rows.filter(row => row.some(cell => cell && cell.length > 0));
                
                if (filteredRows.length === 0) {
                    throw new Error('試算表中沒有找到任何有效資料');
                }

                // 儲存原始資料並顯示欄位選擇
                financialData = {
                    headers: filteredRows[0] || [],
                    rows: filteredRows.slice(1) // 排除標題行
                };

                displayColumnSelection(financialData);
                showStatus('financial-status', `✅ 成功載入 ${financialData.rows.length} 筆資料，請選擇要分析的欄位`, 'success');

            } catch (error) {
                console.error('財務分析失敗:', error);
                showStatus('financial-status', `❌ ${error.message}`, 'error');
            }
        }

        function displayFinancialData(data) {
            const preview = document.getElementById('financial-raw-data');
            
            let html = '<table style="width: 100%; border-collapse: collapse; color: #e0e0e0; font-size: 12px;">';
            
            if (data.headers.length > 0) {
                html += '<tr style="background: #404040;">';
                data.headers.forEach(header => {
                    html += `<th style="border: 1px solid #666; padding: 4px; text-align: left;">${header}</th>`;
                });
                html += '</tr>';
            }

            // 只顯示前10行資料以節省空間
            const displayRows = data.rows.slice(0, 10);
            displayRows.forEach((row, index) => {
                html += `<tr style="background: ${index % 2 === 0 ? '#2a2a2a' : '#333333'};">`;
                row.forEach(cell => {
                    html += `<td style="border: 1px solid #666; padding: 4px;">${cell}</td>`;
                });
                html += '</tr>';
            });

            if (data.rows.length > 10) {
                html += `<tr><td colspan="${data.headers.length}" style="text-align: center; padding: 8px; color: #888;">... 還有 ${data.rows.length - 10} 筆資料</td></tr>`;
            }

            html += '</table>';
            preview.innerHTML = html;
            
            document.getElementById('financial-data-preview').style.display = 'block';
        }

        function performFinancialAnalysis(data) {
            const headers = data.headers;
            const rows = data.rows;
            
            // 尋找包含支出相關欄位
            const expenseColumns = [];
            const amountColumns = [];
            
            headers.forEach((header, index) => {
                const lowerHeader = header.toLowerCase();
                if (lowerHeader.includes('支出') || lowerHeader.includes('費用') || lowerHeader.includes('成本') || 
                    lowerHeader.includes('expense') || lowerHeader.includes('cost')) {
                    expenseColumns.push({ header, index });
                }
                // 尋找數字欄位
                if (lowerHeader.includes('金額') || lowerHeader.includes('價格') || lowerHeader.includes('錢') || 
                    lowerHeader.includes('amount') || lowerHeader.includes('price') || lowerHeader.includes('總計')) {
                    amountColumns.push({ header, index });
                }
            });

            // 分析支出類別
            const expenseCategories = {};
            let totalExpense = 0;
            let validEntries = 0;

            rows.forEach(row => {
                // 檢查每一欄位是否包含支出關鍵字和金額
                row.forEach((cell, cellIndex) => {
                    const cellValue = cell.toString().trim();
                    
                    // 檢查是否包含支出關鍵字
                    const hasExpenseKeyword = cellValue.includes('支出') || cellValue.includes('費用') || 
                                             cellValue.includes('成本') || cellValue.includes('購買') ||
                                             cellValue.includes('支付') || cellValue.includes('付款');
                    
                    if (hasExpenseKeyword) {
                        // 在同一行中尋找數字
                        let amount = 0;
                        let category = '其他支出';
                        
                        // 從同一行的其他欄位中提取金額
                        for (let i = 0; i < row.length; i++) {
                            const otherCell = row[i].toString().trim();
                            const numberMatch = otherCell.match(/\d+/);
                            if (numberMatch && parseInt(numberMatch[0]) > 0) {
                                amount = parseInt(numberMatch[0]);
                                break;
                            }
                        }
                        
                        // 識別支出類別
                        if (cellValue.includes('油') || cellValue.includes('燃料') || cellValue.includes('加油')) {
                            category = '燃料費';
                        } else if (cellValue.includes('餐') || cellValue.includes('食') || cellValue.includes('午餐') || cellValue.includes('晚餐')) {
                            category = '餐飲費';
                        } else if (cellValue.includes('交通') || cellValue.includes('過路') || cellValue.includes('停車')) {
                            category = '交通費';
                        } else if (cellValue.includes('維修') || cellValue.includes('保養') || cellValue.includes('修理')) {
                            category = '維修保養費';
                        } else if (cellValue.includes('設備') || cellValue.includes('工具') || cellValue.includes('購買')) {
                            category = '設備採購費';
                        } else if (cellValue.includes('人事') || cellValue.includes('薪資') || cellValue.includes('工資')) {
                            category = '人事費用';
                        } else if (cellValue.includes('辦公') || cellValue.includes('文具') || cellValue.includes('用品')) {
                            category = '辦公用品費';
                        } else {
                            // 使用標題欄位作為類別
                            if (headers[cellIndex]) {
                                category = headers[cellIndex];
                            }
                        }
                        
                        if (amount > 0) {
                            if (!expenseCategories[category]) {
                                expenseCategories[category] = { total: 0, count: 0, items: [] };
                            }
                            expenseCategories[category].total += amount;
                            expenseCategories[category].count += 1;
                            expenseCategories[category].items.push({
                                description: cellValue,
                                amount: amount
                            });
                            totalExpense += amount;
                            validEntries++;
                        }
                    }
                });
            });

            // 如果沒有找到明確的支出項目，嘗試從數字欄位中分析
            if (validEntries === 0 && amountColumns.length > 0) {
                rows.forEach(row => {
                    amountColumns.forEach(amountCol => {
                        const cellValue = row[amountCol.index];
                        const numberMatch = cellValue.toString().match(/\d+/);
                        if (numberMatch) {
                            const amount = parseInt(numberMatch[0]);
                            if (amount > 0) {
                                const category = amountCol.header || '未分類支出';
                                if (!expenseCategories[category]) {
                                    expenseCategories[category] = { total: 0, count: 0, items: [] };
                                }
                                expenseCategories[category].total += amount;
                                expenseCategories[category].count += 1;
                                expenseCategories[category].items.push({
                                    description: `${amountCol.header}`,
                                    amount: amount
                                });
                                totalExpense += amount;
                                validEntries++;
                            }
                        }
                    });
                });
            }

            // 顯示分析結果
            displayFinancialSummary(expenseCategories, totalExpense, validEntries);
            displayFinancialBreakdown(expenseCategories);
            
            document.getElementById('financial-analysis-output').style.display = 'block';
        }

        function displayFinancialSummary(categories, total, count) {
            const summary = document.getElementById('financial-summary');
            const categoryCount = Object.keys(categories).length;
            
            let html = `
                <h5 style="color: #ffd700; margin-bottom: 15px;">📊 財務摘要</h5>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background: #1a4d2e; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #4ade80;">$${total.toLocaleString()}</div>
                        <div style="color: #a3a3a3; font-size: 14px;">總支出金額</div>
                    </div>
                    <div style="background: #2d1b69; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #a78bfa;">${categoryCount}</div>
                        <div style="color: #a3a3a3; font-size: 14px;">支出類別</div>
                    </div>
                    <div style="background: #7c2d12; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #fb7185;">${count}</div>
                        <div style="color: #a3a3a3; font-size: 14px;">交易筆數</div>
                    </div>
                    <div style="background: #365314; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #fbbf24;">$${Math.round(total / count).toLocaleString()}</div>
                        <div style="color: #a3a3a3; font-size: 14px;">平均單筆</div>
                    </div>
                </div>
            `;
            
            summary.innerHTML = html;
        }

        function displayFinancialBreakdown(categories) {
            const breakdown = document.getElementById('financial-breakdown');
            
            let html = '<h5 style="color: #ffd700; margin-bottom: 15px;">📈 支出明細</h5>';
            
            if (Object.keys(categories).length === 0) {
                html += '<div style="text-align: center; color: #888; padding: 20px;">未找到支出資料</div>';
            } else {
                // 按金額排序
                const sortedCategories = Object.entries(categories).sort(([,a], [,b]) => b.total - a.total);
                
                sortedCategories.forEach(([categoryName, categoryData]) => {
                    const percentage = ((categoryData.total / Object.values(categories).reduce((sum, cat) => sum + cat.total, 0)) * 100).toFixed(1);
                    
                    html += `
                        <div style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-weight: bold; color: #fff;">${categoryName}</div>
                                <div style="color: #4ade80; font-weight: bold;">$${categoryData.total.toLocaleString()} (${percentage}%)</div>
                            </div>
                            <div style="color: #a3a3a3; font-size: 14px; margin-bottom: 8px;">${categoryData.count} 筆交易 • 平均 $${Math.round(categoryData.total / categoryData.count).toLocaleString()}</div>
                            <div style="background: #4ade80; height: 6px; border-radius: 3px; width: ${percentage}%;"></div>
                        </div>
                    `;
                });
            }
            
            breakdown.innerHTML = html;
        }

        function copyFinancialAnalysis() {
            if (!financialData || Object.keys(financialData).length === 0) {
                showStatus('financial-status', '❌ 沒有分析結果可複製', 'error');
                return;
            }

            const summaryText = document.getElementById('financial-summary').textContent;
            const breakdownText = document.getElementById('financial-breakdown').textContent;
            
            const analysisText = `財務分析報告\n\n${summaryText}\n\n${breakdownText}`;
            
            navigator.clipboard.writeText(analysisText).then(() => {
                showStatus('financial-status', '✅ 財務分析結果已複製到剪貼簿', 'success');
            }).catch(() => {
                showStatus('financial-status', '❌ 複製失敗，請手動選擇複製', 'error');
            });
        }

        // 頁面載入時初始化網址下拉選單
        document.addEventListener('DOMContentLoaded', function() {
            updateUrlDropdown();
            updateFinancialUrlDropdown();
        });
    </script>
</body>
</html>
