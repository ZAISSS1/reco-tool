<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯èƒ½æ°¸çºŒ-å ±åƒ¹å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #2a2a2a;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            overflow: hidden;
            border: 1px solid #404040;
        }

        .header {
            background: linear-gradient(135deg, #333333 0%, #1a1a1a 100%);
            color: #ffffff;
            text-align: center;
            padding: 30px 20px;
        }

        .header h1 {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            font-weight: bold;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #1a1a1a;
            border-bottom: 2px solid #404040;
            overflow-x: auto;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .tab {
            flex: 1;
            min-width: 200px;
            padding: 15px 10px;
            text-align: center;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #a0a0a0;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #2a2a2a;
            color: #ffffff;
            border-bottom: 3px solid #667eea;
        }

        .tab:hover {
            background: #333333;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h3 {
            color: #ffffff;
            margin-bottom: 15px;
            font-size: 1.4rem;
        }

        .info-box {
            background: #2a2a2a;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            color: #e0e0e0;
            border: 1px solid #404040;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #e0e0e0;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #555555;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #333333;
            color: #ffffff;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .btn {
            width: 60px;
            height: 60px;
            margin: 20px auto;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn:hover {
            transform: translateY(-3px);
        }

        .btn.quote { 
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); 
            color: #333;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .btn.quote:hover { 
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
            background: linear-gradient(135deg, #f8f8f8 0%, #e8e8e8 100%);
        }

        .btn.monthly { 
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); 
            color: #333;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .btn.monthly:hover { 
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
            background: linear-gradient(135deg, #f8f8f8 0%, #e8e8e8 100%);
        }

        .btn.single { 
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); 
            color: #333;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .btn.single:hover { 
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
            background: linear-gradient(135deg, #f8f8f8 0%, #e8e8e8 100%);
        }

        .btn.clean { 
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); 
            color: #333;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .btn.clean:hover { 
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
            background: linear-gradient(135deg, #f8f8f8 0%, #e8e8e8 100%);
        }

        .btn-financial {
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            color: #333;
            border: none;
            width: 60px;
            height: 60px;
            font-size: 24px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .btn-financial:hover {
            background: linear-gradient(135deg, #f8f8f8 0%, #e8e8e8 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
        }

        .output-section {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #404040;
        }

        .output-area {
            width: 100%;
            min-height: 300px;
            border: 2px solid #555555;
            border-radius: 8px;
            padding: 15px;
            background: #2a2a2a;
            color: #ffffff;
            font-family: monospace;
            white-space: pre-wrap;
            margin-bottom: 15px;
        }

        .copy-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .copy-btn {
            width: 50px;
            height: 50px;
            margin: 15px auto;
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            color: #333;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            background: linear-gradient(135deg, #f8f8f8 0%, #e8e8e8 100%);
        }

        .status {
            margin-top: 15px;
            text-align: center;
            min-height: 40px;
            padding: 10px;
            border-radius: 5px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 5px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #e0e0e0;
            cursor: pointer;
            margin-bottom: 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            width: 16px;
            height: 16px;
        }

        h4 {
            color: #ffffff;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        small {
            color: #a0a0a0;
            font-size: 12px;
        }

        .mobile-text {
            display: none;
        }

        .desktop-text {
            display: inline;
        }

        .clear-btn-small {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(108, 117, 125, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .clear-btn-small:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
        }

        /* æ‹–æ›³ä¸Šå‚³æ¨£å¼ */
        .drop-zone {
            border: 2px dashed #666;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #2a2a2a;
            transition: all 0.3s ease;
            position: relative;
            min-height: 120px;
        }

        .drop-zone:hover, .drop-zone.dragover,
        .drop-zone-inline:hover, .drop-zone-inline.dragover {
            border-color: #4CAF50 !important;
            background: #2f3f2f !important;
        }

        .drop-zone-content {
            pointer-events: none;
        }

        .drop-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .drop-text {
            color: #ccc;
            font-size: 16px;
        }

        /* ç…§ç‰‡åˆä½µæŒ‰éˆ•æ¨£å¼ */
        .btn-merge {
            background: linear-gradient(135deg, #1565C0, #0D47A1);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(21, 101, 192, 0.3);
        }

        .btn-merge:hover {
            background: linear-gradient(135deg, #0D47A1, #0A3880);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(21, 101, 192, 0.4);
        }

        .btn-clear {
            background: linear-gradient(135deg, #9E9E9E, #757575);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(158, 158, 158, 0.3);
        }

        .btn-clear:hover {
            background: linear-gradient(135deg, #757575, #616161);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(158, 158, 158, 0.4);
        }

        .btn-download {
            background: linear-gradient(135deg, #2E7D32, #1B5E20);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(46, 125, 50, 0.3);
        }

        .btn-download:hover {
            background: linear-gradient(135deg, #1B5E20, #0F4318);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(46, 125, 50, 0.4);
        }

        .btn-financial {
            background: linear-gradient(135deg, #FF6B35, #F7931E);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }

        .btn-financial:hover {
            background: linear-gradient(135deg, #F7931E, #E8890B);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
        }

        /* ç…§ç‰‡é è¦½æ¨£å¼ */
        .photo-preview {
            display: inline-block;
            margin: 5px;
            border: 2px solid #444;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }

        .photo-preview img {
            width: 120px;
            height: 90px;
            object-fit: cover;
        }

        .photo-remove {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .merged-photo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .merged-photo-content {
            flex: 1;
            text-align: left;
        }

        .merged-photo-controls {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .merged-photo img {
            max-width: 100%;
            height: auto;
            border: 2px solid #4CAF50;
            border-radius: 8px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 5px;
                border-radius: 10px;
            }
            
            .header {
                padding: 15px 10px;
            }
            
            .header h1 {
                font-size: 20px;
                margin: 0;
            }
            
            .tab-content {
                padding: 15px 10px;
            }
            
            .tabs {
                gap: 2px;
                padding: 5px 2px;
                position: sticky;
                top: 0;
                z-index: 1001;
            }
            
            .tab {
                padding: 8px 6px;
                font-size: 11px;
                min-height: auto;
                min-width: auto;
                flex: 1;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 10px;
                margin-bottom: 15px;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            h3 {
                font-size: 18px;
                margin-bottom: 10px;
            }
            
            h4 {
                font-size: 16px;
                margin-bottom: 10px;
                padding-bottom: 5px;
            }
            
            .info-box {
                padding: 10px;
                margin-bottom: 15px;
                font-size: 14px;
            }
            
            label {
                font-size: 14px;
                margin-bottom: 5px;
            }
            
            input, textarea, select {
                font-size: 16px;
                padding: 8px;
                margin-bottom: 0;
            }
            
            textarea {
                height: 120px;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 16px;
                margin: 15px auto;
                min-width: 200px;
            }
            
            .copy-btn {
                padding: 10px 15px;
                font-size: 14px;
                margin: 10px auto;
            }
            
            .output-area {
                min-height: 200px;
                padding: 10px;
                font-size: 14px;
            }
            
            .checkbox-group {
                gap: 5px;
                margin-top: 3px;
            }
            
            .checkbox-group label {
                font-size: 13px;
                margin-bottom: 3px;
            }
            
            .status {
                padding: 8px;
                margin-top: 10px;
                font-size: 14px;
            }
            
            .section {
                margin-bottom: 20px;
            }
            
            .desktop-text {
                display: none;
            }
            
            .mobile-text {
                display: inline;
            }
            
            .photo-upload-row {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            .photo-upload-row #single-drop-zone {
                flex: 1 !important;
                min-width: auto !important;
            }
            
            .photo-upload-row #single-merge-controls {
                flex-direction: row !important;
                justify-content: center;
                gap: 10px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>è¯èƒ½æ°¸çºŒ-å ±åƒ¹å·¥å…·</h1>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('auto-quote')"><span class="desktop-text">ğŸš€ å®¢æˆ¶å–®â®•è‡ªå‹•å ±åƒ¹å–®</span><span class="mobile-text">è‡ªå‹•å ±åƒ¹</span></button>
            <button class="tab" onclick="showTab('quote')"><span class="desktop-text">ğŸš€ å®¢æˆ¶å–®â®•å ±åƒ¹å–®</span><span class="mobile-text">å®¢æˆ¶å ±åƒ¹</span></button>
            <button class="tab" onclick="showTab('monthly')"><span class="desktop-text">ğŸš€ å ±åƒ¹å–®â®•åŒ…æœˆä»»å‹™å–®</span><span class="mobile-text">åŒ…æœˆä»»å‹™</span></button>
            <button class="tab" onclick="showTab('single')"><span class="desktop-text">ğŸš€ å ±åƒ¹å–®â®•å–®è¶Ÿä»»å‹™å–®</span><span class="mobile-text">å–®è¶Ÿä»»å‹™</span></button>
            <button class="tab" onclick="showTab('clean')"><span class="desktop-text">ğŸš€ å ±åƒ¹å–®â®•å–®æ¬¡æ¸…æ½”ä»»å‹™å–®</span><span class="mobile-text">æ¸…æ½”ä»»å‹™</span></button>
            <button class="tab" onclick="showTab('financial')"><span class="desktop-text">ğŸ’° è²¡å‹™åˆ†æ</span><span class="mobile-text">è²¡å‹™åˆ†æ</span></button>
        </div>

        <!-- å®¢æˆ¶å–®â®•è‡ªå‹•å ±åƒ¹å–® -->
        <div id="auto-quote" class="tab-content active">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">ğŸš€ å®¢æˆ¶å–®â®•è‡ªå‹•å ±åƒ¹å–®</h3>
                    <button class="clear-btn-small" onclick="clearAutoQuoteForm()" title="æ¸…ç©ºè¡¨å–®">Ã—</button>
                </div>
                <div class="info-box">
                    ğŸ’¡ è‡ªå‹•åµæ¸¬Googleè©¦ç®—è¡¨æœ€æ–°è³‡æ–™ï¼Œä¾ç…§å„²å­˜æ ¼å…§å®¹ç”Ÿæˆå°ˆæ¥­æ¨™æº–åŒ–å ±åƒ¹å–®
                </div>
                
                <div class="form-group">
                    <h4>ğŸ”— Googleè©¦ç®—è¡¨é€£çµ</h4>
                    <div class="form-row">
                        <div style="grid-column: span 3;">
                            <label for="sheets-url">è©¦ç®—è¡¨ç¶²å€ï¼š</label>
                            <input type="text" id="sheets-url" placeholder="è«‹è²¼ä¸ŠGoogleè©¦ç®—è¡¨çš„å…±äº«é€£çµ" style="width: 100%;" onchange="saveUrlToHistory()">
                            <small style="color: #888; margin-top: 5px; display: block;">ğŸ’¡ æç¤ºï¼šè«‹ç¢ºä¿è©¦ç®—è¡¨åˆ†äº«è¨­å®šç‚ºã€ŒçŸ¥é“é€£çµçš„ä½¿ç”¨è€…ã€</small>
                        </div>
                        <div>
                            <label for="saved-urls">æ­·å²ç¶²å€ï¼š</label>
                            <select id="saved-urls" onchange="loadSavedUrl()" style="width: 100%;">
                                <option value="">é¸æ“‡æ­·å²ç¶²å€</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <h4>âš™ï¸ è³‡æ–™è¼¸å…¥</h4>
                    <!-- ç¬¬ä¸€è¡Œï¼šæ”¶å–æ˜ŸæœŸã€æ”¶å–æ™‚é–“ã€æ¨“å±¤ã€æœˆè²»ã€è¶Ÿæ•¸ -->
                    <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr 1fr 1fr;">
                        <div>
                            <label for="manual-days">æ”¶å–æ˜ŸæœŸï¼š</label>
                            <div style="margin-top: 8px; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px;">
                                <label style="display: flex; align-items: center; font-size: 13px; color: #e0e0e0; cursor: pointer; margin-bottom: 0; white-space: nowrap;">
                                    <input type="checkbox" name="manual-days" value="é€±ä¸€" style="width: 14px; height: 14px; margin-right: 4px;"> é€±ä¸€
                                </label>
                                <label style="display: flex; align-items: center; font-size: 13px; color: #e0e0e0; cursor: pointer; margin-bottom: 0; white-space: nowrap;">
                                    <input type="checkbox" name="manual-days" value="é€±äºŒ" style="width: 14px; height: 14px; margin-right: 4px;"> é€±äºŒ
                                </label>
                                <label style="display: flex; align-items: center; font-size: 13px; color: #e0e0e0; cursor: pointer; margin-bottom: 0; white-space: nowrap;">
                                    <input type="checkbox" name="manual-days" value="é€±ä¸‰" style="width: 14px; height: 14px; margin-right: 4px;"> é€±ä¸‰
                                </label>
                                <label style="display: flex; align-items: center; font-size: 13px; color: #e0e0e0; cursor: pointer; margin-bottom: 0; white-space: nowrap;">
                                    <input type="checkbox" name="manual-days" value="é€±å››" style="width: 14px; height: 14px; margin-right: 4px;"> é€±å››
                                </label>
                                <label style="display: flex; align-items: center; font-size: 13px; color: #e0e0e0; cursor: pointer; margin-bottom: 0; white-space: nowrap;">
                                    <input type="checkbox" name="manual-days" value="é€±äº”" style="width: 14px; height: 14px; margin-right: 4px;"> é€±äº”
                                </label>
                                <label style="display: flex; align-items: center; font-size: 13px; color: #e0e0e0; cursor: pointer; margin-bottom: 0; white-space: nowrap;">
                                    <input type="checkbox" name="manual-days" value="é€±å…­" style="width: 14px; height: 14px; margin-right: 4px;"> é€±å…­
                                </label>
                                <label style="display: flex; align-items: center; font-size: 13px; color: #e0e0e0; cursor: pointer; margin-bottom: 0; white-space: nowrap;">
                                    <input type="checkbox" name="manual-days" value="é€±æ—¥" style="width: 14px; height: 14px; margin-right: 4px;"> é€±æ—¥
                                </label>
                                <div></div> <!-- ç©ºæ ¼è£œä½ -->
                            </div>
                        </div>
                        <div>
                            <label for="manual-time">æ”¶å–æ™‚é–“ï¼š</label>
                            <input type="text" id="manual-time" placeholder="0" value="">
                        </div>
                        <div>
                            <label for="manual-floor">æ¨“å±¤ï¼š</label>
                            <input type="number" id="manual-floor" placeholder="0" min="-10" max="50" value="">
                        </div>
                        <div>
                            <label for="manual-fee">æœˆè²»(å…ƒ)ï¼š</label>
                            <input type="number" id="manual-fee" placeholder="0" min="0" value="">
                        </div>
                        <div>
                            <label for="manual-frequency">è¶Ÿæ•¸ï¼š</label>
                            <input type="number" id="manual-frequency" placeholder="0" min="1" max="7" value="">
                        </div>
                    </div>
                    
                    <!-- ç¬¬äºŒè¡Œï¼šåƒåœ¾åŒ…æ•¸ã€åƒåœ¾è¢‹å®¹é‡ã€è³‡æºåŒ…æ•¸ã€è³‡æºè¢‹å®¹é‡ -->
                    <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                        <div>
                            <label for="manual-trash">åƒåœ¾åŒ…æ•¸ï¼š</label>
                            <input type="number" id="manual-trash" placeholder="0" min="0" value="">
                        </div>
                        <div>
                            <label for="manual-trash-volume">åƒåœ¾è¢‹å®¹é‡ï¼š</label>
                            <select id="manual-trash-volume">
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="14å…¬å‡">14å…¬å‡</option>
                                <option value="25å…¬å‡">25å…¬å‡</option>
                                <option value="75å…¬å‡">75å…¬å‡</option>
                                <option value="76å…¬å‡">76å…¬å‡</option>
                            </select>
                        </div>
                        <div>
                            <label for="manual-recycle">è³‡æºåŒ…æ•¸ï¼š</label>
                            <input type="number" id="manual-recycle" placeholder="0" min="0" value="">
                        </div>
                        <div>
                            <label for="manual-recycle-volume">è³‡æºè¢‹å®¹é‡ï¼š</label>
                            <select id="manual-recycle-volume">
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="14å…¬å‡">14å…¬å‡</option>
                                <option value="25å…¬å‡">25å…¬å‡</option>
                                <option value="75å…¬å‡">75å…¬å‡</option>
                                <option value="76å…¬å‡">76å…¬å‡</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- ç¬¬ä¸‰è¡Œï¼šæœ€å¤šåƒåœ¾è¢‹æ•¸ã€æœ€å¤šè³‡æºè¢‹æ•¸ã€ç‰¹æ®Šéœ€æ±‚ -->
                    <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
                        <div>
                            <label for="manual-trash-max">æœ€å¤šåƒåœ¾è¢‹æ•¸ï¼š</label>
                            <input type="number" id="manual-trash-max" placeholder="0" min="0" value="">
                        </div>
                        <div>
                            <label for="manual-recycle-max">æœ€å¤šè³‡æºè¢‹æ•¸ï¼š</label>
                            <input type="number" id="manual-recycle-max" placeholder="0" min="0" value="">
                        </div>
                        <div>
                            <label for="manual-special-notes">ç‰¹æ®Šéœ€æ±‚ï¼š</label>
                            <input type="text" id="manual-special-notes" placeholder="ç‰¹æ®Šéœ€æ±‚" value="">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <h4>ğŸ“Š è³‡æ–™åµæ¸¬è¨­å®š</h4>
                    <div class="form-row">
                        <div>
                            <label for="sheet-name">å·¥ä½œè¡¨åç¨±ï¼š</label>
                            <input type="text" id="sheet-name" placeholder="ä¾‹ï¼šå ±åƒ¹è³‡æ–™" value="å·¥ä½œè¡¨1">
                        </div>
                        <div>
                            <label for="start-row">é–‹å§‹åˆ—æ•¸ï¼š</label>
                            <input type="number" id="start-row" min="1" value="2" placeholder="ç¬¬å¹¾åˆ—é–‹å§‹">
                        </div>
                        <div>
                            <label for="data-columns">è³‡æ–™æ¬„ä½ï¼š</label>
                            <select id="data-columns">
                                <option value="auto">è‡ªå‹•åµæ¸¬</option>
                                <option value="A-H">Aåˆ°Hæ¬„</option>
                                <option value="A-J">Aåˆ°Jæ¬„</option>
                                <option value="A-L">Aåˆ°Læ¬„</option>
                            </select>
                        </div>
                        <div>
                            <label for="update-mode">æ›´æ–°æ¨¡å¼ï¼š</label>
                            <select id="update-mode">
                                <option value="latest">æœ€æ–°ä¸€åˆ—</option>
                                <option value="all">æ‰€æœ‰è³‡æ–™</option>
                                <option value="last-5">æœ€å¾Œ5åˆ—</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: center; margin: 25px 0;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; width: 100%; max-width: 600px;">
                        <div></div>
                        <button onclick="fetchGoogleSheetsData()" style="background: white; color: #333; border: 2px solid #ddd; width: 50px; height: 50px; font-size: 18px; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; font-weight: bold; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" title="è®€å–è³‡æ–™">
                            â‡„
                        </button>
                        <div></div>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: center; margin: 15px 0;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; width: 100%; max-width: 600px;">
                        <div></div>
                        <button onclick="clearAutoQuoteForm()" style="background: #6c757d; color: white; border: none; width: 30px; height: 30px; font-size: 14px; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; font-weight: 600; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(108, 117, 125, 0.3);" title="æ¸…ç©ºè¡¨å–®" onmouseover="this.style.background='#5a6268'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(108, 117, 125, 0.4)'" onmouseout="this.style.background='#6c757d'; this.style.transform='translateY(0px)'; this.style.boxShadow='0 2px 5px rgba(108, 117, 125, 0.3)'">
                            Ã—
                        </button>
                        <div></div>
                    </div>
                </div>
                
                <div id="auto-sheets-status" class="status" style="display: none;"></div>
                
                <div class="form-group" id="auto-detected-data" style="display: none;">
                    <h4>ğŸ“‹ åµæ¸¬è³‡æ–™</h4>
                    <div id="detected-data-preview" class="output-area" style="background: #2a2a2a; border: 1px solid #404040; border-radius: 8px; max-height: 300px; overflow-y: auto;"></div>
                </div>
                
                <div class="form-group" id="auto-quote-controls" style="display: none;">
                    <h4>âš¡ è‡ªå‹•ç”Ÿæˆ</h4>
                    <div style="display: flex; justify-content: center; margin: 20px 0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; width: 100%; max-width: 600px;">
                            <div></div>
                            <button class="btn quote" onclick="generateAutoQuote()">âˆ</button>
                            <div></div>
                        </div>
                    </div>
                </div>
                
                <div class="output-section" id="auto-quote-output" style="display: none;">
                    <h4>ğŸ“„ è‡ªå‹•ç”Ÿæˆçš„å ±åƒ¹å–®</h4>
                    <div class="output-area" id="auto-quote-result-display"></div>
                    <button class="copy-btn" onclick="copyAutoQuote()">â§‰</button>
                    <div class="status" id="auto-quote-copy-status"></div>
                </div>
                
                <div id="auto-quote-final-status" class="status" style="display: none;"></div>
            </div>
        </div>

        <!-- å®¢æˆ¶å–®â®•å ±åƒ¹å–® -->
        <div id="quote" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">ğŸš€ å®¢æˆ¶å–®â®•å ±åƒ¹å–®</h3>
                    <button class="clear-btn-small" onclick="clearQuoteForm()" title="æ¸…ç©ºè¡¨å–®">Ã—</button>
                </div>
                <div class="info-box">
                    ğŸ’¡ å°‡å®¢æˆ¶è³‡æ–™è½‰æ›ç‚ºå°ˆæ¥­æ¨™æº–åŒ–å ±åƒ¹å–®æ ¼å¼
                </div>
                
                <div class="form-group">
                    <h4>âš™ï¸ è³‡æ–™è¼¸å…¥</h4>
                    
                    <!-- ç¬¬ä¸€è¡Œï¼šæ”¶å–åŸºæœ¬è¨­å®š -->
                    <div class="form-row">
                        <div>
                            <label for="service-days">æ”¶å–æ˜ŸæœŸï¼š</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px;">
                                <label style="display: flex; align-items: center; font-size: 14px; color: #e0e0e0; cursor: pointer; margin-bottom: 0;"><input type="checkbox" name="service-days" value="é€±ä¸€" style="width: 16px; height: 16px; margin-right: 8px;"> é€±ä¸€</label>
                                <label style="display: flex; align-items: center; font-size: 14px; color: #e0e0e0; cursor: pointer; margin-bottom: 0;"><input type="checkbox" name="service-days" value="é€±äºŒ" checked style="width: 16px; height: 16px; margin-right: 8px;"> é€±äºŒ</label>
                                <label style="display: flex; align-items: center; font-size: 14px; color: #e0e0e0; cursor: pointer; margin-bottom: 0;"><input type="checkbox" name="service-days" value="é€±ä¸‰" style="width: 16px; height: 16px; margin-right: 8px;"> é€±ä¸‰</label>
                                <label style="display: flex; align-items: center; font-size: 14px; color: #e0e0e0; cursor: pointer; margin-bottom: 0;"><input type="checkbox" name="service-days" value="é€±å››" style="width: 16px; height: 16px; margin-right: 8px;"> é€±å››</label>
                                <label style="display: flex; align-items: center; font-size: 14px; color: #e0e0e0; cursor: pointer; margin-bottom: 0;"><input type="checkbox" name="service-days" value="é€±äº”" checked style="width: 16px; height: 16px; margin-right: 8px;"> é€±äº”</label>
                                <label style="display: flex; align-items: center; font-size: 14px; color: #e0e0e0; cursor: pointer; margin-bottom: 0;"><input type="checkbox" name="service-days" value="é€±å…­" style="width: 16px; height: 16px; margin-right: 8px;"> é€±å…­</label>
                                <label style="display: flex; align-items: center; font-size: 14px; color: #e0e0e0; cursor: pointer; margin-bottom: 0;"><input type="checkbox" name="service-days" value="é€±æ—¥" style="width: 16px; height: 16px; margin-right: 8px;"> é€±æ—¥</label>
                            </div>
                        </div>
                        <div>
                            <label for="service-time">æ”¶å–æ™‚é–“ï¼š</label>
                            <input type="text" id="service-time" placeholder="0">
                        </div>
                        <div>
                            <label for="floor-level">æ¨“å±¤ï¼š</label>
                            <input type="number" id="floor-level" min="-10" max="50" placeholder="0">
                        </div>
                        <div>
                            <label for="monthly-fee">æœˆè²»(å…ƒ)ï¼š</label>
                            <input type="number" id="monthly-fee" min="0" step="50" placeholder="0">
                        </div>
                    </div>
                    
                    <!-- ç¬¬äºŒè¡Œï¼šåƒåœ¾å’Œè³‡æºè¨­å®š -->
                    <div class="form-row">
                        <div>
                            <label for="trash-bags">åƒåœ¾åŒ…æ•¸ï¼š</label>
                            <input type="number" id="trash-bags" min="0" placeholder="0">
                        </div>
                        <div>
                            <label for="trash-volume">åƒåœ¾è¢‹å®¹é‡ï¼š</label>
                            <select id="trash-volume">
                                <option value="0å…¬å‡">0å…¬å‡</option>
                                <option value="14å…¬å‡" selected>14å…¬å‡</option>
                                <option value="25å…¬å‡">25å…¬å‡</option>
                                <option value="75å…¬å‡">75å…¬å‡</option>
                                <option value="76å…¬å‡">76å…¬å‡</option>
                            </select>
                        </div>
                        <div>
                            <label for="recycle-bags">è³‡æºåŒ…æ•¸ï¼š</label>
                            <input type="number" id="recycle-bags" min="0" placeholder="0">
                        </div>
                        <div>
                            <label for="recycle-volume">è³‡æºè¢‹å®¹é‡ï¼š</label>
                            <select id="recycle-volume">
                                <option value="0å…¬å‡">0å…¬å‡</option>
                                <option value="14å…¬å‡" selected>14å…¬å‡</option>
                                <option value="25å…¬å‡">25å…¬å‡</option>
                                <option value="75å…¬å‡">75å…¬å‡</option>
                                <option value="76å…¬å‡">76å…¬å‡</option>
                            </select>
                        </div>
                    </div>

                    <!-- ç¬¬ä¸‰è¡Œï¼šé™åˆ¶å’Œç‰¹æ®Šéœ€æ±‚ -->
                    <div class="form-row">
                        <div>
                            <label for="trash-max">æœ€å¤šåƒåœ¾è¢‹æ•¸ï¼š</label>
                            <input type="number" id="trash-max" min="0" placeholder="0">
                        </div>
                        <div>
                            <label for="recycle-max">æœ€å¤šè³‡æºè¢‹æ•¸ï¼š</label>
                            <input type="number" id="recycle-max" min="0" placeholder="0">
                        </div>
                        <div>
                            <label for="special-notes">ç‰¹æ®Šéœ€æ±‚ï¼š</label>
                            <input type="text" id="special-notes" placeholder="ç‰¹æ®Šéœ€æ±‚">
                        </div>
                        <div></div> <!-- ç©ºæ¬„ä½ä¿æŒå°é½Š -->
                    </div>
                    
                    <button class="btn quote" onclick="generateQuote()">âˆ</button>
                </div>
                
                <div class="output-section" id="quote-output" style="display: none;">
                    <h4>ğŸ“‹ ç”Ÿæˆçš„å ±åƒ¹å–®</h4>
                    <div class="output-area" id="quote-result"></div>
                    <button class="copy-btn" onclick="copyToClipboard('quote-result')">â§‰</button>
                    <div class="status" id="quote-status"></div>
                </div>
            </div>
        </div>

        <!-- å ±åƒ¹å–®â®•åŒ…æœˆä»»å‹™å–® -->
        <div id="monthly" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">ğŸš€ å ±åƒ¹å–®â®•åŒ…æœˆä»»å‹™å–®</h3>
                    <button class="clear-btn-small" onclick="clearMonthlyForm()" title="æ¸…ç©ºè¡¨å–®">Ã—</button>
                </div>
                <div class="info-box">
                    ğŸ’¡ å°‡å ±åƒ¹è³‡æ–™è½‰æ›ç‚ºåŒ…æœˆä»»å‹™åŸ·è¡Œå–®æ ¼å¼
                </div>
                
                <div class="form-group">
                    <h4>âš™ï¸ è³‡æ–™è¼¸å…¥</h4>
                    
                    <!-- ç¬¬ä¸€è¡Œè¨­å®šåƒæ•¸ -->
                    <div class="form-row">
                        <div>
                            <label for="monthly-date">æ—¥æœŸï¼š</label>
                            <input type="date" id="monthly-date">
                        </div>
                        <div>
                            <label for="monthly-percentage">ç™¾åˆ†æ¯”ï¼š</label>
                            <input type="text" id="monthly-percentage" value="50" placeholder="åŸ·è¡ŒäººæŠ½æˆ%æ•¸">
                        </div>
                        <div>
                            <label for="monthly-upstairs">ä¸Šæ¨“ï¼š</label>
                            <select id="monthly-upstairs">
                                <option value="éœ€ä¸Šæ¨“" selected>éœ€ä¸Šæ¨“</option>
                                <option value="ä¸ç”¨ä¸Šæ¨“">ä¸ç”¨ä¸Šæ¨“</option>
                            </select>
                        </div>
                        <div>
                            <label for="monthly-address">åœ°å€ï¼š</label>
                            <input type="text" id="monthly-address" placeholder="è«‹è¼¸å…¥å®Œæ•´åœ°å€">
                        </div>
                        <div>
                            <label for="monthly-phone">é›»è©±ï¼š</label>
                            <input type="text" id="monthly-phone" placeholder="è«‹è¼¸å…¥è¯çµ¡é›»è©±">
                        </div>
                        <div>
                            <label for="monthly-name">å§“åï¼š</label>
                            <input type="text" id="monthly-name" placeholder="è«‹è¼¸å…¥å®¢æˆ¶å§“å">
                        </div>
                        <div>
                            <label for="monthly-key">é‘°åŒ™ï¼š</label>
                            <select id="monthly-key">
                                <option value="ç„¡" selected>ç„¡</option>
                                <option value="æœ‰">æœ‰</option>
                            </select>
                        </div>
                        <div>
                            <label for="monthly-time">æ™‚é–“ï¼š</label>
                            <input type="text" id="monthly-time" placeholder="ä¾‹å¦‚ï¼š0800å¾Œ">
                        </div>
                    </div>
                    
                    <!-- ç¬¬äºŒè¡Œè¨­å®šåƒæ•¸ -->
                    <div class="form-row">
                        <div>
                            <label for="monthly-trash-pickup">åƒåœ¾ï¼š</label>
                            <input type="number" id="monthly-trash-pickup" min="1" max="100" value="3" placeholder="åƒåœ¾ä¸€æ¬¡æ”¶å–åŒ…æ•¸">
                        </div>
                        <div>
                            <label for="monthly-recycle-pickup">è³‡æºï¼š</label>
                            <input type="number" id="monthly-recycle-pickup" min="1" max="100" value="3" placeholder="è³‡æºä¸€æ¬¡æ”¶å–åŒ…æ•¸">
                        </div>
                        <div>
                            <label for="monthly-bag">å°ˆç”¨è¢‹ï¼š</label>
                            <select id="monthly-bag">
                                <option value="æœ‰" selected>æœ‰</option>
                                <option value="ç„¡">ç„¡</option>
                            </select>
                        </div>
                        <div></div> <!-- ç©ºæ¬„ä½ä¿æŒå°é½Š -->
                    </div>
                    
                    <h4>ğŸ“ è¼¸å…¥è³‡æ–™</h4>
                    <label for="monthly-quote-data">è²¼ä¸Šå ±åƒ¹è³‡æ–™ï¼š</label>
                    <textarea id="monthly-quote-data" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šå®Œæ•´çš„å ±åƒ¹è³‡æ–™..." style="height: 200px;"></textarea>
                    
                    <button class="btn monthly" onclick="generateMonthlyTask()">âˆ</button>
                </div>
                
                <div class="output-section" id="monthly-output" style="display: none;">
                    <h4>ğŸ“‹ åŒ…æœˆä»»å‹™å–®</h4>
                    <div class="copy-buttons">
                        <div>
                            <h5>ä¸€èˆ¬ç‰ˆä»»å‹™å–®</h5>
                            <div class="output-area" id="monthly-general"></div>
                            <button class="copy-btn" onclick="copyToClipboard('monthly-general')">â§‰</button>
                        </div>
                        <div>
                            <h5>é™åˆ¶ç‰ˆä»»å‹™å–®</h5>
                            <div class="output-area" id="monthly-limited"></div>
                            <button class="copy-btn" onclick="copyToClipboard('monthly-limited')">â§‰</button>
                        </div>
                    </div>
                    <div class="status" id="monthly-status"></div>
                </div>
            </div>
        </div>

        <!-- å ±åƒ¹å–®â®•å–®è¶Ÿä»»å‹™å–® -->
        <div id="single" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">ğŸš€ å ±åƒ¹å–®â®•å–®è¶Ÿä»»å‹™å–®</h3>
                    <button class="clear-btn-small" onclick="clearSingleForm()" title="æ¸…ç©ºè¡¨å–®">Ã—</button>
                </div>
                <div class="info-box">
                    ğŸ’¡ å°‡å ±åƒ¹è³‡æ–™è½‰æ›ç‚ºå–®æ¬¡æœå‹™çš„ä»»å‹™åŸ·è¡Œå–®
                </div>
                
                <div class="form-group">
                    <h4>âš™ï¸ è³‡æ–™è¼¸å…¥</h4>
                    
                    <!-- ç¬¬ä¸€è¡Œåƒæ•¸ -->
                    <div class="form-row">
                        <div>
                            <label for="single-date">æ—¥æœŸï¼š</label>
                            <input type="date" id="single-date">
                        </div>
                        <div>
                            <label for="single-time">æ™‚é–“ï¼š</label>
                            <input type="text" id="single-time" placeholder="ä¾‹ï¼š14:30">
                        </div>
                        <div>
                            <label for="single-phone">é›»è©±ï¼š</label>
                            <input type="text" id="single-phone" placeholder="ä¾‹ï¼š0912345678">
                        </div>
                        <div>
                            <label for="single-name">å§“æ°ï¼š</label>
                            <input type="text" id="single-name" placeholder="ä¾‹ï¼šé™³">
                        </div>
                    </div>
                    
                    <!-- ç¬¬äºŒè¡Œåƒæ•¸ -->
                    <div class="form-row">
                        <div>
                            <label for="single-address">åœ°å€ï¼š</label>
                            <input type="text" id="single-address" placeholder="ä¾‹ï¼šå°åŒ—å¸‚ä¸­å±±å€æ°‘ç”Ÿæ±è·¯">
                        </div>
                        <div>
                            <label for="single-floor">æ¨“å±¤ï¼š</label>
                            <input type="text" id="single-floor" placeholder="ä¾‹ï¼š3F æˆ– åœ°ä¸‹1æ¨“">
                        </div>
                        <div>
                            <label for="single-customer-bag">å®¢æˆ¶ä½¿ç”¨å°ˆç”¨è¢‹ï¼š</label>
                            <select id="single-customer-bag">
                                <option value="ç„¡" selected>ç„¡</option>
                                <option value="æœ‰">æœ‰</option>
                                <option value="éƒ¨åˆ†æœ‰">éƒ¨åˆ†æœ‰</option>
                            </select>
                        </div>
                        <div>
                            <label for="single-waste-type">åƒåœ¾è³‡æºé‡ï¼š</label>
                            <select id="single-waste-type">
                                <option value="å¦‚åœ–" selected>å¦‚åœ–</option>
                                <option value="æ‰‹å‹•å¡«å¯«">æ‰‹å‹•å¡«å¯«</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- ç¬¬ä¸‰è¡Œåƒæ•¸ -->
                    <div class="form-row">
                        <div>
                            <label for="single-fee">è²»ç”¨ï¼š</label>
                            <input type="text" id="single-fee" placeholder="ä¾‹ï¼š500">
                        </div>
                        <div>
                            <label for="single-other1">å…¶ä»–èªªæ˜1ï¼š</label>
                            <input type="text" id="single-other1" placeholder="ä¾‹ï¼šå›å ±è·¯æ®µ">
                        </div>
                        <div>
                            <label for="single-other2">å…¶ä»–èªªæ˜2ï¼š</label>
                            <input type="text" id="single-other2" placeholder="ä¾‹ï¼šé¡å¤–å‚™è¨»">
                        </div>
                        <div>
                            <label for="single-other3">å…¶ä»–èªªæ˜3ï¼š</label>
                            <input type="text" id="single-other3" placeholder="ä¾‹ï¼šç‰¹æ®Šè¦æ±‚">
                        </div>
                    </div>
                    
                    <h4>ğŸ“· ç¾æ³ç…§ç‰‡ä¸Šå‚³</h4>
                    
                    <!-- ç…§ç‰‡åŠŸèƒ½ä¸€è¡Œå¼å¸ƒå±€ -->
                    <div class="photo-upload-row" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: stretch; margin-bottom: 15px; min-height: 110px;">
                        <!-- æ‹–æ›³ä¸Šå‚³å€åŸŸ -->
                        <div id="single-drop-zone" class="drop-zone-inline" style="flex: 0 0 280px; border: 2px dashed #666; border-radius: 8px; padding: 15px; text-align: center; background: #2a2a2a; transition: all 0.3s ease; position: relative; height: 110px; display: flex; align-items: center; justify-content: center;">
                            <div class="drop-zone-content">
                                <div style="font-size: 1.5em; margin-bottom: 5px;">ğŸ“</div>
                                <div style="color: #ccc; font-size: 14px;">æ‹–æ›³ç…§ç‰‡æˆ–é»æ“Šé¸æ“‡</div>
                                <input type="file" id="single-images" multiple accept="image/png,image/jpg,image/jpeg" style="opacity: 0; position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer;">
                            </div>
                        </div>
                        
                        <!-- æ§åˆ¶æŒ‰éˆ•å€åŸŸ -->
                        <div id="single-merge-controls" style="display: none; flex: 0 0 auto; height: 110px; flex-direction: column; justify-content: center; gap: 8px;">
                            <button type="button" class="btn-merge" onclick="mergeSingleImages()">â‰«</button>
                            <button type="button" class="btn-clear" onclick="clearSingleImages()">Ã—</button>
                        </div>
                        
                        <!-- ç…§ç‰‡é è¦½å€åŸŸ -->
                        <div id="single-image-preview" style="flex: 1; min-width: 180px; min-height: 110px; display: flex; flex-direction: column; justify-content: flex-start;"></div>
                    </div>
                    
                    <!-- åˆä½µç…§ç‰‡é¡¯ç¤ºå€åŸŸ - ç§»åˆ°ä¸‹æ–¹ -->
                    <div id="single-merged-preview" style="width: 100%; margin-bottom: 15px; display: flex; justify-content: center;"></div>
                    
                    <button class="btn single" onclick="generateSingleTask()">âˆ</button>
                </div>
                
                <div class="output-section" id="single-output" style="display: none;">
                    <h4>ğŸ“‹ å–®è¶Ÿä»»å‹™å–®</h4>
                    <div class="output-area" id="single-result"></div>
                    <button class="copy-btn" onclick="copyToClipboard('single-result')">â§‰</button>
                    <div class="status" id="single-status"></div>
                </div>
            </div>
        </div>

        <!-- å ±åƒ¹å–®â®•å–®æ¬¡æ¸…æ½”ä»»å‹™å–® -->
        <div id="clean" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">ğŸš€ å ±åƒ¹å–®â®•å–®æ¬¡æ¸…æ½”ä»»å‹™å–®</h3>
                    <button class="clear-btn-small" onclick="clearCleanForm()" title="æ¸…ç©ºè¡¨å–®">Ã—</button>
                </div>
                <div class="info-box">
                    ğŸ’¡ å°‡å ±åƒ¹è³‡æ–™è½‰æ›ç‚ºå–®æ¬¡æ¸…æ½”æœå‹™çš„ä»»å‹™åŸ·è¡Œå–®
                </div>
                
                <div class="form-group">
                    <h4>âš™ï¸ è³‡æ–™è¼¸å…¥</h4>
                    
                    <!-- ç¬¬ä¸€è¡Œåƒæ•¸ -->
                    <div class="form-row">
                        <div>
                            <label for="clean-date">æ—¥æœŸï¼š</label>
                            <input type="date" id="clean-date">
                        </div>
                        <div>
                            <label for="clean-time">æ™‚é–“ï¼š</label>
                            <input type="text" id="clean-time" placeholder="ä¾‹ï¼š14:30">
                        </div>
                        <div>
                            <label for="clean-phone">é›»è©±ï¼š</label>
                            <input type="text" id="clean-phone" placeholder="ä¾‹ï¼š0912345678">
                        </div>
                        <div>
                            <label for="clean-name">å§“æ°ï¼š</label>
                            <input type="text" id="clean-name" placeholder="ä¾‹ï¼šé™³">
                        </div>
                        <div>
                            <label for="clean-address">åœ°å€ï¼š</label>
                            <input type="text" id="clean-address" placeholder="ä¾‹ï¼šå°åŒ—å¸‚ä¸­å±±å€æ°‘ç”Ÿæ±è·¯">
                        </div>
                        <div>
                            <label for="clean-floor">æ¨“å±¤ï¼š</label>
                            <input type="text" id="clean-floor" placeholder="ä¾‹ï¼š3F æˆ– åœ°ä¸‹1æ¨“">
                        </div>
                        <div>
                            <label for="clean-waste-type">ç¾æ³ç…§ç‰‡ï¼š</label>
                            <select id="clean-waste-type">
                                <option value="å¦‚åœ–" selected>å¦‚åœ–</option>
                                <option value="æ‰‹å‹•å¡«å¯«">æ‰‹å‹•å¡«å¯«</option>
                            </select>
                        </div>
                        <div>
                            <label for="clean-fee">è²»ç”¨ï¼š</label>
                            <input type="text" id="clean-fee" placeholder="ä¾‹ï¼š800">
                        </div>
                    </div>
                    
                    <!-- ç¬¬äºŒè¡Œåƒæ•¸ -->
                    <div class="form-row">
                        <div>
                            <label for="clean-other1">å…¶ä»–èªªæ˜1ï¼š</label>
                            <input type="text" id="clean-other1" placeholder="ä¾‹ï¼šç‰¹æ®Šæ¸…æ½”éœ€æ±‚">
                        </div>
                        <div>
                            <label for="clean-other2">å…¶ä»–èªªæ˜2ï¼š</label>
                            <input type="text" id="clean-other2" placeholder="ä¾‹ï¼šé¡å¤–å‚™è¨»">
                        </div>
                        <div>
                            <label for="clean-other3">å…¶ä»–èªªæ˜3ï¼š</label>
                            <input type="text" id="clean-other3" placeholder="ä¾‹ï¼šæ³¨æ„äº‹é …">
                        </div>
                    </div>
                    
                    <h4>ğŸ§¹ æ¸…æ½”ç¯„åœ</h4>
                    <div class="form-row">
                        <div>
                            <label for="clean-scope-1">1.</label>
                            <input type="text" id="clean-scope-1" placeholder="æ¸…æ½”é …ç›® 1">
                        </div>
                        <div>
                            <label for="clean-scope-2">2.</label>
                            <input type="text" id="clean-scope-2" placeholder="æ¸…æ½”é …ç›® 2">
                        </div>
                        <div>
                            <label for="clean-scope-3">3.</label>
                            <input type="text" id="clean-scope-3" placeholder="æ¸…æ½”é …ç›® 3">
                        </div>
                        <div>
                            <label for="clean-scope-4">4.</label>
                            <input type="text" id="clean-scope-4" placeholder="æ¸…æ½”é …ç›® 4">
                        </div>
                        <div>
                            <label for="clean-scope-5">5.</label>
                            <input type="text" id="clean-scope-5" placeholder="æ¸…æ½”é …ç›® 5">
                        </div>
                        <div>
                            <label for="clean-scope-6">6.</label>
                            <input type="text" id="clean-scope-6" placeholder="æ¸…æ½”é …ç›® 6">
                        </div>
                    </div>
                    <div class="form-row">
                        <div>
                            <label for="clean-scope-7">7.</label>
                            <input type="text" id="clean-scope-7" placeholder="æ¸…æ½”é …ç›® 7">
                        </div>
                        <div>
                            <label for="clean-scope-8">8.</label>
                            <input type="text" id="clean-scope-8" placeholder="æ¸…æ½”é …ç›® 8">
                        </div>
                        <div>
                            <label for="clean-scope-9">9.</label>
                            <input type="text" id="clean-scope-9" placeholder="æ¸…æ½”é …ç›® 9">
                        </div>
                        <div>
                            <label for="clean-scope-10">10.</label>
                            <input type="text" id="clean-scope-10" placeholder="æ¸…æ½”é …ç›® 10">
                        </div>
                        <div></div> <!-- ç©ºæ¬„ä½ä¿æŒå°é½Š -->
                        <div></div> <!-- ç©ºæ¬„ä½ä¿æŒå°é½Š -->
                    </div>
                    
                    <h4>ğŸ“· ç¾æ³ç…§ç‰‡ä¸Šå‚³</h4>
                    
                    <!-- ç…§ç‰‡åŠŸèƒ½ä¸€è¡Œå¼å¸ƒå±€ -->
                    <div class="photo-upload-row" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: stretch; margin-bottom: 15px; min-height: 110px;">
                        <!-- æ‹–æ›³ä¸Šå‚³å€åŸŸ -->
                        <div id="clean-drop-zone" class="drop-zone-inline" style="flex: 0 0 280px; border: 2px dashed #666; border-radius: 8px; padding: 15px; text-align: center; background: #2a2a2a; transition: all 0.3s ease; position: relative; height: 110px; display: flex; align-items: center; justify-content: center;">
                            <div class="drop-zone-content">
                                <div style="font-size: 1.5em; margin-bottom: 5px;">ğŸ“</div>
                                <div style="color: #ccc; font-size: 14px;">æ‹–æ›³ç…§ç‰‡æˆ–é»æ“Šé¸æ“‡</div>
                                <input type="file" id="clean-images" multiple accept="image/png,image/jpg,image/jpeg" style="opacity: 0; position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer;">
                            </div>
                        </div>
                        
                        <!-- æ§åˆ¶æŒ‰éˆ•å€åŸŸ -->
                        <div id="clean-merge-controls" style="display: none; flex: 0 0 auto; height: 110px; flex-direction: column; justify-content: center; gap: 8px;">
                            <button type="button" class="btn-merge" onclick="mergeCleanImages()">â‰«</button>
                            <button type="button" class="btn-clear" onclick="clearCleanImages()">Ã—</button>
                        </div>
                        
                        <!-- ç…§ç‰‡é è¦½å€åŸŸ -->
                        <div id="clean-image-preview" style="flex: 1; min-width: 180px; min-height: 110px; display: flex; flex-direction: column; justify-content: flex-start;"></div>
                    </div>
                    
                    <!-- åˆä½µç…§ç‰‡é¡¯ç¤ºå€åŸŸ - ç§»åˆ°ä¸‹æ–¹ -->
                    <div id="clean-merged-preview" style="width: 100%; margin-bottom: 15px; display: flex; justify-content: center;"></div>
                    
                    <button class="btn clean" onclick="generateCleanTask()">âˆ</button>
                </div>
                
                <div class="output-section" id="clean-output" style="display: none;">
                    <h4>ğŸ“‹ æ¸…æ½”ä»»å‹™å–®</h4>
                    <div class="output-area" id="clean-result"></div>
                    <button class="copy-btn" onclick="copyToClipboard('clean-result')">â§‰</button>
                    <div class="status" id="clean-status"></div>
                </div>
            </div>
        </div>

        <!-- è²¡å‹™åˆ†æ -->
        <div id="financial" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">ğŸ’° è²¡å‹™åˆ†æ</h3>
                    <button class="clear-btn-small" onclick="clearFinancialForm()" title="æ¸…ç©ºè¡¨å–®">Ã—</button>
                </div>
                <div class="info-box">
                    ğŸ’¡ åˆ†ææ”¯å‡ºæ•¸æ“šï¼Œè‡ªå‹•è¨ˆç®—å„é¡åˆ¥è²»ç”¨ä¸¦ç”Ÿæˆè²¡å‹™å ±å‘Šã€‚æ”¯æ´å…©ç¨®æ–¹å¼ï¼š1. ç›´æ¥è²¼ä¸ŠCSVè³‡æ–™ 2. Googleè©¦ç®—è¡¨é€£çµï¼ˆéœ€è¦ç‰¹æ®Šè¨­å®šï¼‰
                </div>
                
                <div class="form-group">
                    <h4>ğŸ“Š è³‡æ–™è¼¸å…¥æ–¹å¼</h4>
                    <div style="margin-bottom: 15px;">
                        <label style="color: #e0e0e0; margin-bottom: 10px; display: block;">é¸æ“‡è¼¸å…¥æ–¹å¼ï¼š</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; color: #e0e0e0; cursor: pointer;">
                                <input type="radio" name="input-method" value="csv" checked onchange="toggleInputMethod()" style="margin-right: 8px;">
                                CSVè³‡æ–™è²¼ä¸Š
                            </label>
                            <label style="display: flex; align-items: center; color: #e0e0e0; cursor: pointer;">
                                <input type="radio" name="input-method" value="sheets" onchange="toggleInputMethod()" style="margin-right: 8px;">
                                Googleè©¦ç®—è¡¨é€£çµ
                            </label>
                        </div>
                    </div>
                    
                    <!-- CSVè³‡æ–™è²¼ä¸Šå€åŸŸ -->
                    <div id="csv-input-area">
                        <h4>ğŸ“ CSVè³‡æ–™</h4>
                        <textarea id="financial-csv-data" placeholder="è«‹å°‡CSVè³‡æ–™è²¼ä¸Šæ­¤è™•ï¼Œä¾‹å¦‚ï¼š&#10;æ—¥æœŸ,é …ç›®,é‡‘é¡,é¡åˆ¥&#10;2025-01-01,åˆé¤,200,é¤é£²è²»&#10;2025-01-02,åŠ æ²¹,1500,ç‡ƒæ–™è²»" style="width: 100%; height: 150px; background: #2a2a2a; color: white; border: 1px solid #555; border-radius: 4px; padding: 10px; font-family: monospace; resize: vertical;"></textarea>
                        <small style="color: #888; margin-top: 5px; display: block;">ğŸ’¡ å¾Googleè©¦ç®—è¡¨è¤‡è£½è³‡æ–™æ™‚ï¼Œè«‹é¸æ“‡è³‡æ–™ç¯„åœå¾Œç›´æ¥Ctrl+Cè¤‡è£½ï¼Œç„¶å¾Œè²¼ä¸Šåˆ°æ­¤è™•</small>
                    </div>
                    
                    <!-- Googleè©¦ç®—è¡¨é€£çµå€åŸŸ -->
                    <div id="sheets-input-area" style="display: none;">
                        <h4>ğŸ”— Googleè©¦ç®—è¡¨é€£çµ</h4>
                        <div class="form-row">
                            <div style="grid-column: span 2;">
                                <label for="financial-sheets-url">è©¦ç®—è¡¨ç¶²å€ï¼š</label>
                                <input type="text" id="financial-sheets-url" placeholder="è«‹è²¼ä¸ŠGoogleè©¦ç®—è¡¨çš„å…±äº«é€£çµ" style="width: 100%;">
                                <small style="color: #888; margin-top: 5px; display: block;">ğŸ’¡ æç¤ºï¼šè«‹ç¢ºä¿è©¦ç®—è¡¨åˆ†äº«è¨­å®šç‚ºã€ŒçŸ¥é“é€£çµçš„ä½¿ç”¨è€…ã€</small>
                            </div>
                            <div>
                                <label for="financial-url-dropdown">è¨˜æ†¶ç¶²å€ï¼š</label>
                                <select id="financial-url-dropdown" onchange="selectFinancialUrl()" style="width: 100%;">
                                    <option value="">é¸æ“‡å·²å­˜ç¶²å€</option>
                                </select>
                                <button type="button" onclick="saveFinancialUrl()" style="width: 100%; margin-top: 5px; padding: 5px; background: #444; color: white; border: 1px solid #666; border-radius: 4px; cursor: pointer;">ğŸ’¾ å­˜å„²ç¶²å€</button>
                            </div>
                            <div>
                                <label for="financial-sheet-name">å·¥ä½œè¡¨åç¨±ï¼š</label>
                                <input type="text" id="financial-sheet-name" placeholder="ä¾‹ï¼šå·¥ä½œè¡¨1 æˆ–ç•™ç©ºä½¿ç”¨é è¨­å·¥ä½œè¡¨" style="width: 100%;">
                                <small style="color: #888; margin-top: 5px; display: block;">ğŸ’¡ å¯æŒ‡å®šç‰¹å®šå·¥ä½œè¡¨åç¨±ï¼Œç•™ç©ºå‰‡ä½¿ç”¨é è¨­å·¥ä½œè¡¨</small>
                            </div>
                            <div>
                                <label for="financial-cell-range">å„²å­˜æ ¼ç¯„åœï¼š</label>
                                <input type="text" id="financial-cell-range" placeholder="ä¾‹ï¼šA1:Z100 æˆ–ç•™ç©ºè®€å–å…¨éƒ¨" style="width: 100%;">
                                <small style="color: #888; margin-top: 5px; display: block;">ğŸ’¡ å¯æŒ‡å®šç¯„åœå¦‚ A1:Z100ï¼Œæˆ–ç•™ç©ºè®€å–æ•´å€‹å·¥ä½œè¡¨</small>
                            </div>
                        </div>
                    </div>
                </div>
                

                
                <!-- æ¬„ä½é¸æ“‡å€åŸŸ -->
                <div id="financial-column-selection" style="display: none;">
                    <h4>ğŸ“‹ é¸æ“‡åˆ†ææ¬„ä½</h4>
                    <div style="background: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div id="financial-column-checkboxes" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;"></div>
                        <div style="margin-top: 15px; text-align: center;">
                            <button type="button" onclick="selectAllColumns()" style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 10px; cursor: pointer;">å…¨é¸</button>
                            <button type="button" onclick="clearAllColumns()" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 10px; cursor: pointer;">æ¸…ç©º</button>
                            <button type="button" onclick="proceedWithAnalysis()" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">é–‹å§‹åˆ†æ</button>
                        </div>
                    </div>
                </div>
                
                <!-- è³‡æ–™é è¦½å€åŸŸ -->
                <div id="financial-data-preview" style="display: none;">
                    <h4>ğŸ“Š åŸå§‹è³‡æ–™é è¦½</h4>
                    <div id="financial-raw-data" style="background: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 20px; max-height: 300px; overflow-y: auto;"></div>
                </div>
                
                <!-- è²¡å‹™åˆ†æçµæœ -->
                <div id="financial-analysis-output" style="display: none;">
                    <h4>ğŸ“ˆ è²¡å‹™åˆ†æçµæœ</h4>
                    <div id="financial-summary" style="background: #2a2a2a; padding: 20px; border-radius: 8px; margin-bottom: 15px;"></div>
                    <div id="financial-breakdown" style="background: #2a2a2a; padding: 20px; border-radius: 8px; margin-bottom: 15px;"></div>
                    <button class="copy-btn" onclick="copyFinancialAnalysis()">â§‰ è¤‡è£½åˆ†æçµæœ</button>
                </div>
                
                <div class="status" id="financial-status"></div>
            </div>
        </div>
    </div>

    <script>
        // Tab switching functionality
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // Quote generation function
        function generateQuote() {
            // ç²å–æ‰€æœ‰è¡¨å–®æ•¸æ“š
            const serviceDaysCheckboxes = document.querySelectorAll('input[name="service-days"]:checked');
            const serviceDays = Array.from(serviceDaysCheckboxes).map(checkbox => checkbox.value);
            const serviceTime = document.getElementById('service-time').value;
            const floorLevel = parseInt(document.getElementById('floor-level').value);
            const trashBags = document.getElementById('trash-bags').value;
            const trashVolume = document.getElementById('trash-volume').value;
            const recycleBags = document.getElementById('recycle-bags').value;
            const recycleVolume = document.getElementById('recycle-volume').value;
            const trashMax = document.getElementById('trash-max').value;
            const recycleMax = document.getElementById('recycle-max').value;
            const monthlyFee = document.getElementById('monthly-fee').value;
            const specialNotes = document.getElementById('special-notes').value;
            
            // æ ¼å¼åŒ–æœå‹™æ—¥æœŸ
            const daysText = serviceDays.length > 0 ? serviceDays.join('ã€') : 'å¾…ç¢ºå®š';
            
            // æ ¼å¼åŒ–æ™‚é–“
            let formattedTime = serviceTime;
            if (serviceTime) {
                const timeMatch = serviceTime.match(/(\d{4})/);
                if (timeMatch) {
                    const timeStr = timeMatch[1];
                    const hour = parseInt(timeStr.substring(0, 2));
                    const minute = timeStr.substring(2);
                    if (hour < 12) {
                        formattedTime = `ä¸Šåˆ ${hour.toString().padStart(2, '0')}ï¼š${minute}`;
                    } else if (hour < 18) {
                        formattedTime = `ä¸‹åˆ ${hour.toString().padStart(2, '0')}ï¼š${minute}`;
                    } else {
                        formattedTime = `æ™šé–“ ${hour.toString().padStart(2, '0')}ï¼š${minute}`;
                    }
                }
            }
            
            // è¨ˆç®—é€±è¶Ÿæ•¸å’Œæ ¼å¼åŒ–æ—¥æœŸ
            const weeklyTrips = serviceDays.length || 2;
            const dayMapping = {"é€±ä¸€": "é€±1", "é€±äºŒ": "é€±2", "é€±ä¸‰": "é€±3", "é€±å››": "é€±4", "é€±äº”": "é€±5", "é€±å…­": "é€±6", "é€±æ—¥": "é€±7"};
            const formattedDays = serviceDays.map(day => dayMapping[day] || day).join('+');
            const tripsAndDays = serviceDays.length > 0 ? `${weeklyTrips}è¶Ÿ-${formattedDays}` : `${weeklyTrips}è¶Ÿ`;
            
            // æ ¼å¼åŒ–æ¨“å±¤
            const floorNumber = floorLevel < 0 ? `åœ°ä¸‹${Math.abs(floorLevel)}æ¨“` : `${floorLevel}F`;
            
            // æ”¶å–æ™‚é–“æè¿°
            let collectionTimeDesc = '';
            if (formattedTime.includes('ä¸Šåˆ')) {
                collectionTimeDesc = 'ä¸­åˆå‰';
            } else if (formattedTime.includes('ä¸‹åˆ')) {
                collectionTimeDesc = 'ä¸‹åˆçµæŸå‰';
            } else if (formattedTime.includes('æ™šé–“')) {
                collectionTimeDesc = 'åŠå¤œå‰';
            } else {
                collectionTimeDesc = 'ä¸­åˆ/ä¸‹åˆ/åŠå¤œ/';
            }
            
            // é‘°åŒ™æç¤º
            const keyNote = floorLevel > 1 ? 'ï¼ˆä¸Šæ¨“ä»£æ”¶éœ€æä¾›1æ¨“å¤§é–€é‘°åŒ™ï¼‰' : 
                           floorLevel < 0 ? 'ï¼ˆåœ°ä¸‹å®¤ä»£æ”¶éœ€æä¾›åœ°ä¸‹å®¤é‘°åŒ™ï¼‰' : '';
            
            const quote = `â›”å ±åƒ¹è³‡æ–™â›”

ä¸€é€±è¶Ÿæ•¸ï¼š${tripsAndDays}
   ç½®æ”¾æ™‚é–“ï¼š${formattedTime || 'ï¼ˆæº–æ™‚ç½®æ”¾ï¼‰'}
   ç½®æ”¾æ¨“å±¤ï¼š${floorNumber}

ï¼ˆâš ï¸ åƒåœ¾ç•¶æ—¥ï¼š${collectionTimeDesc}   ä»£æ”¶å®Œç•¢ï¼‰

ï¼ˆâš ï¸ éç¨‹ä¸­åš´ç¦å‚¬ä¿ƒï¼‰
ï¼ˆâš ï¸ è«‹æº–æ™‚ç½®æ”¾ ä»¥å…å¤šæœ‰ç³¾ç´›ï¼‰

 1é€±åƒåœ¾ï¼š${trashBags}åŒ…æ•¸ï¼ˆ${trashVolume}ï¼‰
ï¼ˆ1æ¬¡æœ€å¤šæ”¶å–${trashMax}è¢‹--è¶…é‡æ‹’æ”¶ï¼‰
ï¼ˆåƒåœ¾è«‹ç¶ç·Šã€å‹¿å¤–éœ²ï¼‰
ï¼ˆåƒåœ¾è¢‹å¤–éƒ¨å‹¿æµæ¹¯æ±ï¼‰
ï¼ˆä¸€æ¬¡æ€§ç´™/å¡‘è† å®¹å™¨å‡åƒåœ¾ï¼‰


 1é€±è³‡æº:${recycleBags}åŒ…æ•¸ï¼ˆ${recycleVolume}ï¼‰-ç”¨ä¸€èˆ¬å¡‘è† è¢‹
ï¼ˆ1æ¬¡æœ€å¤šæ”¶å–${recycleMax}è¢‹--è¶…é‡æ‹’æ”¶ï¼‰
ï¼ˆè‹¥æœªè£è¢‹ä¸€å¾‹æ‹’æ”¶ï¼‰
ï¼ˆè«‹å‹¿ç”¨é»‘è‰²è¢‹å­è£è³‡æºï¼‰
ï¼ˆåƒ…æ”¶å¯¶ç‰¹ç»ç’ƒéµé‹ç½ï¼‰
ï¼ˆåƒ…æ”¶ä¸­å°ç´™æ¿ç®±å£“æ‰æŠ˜å¥½ï¼‰
ï¼ˆåƒ…æ”¶æ›¸æœ¬/ä¹¾æ·¨ç´™å¼µï¼‰

âš ï¸ä¸‹åˆ—ç‰©å“è¦–ç‚ºåƒåœ¾
ï¼ˆä¾¿ç•¶ç›’/å¡‘è† è¢‹/å¸ç®¡â¡ï¸åƒåœ¾ï¼‰
ï¼ˆè»Ÿå¡‘è† è“‹/å¸ç®¡â¡ï¸åƒåœ¾ï¼‰
ï¼ˆæ—©é¤ç›’/å¿«é£²æ¯â¡ï¸åƒåœ¾ï¼‰
ï¼ˆæ³¡æ£‰/é›è›‹è»Ÿå¡‘è† ç›’â¡ï¸åƒåœ¾ï¼‰
ï¼ˆè›‹ç³•ç›’/ç·©è¡ææ–™â¡ï¸åƒåœ¾ï¼‰

ä¸€å€‹æœˆè²»ç”¨ï¼š${monthlyFee}å…ƒ
${keyNote}

-
â›”é…åˆäº‹é …â›”
â­.åƒåœ¾å‹™å¿…æ‰“åŒ…ç¶å¥½æ”¾ç½®é–€å£
â­.å¦‚å› æ”¿ç­–é—œä¿‚éœ€æ›´æ”¹æ™‚é–“
  ï¼ˆæœƒåœ¨æå‰å‘ŠçŸ¥ ç…©è«‹é…åˆï¼‰
â­.è‡ªå‚™é›™åŒ—å¸‚æ”¿åºœå°ˆç”¨åƒåœ¾è¢‹
â­.æ”¶æ¬¾å¾Œä¸é€€æ¬¾å…§å®¹ä¸æ›´æ”¹
â­.è‹¥æœ‰è¶…é‡åƒåœ¾æ‹’æ”¶

â¬â¬

â›”å…¶ä»–å•é¡Œâ›”
ğŸŸ¥.è«‹å®Œæ•´çœ‹å®Œå ±åƒ¹å…§å®¹å¾Œæå‡º
ğŸŸ¥.å®¢æœæœƒç‚ºæ‚¨è§£æ±ºä»»ä½•å•é¡Œ

â¬â¬

â­•è§£æ±ºå•é¡Œâ­•
âœ”ï¸.ä¸Šè¿°å•é¡Œå‡è§£æ±º
âœ”ï¸.ä¸Šè¿°å…§å®¹èƒ½é…åˆ
å›è¦†å‘ŠçŸ¥æˆ‘å€‘ï¼šåŒæ„âœ…+é–‹å§‹æ—¥

â¬â¬

æ”¶åˆ°_åŒæ„âœ…_å¾Œ
ğŸ’§å®¢æœâ¡ï¸æä¾›ç¹³è²»å–®
ğŸ’§å®¢æˆ¶â¡ï¸å®Œæˆç¹³è²»
ğŸ’§å®¢æœâ¡ï¸é–‹å§‹ä»£æ”¶

âœ–ï¸æ³¨æ„äº‹é …âœ–ï¸
ğŸ”».1åˆ†éŒ¢1åˆ†æœå‹™_ä¾¿å®œç„¡å®‰å…¨æœå‹™
ğŸ”».è¿‘æœŸå¤šæ¡ˆä¾‹/è«‹æˆ¿æ±ä½æˆ¶å¤šæ³¨æ„
ğŸ”».å‡ç‚ºå¹´è¼•åœ˜éšŠä½œæ¥­æµç¨‹å‡æœ‰SOP
ğŸ”».æˆå“¡å¹³å‡30-35æ­²å…§å‡æœ‰è‰¯æ°‘è­‰
ğŸ”».éå¹´åŠå¤©ç½äººç¦åœæ­¢ä»£æ”¶ç„¡é€€æ¬¾
       å»¶è‡³ä¸‹ä¸€æ¬¡èƒ½ä»£æ”¶å·¥ä½œæ—¥



ğŸ”¥è¬äº‹é †å¿ƒğŸ”¥

${specialNotes ? `ç‰¹æ®Šéœ€æ±‚ï¼š${specialNotes}` : ''}`;

            document.getElementById('quote-result').textContent = quote;
            document.getElementById('quote-output').style.display = 'block';
            showStatus('quote-status', 'âœ… å ±åƒ¹å–®ç”Ÿæˆå®Œæˆï¼', 'success');
        }

        // Monthly task generation function
        function generateMonthlyTask() {
            const quoteData = document.getElementById('monthly-quote-data').value;
            const date = document.getElementById('monthly-date').value;
            
            // ç²å–æ‰€æœ‰æ‰‹å‹•è¼¸å…¥æ¬„ä½
            const percentage = document.getElementById('monthly-percentage').value.replace('%', '') || '50';
            const upstairs = document.getElementById('monthly-upstairs').value;
            const address = document.getElementById('monthly-address').value;
            const phone = document.getElementById('monthly-phone').value;
            const name = document.getElementById('monthly-name').value;
            const trashPickup = document.getElementById('monthly-trash-pickup').value;
            const recyclePickup = document.getElementById('monthly-recycle-pickup').value;
            const key = document.getElementById('monthly-key').value;
            const manualTime = document.getElementById('monthly-time').value;
            const bag = document.getElementById('monthly-bag').value;
            
            if (!quoteData || !date) {
                showStatus('monthly-status', 'è«‹å¡«å¯«å ±åƒ¹è³‡æ–™å’ŒåŸ·è¡Œæ—¥æœŸ', 'error');
                return;
            }
            
            // è§£æå ±åƒ¹è³‡æ–™
            let extractedAddress = address, extractedName = name, extractedPhone = phone;
            let fee = 0, weekDays = 'æœªå¡«', time = 'ä¸Šåˆ';
            let trashAmount = 'æœªå¡«', recycleAmount = 'æœªå¡«';
            
            // å¦‚æœæ‰‹å‹•æ¬„ä½ç‚ºç©ºï¼Œå‰‡å¾å ±åƒ¹è³‡æ–™ä¸­æå–
            if (!address || !name || !phone) {
                const lines = quoteData.split('\n');
                for (const line of lines) {
                    if (line.includes('åœ°å€') && !extractedAddress) {
                        extractedAddress = line.split(/[ï¼š:]/)[1]?.trim() || '';
                    }
                    if (line.includes('å§“å') && !extractedName) {
                        extractedName = line.split(/[ï¼š:]/)[1]?.trim() || '';
                    }
                    if (line.includes('é›»è©±') && !extractedPhone) {
                        extractedPhone = line.split(/[ï¼š:]/)[1]?.trim() || '';
                    }
                }
            }
            
            // æå–è²»ç”¨ä¸¦æ‡‰ç”¨ç™¾åˆ†æ¯”
            const feeMatch = quoteData.match(/ä¸€å€‹æœˆè²»ç”¨ï¼š(\d+)/);
            if (feeMatch) {
                const originalFee = parseInt(feeMatch[1]);
                fee = Math.floor(originalFee * (parseInt(percentage) / 100));
            }
            
            // æå–é€±è¶Ÿæ•¸å’Œæ—¥æœŸ
            const weekMatch = quoteData.match(/ä¸€é€±è¶Ÿæ•¸ï¼š.*?(\d+è¶Ÿ)-(é€±.*?)\n/);
            weekDays = weekMatch ? weekMatch[2] : 'æœªå¡«';
            
            // å°‡é€±1+é€±4æ ¼å¼è½‰æ›ç‚ºæ˜ŸæœŸæ ¼å¼
            function convertWeekdayFormat(weekStr) {
                if (!weekStr || weekStr === 'æœªå¡«') return 'æœªå¡«';
                
                const weekMap = {
                    'é€±1': 'é€±ä¸€', 'é€±2': 'é€±äºŒ', 'é€±3': 'é€±ä¸‰', 
                    'é€±4': 'é€±å››', 'é€±5': 'é€±äº”', 'é€±6': 'é€±å…­', 'é€±æ—¥': 'é€±æ—¥'
                };
                
                // è™•ç†é€±1+é€±4é€™ç¨®æ ¼å¼
                return weekStr.replace(/é€±(\d)/g, (match, num) => {
                    return weekMap[match] || match;
                });
            }
            
            weekDays = convertWeekdayFormat(weekDays);
            
            // æ™‚é–“æ ¼å¼åŒ–å‡½æ•¸
            function formatTimeToChinnese(timeStr) {
                timeStr = timeStr.replace(/[ï¼š:å¾Œ]/g, '').trim();
                if (timeStr.length === 4 && !isNaN(timeStr)) {
                    const hour = parseInt(timeStr.substring(0, 2));
                    const minute = timeStr.substring(2);
                    let period;
                    if (hour < 12) {
                        period = 'ä¸Šåˆ';
                    } else if (hour < 18) {
                        period = 'ä¸‹åˆ';
                    } else {
                        period = 'æ™šé–“';
                    }
                    return `${period} ${hour.toString().padStart(2, '0')}ï¼š${minute} å¾Œ`;
                }
                if (timeStr.includes('ä¸Šåˆ') || timeStr.includes('ä¸‹åˆ') || timeStr.includes('æ™šé–“')) {
                    return timeStr + (timeStr.endsWith('å¾Œ') ? '' : ' å¾Œ');
                }
                return timeStr + (timeStr && !timeStr.endsWith('å¾Œ') ? 'å¾Œ' : '');
            }
            
            // ä½¿ç”¨æ‰‹å‹•æ™‚é–“æˆ–å¾æ–‡å­—ä¸­æå–
            if (manualTime.trim()) {
                time = formatTimeToChinnese(manualTime);
            } else {
                const timeMatch = quoteData.match(/ç½®æ”¾æ™‚é–“ï¼š(\d{2}ï¼š\d{2})/);
                if (timeMatch) {
                    const timeStr = timeMatch[1].replace('ï¼š', '');
                    time = formatTimeToChinnese(timeStr);
                } else {
                    time = 'ä¸Šåˆ';
                }
            }
            
            // æå–åƒåœ¾é‡ - å¢å¼·ç‰ˆåµæ¸¬
            let trashMatchFound = false;
            const trashPatterns = [
                /1é€±åƒåœ¾ï¼š(\d+)åŒ…æ•¸.*?\((\d+å…¬å‡)\)/,
                /åƒåœ¾.*?(\d+)åŒ….*?(\d+å…¬å‡)/,
                /1é€±åƒåœ¾.*?(\d+).*?(\d+å…¬å‡)/,
                /é€±åƒåœ¾ï¼š(\d+)åŒ…æ•¸.*?\((\d+å…¬å‡)\)/,
                /åƒåœ¾åŒ…æ•¸ï¼š(\d+).*?(\d+å…¬å‡)/
            ];
            
            for (const pattern of trashPatterns) {
                const match = quoteData.match(pattern);
                if (match) {
                    trashAmount = `${match[1]}åŒ…ï¼ˆ${match[2]}å…¬å‡ï¼‰`;
                    trashMatchFound = true;
                    break;
                }
            }
            
            // æå–è³‡æºé‡ - å¢å¼·ç‰ˆåµæ¸¬
            let recycleMatchFound = false;
            const recyclePatterns = [
                /1é€±è³‡æº:(\d+)åŒ…æ•¸.*?\((\d+å…¬å‡)\)/,
                /1é€±è³‡æºï¼š(\d+)åŒ…æ•¸.*?\((\d+å…¬å‡)\)/,
                /è³‡æº.*?(\d+)åŒ….*?(\d+å…¬å‡)/,
                /1é€±è³‡æº.*?(\d+).*?(\d+å…¬å‡)/,
                /é€±è³‡æºï¼š(\d+)åŒ…æ•¸.*?\((\d+å…¬å‡)\)/,
                /è³‡æºåŒ…æ•¸ï¼š(\d+).*?(\d+å…¬å‡)/
            ];
            
            for (const pattern of recyclePatterns) {
                const match = quoteData.match(pattern);
                if (match) {
                    recycleAmount = `${match[1]}åŒ…ï¼ˆ${match[2]}å…¬å‡ï¼‰`;
                    recycleMatchFound = true;
                    break;
                }
            }
            
            // å¦‚æœæ²’æœ‰æ‰¾åˆ°å®Œæ•´çš„åŒ…æ•¸å’Œå®¹é‡ï¼Œå˜—è©¦åªæ‰¾åŒ…æ•¸
            if (!trashMatchFound) {
                const trashSimplePatterns = [
                    /åƒåœ¾.*?(\d+)åŒ…/,
                    /1é€±åƒåœ¾.*?(\d+)/,
                    /åƒåœ¾åŒ…æ•¸ï¼š(\d+)/
                ];
                for (const pattern of trashSimplePatterns) {
                    const match = quoteData.match(pattern);
                    if (match) {
                        trashAmount = `${match[1]}åŒ…`;
                        break;
                    }
                }
            }
            
            if (!recycleMatchFound) {
                const recycleSimplePatterns = [
                    /è³‡æº.*?(\d+)åŒ…/,
                    /1é€±è³‡æº.*?(\d+)/,
                    /è³‡æºåŒ…æ•¸ï¼š(\d+)/
                ];
                for (const pattern of recycleSimplePatterns) {
                    const match = quoteData.match(pattern);
                    if (match) {
                        recycleAmount = `${match[1]}åŒ…`;
                        break;
                    }
                }
            }
            
            const dateObj = new Date(date);
            const weekDaysArray = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const weekDay = weekDaysArray[dateObj.getDay()];
            const formattedDate = `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
            const dateWithWeekday = `${formattedDate} é€±${weekDay}`;
            
            const generalTask = `ğŸ§‘â€ğŸš€åŒ…æœˆä»»å‹™ğŸ§‘â€ğŸš€

â¡ï¸æ—¥æœŸï¼š${dateWithWeekday}
â¡ï¸æ˜ŸæœŸï¼š${weekDays}
â¡ï¸æ™‚é–“ï¼š${time}
â¡ï¸åœ°å€ï¼š${extractedAddress}
â¡ï¸ä¸Šæ¨“ï¼š${upstairs === 'éœ€ä¸Šæ¨“' ? 'æ˜¯' : 'å¦'}
â¡ï¸é‘°åŒ™ï¼š${key}
â¡ï¸è²»ç”¨ï¼š${fee}
â¡ï¸å®¢æˆ¶è‡ªå‚™å°ˆç”¨è¢‹ï¼š${bag}
â¡ï¸1é€±åƒåœ¾é‡ï¼š${trashAmount}
ï¼ˆ1-${trashPickup}ï¼‰
â¡ï¸1é€±è³‡æºé‡ï¼š${recycleAmount}
ï¼ˆ1-${recyclePickup}ï¼‰
â¡ï¸å§“åï¼š${extractedName}
â¡ï¸é›»è©±ï¼š${extractedPhone}
â¡ï¸å…¶ä»–ï¼š
1.è‹¥æœ‰é‘°åŒ™ç´¢å–è«‹å›å ±
2.7å¤©å…§è¤‡è£½æ­¸é‚„åŸé‘°
3.å¦æœ‰è¦å®šæ™‚é–“è€…é™¤å¤–
4.é‘°åŒ™é€šå¸¸ç²˜ç½®ä¿¡ç®±

ğŸ“›å·²æ–°å¢æ—¥æ›†ğŸ“›
ğŸ“›å‹™å¿…è«‹éç›®ğŸ“›
ğŸ“›æœ‰å•é¡Œæå‡ºğŸ“›`;

            const limitedTask = `ğŸ§‘â€ğŸš€åŒ…æœˆä»»å‹™ğŸ§‘â€ğŸš€

â¡ï¸æ—¥æœŸï¼š${dateWithWeekday}
â¡ï¸æ˜ŸæœŸï¼š${weekDays}
â¡ï¸æ™‚é–“ï¼š${time}
â¡ï¸åœ°å€ï¼š${extractedAddress}
â¡ï¸ä¸Šæ¨“ï¼š${upstairs === 'éœ€ä¸Šæ¨“' ? 'æ˜¯' : 'å¦'}
â¡ï¸é‘°åŒ™ï¼š${key}
â¡ï¸è²»ç”¨ï¼š${fee}
â¡ï¸å®¢æˆ¶è‡ªå‚™å°ˆç”¨è¢‹ï¼š${bag}
â¡ï¸1é€±åƒåœ¾é‡ï¼š${trashAmount}
ï¼ˆ1-${trashPickup}ï¼‰
â¡ï¸1é€±è³‡æºé‡ï¼š${recycleAmount}
ï¼ˆ1-${recyclePickup}ï¼‰
â¡ï¸å§“åï¼š${extractedName}
â¡ï¸é›»è©±ï¼š${extractedPhone}
â¡ï¸åŸºæœ¬æœå‹™ï¼š
1.è¶…é‡ä¸€å¾‹æ”¶èµ°
2.ç¾å ´æ¸…ç©º
3.æ­£ç¢ºå›å ±

â¡ï¸å…¶ä»–ï¼š
1.è‹¥æœ‰é‘°åŒ™ç´¢å–è«‹å›å ±
2.7å¤©å…§è¤‡è£½æ­¸é‚„åŸé‘°
3.å¦æœ‰è¦å®šæ™‚é–“è€…é™¤å¤–
4.é‘°åŒ™é€šå¸¸ç²˜ç½®ä¿¡ç®±

ğŸ“›å·²æ–°å¢æ—¥æ›†ğŸ“›
ğŸ“›å‹™å¿…è«‹éç›®ğŸ“›
ğŸ“›æœ‰å•é¡Œæå‡ºğŸ“›`;

            document.getElementById('monthly-general').textContent = generalTask;
            document.getElementById('monthly-limited').textContent = limitedTask;
            document.getElementById('monthly-output').style.display = 'block';
            showStatus('monthly-status', 'âœ… åŒ…æœˆä»»å‹™å–®è½‰æ›å®Œæˆï¼', 'success');
        }



        // Single task generation function
        function generateSingleTask() {
            const date = document.getElementById('single-date').value;
            const time = document.getElementById('single-time').value;
            const phone = document.getElementById('single-phone').value;
            const name = document.getElementById('single-name').value;
            const address = document.getElementById('single-address').value;
            const floor = document.getElementById('single-floor').value;
            const wasteType = document.getElementById('single-waste-type').value;

            const fee = document.getElementById('single-fee').value;
            const customerBag = document.getElementById('single-customer-bag').value;
            const otherNotes1 = document.getElementById('single-other1').value;
            const otherNotes2 = document.getElementById('single-other2').value;
            const otherNotes3 = document.getElementById('single-other3').value;
            
            if (!date) {
                showStatus('single-status', 'è«‹å¡«å¯«åŸ·è¡Œæ—¥æœŸ', 'error');
                return;
            }
            
            const dateObj = new Date(date);
            const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const weekDay = weekDays[dateObj.getDay()];
            const formattedDate = `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
            const dateWithWeekday = `${formattedDate} é€±${weekDay}`;
            
            // æ ¼å¼åŒ–æ™‚é–“ - æ”¯æ´æ™‚é–“å€é–“
            let formattedTime = time || 'ä¸Šåˆ';
            if (time) {
                // æª¢æŸ¥æ˜¯å¦ç‚ºæ™‚é–“å€é–“æ ¼å¼ (å¦‚ 1500-1630)
                const timeRangeMatch = time.match(/(\d{4})-(\d{4})/);
                if (timeRangeMatch) {
                    const startTime = timeRangeMatch[1];
                    const endTime = timeRangeMatch[2];
                    
                    // æ ¼å¼åŒ–é–‹å§‹æ™‚é–“
                    const startHour = parseInt(startTime.substring(0, 2));
                    const startMinute = startTime.substring(2);
                    let startPeriod = startHour < 12 ? 'ä¸Šåˆ' : (startHour < 18 ? 'ä¸‹åˆ' : 'æ™šé–“');
                    
                    // æ ¼å¼åŒ–çµæŸæ™‚é–“
                    const endHour = parseInt(endTime.substring(0, 2));
                    const endMinute = endTime.substring(2);
                    
                    formattedTime = `${startPeriod} ${startHour.toString().padStart(2, '0')}ï¼š${startMinute}-${endHour.toString().padStart(2, '0')}ï¼š${endMinute}`;
                } else if (time.match(/^\d{4}$/)) {
                    // è™•ç†å››ä½æ•¸æ™‚é–“æ ¼å¼ (å¦‚ 1300)
                    const hour = parseInt(time.substring(0, 2));
                    const minute = time.substring(2);
                    let period = hour < 12 ? 'ä¸Šåˆ' : (hour < 18 ? 'ä¸‹åˆ' : 'æ™šé–“');
                    formattedTime = `${period} ${hour.toString().padStart(2, '0')}ï¼š${minute}`;
                } else if (time.includes(':')) {
                    // åŸæœ‰çš„å–®ä¸€æ™‚é–“æ ¼å¼è™•ç†
                    const [hour, minute] = time.split(':');
                    const hourInt = parseInt(hour);
                    if (hourInt < 12) {
                        formattedTime = `ä¸Šåˆ ${hour}ï¼š${minute}`;
                    } else if (hourInt < 18) {
                        formattedTime = `ä¸‹åˆ ${hour}ï¼š${minute}`;
                    } else {
                        formattedTime = `æ™šé–“ ${hour}ï¼š${minute}`;
                    }
                } else {
                    // å…¶ä»–æ ¼å¼ç›´æ¥é¡¯ç¤º
                    formattedTime = time;
                }
            }
            
            // æ±ºå®šåƒåœ¾è³‡æºé‡æ–‡å­—
            const wasteAmount = 'å¦‚åœ–';
            
            // æ§‹å»ºå…¶ä»–èªªæ˜å…§å®¹
            let otherDetails = '';
            let itemNumber = 4;
            if (otherNotes1) {
                otherDetails += `${itemNumber}.${otherNotes1}\n`;
                itemNumber++;
            }
            if (otherNotes2) {
                otherDetails += `${itemNumber}.${otherNotes2}\n`;
                itemNumber++;
            }
            if (otherNotes3) {
                otherDetails += `${itemNumber}.${otherNotes3}`;
            }

            const singleTask = `ğŸ§‘â€ğŸš€å–®è¶Ÿä»»å‹™ğŸ§‘â€ğŸš€

â¡ï¸æ—¥æœŸï¼š${dateWithWeekday}
â¡ï¸æ™‚é–“ï¼š${formattedTime}
â¡ï¸é›»è©±ï¼š${phone}
â¡ï¸å§“åï¼š${name}
â¡ï¸åœ°å€ï¼š${address}
â¡ï¸æ¨“å±¤ï¼š${floor}
â¡ï¸å®¢æˆ¶è‡ªå‚™å°ˆç”¨è¢‹ï¼š${customerBag}
â¡ï¸è²»ç”¨ï¼š${fee}
â¡ï¸åƒåœ¾è³‡æºé‡ï¼š${wasteAmount}
â¡ï¸ç¾æ³ç…§ç‰‡ï¼š
â¡ï¸å…¶ä»–ï¼š
1.å›å ±ï¼š
ï¼ˆ1ï¼‰å–®è¶Ÿï¼šXX+è·¯æ®µ/è¡—
2.å°‘é‡è¶…é‡ä¸€å¾‹æ¸…èµ°
3.ç…§ç‰‡æ‹å®Œå–„
${otherDetails}

ğŸ”¥å·²æ–°å¢æ—¥æ›†ğŸ”¥
ğŸ”¥å‹™å¿…è«‹éç›®ğŸ”¥
ğŸ”¥æœ‰å•é¡Œæå‡ºğŸ”¥`;

            document.getElementById('single-result').textContent = singleTask;
            document.getElementById('single-output').style.display = 'block';
            showStatus('single-status', 'âœ… å–®è¶Ÿä»»å‹™å–®è½‰æ›å®Œæˆï¼', 'success');
        }



        // Clean task generation function
        function generateCleanTask() {
            const date = document.getElementById('clean-date').value;
            const time = document.getElementById('clean-time').value;
            const phone = document.getElementById('clean-phone').value;
            const name = document.getElementById('clean-name').value;
            const address = document.getElementById('clean-address').value;
            const floor = document.getElementById('clean-floor').value;
            const wasteType = document.getElementById('clean-waste-type').value;
            const fee = document.getElementById('clean-fee').value;
            const otherNotes1 = document.getElementById('clean-other1').value;
            const otherNotes2 = document.getElementById('clean-other2').value;
            const otherNotes3 = document.getElementById('clean-other3').value;
            
            if (!date) {
                showStatus('clean-status', 'è«‹å¡«å¯«æ¸…æ½”æ—¥æœŸ', 'error');
                return;
            }
            
            // æ”¶é›†æ¸…æ½”ç¯„åœ
            const cleaningScope = [];
            for (let i = 1; i <= 10; i++) {
                const scopeItem = document.getElementById(`clean-scope-${i}`).value.trim();
                if (scopeItem) {
                    cleaningScope.push(`${i}.${scopeItem}`);
                }
            }
            
            const dateObj = new Date(date);
            const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const weekDay = weekDays[dateObj.getDay()];
            const formattedDate = `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
            const dateWithWeekday = `${formattedDate} é€±${weekDay}`;
            
            // æ ¼å¼åŒ–æ™‚é–“
            let formattedTime = time || 'ä¸Šåˆ';
            if (time && time.includes(':')) {
                const [hour, minute] = time.split(':');
                const hourInt = parseInt(hour);
                if (hourInt < 12) {
                    formattedTime = `ä¸Šåˆ ${hour}ï¼š${minute}`;
                } else if (hourInt < 18) {
                    formattedTime = `ä¸‹åˆ ${hour}ï¼š${minute}`;
                } else {
                    formattedTime = `æ™šé–“ ${hour}ï¼š${minute}`;
                }
            }
            
            // ç”Ÿæˆæ¸…æ½”ç¯„åœæ–‡å­—
            const scopeText = cleaningScope.length > 0 ? cleaningScope.join('\n') : 'å¾…ç¾å ´ç¢ºèª';
            
            // æ§‹å»ºå…¶ä»–èªªæ˜å…§å®¹
            let otherDetails = '';
            let itemNumber = 5;
            if (otherNotes1) {
                otherDetails += `${itemNumber}.${otherNotes1}\n`;
                itemNumber++;
            }
            if (otherNotes2) {
                otherDetails += `${itemNumber}.${otherNotes2}\n`;
                itemNumber++;
            }
            if (otherNotes3) {
                otherDetails += `${itemNumber}.${otherNotes3}`;
            }
            
            const cleanTask = `ğŸ§‘â€ğŸš€æ¸…æ½”ä»»å‹™ğŸ§‘â€ğŸš€

â¡ï¸æ—¥æœŸï¼š${dateWithWeekday}
â¡ï¸é›»è©±ï¼š${phone}
â¡ï¸å§“åï¼š${name}
â¡ï¸åœ°å€ï¼š${address}
â¡ï¸ä¸Šæ¨“ï¼š${floor.includes('F') && !floor.includes('1F') ? 'æœ‰' : 'ç„¡'}
â¡ï¸è²»ç”¨ï¼š${fee}
â¡ï¸æ¸…æ½”ç¯„åœï¼š
${scopeText}
â¡ï¸ç¾æ³ç…§ç‰‡ï¼šå¦‚åœ–
â¡ï¸å…¶ä»–ï¼š
1.å›å ±ï¼š
ï¼ˆ1ï¼‰å–®è¶Ÿï¼šXX+è·¯æ®µ/è¡—
2.ç¾å ´æ¸…æ½”å¾ŒåŠå°‘é‡åƒåœ¾
   ä¸€å¾‹å¸¶èµ°æ¸…ç©º
3.ç…§ç‰‡æ‹å®Œå–„
4.æ¸…æ½”ç…§ç‰‡åƒ…æ‹å®Œæˆå¾Œç…§ç‰‡å³å¯
${otherDetails}

ğŸ”¥å·²æ–°å¢æ—¥æ›†ğŸ”¥
ğŸ”¥å‹™å¿…è«‹éç›®ğŸ”¥
ğŸ”¥æœ‰å•é¡Œæå‡ºğŸ”¥`;

            document.getElementById('clean-result').textContent = cleanTask;
            document.getElementById('clean-output').style.display = 'block';
            showStatus('clean-status', 'âœ… æ¸…æ½”ä»»å‹™å–®è½‰æ›å®Œæˆï¼', 'success');
        }

        // Copy to clipboard function
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(function() {
                    const statusId = elementId.includes('quote') ? 'quote-status' : 
                                   elementId.includes('monthly') ? 'monthly-status' :
                                   elementId.includes('single') ? 'single-status' : 'clean-status';
                    showStatus(statusId, 'âœ… å…§å®¹å·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'success');
                }, function(err) {
                    showStatus(statusId, 'âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–æ–‡å­—è¤‡è£½', 'error');
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    const statusId = elementId.includes('quote') ? 'quote-status' : 
                                   elementId.includes('monthly') ? 'monthly-status' :
                                   elementId.includes('single') ? 'single-status' : 'clean-status';
                    showStatus(statusId, 'âœ… å…§å®¹å·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'success');
                } catch (err) {
                    showStatus(statusId, 'âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–æ–‡å­—è¤‡è£½', 'error');
                }
                document.body.removeChild(textArea);
            }
        }

        // Show status message
        function showStatus(elementId, message, type) {
            const statusElement = document.getElementById(elementId);
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            
            setTimeout(() => {
                statusElement.textContent = '';
                statusElement.className = 'status';
            }, 4000);
        }

        // Clear form functions
        function clearQuoteForm() {
            // Reset form fields to default values
            document.getElementById('service-time').value = '0800';
            document.getElementById('floor-level').value = '1';
            document.getElementById('monthly-fee').value = '1200';
            document.getElementById('trash-bags').value = '6';
            document.getElementById('trash-volume').value = '14å…¬å‡';
            document.getElementById('recycle-bags').value = '3';
            document.getElementById('recycle-volume').value = '14å…¬å‡';
            document.getElementById('trash-max').value = '3';
            document.getElementById('recycle-max').value = '3';
            document.getElementById('special-notes').value = '';
            
            // Clear and reset checkboxes to default (é€±äºŒ and é€±äº”)
            const checkboxes = document.querySelectorAll('input[name="service-days"]');
            checkboxes.forEach(cb => cb.checked = false);
            document.querySelector('input[name="service-days"][value="é€±äºŒ"]').checked = true;
            document.querySelector('input[name="service-days"][value="é€±äº”"]').checked = true;
            
            // Hide output
            document.getElementById('quote-output').style.display = 'none';
            document.getElementById('quote-status').textContent = '';
            
            // Show confirmation message
            showStatus('quote-status', 'âœ… è¡¨å–®å·²æ¸…ç©ºé‡ç½®ï¼', 'success');
        }

        function clearMonthlyForm() {
            document.getElementById('monthly-quote-data').value = '';
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('monthly-date').value = today;
            document.getElementById('monthly-percentage').value = '50';
            document.getElementById('monthly-upstairs').value = 'ä¸éœ€ä¸Šæ¨“';
            document.getElementById('monthly-address').value = '';
            document.getElementById('monthly-phone').value = '';
            document.getElementById('monthly-name').value = '';
            document.getElementById('monthly-trash-pickup').value = '3';
            document.getElementById('monthly-recycle-pickup').value = '3';
            document.getElementById('monthly-key').value = 'ç„¡';
            document.getElementById('monthly-time').value = '';
            document.getElementById('monthly-bag').value = 'æœ‰';
            
            // Hide output
            document.getElementById('monthly-output').style.display = 'none';
            document.getElementById('monthly-status').textContent = '';
        }

        function clearSingleForm() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('single-date').value = today;
            document.getElementById('single-time').value = '';
            document.getElementById('single-phone').value = '';
            document.getElementById('single-name').value = '';
            document.getElementById('single-address').value = '';
            document.getElementById('single-floor').value = '';
            document.getElementById('single-customer-bag').value = 'ç„¡';
            document.getElementById('single-waste-type').value = 'å¦‚åœ–';
            document.getElementById('single-fee').value = '';
            document.getElementById('single-other1').value = '';
            document.getElementById('single-other2').value = '';
            document.getElementById('single-other3').value = '';
            
            // Clear images using the new clear function
            clearSingleImages();
            
            // Hide output
            document.getElementById('single-output').style.display = 'none';
            document.getElementById('single-status').textContent = '';
            
            // Show confirmation message
            showStatus('single-status', 'âœ… è¡¨å–®å·²æ¸…ç©ºé‡ç½®ï¼', 'success');
        }

        function clearCleanForm() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('clean-date').value = today;
            document.getElementById('clean-time').value = '';
            document.getElementById('clean-phone').value = '';
            document.getElementById('clean-name').value = '';
            document.getElementById('clean-address').value = '';
            document.getElementById('clean-floor').value = '';
            document.getElementById('clean-waste-type').value = 'å¦‚åœ–';
            document.getElementById('clean-fee').value = '';
            document.getElementById('clean-other1').value = '';
            document.getElementById('clean-other2').value = '';
            document.getElementById('clean-other3').value = '';
            
            // Clear cleaning scope inputs
            for (let i = 1; i <= 10; i++) {
                document.getElementById(`clean-scope-${i}`).value = '';
            }
            
            // Clear images using the new clear function
            clearCleanImages();
            
            // Hide output
            document.getElementById('clean-output').style.display = 'none';
            document.getElementById('clean-status').textContent = '';
        }

        // Set today's date as default for date inputs
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('monthly-date').value = today;
            document.getElementById('single-date').value = today;
            document.getElementById('clean-date').value = today;
            
            // Initialize drag and drop for single trip and clean photos
            initializeSingleImageUpload();
            initializeCleanImageUpload();
        });

        // Single trip image upload functions
        let singleImages = [];

        function initializeSingleImageUpload() {
            const dropZone = document.getElementById('single-drop-zone');
            const fileInput = document.getElementById('single-images');

            if (!dropZone || !fileInput) return;

            // Drag and drop events
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', (e) => {
                // Only remove dragover if we're actually leaving the drop zone
                if (!dropZone.contains(e.relatedTarget)) {
                    dropZone.classList.remove('dragover');
                }
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleSingleImageFiles(files);
            });

            // File input change event
            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                handleSingleImageFiles(files);
            });
        }

        function handleSingleImageFiles(files) {
            // Filter for image files only
            const imageFiles = files.filter(file => file.type.startsWith('image/'));
            
            if (imageFiles.length === 0) {
                showStatus('single-status', 'âŒ è«‹é¸æ“‡æœ‰æ•ˆçš„åœ–ç‰‡æª”æ¡ˆ (PNG, JPG, JPEG)', 'error');
                return;
            }

            // Add new images to collection
            imageFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageData = {
                        file: file,
                        dataUrl: e.target.result,
                        id: Date.now() + Math.random()
                    };
                    singleImages.push(imageData);
                    updateSingleImagePreview();
                };
                reader.readAsDataURL(file);
            });

            showStatus('single-status', `âœ… å·²æ·»åŠ  ${imageFiles.length} å¼µç…§ç‰‡`, 'success');
        }

        function updateSingleImagePreview() {
            const previewContainer = document.getElementById('single-image-preview');
            const mergeControls = document.getElementById('single-merge-controls');
            
            if (singleImages.length === 0) {
                previewContainer.innerHTML = '';
                mergeControls.style.display = 'none';
                return;
            }

            // Show merge controls
            mergeControls.style.display = 'flex';
            
            // Create compact preview HTML for inline layout
            let previewHTML = '<div style="margin-bottom: 8px; font-size: 14px; color: #ccc;"><strong>å·²ä¸Šå‚³ (' + singleImages.length + 'å¼µ)</strong></div>';
            previewHTML += '<div style="display: flex; flex-wrap: wrap; gap: 5px;">';
            
            // Show only first 6 images in preview, indicate more if needed
            const displayCount = Math.min(6, singleImages.length);
            
            for (let i = 0; i < displayCount; i++) {
                const image = singleImages[i];
                previewHTML += `
                    <div class="photo-preview-inline" style="position: relative; display: inline-block;">
                        <img src="${image.dataUrl}" alt="Photo ${i + 1}" style="width: 60px; height: 45px; object-fit: cover; border-radius: 3px; border: 1px solid #444;">
                        <button class="photo-remove-inline" onclick="removeSingleImage(${image.id})" title="åˆªé™¤ç…§ç‰‡" style="position: absolute; top: -5px; right: -5px; background: rgba(231, 76, 60, 0.9); color: white; border: none; border-radius: 50%; width: 16px; height: 16px; cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center;">Ã—</button>
                    </div>
                `;
            }
            
            if (singleImages.length > 6) {
                previewHTML += `<div style="color: #888; font-size: 12px; align-self: center;">+${singleImages.length - 6}å¼µ</div>`;
            }
            
            previewHTML += '</div>';
            previewContainer.innerHTML = previewHTML;
        }

        function removeSingleImage(imageId) {
            singleImages = singleImages.filter(img => img.id !== imageId);
            updateSingleImagePreview();
            
            if (singleImages.length === 0) {
                document.getElementById('single-merged-preview').innerHTML = '';
                showStatus('single-status', 'âœ… æ‰€æœ‰ç…§ç‰‡å·²æ¸…é™¤', 'success');
            }
        }

        function clearSingleImages() {
            singleImages = [];
            document.getElementById('single-images').value = '';
            document.getElementById('single-image-preview').innerHTML = '';
            document.getElementById('single-merged-preview').innerHTML = '';
            document.getElementById('single-merge-controls').style.display = 'none';
            showStatus('single-status', 'âœ… æ‰€æœ‰ç…§ç‰‡å·²æ¸…é™¤', 'success');
        }

        function mergeSingleImages() {
            if (singleImages.length === 0) {
                showStatus('single-status', 'âŒ è«‹å…ˆä¸Šå‚³ç…§ç‰‡', 'error');
                return;
            }

            showStatus('single-status', 'ğŸ”„ æ­£åœ¨åˆä½µç…§ç‰‡...', 'success');

            // Create canvas for merging
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Load all images and merge
            Promise.all(singleImages.map(imageData => {
                return new Promise(resolve => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.src = imageData.dataUrl;
                });
            })).then(images => {
                // Smart grid layout based on image count
                let imagesPerRow, rows;
                if (images.length === 1) {
                    imagesPerRow = 1;
                    rows = 1;
                } else if (images.length === 2) {
                    imagesPerRow = 2;
                    rows = 1;
                } else if (images.length === 3) {
                    imagesPerRow = 3;
                    rows = 1;
                } else if (images.length === 4) {
                    imagesPerRow = 2;
                    rows = 2;
                } else if (images.length <= 6) {
                    imagesPerRow = 3;
                    rows = 2;
                } else if (images.length <= 9) {
                    imagesPerRow = 3;
                    rows = 3;
                } else {
                    imagesPerRow = 4;
                    rows = Math.ceil(images.length / 4);
                }
                
                const imageSize = Math.floor(600 / Math.max(imagesPerRow, rows));
                const totalWidth = imagesPerRow * imageSize;
                const totalHeight = rows * imageSize;
                
                // Optimize canvas size to reduce white space
                const actualWidth = totalWidth + 40;
                const actualHeight = totalHeight + 40;
                canvas.width = actualWidth;
                canvas.height = actualHeight;
                const finalMarginX = 20;
                const finalMarginY = 20;
                
                // Fill background
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw images in smart grid
                images.forEach((img, index) => {
                    const col = index % imagesPerRow;
                    const row = Math.floor(index / imagesPerRow);
                    const x = finalMarginX + col * imageSize;
                    const y = finalMarginY + row * imageSize;
                    
                    // Draw image as square (crop to fit)
                    const aspectRatio = img.width / img.height;
                    let sourceX = 0, sourceY = 0, sourceSize;
                    
                    if (aspectRatio > 1) {
                        // å¯¬åœ–ç‰‡ï¼Œè£åˆ‡å·¦å³
                        sourceSize = img.height;
                        sourceX = (img.width - sourceSize) / 2;
                    } else {
                        // é«˜åœ–ç‰‡ï¼Œè£åˆ‡ä¸Šä¸‹
                        sourceSize = img.width;
                        sourceY = (img.height - sourceSize) / 2;
                    }
                    
                    ctx.drawImage(img, sourceX, sourceY, sourceSize, sourceSize, x, y, imageSize, imageSize);
                    
                    // Draw red grid lines
                    ctx.strokeStyle = '#FF0000';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y, imageSize, imageSize);
                });
                
                // Add watermark "è¯é›„èªè­‰" with date/time from bottom-left to top-right
                const now = new Date();
                const dateStr = now.getFullYear() + '/' + 
                              String(now.getMonth() + 1).padStart(2, '0') + '/' + 
                              String(now.getDate()).padStart(2, '0');
                const timeStr = String(now.getHours()).padStart(2, '0') + ':' + 
                              String(now.getMinutes()).padStart(2, '0') + ':' + 
                              String(now.getSeconds()).padStart(2, '0');
                const watermarkText = `è¯é›„èªè­‰ ${dateStr} ${timeStr}`;
                
                ctx.save();
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate(-Math.PI / 4); // -45 degrees (left-bottom to right-top)
                ctx.font = 'bold 32px Arial, sans-serif';
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.lineWidth = 1;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.strokeText(watermarkText, 0, 0);
                ctx.fillText(watermarkText, 0, 0);
                ctx.restore();
                
                // Display merged image
                const mergedDataUrl = canvas.toDataURL('image/jpeg', 0.9);
                const mergedPreview = document.getElementById('single-merged-preview');
                mergedPreview.innerHTML = `
                    <div class="merged-photo">
                        <div class="merged-photo-content">
                            <div><strong>åˆä½µç…§ç‰‡ï¼š</strong></div>
                            <img src="${mergedDataUrl}" alt="åˆä½µç…§ç‰‡">
                        </div>
                        <div class="merged-photo-controls">
                            <button class="btn-download" onclick="downloadMergedImage('${mergedDataUrl}', 'single')">â†“</button>
                        </div>
                    </div>
                `;
                
                showStatus('single-status', `âœ… å·²æˆåŠŸåˆä½µ ${images.length} å¼µç…§ç‰‡ï¼`, 'success');
            });
        }

        function downloadMergedImage(dataUrl, type) {
            const link = document.createElement('a');
            link.download = `åˆä½µç…§ç‰‡_${type}_${new Date().toISOString().slice(0,10)}.jpg`;
            link.href = dataUrl;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Clean task image upload functions
        let cleanImages = [];

        function initializeCleanImageUpload() {
            const dropZone = document.getElementById('clean-drop-zone');
            const fileInput = document.getElementById('clean-images');

            if (!dropZone || !fileInput) return;

            // Drag and drop events
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', (e) => {
                if (!dropZone.contains(e.relatedTarget)) {
                    dropZone.classList.remove('dragover');
                }
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleCleanImageFiles(files);
            });

            // File input change event
            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                handleCleanImageFiles(files);
            });
        }

        function handleCleanImageFiles(files) {
            const imageFiles = files.filter(file => file.type.startsWith('image/'));
            
            if (imageFiles.length === 0) {
                showStatus('clean-status', 'âŒ è«‹é¸æ“‡æœ‰æ•ˆçš„åœ–ç‰‡æª”æ¡ˆ (PNG, JPG, JPEG)', 'error');
                return;
            }

            imageFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageData = {
                        file: file,
                        dataUrl: e.target.result,
                        id: Date.now() + Math.random()
                    };
                    cleanImages.push(imageData);
                    updateCleanImagePreview();
                };
                reader.readAsDataURL(file);
            });

            showStatus('clean-status', `âœ… å·²æ·»åŠ  ${imageFiles.length} å¼µç…§ç‰‡`, 'success');
        }

        function updateCleanImagePreview() {
            const previewContainer = document.getElementById('clean-image-preview');
            const mergeControls = document.getElementById('clean-merge-controls');
            
            if (cleanImages.length === 0) {
                previewContainer.innerHTML = '';
                mergeControls.style.display = 'none';
                return;
            }

            // Show merge controls
            mergeControls.style.display = 'flex';
            
            // Create compact preview HTML for inline layout
            let previewHTML = '<div style="margin-bottom: 8px; font-size: 14px; color: #ccc;"><strong>å·²ä¸Šå‚³ (' + cleanImages.length + 'å¼µ)</strong></div>';
            previewHTML += '<div style="display: flex; flex-wrap: wrap; gap: 5px;">';
            
            const displayCount = Math.min(6, cleanImages.length);
            
            for (let i = 0; i < displayCount; i++) {
                const image = cleanImages[i];
                previewHTML += `
                    <div class="photo-preview-inline" style="position: relative; display: inline-block;">
                        <img src="${image.dataUrl}" alt="Photo ${i + 1}" style="width: 60px; height: 45px; object-fit: cover; border-radius: 3px; border: 1px solid #444;">
                        <button class="photo-remove-inline" onclick="removeCleanImage(${image.id})" title="åˆªé™¤ç…§ç‰‡" style="position: absolute; top: -5px; right: -5px; background: rgba(231, 76, 60, 0.9); color: white; border: none; border-radius: 50%; width: 16px; height: 16px; cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center;">Ã—</button>
                    </div>
                `;
            }
            
            if (cleanImages.length > 6) {
                previewHTML += `<div style="color: #888; font-size: 12px; align-self: center;">+${cleanImages.length - 6}å¼µ</div>`;
            }
            
            previewHTML += '</div>';
            previewContainer.innerHTML = previewHTML;
        }

        function removeCleanImage(imageId) {
            cleanImages = cleanImages.filter(img => img.id !== imageId);
            updateCleanImagePreview();
            
            if (cleanImages.length === 0) {
                document.getElementById('clean-merged-preview').innerHTML = '';
                showStatus('clean-status', 'âœ… æ‰€æœ‰ç…§ç‰‡å·²æ¸…é™¤', 'success');
            }
        }

        function clearCleanImages() {
            cleanImages = [];
            document.getElementById('clean-images').value = '';
            document.getElementById('clean-image-preview').innerHTML = '';
            document.getElementById('clean-merged-preview').innerHTML = '';
            document.getElementById('clean-merge-controls').style.display = 'none';
            showStatus('clean-status', 'âœ… æ‰€æœ‰ç…§ç‰‡å·²æ¸…é™¤', 'success');
        }

        function mergeCleanImages() {
            if (cleanImages.length === 0) {
                showStatus('clean-status', 'âŒ è«‹å…ˆä¸Šå‚³ç…§ç‰‡', 'error');
                return;
            }

            showStatus('clean-status', 'ğŸ”„ æ­£åœ¨åˆä½µç…§ç‰‡...', 'success');

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            Promise.all(cleanImages.map(imageData => {
                return new Promise(resolve => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.src = imageData.dataUrl;
                });
            })).then(images => {
                // Smart grid layout based on image count
                let imagesPerRow, rows;
                if (images.length === 1) {
                    imagesPerRow = 1;
                    rows = 1;
                } else if (images.length === 2) {
                    imagesPerRow = 2;
                    rows = 1;
                } else if (images.length === 3) {
                    imagesPerRow = 3;
                    rows = 1;
                } else if (images.length === 4) {
                    imagesPerRow = 2;
                    rows = 2;
                } else if (images.length <= 6) {
                    imagesPerRow = 3;
                    rows = 2;
                } else if (images.length <= 9) {
                    imagesPerRow = 3;
                    rows = 3;
                } else {
                    imagesPerRow = 4;
                    rows = Math.ceil(images.length / 4);
                }
                
                const imageSize = Math.floor(600 / Math.max(imagesPerRow, rows));
                const totalWidth = imagesPerRow * imageSize;
                const totalHeight = rows * imageSize;
                
                // Optimize canvas size to reduce white space
                const actualWidth = totalWidth + 40;
                const actualHeight = totalHeight + 40;
                canvas.width = actualWidth;
                canvas.height = actualHeight;
                const finalMarginX = 20;
                const finalMarginY = 20;
                
                // Fill background
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw images in smart grid
                images.forEach((img, index) => {
                    const col = index % imagesPerRow;
                    const row = Math.floor(index / imagesPerRow);
                    const x = finalMarginX + col * imageSize;
                    const y = finalMarginY + row * imageSize;
                    
                    // Draw image as square (crop to fit)
                    const aspectRatio = img.width / img.height;
                    let sourceX = 0, sourceY = 0, sourceSize;
                    
                    if (aspectRatio > 1) {
                        // å¯¬åœ–ç‰‡ï¼Œè£åˆ‡å·¦å³
                        sourceSize = img.height;
                        sourceX = (img.width - sourceSize) / 2;
                    } else {
                        // é«˜åœ–ç‰‡ï¼Œè£åˆ‡ä¸Šä¸‹
                        sourceSize = img.width;
                        sourceY = (img.height - sourceSize) / 2;
                    }
                    
                    ctx.drawImage(img, sourceX, sourceY, sourceSize, sourceSize, x, y, imageSize, imageSize);
                    
                    // Draw red grid lines
                    ctx.strokeStyle = '#FF0000';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y, imageSize, imageSize);
                });
                
                // Add watermark "è¯é›„èªè­‰" with date/time from bottom-left to top-right
                const now = new Date();
                const dateStr = now.getFullYear() + '/' + 
                              String(now.getMonth() + 1).padStart(2, '0') + '/' + 
                              String(now.getDate()).padStart(2, '0');
                const timeStr = String(now.getHours()).padStart(2, '0') + ':' + 
                              String(now.getMinutes()).padStart(2, '0') + ':' + 
                              String(now.getSeconds()).padStart(2, '0');
                const watermarkText = `è¯é›„èªè­‰ ${dateStr} ${timeStr}`;
                
                ctx.save();
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate(-Math.PI / 4); // -45 degrees (left-bottom to right-top)
                ctx.font = 'bold 32px Arial, sans-serif';
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.lineWidth = 1;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.strokeText(watermarkText, 0, 0);
                ctx.fillText(watermarkText, 0, 0);
                ctx.restore();
                
                const mergedDataUrl = canvas.toDataURL('image/jpeg', 0.9);
                const mergedPreview = document.getElementById('clean-merged-preview');
                mergedPreview.innerHTML = `
                    <div class="merged-photo">
                        <div class="merged-photo-content">
                            <div><strong>åˆä½µç…§ç‰‡ï¼š</strong></div>
                            <img src="${mergedDataUrl}" alt="åˆä½µç…§ç‰‡">
                        </div>
                        <div class="merged-photo-controls">
                            <button class="btn-download" onclick="downloadMergedImage('${mergedDataUrl}', 'clean')">â†“</button>
                        </div>
                    </div>
                `;
                
                showStatus('clean-status', `âœ… å·²æˆåŠŸåˆä½µ ${images.length} å¼µç…§ç‰‡ï¼`, 'success');
            });
        }

        // è‡ªå‹•å ±åƒ¹å–®ç›¸é—œå‡½æ•¸
        let autoQuoteData = null;

        function clearAutoQuoteForm() {
            // æ¸…ç©ºGoogleè©¦ç®—è¡¨ç¶²å€
            document.getElementById('sheets-url').value = '';
            document.getElementById('saved-urls').value = '';
            
            // æ¸…ç©ºæ‰‹å‹•è¼¸å…¥æ¬„ä½
            document.getElementById('manual-fee').value = '';
            document.getElementById('manual-time').value = '';
            document.getElementById('manual-floor').value = '';
            document.getElementById('manual-frequency').value = '';
            document.getElementById('manual-trash').value = '';
            document.getElementById('manual-recycle').value = '';
            document.getElementById('manual-trash-volume').value = '';
            document.getElementById('manual-recycle-volume').value = '';
            document.getElementById('manual-trash-max').value = '';
            document.getElementById('manual-recycle-max').value = '';
            document.getElementById('manual-special-notes').value = '';
            
            // æ¸…ç©ºè¤‡é¸æ¡†
            document.querySelectorAll('input[name="manual-days"]').forEach(cb => cb.checked = false);
            
            // éš±è—è¼¸å‡ºå€åŸŸ
            document.getElementById('auto-detected-data').style.display = 'none';
            document.getElementById('auto-quote-controls').style.display = 'none';
            document.getElementById('auto-quote-output').style.display = 'none';
            document.getElementById('auto-sheets-status').style.display = 'none';
            document.getElementById('auto-quote-final-status').style.display = 'none';
            
            // æ¸…ç©ºæ•¸æ“š
            autoQuoteData = null;
        }

        async function fetchGoogleSheetsData() {
            const sheetsUrl = document.getElementById('sheets-url').value.trim();
            
            if (!sheetsUrl) {
                showStatus('auto-sheets-status', 'âŒ è«‹è¼¸å…¥Googleè©¦ç®—è¡¨ç¶²å€', 'error');
                return;
            }

            if (!sheetsUrl.includes('docs.google.com/spreadsheets')) {
                showStatus('auto-sheets-status', 'âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„Googleè©¦ç®—è¡¨é€£çµ', 'error');
                return;
            }

            showStatus('auto-sheets-status', 'ğŸ”„ æ­£åœ¨è¼‰å…¥è©¦ç®—è¡¨è³‡æ–™...', 'success');

            try {
                // å¾URLä¸­æå–è©¦ç®—è¡¨ID
                let spreadsheetId = '';
                const urlMatch = sheetsUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                if (urlMatch) {
                    spreadsheetId = urlMatch[1];
                } else {
                    throw new Error('ç„¡æ³•è§£æè©¦ç®—è¡¨IDï¼Œè«‹ç¢ºèªURLæ ¼å¼æ­£ç¢º');
                }

                // æ§‹å»ºCSVå°å‡ºURL - æ›´ç©©å®šçš„æ–¹å¼
                const csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv`;
                
                console.log('æ­£åœ¨å˜—è©¦è¼‰å…¥:', csvUrl);

                // ä½¿ç”¨ä»£ç†æ–¹å¼é¿å…CORSå•é¡Œ
                const proxyUrl = `https://cors-anywhere.herokuapp.com/${csvUrl}`;
                let response;
                
                try {
                    // é¦–å…ˆå˜—è©¦ç›´æ¥è¨ªå•
                    response = await fetch(csvUrl, {
                        mode: 'cors',
                        headers: {
                            'Accept': 'text/csv,text/plain'
                        }
                    });
                } catch (corsError) {
                    console.log('ç›´æ¥è¨ªå•å¤±æ•—ï¼Œå˜—è©¦ä»£ç†æ–¹å¼:', corsError);
                    // å¦‚æœCORSå¤±æ•—ï¼Œé¡¯ç¤ºèªªæ˜
                    throw new Error('ç”±æ–¼ç€è¦½å™¨å®‰å…¨é™åˆ¶ï¼Œç„¡æ³•ç›´æ¥è®€å–Googleè©¦ç®—è¡¨ã€‚è«‹ç¢ºèªï¼š\n1. è©¦ç®—è¡¨å·²è¨­ç‚ºã€ŒçŸ¥é“é€£çµçš„ä½¿ç”¨è€…ã€å¯æª¢è¦–\n2. æˆ–æ‰‹å‹•è¤‡è£½è²¼ä¸Šè³‡æ–™åˆ°ä¸‹æ–¹');
                }

                if (!response.ok) {
                    if (response.status === 403) {
                        throw new Error('ç„¡æ³•å­˜å–è©¦ç®—è¡¨ï¼Œè«‹ç¢ºèªåˆ†äº«è¨­å®šç‚ºã€ŒçŸ¥é“é€£çµçš„ä½¿ç”¨è€…ã€å¯æª¢è¦–');
                    } else if (response.status === 404) {
                        throw new Error('æ‰¾ä¸åˆ°è©¦ç®—è¡¨ï¼Œè«‹ç¢ºèªç¶²å€æ­£ç¢º');
                    } else {
                        throw new Error(`è¼‰å…¥å¤±æ•— (éŒ¯èª¤ä»£ç¢¼: ${response.status})`);
                    }
                }

                const csvText = await response.text();
                console.log('CSVè³‡æ–™:', csvText.substring(0, 200) + '...');
                
                if (!csvText || csvText.trim().length === 0) {
                    throw new Error('è©¦ç®—è¡¨è³‡æ–™ç‚ºç©ºï¼Œè«‹ç¢ºèªè¡¨æ ¼ä¸­æœ‰è³‡æ–™');
                }

                // æ”¹é€²çš„CSVè§£æ
                const rows = parseCSV(csvText);
                const filteredRows = rows.filter(row => row.some(cell => cell && cell.length > 0));
                
                if (filteredRows.length === 0) {
                    throw new Error('è©¦ç®—è¡¨ä¸­æ²’æœ‰æ‰¾åˆ°ä»»ä½•æœ‰æ•ˆè³‡æ–™');
                }

                const startRow = Math.max(0, parseInt(document.getElementById('start-row').value) - 1);
                const updateMode = document.getElementById('update-mode').value;
                
                let dataRows;
                if (updateMode === 'latest') {
                    dataRows = filteredRows.slice(-1);
                } else if (updateMode === 'last-5') {
                    dataRows = filteredRows.slice(-5);
                } else {
                    dataRows = filteredRows.slice(startRow);
                }

                autoQuoteData = {
                    headers: filteredRows[0] || [],
                    rows: dataRows
                };

                displayDetectedData(autoQuoteData);
                showStatus('auto-sheets-status', `âœ… æˆåŠŸè¼‰å…¥ ${dataRows.length} ç­†è³‡æ–™`, 'success');

            } catch (error) {
                console.error('è¼‰å…¥è©¦ç®—è¡¨å¤±æ•—:', error);
                showStatus('auto-sheets-status', `âŒ ${error.message}`, 'error');
                
                // é¡¯ç¤ºæ‰‹å‹•è¼¸å…¥é¸é …
                showManualDataInput();
            }
        }

        // æ”¹é€²çš„CSVè§£æå‡½æ•¸
        function parseCSV(csvText) {
            const rows = [];
            const lines = csvText.split('\n');
            
            for (let line of lines) {
                if (!line.trim()) continue;
                
                const row = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        row.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                row.push(current.trim());
                rows.push(row);
            }
            
            return rows;
        }

        // é¡¯ç¤ºæ‰‹å‹•è³‡æ–™è¼¸å…¥é¸é …
        function showManualDataInput() {
            const detectedDataDiv = document.getElementById('auto-detected-data');
            detectedDataDiv.style.display = 'block';
            
            const preview = document.getElementById('detected-data-preview');
            preview.innerHTML = `
                <div style="text-align: center; padding: 20px; background: #333; border-radius: 8px;">
                    <h4 style="color: #ffd700; margin-bottom: 15px;">ğŸ“‹ æ‰‹å‹•è³‡æ–™è¼¸å…¥</h4>
                    <p style="color: #e0e0e0; margin-bottom: 15px;">ç”±æ–¼è‡ªå‹•è®€å–å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥å®¢æˆ¶è³‡æ–™ï¼š</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="manual-name" placeholder="å®¢æˆ¶å§“å" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                        <input type="text" id="manual-address" placeholder="æœå‹™åœ°å€" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                        <input type="text" id="manual-phone" placeholder="è¯çµ¡é›»è©±" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                        <input type="number" id="manual-fee" placeholder="æœˆè²»" value="1200" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                        <input type="text" id="manual-days" placeholder="æœå‹™æ˜ŸæœŸ" value="é€±äºŒã€é€±äº”" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                        <input type="text" id="manual-time" placeholder="æœå‹™æ™‚é–“" value="0800" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                        <input type="number" id="manual-floor" placeholder="æ¨“å±¤" value="1" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                        <input type="number" id="manual-trash" placeholder="åƒåœ¾è¢‹æ•¸" value="6" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                        <input type="number" id="manual-recycle" placeholder="è³‡æºè¢‹æ•¸" value="3" style="padding: 8px; border-radius: 4px; border: 1px solid #666; background: #2a2a2a; color: #fff;">
                    </div>
                    <button onclick="useManualData()" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold;">
                        âœ… ä½¿ç”¨æ‰‹å‹•è³‡æ–™ç”Ÿæˆå ±åƒ¹å–®
                    </button>
                </div>
            `;
            
            document.getElementById('auto-quote-controls').style.display = 'none';
        }

        // ä½¿ç”¨æ‰‹å‹•è¼¸å…¥çš„è³‡æ–™
        function useManualData() {
            showStatus('auto-sheets-status', 'ğŸ”„ æ­£åœ¨ä½¿ç”¨æ‰‹å‹•è³‡æ–™ç”Ÿæˆå ±åƒ¹å–®...', 'success');
            
            const selectedDays = Array.from(document.querySelectorAll('input[name="manual-days"]:checked')).map(cb => cb.value);
            const manualData = {
                lineName: '',
                address: '',
                housingType: '',
                monthlyFee: document.getElementById('manual-fee').value || '',
                serviceDays: selectedDays.join('ã€') || '',
                serviceTime: document.getElementById('manual-time').value || '',
                floor: document.getElementById('manual-floor').value || '',
                trashBags: document.getElementById('manual-trash').value || '',
                recycleBags: document.getElementById('manual-recycle').value || '',
                trashVolume: document.getElementById('manual-trash-volume').value || '',
                recycleVolume: document.getElementById('manual-recycle-volume').value || '',
                trashMax: document.getElementById('manual-trash-max').value || '',
                recycleMax: document.getElementById('manual-recycle-max').value || '',
                specialNotes: document.getElementById('manual-special-notes').value || ''
            };

            try {
                const quote = generateQuoteFromData(manualData);
                document.getElementById('auto-quote-result-display').textContent = quote;
                document.getElementById('auto-quote-output').style.display = 'block';
                
                // é¡¯ç¤ºä½¿ç”¨çš„è³‡æ–™é è¦½
                const preview = document.getElementById('detected-data-preview');
                preview.innerHTML = `
                    <div style="background: #2a2a2a; padding: 15px; border-radius: 8px; color: #e0e0e0;">
                        <h4 style="color: #28a745; margin-bottom: 10px;">âœ… ä½¿ç”¨çš„æ‰‹å‹•è³‡æ–™ï¼š</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <div><strong>æœˆè²»ï¼š</strong> ${manualData.monthlyFee}å…ƒ</div>
                            <div><strong>æ”¶å–æ˜ŸæœŸï¼š</strong> ${manualData.serviceDays}</div>
                            <div><strong>æœå‹™æ™‚é–“ï¼š</strong> ${manualData.serviceTime}</div>
                            <div><strong>æ¨“å±¤ï¼š</strong> ${manualData.floor}æ¨“</div>
                            <div><strong>åƒåœ¾è¢‹æ•¸ï¼š</strong> ${manualData.trashBags}åŒ…</div>
                            <div><strong>è³‡æºè¢‹æ•¸ï¼š</strong> ${manualData.recycleBags}åŒ…</div>
                            <div><strong>åƒåœ¾è¢‹å®¹é‡ï¼š</strong> ${manualData.trashVolume}</div>
                            <div><strong>è³‡æºè¢‹å®¹é‡ï¼š</strong> ${manualData.recycleVolume}</div>
                            <div><strong>æœ€å¤šåƒåœ¾è¢‹æ•¸ï¼š</strong> ${manualData.trashMax}è¢‹</div>
                            <div><strong>æœ€å¤šè³‡æºè¢‹æ•¸ï¼š</strong> ${manualData.recycleMax}è¢‹</div>
                            ${manualData.specialNotes ? `<div><strong>ç‰¹æ®Šéœ€æ±‚ï¼š</strong> ${manualData.specialNotes}</div>` : ''}
                        </div>
                    </div>
                `;
                
                document.getElementById('auto-detected-data').style.display = 'block';
                showStatus('auto-quote-final-status', 'âœ… æ‰‹å‹•è³‡æ–™å ±åƒ¹å–®ç”Ÿæˆå®Œæˆï¼', 'success');
                
            } catch (error) {
                showStatus('auto-quote-final-status', `âŒ ç”Ÿæˆå¤±æ•—: ${error.message}`, 'error');
            }
        }

        function displayDetectedData(data) {
            const preview = document.getElementById('detected-data-preview');
            let html = '<table style="width: 100%; border-collapse: collapse; color: #e0e0e0;">';
            
            if (data.headers.length > 0) {
                html += '<tr style="background: #404040;">';
                data.headers.forEach(header => {
                    // ç°¡åŒ–è¡¨é ­é¡¯ç¤ºï¼šç§»é™¤è¡¨æƒ…ç¬¦è™Ÿï¼Œæå–é—œéµå­—
                    let simplifiedHeader = header;
                    
                    // ç§»é™¤æ‰€æœ‰è¡¨æƒ…ç¬¦è™Ÿ
                    simplifiedHeader = simplifiedHeader.replace(/[\u{1F000}-\u{1F6FF}]|[\u{1F700}-\u{1F77F}]|[\u{1F780}-\u{1F7FF}]|[\u{1F800}-\u{1F8FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '');
                    
                    // åˆ¤æ–·æ¬„ä½é¡å‹
                    const isResourceField = header.toLowerCase().includes('è³‡æº');
                    const isTrashField = header.toLowerCase().includes('åƒåœ¾');
                    
                    // æå–é—œéµå­—ï¼ˆæ–¹æ‹¬è™Ÿå…§çš„å…§å®¹æˆ–æœ€å¾Œçš„é‡è¦è©å½™ï¼‰
                    const bracketMatch = simplifiedHeader.match(/\[([^\]]+)\]/);
                    if (bracketMatch) {
                        simplifiedHeader = bracketMatch[1];
                    } else {
                        // å¦‚æœæ²’æœ‰æ–¹æ‹¬è™Ÿï¼Œæå–æœ€å¾Œçš„é—œéµè©
                        if (simplifiedHeader.includes('åœ°å€')) {
                            simplifiedHeader = 'åœ°å€';
                        } else {
                            simplifiedHeader = simplifiedHeader.trim()
                                .replace(/.*åƒåœ¾.*/, 'åƒåœ¾é‡')
                                .replace(/.*è³‡æº.*/, 'è³‡æºé‡')
                                .replace(/.*æœˆè²».*|.*è²»ç”¨.*/, 'æœˆè²»')
                                .replace(/.*æ˜ŸæœŸ.*|.*æ”¶å–.*/, 'æ¬¡æ•¸')
                                .replace(/.*æ™‚é–“.*/, 'æ™‚é–“')
                                .replace(/.*æ¨“å±¤.*/, 'æ¨“å±¤')
                                .replace(/.*line.*|.*æš±ç¨±.*/, 'LINEæš±ç¨±')
                                .replace(/.*ä½å®….*|.*æ€§è³ª.*/, 'ä½å®…æ€§è³ª');
                        }
                    }
                    
                    // æ¸…ç†å¤šé¤˜çš„ç©ºæ ¼å’Œç¬¦è™Ÿ
                    simplifiedHeader = simplifiedHeader.replace(/["""'']/g, '').trim();
                    
                    // è¨­å®šæ¨£å¼ï¼šåƒåœ¾æ¬„ä½ç”¨ç´…è‰²ï¼Œè³‡æºæ¬„ä½ç”¨ç¶ è‰²
                    let backgroundColor = '#404040';
                    let textColor = '#e0e0e0';
                    
                    if (isTrashField) {
                        backgroundColor = '#dc3545'; // ç´…è‰²
                        textColor = '#ffffff';
                    } else if (isResourceField) {
                        backgroundColor = '#28a745'; // ç¶ è‰²
                        textColor = '#ffffff';
                    }
                    
                    html += `<th style="border: 1px solid #666; padding: 8px; text-align: left; background-color: ${backgroundColor}; color: ${textColor};">${simplifiedHeader}</th>`;
                });
                html += '</tr>';
            }

            data.rows.forEach((row, index) => {
                html += `<tr style="background: ${index % 2 === 0 ? '#2a2a2a' : '#333333'};">`;
                row.forEach(cell => {
                    html += `<td style="border: 1px solid #666; padding: 8px;">${cell}</td>`;
                });
                html += '</tr>';
            });

            html += '</table>';
            preview.innerHTML = html;
            
            document.getElementById('auto-detected-data').style.display = 'block';
            document.getElementById('auto-quote-controls').style.display = 'block';
        }

        function generateAutoQuote() {
            if (!autoQuoteData || !autoQuoteData.rows || autoQuoteData.rows.length === 0) {
                showStatus('auto-quote-final-status', 'âŒ è«‹å…ˆè¼‰å…¥è©¦ç®—è¡¨è³‡æ–™', 'error');
                return;
            }

            showStatus('auto-quote-final-status', 'ğŸ”„ æ­£åœ¨ç”Ÿæˆè‡ªå‹•å ±åƒ¹å–®...', 'success');

            try {
                const latestRow = autoQuoteData.rows[autoQuoteData.rows.length - 1];
                const headers = autoQuoteData.headers;
                
                // å…ˆç²å–æ‰‹å‹•è¼¸å…¥çš„è³‡æ–™
                const selectedDays = Array.from(document.querySelectorAll('input[name="manual-days"]:checked')).map(cb => cb.value);
                const manualData = {
                    lineName: '',
                    address: '',
                    housingType: '',
                    monthlyFee: document.getElementById('manual-fee').value || '',
                    serviceDays: selectedDays.join('ã€') || '',
                    serviceTime: document.getElementById('manual-time').value || '',
                    floor: document.getElementById('manual-floor').value || '',
                    frequency: document.getElementById('manual-frequency').value || '',
                    trashBags: document.getElementById('manual-trash').value || '',
                    recycleBags: document.getElementById('manual-recycle').value || '',
                    trashVolume: document.getElementById('manual-trash-volume').value || '',
                    recycleVolume: document.getElementById('manual-recycle-volume').value || '',
                    trashMax: document.getElementById('manual-trash-max').value || '',
                    recycleMax: document.getElementById('manual-recycle-max').value || '',
                    specialNotes: document.getElementById('manual-special-notes').value || ''
                };

                const fieldMapping = {};
                console.log('Headers:', headers);
                console.log('Latest row:', latestRow);
                
                // æ”¶é›†åƒåœ¾å’Œè³‡æºçš„åŒ…æ•¸èˆ‡å®¹é‡æ•¸æ“š
                let trashData = { bags: '', volume: '' };
                let recycleData = { bags: '', volume: '' };
                
                headers.forEach((header, index) => {
                    const lowerHeader = header.toLowerCase();
                    const cellValue = latestRow[index];
                    console.log(`Processing header: "${header}" (${lowerHeader}) with value: "${cellValue}"`);
                    
                    if (lowerHeader.includes('line') || lowerHeader.includes('æš±ç¨±')) {
                        fieldMapping.lineName = cellValue;
                    } else if (lowerHeader.includes('åœ°å€')) {
                        fieldMapping.address = cellValue;
                        
                        // è‡ªå‹•åµæ¸¬åœ°å€ä¸­çš„æ¨“å±¤æ•¸å­—ä¸¦å¡«å…¥æ¨“å±¤æ¬„ä½ï¼ˆåªåœ¨æ‰‹å‹•æ¬„ä½ç‚ºç©ºæ™‚ï¼‰
                        if (cellValue && (!manualData.floor || manualData.floor.trim() === '')) {
                            const floorMatch = cellValue.match(/(\d+)[æ¨“F]/);
                            if (floorMatch) {
                                fieldMapping.floor = floorMatch[1];
                                // åªåœ¨æ‰‹å‹•æ¬„ä½ç‚ºç©ºæ™‚è‡ªå‹•å¡«å…¥
                                document.getElementById('manual-floor').value = floorMatch[1];
                                console.log(`Auto-detected floor: ${floorMatch[1]} from address: ${cellValue}`);
                            } else {
                                console.log(`No floor detected in address: ${cellValue}, keeping manual input`);
                            }
                        }
                    } else if (lowerHeader.includes('ä½å®…') || lowerHeader.includes('æ€§è³ª')) {
                        fieldMapping.housingType = cellValue;
                    } else if (lowerHeader.includes('æœˆè²»') || lowerHeader.includes('è²»ç”¨')) {
                        // å„ªå…ˆä½¿ç”¨æ‰‹å‹•è¼¸å…¥çš„æœˆè²»ï¼Œå…¶æ¬¡æ˜¯è©¦ç®—è¡¨æ•¸æ“š
                        fieldMapping.monthlyFee = (manualData.monthlyFee && manualData.monthlyFee.trim() !== '') ? manualData.monthlyFee : cellValue;
                    } else if (lowerHeader.includes('æ˜ŸæœŸ') || lowerHeader.includes('æ”¶å–')) {
                        // è™•ç†æ¬¡æ•¸æ¬„ä½ï¼Œç”Ÿæˆã€Œä¸€é€±è¶Ÿæ•¸ï¼šXè¶Ÿã€æ ¼å¼
                        if (cellValue && cellValue.trim() !== '') {
                            const frequencyMatch = cellValue.match(/(\d+)/);
                            if (frequencyMatch) {
                                fieldMapping.weeklyFrequency = `ä¸€é€±è¶Ÿæ•¸ï¼š${frequencyMatch[1]}è¶Ÿ`;
                            } else {
                                fieldMapping.weeklyFrequency = `ä¸€é€±è¶Ÿæ•¸ï¼š${cellValue}è¶Ÿ`;
                            }
                        }
                        // ä¿æŒåŸæœ‰çš„æœå‹™æ—¥é‚è¼¯
                        fieldMapping.serviceDays = manualData.serviceDays;
                    } else if (lowerHeader.includes('æ™‚é–“')) {
                        // å„ªå…ˆä½¿ç”¨æ‰‹å‹•è¼¸å…¥çš„æ™‚é–“ï¼Œå…¶æ¬¡æ˜¯è©¦ç®—è¡¨æ•¸æ“š
                        fieldMapping.serviceTime = (manualData.serviceTime && manualData.serviceTime.trim() !== '') ? manualData.serviceTime : cellValue;
                    } else if (lowerHeader.includes('æ¨“å±¤')) {
                        // å„ªå…ˆä½¿ç”¨æ‰‹å‹•è¼¸å…¥çš„æ¨“å±¤è³‡æ–™ï¼Œå…¶æ¬¡æ˜¯è©¦ç®—è¡¨ä¸­çš„æ¨“å±¤è³‡æ–™ï¼Œæœ€å¾Œé è¨­ç‚º0
                        fieldMapping.floor = (manualData.floor && manualData.floor.trim() !== '') ? manualData.floor : ((cellValue && cellValue.trim() !== '') ? cellValue : '0');
                    } else if (lowerHeader.includes('åƒåœ¾')) {
                        console.log(`Found trash header: "${header}" with value: "${cellValue}"`);
                        // å¦‚æœè©²æ¬„ä½æœ‰æ•¸æ“šï¼ŒåŒæ™‚è¨˜éŒ„åŒ…æ•¸å’Œå®¹é‡
                        if (cellValue && cellValue.trim() !== '') {
                            const bagMatch = cellValue.match(/(\d+)åŒ…/);
                            const headerVolumeMatch = header.match(/(\d+(?:\/\d+)?å…¬å‡)/);
                            
                            if (bagMatch) {
                                trashData.bags = bagMatch[1];
                                // åŒæ™‚è¨˜éŒ„è©²æ¬„ä½å°æ‡‰çš„å®¹é‡
                                if (headerVolumeMatch) {
                                    trashData.volume = headerVolumeMatch[1];
                                }
                                console.log(`Trash data found: ${trashData.bags}åŒ… in ${header} (volume: ${trashData.volume})`);
                            }
                        }
                    } else if (lowerHeader.includes('è³‡æº')) {
                        console.log(`Found recycle header: "${header}" with value: "${cellValue}"`);
                        // å¦‚æœè©²æ¬„ä½æœ‰æ•¸æ“šï¼ŒåŒæ™‚è¨˜éŒ„åŒ…æ•¸å’Œå®¹é‡
                        if (cellValue && cellValue.trim() !== '') {
                            const bagMatch = cellValue.match(/(\d+)åŒ…/);
                            const headerVolumeMatch = header.match(/(\d+(?:\/\d+)?å…¬å‡)/);
                            
                            if (bagMatch) {
                                recycleData.bags = bagMatch[1];
                                // åŒæ™‚è¨˜éŒ„è©²æ¬„ä½å°æ‡‰çš„å®¹é‡
                                if (headerVolumeMatch) {
                                    recycleData.volume = headerVolumeMatch[1];
                                }
                                console.log(`Recycle data found: ${recycleData.bags}åŒ… in ${header} (volume: ${recycleData.volume})`);
                            }
                        }
                    }
                });
                
                // çµ„åˆåƒåœ¾è¢‹æ•¸æ“š
                if (manualData.trashBags || manualData.trashVolume) {
                    if (manualData.trashBags && manualData.trashVolume) {
                        fieldMapping.trashBags = `${manualData.trashBags}åŒ…æ•¸ï¼ˆ${manualData.trashVolume}ï¼‰`;
                    } else if (manualData.trashBags) {
                        fieldMapping.trashBags = `${manualData.trashBags}åŒ…æ•¸ï¼ˆ14å…¬å‡ï¼‰`;
                    } else {
                        fieldMapping.trashBags = `6åŒ…æ•¸ï¼ˆ${manualData.trashVolume}ï¼‰`;
                    }
                } else if (trashData.bags && trashData.volume) {
                    fieldMapping.trashBags = `${trashData.bags}åŒ…ï¼ˆ${trashData.volume}ï¼‰`;
                } else if (trashData.bags) {
                    fieldMapping.trashBags = `${trashData.bags}åŒ…ï¼ˆ14å…¬å‡ï¼‰`;
                } else {
                    fieldMapping.trashBags = '6åŒ…ï¼ˆ14å…¬å‡ï¼‰';
                }
                
                // çµ„åˆè³‡æºè¢‹æ•¸æ“š
                if (manualData.recycleBags || manualData.recycleVolume) {
                    if (manualData.recycleBags && manualData.recycleVolume) {
                        fieldMapping.recycleBags = `${manualData.recycleBags}åŒ…æ•¸ï¼ˆ${manualData.recycleVolume}ï¼‰`;
                    } else if (manualData.recycleBags) {
                        fieldMapping.recycleBags = `${manualData.recycleBags}åŒ…æ•¸ï¼ˆ14å…¬å‡ï¼‰`;
                    } else {
                        fieldMapping.recycleBags = `3åŒ…æ•¸ï¼ˆ${manualData.recycleVolume}ï¼‰`;
                    }
                } else if (recycleData.bags && recycleData.volume) {
                    fieldMapping.recycleBags = `${recycleData.bags}åŒ…ï¼ˆ${recycleData.volume}ï¼‰`;
                } else if (recycleData.bags) {
                    fieldMapping.recycleBags = `${recycleData.bags}åŒ…ï¼ˆ14å…¬å‡ï¼‰`;
                } else {
                    fieldMapping.recycleBags = '3åŒ…ï¼ˆ14å…¬å‡ï¼‰';
                }
                
                console.log(`Final trash data: bags="${trashData.bags}", volume="${trashData.volume}", result="${fieldMapping.trashBags}"`);
                console.log(`Final recycle data: bags="${recycleData.bags}", volume="${recycleData.volume}", result="${fieldMapping.recycleBags}"`);
                
                console.log('Final field mapping:', fieldMapping);
                
                // åŠ å…¥æ‰‹å‹•è¼¸å…¥çš„å…¶ä»–æ•¸æ“š
                if (manualData.trashMax) {
                    fieldMapping.trashMax = manualData.trashMax;
                }
                if (manualData.recycleMax) {
                    fieldMapping.recycleMax = manualData.recycleMax;
                }
                if (manualData.specialNotes) {
                    fieldMapping.specialNotes = manualData.specialNotes;
                }
                // ç¢ºä¿æ‰‹å‹•è¼¸å…¥çš„é‡è¦æ¬„ä½æ­£ç¢ºå‚³éï¼ˆè¦†è“‹ä¹‹å‰çš„è¨­å®šï¼‰
                if (manualData.frequency) {
                    fieldMapping.frequency = manualData.frequency;
                }
                // ç¢ºä¿æ‰‹å‹•è¼¸å…¥çš„æ¨“å±¤ä¸€å®šå„ªå…ˆä½¿ç”¨
                if (manualData.floor && manualData.floor.trim() !== '') {
                    fieldMapping.floor = manualData.floor;
                }
                // ç¢ºä¿æ‰‹å‹•è¼¸å…¥çš„æœˆè²»ä¸€å®šå„ªå…ˆä½¿ç”¨
                if (manualData.monthlyFee && manualData.monthlyFee.trim() !== '') {
                    fieldMapping.monthlyFee = manualData.monthlyFee;
                }
                // ç¢ºä¿æ‰‹å‹•è¼¸å…¥çš„æ™‚é–“ä¸€å®šå„ªå…ˆä½¿ç”¨
                if (manualData.serviceTime && manualData.serviceTime.trim() !== '') {
                    fieldMapping.serviceTime = manualData.serviceTime;
                }

                const quote = generateQuoteFromData(fieldMapping);
                
                document.getElementById('auto-quote-result-display').textContent = quote;
                document.getElementById('auto-quote-output').style.display = 'block';
                showStatus('auto-quote-final-status', 'âœ… è‡ªå‹•å ±åƒ¹å–®ç”Ÿæˆå®Œæˆï¼', 'success');

            } catch (error) {
                console.error('ç”Ÿæˆå ±åƒ¹å–®å¤±æ•—:', error);
                showStatus('auto-quote-final-status', `âŒ ç”Ÿæˆå¤±æ•—: ${error.message}`, 'error');
            }
        }

        function generateQuoteFromData(data) {
            const lineName = data.lineName || '';
            const address = data.address || '';
            const housingType = data.housingType || '';
            const monthlyFee = (data.monthlyFee && data.monthlyFee.trim() !== '') ? data.monthlyFee : '0';
            const serviceDays = data.serviceDays || 'é€±äºŒã€é€±äº”';
            const serviceTime = (data.serviceTime && data.serviceTime.trim() !== '') ? data.serviceTime : '0';
            const floor = (data.floor && data.floor.trim() !== '') ? data.floor : '0';
            const trashBags = data.trashBags || '6';
            const recycleBags = data.recycleBags || '3';

            // æ¨“å±¤é¡¯ç¤º
            let floorDisplay;
            const floorNum = parseInt(floor);
            if (floorNum < 0) {
                floorDisplay = `åœ°ä¸‹${Math.abs(floorNum)}æ¨“`;
            } else {
                floorDisplay = `${floorNum}F`;
            }

            // æ™‚é–“æ ¼å¼åŒ– - æ ¹æ“šæ™‚é–“è‡ªå‹•åˆ¤æ–·ä¸Šåˆ/ä¸‹åˆ/æ™šä¸Š
            let timeDisplay = serviceTime;
            if (serviceTime && serviceTime.length === 4 && /^\d{4}$/.test(serviceTime)) {
                const hour = parseInt(serviceTime.substring(0, 2));
                const minute = serviceTime.substring(2);
                
                let period;
                if (hour >= 6 && hour < 12) {
                    period = 'ä¸Šåˆ';
                } else if (hour >= 12 && hour < 18) {
                    period = 'ä¸‹åˆ';
                } else {
                    period = 'æ™šé–“';
                }
                
                timeDisplay = `${period} ${hour.toString().padStart(2, '0')}ï¼š${minute}`;
            } else if (serviceTime && serviceTime.includes(':')) {
                // å¦‚æœå·²ç¶“æ˜¯æ™‚é–“æ ¼å¼ï¼Œæª¢æŸ¥æ˜¯å¦éœ€è¦åŠ ä¸Šæ™‚æ®µ
                const timeMatch = serviceTime.match(/(\d{1,2}):(\d{2})/);
                if (timeMatch) {
                    const hour = parseInt(timeMatch[1]);
                    const minute = timeMatch[2];
                    
                    let period;
                    if (hour >= 6 && hour < 12) {
                        period = 'ä¸Šåˆ';
                    } else if (hour >= 12 && hour < 18) {
                        period = 'ä¸‹åˆ';
                    } else {
                        period = 'æ™šé–“';
                    }
                    
                    timeDisplay = `${period} ${hour.toString().padStart(2, '0')}ï¼š${minute}`;
                } else {
                    timeDisplay = serviceTime;
                }
            } else if (!serviceTime || serviceTime.trim() === '' || serviceTime === '0') {
                // å¦‚æœæ²’æœ‰è¼¸å…¥æ™‚é–“æˆ–æ™‚é–“ç‚º0ï¼Œé¡¯ç¤º0
                timeDisplay = '0';
            }

            // æœå‹™æ˜ŸæœŸæ ¼å¼åŒ–
            let daysDisplay = serviceDays;
            if (serviceDays.includes('é€±')) {
                daysDisplay = serviceDays.replace(/é€±/g, 'é€±').replace(/ã€/g, '+');
            }

            // è™•ç†åƒåœ¾è¢‹é¡¯ç¤ºæ ¼å¼
            let trashDisplay;
            if (typeof trashBags === 'string' && (trashBags.includes('å…¬å‡') || trashBags.includes('åŒ…'))) {
                // å¦‚æœå·²ç¶“åŒ…å«å®Œæ•´æ ¼å¼ï¼ˆå¦‚ï¼š3åŒ… 75/76å…¬å‡ï¼‰ï¼Œéœ€è¦è½‰æ›ç‚ºæ¨™æº–æ ¼å¼
                if (trashBags.includes('åŒ…') && trashBags.includes('å…¬å‡')) {
                    // æå–åŒ…æ•¸å’Œå®¹é‡
                    const bagMatch = trashBags.match(/(\d+)åŒ…/);
                    const volumeMatch = trashBags.match(/(\d+(?:\/\d+)?å…¬å‡)/);
                    if (bagMatch && volumeMatch) {
                        trashDisplay = `${bagMatch[1]}åŒ…æ•¸ï¼ˆ${volumeMatch[1]}ï¼‰`;
                    } else {
                        trashDisplay = trashBags;
                    }
                } else {
                    trashDisplay = trashBags;
                }
            } else {
                // å¦å‰‡å¾æ•¸å­—å»ºç«‹æ ¼å¼
                const trashNum = parseInt(trashBags) || 6;
                trashDisplay = `${trashNum}åŒ…æ•¸ï¼ˆ14å…¬å‡ï¼‰`;
            }

            // è™•ç†è³‡æºè¢‹é¡¯ç¤ºæ ¼å¼
            let recycleDisplay;
            if (typeof recycleBags === 'string' && (recycleBags.includes('å…¬å‡') || recycleBags.includes('åŒ…'))) {
                // å¦‚æœå·²ç¶“åŒ…å«å®Œæ•´æ ¼å¼ï¼ˆå¦‚ï¼š3åŒ… 14å…¬å‡ï¼‰ï¼Œéœ€è¦è½‰æ›ç‚ºæ¨™æº–æ ¼å¼
                if (recycleBags.includes('åŒ…') && recycleBags.includes('å…¬å‡')) {
                    // æå–åŒ…æ•¸å’Œå®¹é‡
                    const bagMatch = recycleBags.match(/(\d+)åŒ…/);
                    const volumeMatch = recycleBags.match(/(\d+(?:\/\d+)?å…¬å‡)/);
                    if (bagMatch && volumeMatch) {
                        recycleDisplay = `${bagMatch[1]}åŒ…æ•¸ï¼ˆ${volumeMatch[1]}ï¼‰`;
                    } else {
                        recycleDisplay = recycleBags;
                    }
                } else {
                    recycleDisplay = recycleBags;
                }
            } else {
                // å¦å‰‡å¾æ•¸å­—å»ºç«‹æ ¼å¼
                const recycleNum = parseInt(recycleBags) || 3;
                recycleDisplay = `${recycleNum}åŒ…æ•¸ï¼ˆ14å…¬å‡ï¼‰`;
            }

            // è¨ˆç®—æ¯æ¬¡æœ€å¤šæ”¶å–è¢‹æ•¸ï¼ˆå¾é¡¯ç¤ºæ–‡å­—ä¸­æå–æ•¸å­—ï¼‰
            const trashNum = parseInt(trashDisplay.match(/(\d+)åŒ…/)?.[1]) || 6;
            const recycleNum = parseInt(recycleDisplay.match(/(\d+)åŒ…/)?.[1]) || 3;
            
            // å¦‚æœæ‰‹å‹•è¼¸å…¥äº†æœ€å¤§è¢‹æ•¸ï¼Œä½¿ç”¨æ‰‹å‹•æ•¸æ“šï¼Œå¦å‰‡è¨ˆç®—
            let trashMax, recycleMax;
            if (data.trashMax) {
                trashMax = parseInt(data.trashMax);
            } else {
                trashMax = Math.floor(trashNum / 2) || 3;
            }
            
            if (data.recycleMax) {
                recycleMax = parseInt(data.recycleMax);
            } else {
                recycleMax = Math.floor(recycleNum / 2) || 3;
            }

            // é¡¯ç¤ºå®¢æˆ¶è³‡è¨Šï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            let customerInfo = '';
            if (lineName) customerInfo += `LINEæš±ç¨±ï¼š${lineName}\n`;
            if (address) customerInfo += `åœ°å€ï¼š${address}\n`;
            if (housingType) customerInfo += `ä½å®…æ€§è³ªï¼š${housingType}\n`;
            if (customerInfo) customerInfo += '\n------------------------------------\n\n';

            // å„ªå…ˆä½¿ç”¨æ‰‹å‹•è¼¸å…¥çš„è¶Ÿæ•¸ï¼Œå…¶æ¬¡æ˜¯è‡ªå‹•åµæ¸¬ï¼Œæœ€å¾Œæ˜¯é è¨­å€¼
            let weeklyFrequency;
            if (data.frequency) {
                weeklyFrequency = `ä¸€é€±è¶Ÿæ•¸ï¼š${data.frequency}è¶Ÿ`;
            } else if (data.weeklyFrequency) {
                weeklyFrequency = data.weeklyFrequency;
            } else {
                weeklyFrequency = 'ä¸€é€±è¶Ÿæ•¸ï¼š2è¶Ÿ';
            }
            
            const quote = `${customerInfo}â›”å ±åƒ¹è³‡æ–™â›”

${weeklyFrequency}-${daysDisplay}
   ç½®æ”¾æ™‚é–“ï¼š${timeDisplay}
   ç½®æ”¾æ¨“å±¤ï¼š${floorDisplay}

ï¼ˆâš ï¸ åƒåœ¾ç•¶æ—¥ï¼šä¸­åˆå‰   ä»£æ”¶å®Œç•¢ï¼‰

ï¼ˆâš ï¸ éç¨‹ä¸­åš´ç¦å‚¬ä¿ƒï¼‰
ï¼ˆâš ï¸ è«‹æº–æ™‚ç½®æ”¾ ä»¥å…å¤šæœ‰ç³¾ç´›ï¼‰

 1é€±åƒåœ¾ï¼š${trashDisplay}
ï¼ˆ1æ¬¡æœ€å¤šæ”¶å–${trashMax}è¢‹--è¶…é‡æ‹’æ”¶ï¼‰
ï¼ˆåƒåœ¾è«‹ç¶ç·Šã€å‹¿å¤–éœ²ï¼‰
ï¼ˆåƒåœ¾è¢‹å¤–éƒ¨å‹¿æµæ¹¯æ±ï¼‰
ï¼ˆä¸€æ¬¡æ€§ç´™/å¡‘è† å®¹å™¨å‡åƒåœ¾ï¼‰


 1é€±è³‡æº:${recycleDisplay}-ç”¨ä¸€èˆ¬å¡‘è† è¢‹
ï¼ˆ1æ¬¡æœ€å¤šæ”¶å–${recycleMax}è¢‹--è¶…é‡æ‹’æ”¶ï¼‰
ï¼ˆè‹¥æœªè£è¢‹ä¸€å¾‹æ‹’æ”¶ï¼‰
ï¼ˆè«‹å‹¿ç”¨é»‘è‰²è¢‹å­è£è³‡æºï¼‰
ï¼ˆåƒ…æ”¶å¯¶ç‰¹ç»ç’ƒéµé‹ç½ï¼‰
ï¼ˆåƒ…æ”¶ä¸­å°ç´™æ¿ç®±å£“æ‰æŠ˜å¥½ï¼‰
ï¼ˆåƒ…æ”¶æ›¸æœ¬/ä¹¾æ·¨ç´™å¼µï¼‰

âš ï¸ä¸‹åˆ—ç‰©å“è¦–ç‚ºåƒåœ¾
ï¼ˆä¾¿ç•¶ç›’/å¡‘è† è¢‹/å¸ç®¡â¡ï¸åƒåœ¾ï¼‰
ï¼ˆè»Ÿå¡‘è† è“‹/å¸ç®¡â¡ï¸åƒåœ¾ï¼‰
ï¼ˆæ—©é¤ç›’/å¿«é£²æ¯â¡ï¸åƒåœ¾ï¼‰
ï¼ˆæ³¡æ£‰/é›è›‹è»Ÿå¡‘è† ç›’â¡ï¸åƒåœ¾ï¼‰
ï¼ˆè›‹ç³•ç›’/ç·©è¡ææ–™â¡ï¸åƒåœ¾ï¼‰

ä¸€å€‹æœˆè²»ç”¨ï¼š${monthlyFee}å…ƒ


-
â›”é…åˆäº‹é …â›”
â­.åƒåœ¾å‹™å¿…æ‰“åŒ…ç¶å¥½æ”¾ç½®é–€å£
â­.å¦‚å› æ”¿ç­–é—œä¿‚éœ€æ›´æ”¹æ™‚é–“
  ï¼ˆæœƒåœ¨æå‰å‘ŠçŸ¥ ç…©è«‹é…åˆï¼‰
â­.è‡ªå‚™é›™åŒ—å¸‚æ”¿åºœå°ˆç”¨åƒåœ¾è¢‹
â­.æ”¶æ¬¾å¾Œä¸é€€æ¬¾å…§å®¹ä¸æ›´æ”¹
â­.è‹¥æœ‰è¶…é‡åƒåœ¾æ‹’æ”¶

â¬â¬

â›”å…¶ä»–å•é¡Œâ›”
ğŸŸ¥.è«‹å®Œæ•´çœ‹å®Œå ±åƒ¹å…§å®¹å¾Œæå‡º
ğŸŸ¥.å®¢æœæœƒç‚ºæ‚¨è§£æ±ºä»»ä½•å•é¡Œ

â¬â¬

â­•è§£æ±ºå•é¡Œâ­•
âœ”ï¸.ä¸Šè¿°å•é¡Œå‡è§£æ±º
âœ”ï¸.ä¸Šè¿°å…§å®¹èƒ½é…åˆ
å›è¦†å‘ŠçŸ¥æˆ‘å€‘ï¼šåŒæ„âœ…+é–‹å§‹æ—¥

â¬â¬

æ”¶åˆ°_åŒæ„âœ…_å¾Œ
ğŸ’§å®¢æœâ¡ï¸æä¾›ç¹³è²»å–®
ğŸ’§å®¢æˆ¶â¡ï¸å®Œæˆç¹³è²»
ğŸ’§å®¢æœâ¡ï¸é–‹å§‹ä»£æ”¶

âœ–ï¸æ³¨æ„äº‹é …âœ–ï¸
ğŸ”».1åˆ†éŒ¢1åˆ†æœå‹™_ä¾¿å®œç„¡å®‰å…¨æœå‹™
ğŸ”».è¿‘æœŸå¤šæ¡ˆä¾‹/è«‹æˆ¿æ±ä½æˆ¶å¤šæ³¨æ„
ğŸ”».å‡ç‚ºå¹´è¼•åœ˜éšŠä½œæ¥­æµç¨‹å‡æœ‰SOP
ğŸ”».æˆå“¡å¹³å‡30-35æ­²å…§å‡æœ‰è‰¯æ°‘è­‰
ğŸ”».éå¹´åŠå¤©ç½äººç¦åœæ­¢ä»£æ”¶ç„¡é€€æ¬¾
       å»¶è‡³ä¸‹ä¸€æ¬¡èƒ½ä»£æ”¶å·¥ä½œæ—¥



ğŸ”¥è¬äº‹é †å¿ƒğŸ”¥`;

            return quote;
        }

        function copyAutoQuote() {
            const quoteText = document.getElementById('auto-quote-result-display').textContent;
            
            if (!quoteText) {
                showStatus('auto-quote-copy-status', 'âŒ æ²’æœ‰å ±åƒ¹å–®å¯è¤‡è£½', 'error');
                return;
            }

            navigator.clipboard.writeText(quoteText).then(() => {
                showStatus('auto-quote-copy-status', 'âœ… è‡ªå‹•å ±åƒ¹å–®å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
            }).catch(() => {
                showStatus('auto-quote-copy-status', 'âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸æ“‡è¤‡è£½', 'error');
            });
        }

        // ç¶²å€è¨˜æ†¶åŠŸèƒ½
        function saveUrlToHistory() {
            const url = document.getElementById('sheets-url').value.trim();
            if (!url || !url.includes('docs.google.com/spreadsheets')) {
                return;
            }

            let savedUrls = JSON.parse(localStorage.getItem('sheetsUrls') || '[]');
            
            // ç§»é™¤é‡è¤‡çš„ç¶²å€
            savedUrls = savedUrls.filter(savedUrl => savedUrl !== url);
            
            // æ·»åŠ åˆ°é–‹é ­
            savedUrls.unshift(url);
            
            // æœ€å¤šä¿ç•™10å€‹ç¶²å€
            if (savedUrls.length > 10) {
                savedUrls = savedUrls.slice(0, 10);
            }
            
            localStorage.setItem('sheetsUrls', JSON.stringify(savedUrls));
            updateUrlDropdown();
        }

        function loadSavedUrl() {
            const selectedUrl = document.getElementById('saved-urls').value;
            if (selectedUrl) {
                document.getElementById('sheets-url').value = selectedUrl;
            }
        }

        function updateUrlDropdown() {
            const savedUrls = JSON.parse(localStorage.getItem('sheetsUrls') || '[]');
            const dropdown = document.getElementById('saved-urls');
            
            // æ¸…ç©ºç¾æœ‰é¸é …
            dropdown.innerHTML = '<option value="">é¸æ“‡æ­·å²ç¶²å€</option>';
            
            // æ·»åŠ æ­·å²ç¶²å€
            savedUrls.forEach((url, index) => {
                const option = document.createElement('option');
                option.value = url;
                // é¡¯ç¤ºç°¡åŒ–çš„ç¶²å€æè¿°
                const urlId = url.match(/\/d\/([a-zA-Z0-9-_]+)/)?.[1] || 'unknown';
                option.textContent = `è©¦ç®—è¡¨ ${index + 1} (${urlId.substring(0, 8)}...)`;
                dropdown.appendChild(option);
            });
        }



        // è²¡å‹™åˆ†æç›¸é—œå‡½æ•¸
        let financialData = null;

        function clearFinancialForm() {
            document.getElementById('financial-sheets-url').value = '';
            document.getElementById('financial-sheet-name').value = '';
            document.getElementById('financial-cell-range').value = '';
            document.getElementById('financial-csv-data').value = '';
            document.querySelector('input[name="input-method"][value="csv"]').checked = true;
            toggleInputMethod();
            document.getElementById('financial-data-preview').style.display = 'none';
            document.getElementById('financial-analysis-output').style.display = 'none';
            document.getElementById('financial-column-selection').style.display = 'none';
            document.getElementById('financial-status').style.display = 'none';
            financialData = null;
        }

        function toggleInputMethod() {
            const method = document.querySelector('input[name="input-method"]:checked').value;
            const csvArea = document.getElementById('csv-input-area');
            const sheetsArea = document.getElementById('sheets-input-area');
            
            if (method === 'csv') {
                csvArea.style.display = 'block';
                sheetsArea.style.display = 'none';
            } else {
                csvArea.style.display = 'none';
                sheetsArea.style.display = 'block';
            }
        }

        function saveFinancialUrl() {
            const url = document.getElementById('financial-sheets-url').value.trim();
            if (!url) {
                showStatus('financial-status', 'âŒ è«‹å…ˆè¼¸å…¥ç¶²å€', 'error');
                return;
            }

            if (!url.includes('docs.google.com/spreadsheets')) {
                showStatus('financial-status', 'âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„Googleè©¦ç®—è¡¨é€£çµ', 'error');
                return;
            }

            // ç²å–ç¾æœ‰çš„ç¶²å€åˆ—è¡¨
            let savedUrls = JSON.parse(localStorage.getItem('financialUrls') || '[]');
            
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (!savedUrls.includes(url)) {
                savedUrls.push(url);
                // é™åˆ¶æœ€å¤šå­˜10å€‹ç¶²å€
                if (savedUrls.length > 10) {
                    savedUrls = savedUrls.slice(-10);
                }
                localStorage.setItem('financialUrls', JSON.stringify(savedUrls));
                updateFinancialUrlDropdown();
                showStatus('financial-status', 'âœ… ç¶²å€å·²å­˜å„²', 'success');
            } else {
                showStatus('financial-status', 'âš  ç¶²å€å·²å­˜åœ¨', 'error');
            }
        }

        function selectFinancialUrl() {
            const dropdown = document.getElementById('financial-url-dropdown');
            const selectedUrl = dropdown.value;
            if (selectedUrl) {
                document.getElementById('financial-sheets-url').value = selectedUrl;
            }
        }

        function updateFinancialUrlDropdown() {
            const dropdown = document.getElementById('financial-url-dropdown');
            const savedUrls = JSON.parse(localStorage.getItem('financialUrls') || '[]');
            
            // æ¸…ç©ºä¸‹æ‹‰é¸å–®
            dropdown.innerHTML = '<option value="">é¸æ“‡å·²å­˜ç¶²å€</option>';
            
            // æ·»åŠ å„²å­˜çš„ç¶²å€
            savedUrls.forEach((url, index) => {
                const option = document.createElement('option');
                option.value = url;
                // é¡¯ç¤ºç°¡åŒ–çš„ç¶²å€
                const urlDisplay = url.length > 50 ? url.substring(0, 47) + '...' : url;
                option.textContent = `${index + 1}. ${urlDisplay}`;
                dropdown.appendChild(option);
            });

            // æ·»åŠ åˆªé™¤é¸é …
            if (savedUrls.length > 0) {
                const deleteOption = document.createElement('option');
                deleteOption.value = 'DELETE_ALL';
                deleteOption.textContent = 'ğŸ—‘ æ¸…ç©ºæ‰€æœ‰ç¶²å€';
                deleteOption.style.color = '#ff6b6b';
                dropdown.appendChild(deleteOption);
                
                // è™•ç†åˆªé™¤åŠŸèƒ½
                dropdown.addEventListener('change', function() {
                    if (this.value === 'DELETE_ALL') {
                        if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å„²å­˜çš„ç¶²å€å—ï¼Ÿ')) {
                            localStorage.removeItem('financialUrls');
                            updateFinancialUrlDropdown();
                            showStatus('financial-status', 'âœ… å·²æ¸…ç©ºæ‰€æœ‰ç¶²å€', 'success');
                        } else {
                            this.value = '';
                        }
                    }
                });
            }
        }

        function filterVisibleRows(rows) {
            // æ™ºèƒ½éæ¿¾ç„¡æ•ˆè³‡æ–™è¡Œçš„é‚è¼¯
            const visibleRows = [];
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                let isVisible = true;
                const rowText = row.join('').toLowerCase();
                
                // 1. éæ¿¾å®Œå…¨ç©ºç™½çš„è¡Œ
                if (row.every(cell => !cell || cell.trim() === '')) {
                    isVisible = false;
                }
                
                // 2. éæ¿¾æœˆä»½æ¨™é¡Œè¡Œï¼ˆå¦‚ï¼š4æœˆã€5æœˆã€6æœˆç­‰ï¼‰
                const firstCell = row[0] ? row[0].toString().trim() : '';
                if (/^\d+æœˆ$/.test(firstCell) || firstCell.match(/^(1[0-2]|[1-9])æœˆ$/)) {
                    isVisible = false;
                }
                
                // 3. éæ¿¾å¹´ä»½è¡Œï¼ˆå¦‚ï¼š2025ï¼‰
                if (row.length === 1 && /^20\d{2}$/.test(firstCell)) {
                    isVisible = false;
                }
                
                // 4. éæ¿¾è¡¨é ­è¡Œï¼ˆåŒ…å«æ¬„ä½æ¨™é¡Œçš„è¡Œï¼‰
                if (rowText.includes('äººåŠ›èª¿') || rowText.includes('æ¸…æ½”') || 
                    rowText.includes('å¢åŠ ') || rowText.includes('åŒ…æœˆ') ||
                    rowText.includes('åç¨±') || rowText.includes('é‡‘é¡') ||
                    (rowText.includes('æ”¯å‡º') && rowText.includes('è²»ç”¨') && rowText.includes('åŒ…æœˆ'))) {
                    // é€™å¯èƒ½æ˜¯è¡¨é ­ï¼Œä½†åŒ…å«è²»ç”¨ä¿¡æ¯æ™‚ä¿ç•™
                    if (!rowText.match(/\d+/) || rowText.includes('æ¨™é¡Œ') || rowText.includes('æ¬„ä½')) {
                        isVisible = false;
                    }
                }
                
                // 5. éæ¿¾åˆ†éš”ç¬¦è¡Œ
                if (rowText.includes('---') || rowText.includes('===') || 
                    rowText.includes('***') || rowText.includes('///')) {
                    isVisible = false;
                }
                
                // 6. éæ¿¾è¨»è§£è¡Œï¼ˆä»¥#é–‹é ­ï¼‰
                const firstNonEmptyCell = row.find(cell => cell && cell.trim() !== '');
                if (firstNonEmptyCell && firstNonEmptyCell.trim().startsWith('#')) {
                    isVisible = false;
                }
                
                // 7. éæ¿¾æ˜é¡¯çš„æ¸¬è©¦è³‡æ–™
                if (rowText.includes('æ¸¬è©¦') || rowText.includes('test') || 
                    rowText.includes('ç¯„ä¾‹') || rowText.includes('example')) {
                    isVisible = false;
                }
                
                // 8. ä¿ç•™åŒ…å«æ•¸å­—é‡‘é¡çš„è³‡æ–™è¡Œ
                const hasAmount = row.some(cell => {
                    const cellStr = cell ? cell.toString().trim() : '';
                    return /\d+/.test(cellStr) && (
                        cellStr.includes('æ”¯å‡º') || 
                        cellStr.includes('è²»ç”¨') || 
                        /^\d+$/.test(cellStr) ||
                        /^\d+\.\d+$/.test(cellStr)
                    );
                });
                
                // å¦‚æœåŒ…å«é‡‘é¡ä¿¡æ¯ï¼Œå³ä½¿æœ‰å…¶ä»–éæ¿¾æ¢ä»¶ä¹Ÿä¿ç•™
                if (hasAmount && !rowText.includes('æ¸¬è©¦') && !rowText.includes('test')) {
                    isVisible = true;
                }
                
                if (isVisible) {
                    visibleRows.push(row);
                }
            }
            
            return visibleRows;
        }

        function displayColumnSelection(data) {
            const checkboxContainer = document.getElementById('financial-column-checkboxes');
            checkboxContainer.innerHTML = '';
            
            data.headers.forEach((header, index) => {
                if (header && header.trim() !== '') {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.style.cssText = 'display: flex; align-items: center; color: #e0e0e0; padding: 5px;';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `col-${index}`;
                    checkbox.value = index;
                    checkbox.style.cssText = 'margin-right: 8px; width: 16px; height: 16px;';
                    
                    const label = document.createElement('label');
                    label.htmlFor = `col-${index}`;
                    label.textContent = header;
                    label.style.cssText = 'cursor: pointer; font-size: 14px;';
                    
                    checkboxDiv.appendChild(checkbox);
                    checkboxDiv.appendChild(label);
                    checkboxContainer.appendChild(checkboxDiv);
                }
            });
            
            document.getElementById('financial-column-selection').style.display = 'block';
        }

        function selectAllColumns() {
            const checkboxes = document.querySelectorAll('#financial-column-checkboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = true);
        }

        function clearAllColumns() {
            const checkboxes = document.querySelectorAll('#financial-column-checkboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = false);
        }

        function proceedWithAnalysis() {
            const selectedColumns = [];
            const checkboxes = document.querySelectorAll('#financial-column-checkboxes input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                showStatus('financial-status', 'âŒ è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ¬„ä½é€²è¡Œåˆ†æ', 'error');
                return;
            }
            
            checkboxes.forEach(checkbox => {
                selectedColumns.push(parseInt(checkbox.value));
            });
            
            // æ ¹æ“šé¸æ“‡çš„æ¬„ä½éæ¿¾è³‡æ–™
            const filteredData = {
                headers: selectedColumns.map(index => financialData.headers[index]),
                rows: financialData.rows.map(row => selectedColumns.map(index => row[index] || ''))
            };
            
            displayFinancialData(filteredData);
            performFinancialAnalysis(filteredData);
            showStatus('financial-status', `âœ… æˆåŠŸåˆ†æ ${selectedColumns.length} å€‹æ¬„ä½çš„ ${filteredData.rows.length} ç­†è³‡æ–™`, 'success');
        }

        async function analyzeFinancialData() {
            const method = document.querySelector('input[name="input-method"]:checked').value;
            
            if (method === 'csv') {
                // è™•ç†CSVè³‡æ–™è²¼ä¸Š
                const csvData = document.getElementById('financial-csv-data').value.trim();
                if (!csvData) {
                    showStatus('financial-status', 'âŒ è«‹è²¼ä¸ŠCSVè³‡æ–™', 'error');
                    return;
                }
                
                showStatus('financial-status', 'ğŸ”„ æ­£åœ¨è§£æCSVè³‡æ–™...', 'success');
                
                try {
                    // è§£æCSV
                    const rows = parseCSV(csvData);
                    const filteredRows = rows.filter(row => row.some(cell => cell && cell.length > 0));
                    
                    if (filteredRows.length === 0) {
                        throw new Error('CSVè³‡æ–™ä¸­æ²’æœ‰æ‰¾åˆ°ä»»ä½•æœ‰æ•ˆè³‡æ–™');
                    }

                    // å„²å­˜åŸå§‹è³‡æ–™ä¸¦é¡¯ç¤ºæ¬„ä½é¸æ“‡
                    financialData = {
                        headers: filteredRows[0] || [],
                        rows: filteredRows.slice(1) // æ’é™¤æ¨™é¡Œè¡Œ
                    };

                    displayColumnSelection(financialData);
                    showStatus('financial-status', `âœ… æˆåŠŸè§£æ ${financialData.rows.length} ç­†è³‡æ–™ï¼Œè«‹é¸æ“‡è¦åˆ†æçš„æ¬„ä½`, 'success');
                    
                } catch (error) {
                    console.error('è§£æCSVè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    showStatus('financial-status', `âŒ ${error.message}`, 'error');
                }
                return;
            }
            
            // è™•ç†Googleè©¦ç®—è¡¨é€£çµ
            const sheetsUrl = document.getElementById('financial-sheets-url').value.trim();
            
            if (!sheetsUrl) {
                showStatus('financial-status', 'âŒ è«‹è¼¸å…¥Googleè©¦ç®—è¡¨ç¶²å€', 'error');
                return;
            }

            if (!sheetsUrl.includes('docs.google.com/spreadsheets')) {
                showStatus('financial-status', 'âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„Googleè©¦ç®—è¡¨é€£çµ', 'error');
                return;
            }

            showStatus('financial-status', 'ğŸ”„ æ­£åœ¨è¼‰å…¥è©¦ç®—è¡¨è³‡æ–™...', 'success');

            try {
                // å¾URLä¸­æå–è©¦ç®—è¡¨ID
                let spreadsheetId = '';
                const urlMatch = sheetsUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                if (urlMatch) {
                    spreadsheetId = urlMatch[1];
                } else {
                    throw new Error('ç„¡æ³•è§£æè©¦ç®—è¡¨IDï¼Œè«‹ç¢ºèªURLæ ¼å¼æ­£ç¢º');
                }

                // æ§‹å»ºCSVå°å‡ºURL
                let csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv`;
                
                // æª¢æŸ¥æ˜¯å¦æŒ‡å®šäº†å·¥ä½œè¡¨åç¨±
                const sheetName = document.getElementById('financial-sheet-name').value.trim();
                if (sheetName) {
                    csvUrl += `&gid=0`; // é€™è£¡éœ€è¦å¯¦éš›çš„å·¥ä½œè¡¨IDï¼Œç°¡åŒ–è™•ç†
                    showStatus('financial-status', `ğŸ”„ æ­£åœ¨è¼‰å…¥å·¥ä½œè¡¨ "${sheetName}" çš„è³‡æ–™...`, 'success');
                } else {
                    showStatus('financial-status', 'ğŸ”„ æ­£åœ¨è¼‰å…¥é è¨­å·¥ä½œè¡¨è³‡æ–™...', 'success');
                }
                
                // æª¢æŸ¥æ˜¯å¦æŒ‡å®šäº†å„²å­˜æ ¼ç¯„åœ
                const cellRange = document.getElementById('financial-cell-range').value.trim();
                if (cellRange) {
                    // é©—è­‰ç¯„åœæ ¼å¼ (æ”¯æ´å¤šç¨®æ ¼å¼: A1:Z100, A:Z, 1:100, A1, ç­‰)
                    const upperRange = cellRange.toUpperCase();
                    const rangePatterns = [
                        /^[A-Z]+\d+:[A-Z]+\d+$/,  // A1:Z100
                        /^[A-Z]+:[A-Z]+$/,        // A:Z
                        /^\d+:\d+$/,              // 1:100
                        /^[A-Z]+\d+$/             // A1
                    ];
                    
                    const isValidRange = rangePatterns.some(pattern => pattern.test(upperRange));
                    
                    if (isValidRange) {
                        csvUrl += `&range=${encodeURIComponent(upperRange)}`;
                        showStatus('financial-status', `ğŸ”„ æ­£åœ¨è¼‰å…¥æŒ‡å®šç¯„åœ ${upperRange} çš„è³‡æ–™...`, 'success');
                    } else {
                        throw new Error('å„²å­˜æ ¼ç¯„åœæ ¼å¼éŒ¯èª¤ï¼Œæ”¯æ´æ ¼å¼ï¼šA1:Z100ã€A:Zã€1:100ã€A1 ç­‰');
                    }
                }
                
                let response;
                try {
                    // å˜—è©¦ç›´æ¥è¨ªå•
                    response = await fetch(csvUrl, {
                        mode: 'cors',
                        headers: {
                            'Accept': 'text/csv,text/plain'
                        }
                    });
                } catch (corsError) {
                    throw new Error('ç”±æ–¼ç€è¦½å™¨å®‰å…¨é™åˆ¶ï¼Œç„¡æ³•ç›´æ¥è®€å–Googleè©¦ç®—è¡¨ã€‚å»ºè­°ä½¿ç”¨CSVè²¼ä¸Šæ–¹å¼ï¼š\n1. åœ¨Googleè©¦ç®—è¡¨ä¸­é¸æ“‡è³‡æ–™ç¯„åœ\n2. æŒ‰Ctrl+Cè¤‡è£½\n3. åˆ‡æ›åˆ°ã€ŒCSVè³‡æ–™è²¼ä¸Šã€æ–¹å¼ä¸¦è²¼ä¸Šè³‡æ–™');
                }

                if (!response.ok) {
                    if (response.status === 403) {
                        throw new Error('ç„¡æ³•å­˜å–è©¦ç®—è¡¨ï¼Œè«‹ç¢ºèªåˆ†äº«è¨­å®šç‚ºã€ŒçŸ¥é“é€£çµçš„ä½¿ç”¨è€…ã€å¯æª¢è¦–');
                    } else if (response.status === 404) {
                        throw new Error('æ‰¾ä¸åˆ°è©¦ç®—è¡¨ï¼Œè«‹ç¢ºèªç¶²å€æ­£ç¢º');
                    } else {
                        throw new Error(`è¼‰å…¥å¤±æ•— (éŒ¯èª¤ä»£ç¢¼: ${response.status})`);
                    }
                }

                const csvText = await response.text();
                
                if (!csvText || csvText.trim().length === 0) {
                    throw new Error('è©¦ç®—è¡¨è³‡æ–™ç‚ºç©ºï¼Œè«‹ç¢ºèªè¡¨æ ¼ä¸­æœ‰è³‡æ–™');
                }

                // è§£æCSV
                const rows = parseCSV(csvText);
                const filteredRows = rows.filter(row => row.some(cell => cell && cell.length > 0));
                
                if (filteredRows.length === 0) {
                    throw new Error('è©¦ç®—è¡¨ä¸­æ²’æœ‰æ‰¾åˆ°ä»»ä½•æœ‰æ•ˆè³‡æ–™');
                }

                // å„²å­˜åŸå§‹è³‡æ–™ä¸¦é¡¯ç¤ºæ¬„ä½é¸æ“‡
                financialData = {
                    headers: filteredRows[0] || [],
                    rows: filteredRows.slice(1) // æ’é™¤æ¨™é¡Œè¡Œ
                };

                displayColumnSelection(financialData);
                showStatus('financial-status', `âœ… æˆåŠŸè¼‰å…¥ ${financialData.rows.length} ç­†è³‡æ–™ï¼Œè«‹é¸æ“‡è¦åˆ†æçš„æ¬„ä½`, 'success');

            } catch (error) {
                console.error('è²¡å‹™åˆ†æå¤±æ•—:', error);
                showStatus('financial-status', `âŒ ${error.message}`, 'error');
            }
        }

        function displayFinancialData(data) {
            const preview = document.getElementById('financial-raw-data');
            
            let html = '<table style="width: 100%; border-collapse: collapse; color: #e0e0e0; font-size: 12px;">';
            
            if (data.headers.length > 0) {
                html += '<tr style="background: #404040;">';
                data.headers.forEach(header => {
                    html += `<th style="border: 1px solid #666; padding: 4px; text-align: left;">${header}</th>`;
                });
                html += '</tr>';
            }

            // åªé¡¯ç¤ºå‰10è¡Œè³‡æ–™ä»¥ç¯€çœç©ºé–“
            const displayRows = data.rows.slice(0, 10);
            displayRows.forEach((row, index) => {
                html += `<tr style="background: ${index % 2 === 0 ? '#2a2a2a' : '#333333'};">`;
                row.forEach(cell => {
                    html += `<td style="border: 1px solid #666; padding: 4px;">${cell}</td>`;
                });
                html += '</tr>';
            });

            if (data.rows.length > 10) {
                html += `<tr><td colspan="${data.headers.length}" style="text-align: center; padding: 8px; color: #888;">... é‚„æœ‰ ${data.rows.length - 10} ç­†è³‡æ–™</td></tr>`;
            }

            html += '</table>';
            preview.innerHTML = html;
            
            document.getElementById('financial-data-preview').style.display = 'block';
        }

        function performFinancialAnalysis(data) {
            const headers = data.headers;
            const rows = data.rows;
            
            // å°‹æ‰¾åŒ…å«æ”¯å‡ºç›¸é—œæ¬„ä½
            const expenseColumns = [];
            const amountColumns = [];
            
            headers.forEach((header, index) => {
                const lowerHeader = header.toLowerCase();
                if (lowerHeader.includes('æ”¯å‡º') || lowerHeader.includes('è²»ç”¨') || lowerHeader.includes('æˆæœ¬') || 
                    lowerHeader.includes('expense') || lowerHeader.includes('cost')) {
                    expenseColumns.push({ header, index });
                }
                // å°‹æ‰¾æ•¸å­—æ¬„ä½
                if (lowerHeader.includes('é‡‘é¡') || lowerHeader.includes('åƒ¹æ ¼') || lowerHeader.includes('éŒ¢') || 
                    lowerHeader.includes('amount') || lowerHeader.includes('price') || lowerHeader.includes('ç¸½è¨ˆ')) {
                    amountColumns.push({ header, index });
                }
            });

            // åˆ†ææ”¯å‡ºé¡åˆ¥
            const expenseCategories = {};
            let totalExpense = 0;
            let validEntries = 0;

            rows.forEach(row => {
                // æª¢æŸ¥æ¯ä¸€æ¬„ä½æ˜¯å¦åŒ…å«æ”¯å‡ºé—œéµå­—å’Œé‡‘é¡
                row.forEach((cell, cellIndex) => {
                    const cellValue = cell.toString().trim();
                    
                    // æª¢æŸ¥æ˜¯å¦åŒ…å«æ”¯å‡ºé—œéµå­—
                    const hasExpenseKeyword = cellValue.includes('æ”¯å‡º') || cellValue.includes('è²»ç”¨') || 
                                             cellValue.includes('æˆæœ¬') || cellValue.includes('è³¼è²·') ||
                                             cellValue.includes('æ”¯ä»˜') || cellValue.includes('ä»˜æ¬¾');
                    
                    if (hasExpenseKeyword) {
                        // åœ¨åŒä¸€è¡Œä¸­å°‹æ‰¾æ•¸å­—
                        let amount = 0;
                        let category = 'å…¶ä»–æ”¯å‡º';
                        
                        // å¾åŒä¸€è¡Œçš„å…¶ä»–æ¬„ä½ä¸­æå–é‡‘é¡
                        for (let i = 0; i < row.length; i++) {
                            const otherCell = row[i].toString().trim();
                            const numberMatch = otherCell.match(/\d+/);
                            if (numberMatch && parseInt(numberMatch[0]) > 0) {
                                amount = parseInt(numberMatch[0]);
                                break;
                            }
                        }
                        
                        // è­˜åˆ¥æ”¯å‡ºé¡åˆ¥
                        if (cellValue.includes('æ²¹') || cellValue.includes('ç‡ƒæ–™') || cellValue.includes('åŠ æ²¹')) {
                            category = 'ç‡ƒæ–™è²»';
                        } else if (cellValue.includes('é¤') || cellValue.includes('é£Ÿ') || cellValue.includes('åˆé¤') || cellValue.includes('æ™šé¤')) {
                            category = 'é¤é£²è²»';
                        } else if (cellValue.includes('äº¤é€š') || cellValue.includes('éè·¯') || cellValue.includes('åœè»Š')) {
                            category = 'äº¤é€šè²»';
                        } else if (cellValue.includes('ç¶­ä¿®') || cellValue.includes('ä¿é¤Š') || cellValue.includes('ä¿®ç†')) {
                            category = 'ç¶­ä¿®ä¿é¤Šè²»';
                        } else if (cellValue.includes('è¨­å‚™') || cellValue.includes('å·¥å…·') || cellValue.includes('è³¼è²·')) {
                            category = 'è¨­å‚™æ¡è³¼è²»';
                        } else if (cellValue.includes('äººäº‹') || cellValue.includes('è–ªè³‡') || cellValue.includes('å·¥è³‡')) {
                            category = 'äººäº‹è²»ç”¨';
                        } else if (cellValue.includes('è¾¦å…¬') || cellValue.includes('æ–‡å…·') || cellValue.includes('ç”¨å“')) {
                            category = 'è¾¦å…¬ç”¨å“è²»';
                        } else {
                            // ä½¿ç”¨æ¨™é¡Œæ¬„ä½ä½œç‚ºé¡åˆ¥
                            if (headers[cellIndex]) {
                                category = headers[cellIndex];
                            }
                        }
                        
                        if (amount > 0) {
                            if (!expenseCategories[category]) {
                                expenseCategories[category] = { total: 0, count: 0, items: [] };
                            }
                            expenseCategories[category].total += amount;
                            expenseCategories[category].count += 1;
                            expenseCategories[category].items.push({
                                description: cellValue,
                                amount: amount
                            });
                            totalExpense += amount;
                            validEntries++;
                        }
                    }
                });
            });

            // å¦‚æœæ²’æœ‰æ‰¾åˆ°æ˜ç¢ºçš„æ”¯å‡ºé …ç›®ï¼Œå˜—è©¦å¾æ•¸å­—æ¬„ä½ä¸­åˆ†æ
            if (validEntries === 0 && amountColumns.length > 0) {
                rows.forEach(row => {
                    amountColumns.forEach(amountCol => {
                        const cellValue = row[amountCol.index];
                        const numberMatch = cellValue.toString().match(/\d+/);
                        if (numberMatch) {
                            const amount = parseInt(numberMatch[0]);
                            if (amount > 0) {
                                const category = amountCol.header || 'æœªåˆ†é¡æ”¯å‡º';
                                if (!expenseCategories[category]) {
                                    expenseCategories[category] = { total: 0, count: 0, items: [] };
                                }
                                expenseCategories[category].total += amount;
                                expenseCategories[category].count += 1;
                                expenseCategories[category].items.push({
                                    description: `${amountCol.header}`,
                                    amount: amount
                                });
                                totalExpense += amount;
                                validEntries++;
                            }
                        }
                    });
                });
            }

            // é¡¯ç¤ºåˆ†æçµæœ
            displayFinancialSummary(expenseCategories, totalExpense, validEntries);
            displayFinancialBreakdown(expenseCategories);
            
            document.getElementById('financial-analysis-output').style.display = 'block';
        }

        function displayFinancialSummary(categories, total, count) {
            const summary = document.getElementById('financial-summary');
            const categoryCount = Object.keys(categories).length;
            
            let html = `
                <h5 style="color: #ffd700; margin-bottom: 15px;">ğŸ“Š è²¡å‹™æ‘˜è¦</h5>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background: #1a4d2e; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #4ade80;">$${total.toLocaleString()}</div>
                        <div style="color: #a3a3a3; font-size: 14px;">ç¸½æ”¯å‡ºé‡‘é¡</div>
                    </div>
                    <div style="background: #2d1b69; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #a78bfa;">${categoryCount}</div>
                        <div style="color: #a3a3a3; font-size: 14px;">æ”¯å‡ºé¡åˆ¥</div>
                    </div>
                    <div style="background: #7c2d12; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #fb7185;">${count}</div>
                        <div style="color: #a3a3a3; font-size: 14px;">äº¤æ˜“ç­†æ•¸</div>
                    </div>
                    <div style="background: #365314; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #fbbf24;">$${Math.round(total / count).toLocaleString()}</div>
                        <div style="color: #a3a3a3; font-size: 14px;">å¹³å‡å–®ç­†</div>
                    </div>
                </div>
            `;
            
            summary.innerHTML = html;
        }

        function displayFinancialBreakdown(categories) {
            const breakdown = document.getElementById('financial-breakdown');
            
            let html = '<h5 style="color: #ffd700; margin-bottom: 15px;">ğŸ“ˆ æ”¯å‡ºæ˜ç´°</h5>';
            
            if (Object.keys(categories).length === 0) {
                html += '<div style="text-align: center; color: #888; padding: 20px;">æœªæ‰¾åˆ°æ”¯å‡ºè³‡æ–™</div>';
            } else {
                // æŒ‰é‡‘é¡æ’åº
                const sortedCategories = Object.entries(categories).sort(([,a], [,b]) => b.total - a.total);
                
                sortedCategories.forEach(([categoryName, categoryData]) => {
                    const percentage = ((categoryData.total / Object.values(categories).reduce((sum, cat) => sum + cat.total, 0)) * 100).toFixed(1);
                    
                    html += `
                        <div style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-weight: bold; color: #fff;">${categoryName}</div>
                                <div style="color: #4ade80; font-weight: bold;">$${categoryData.total.toLocaleString()} (${percentage}%)</div>
                            </div>
                            <div style="color: #a3a3a3; font-size: 14px; margin-bottom: 8px;">${categoryData.count} ç­†äº¤æ˜“ â€¢ å¹³å‡ $${Math.round(categoryData.total / categoryData.count).toLocaleString()}</div>
                            <div style="background: #4ade80; height: 6px; border-radius: 3px; width: ${percentage}%;"></div>
                        </div>
                    `;
                });
            }
            
            breakdown.innerHTML = html;
        }

        function copyFinancialAnalysis() {
            if (!financialData || Object.keys(financialData).length === 0) {
                showStatus('financial-status', 'âŒ æ²’æœ‰åˆ†æçµæœå¯è¤‡è£½', 'error');
                return;
            }

            const summaryText = document.getElementById('financial-summary').textContent;
            const breakdownText = document.getElementById('financial-breakdown').textContent;
            
            const analysisText = `è²¡å‹™åˆ†æå ±å‘Š\n\n${summaryText}\n\n${breakdownText}`;
            
            navigator.clipboard.writeText(analysisText).then(() => {
                showStatus('financial-status', 'âœ… è²¡å‹™åˆ†æçµæœå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
            }).catch(() => {
                showStatus('financial-status', 'âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸æ“‡è¤‡è£½', 'error');
            });
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–ç¶²å€ä¸‹æ‹‰é¸å–®
        document.addEventListener('DOMContentLoaded', function() {
            updateUrlDropdown();
            updateFinancialUrlDropdown();
        });
    </script>
</body>
</html>
